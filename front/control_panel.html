<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMB2API ÁÆ°ÁêÜÈù¢Êùø</title>
    <style>
        /* CSS ÂèòÈáè - ‰∫ÆËâ≤Ê®°Âºè */
        :root {
            --bg-color: #f5f5f5;
            --container-bg: white;
            --text-color: #333;
            --text-secondary: #666;
            --text-muted: #999;
            --border-color: #e1e4e8;
            --input-bg: white;
            --input-border: #ddd;
            --card-bg: #f8f9fa;
            --hover-bg: #f1f5f9;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --tab-bg: #f8fafc;
            --tab-active-bg: #ffffff;
            --table-stripe: #fcfcfc;
            --table-hover: #f8fbff;
            --code-bg: #f0f8ff;
            --modal-overlay: rgba(0, 0, 0, 0.5);
        }

        /* ÊöóÈªëÊ®°Âºè */
        [data-theme="dark"] {
            --bg-color: #1a1a2e;
            --container-bg: #16213e;
            --text-color: #e8e8e8;
            --text-secondary: #a0a0a0;
            --text-muted: #707070;
            --border-color: #2d3748;
            --input-bg: #1e2a47;
            --input-border: #3d4f6f;
            --card-bg: #1e2a47;
            --hover-bg: #243b55;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --tab-bg: #1e2a47;
            --tab-active-bg: #243b55;
            --table-stripe: #1e2a47;
            --table-hover: #243b55;
            --code-bg: #1e2a47;
            --modal-overlay: rgba(0, 0, 0, 0.7);
        }

        /* ÈáëÈ¢ùÂä®ÊÄÅÁâπÊïà - ‰ΩôÈ¢ùÁ∫¢Ëâ≤Èó™ÁÉÅ */
        @keyframes balancePulse {
            0%, 100% { text-shadow: 0 0 5px rgba(255, 77, 77, 0.5); }
            50% { text-shadow: 0 0 20px rgba(255, 77, 77, 0.8), 0 0 30px rgba(255, 77, 77, 0.4); }
        }
        
        /* ÈáëÈ¢ùÂä®ÊÄÅÁâπÊïà - Ê∂àË¥πÁªøËâ≤ÊµÅÂä® */
        @keyframes spendGlow {
            0%, 100% { text-shadow: 0 0 5px rgba(40, 167, 69, 0.5); }
            50% { text-shadow: 0 0 15px rgba(40, 167, 69, 0.8), 0 0 25px rgba(40, 167, 69, 0.4); }
        }
        
        /* Êï∞Â≠óË∑≥Âä®ÊïàÊûú */
        @keyframes numberBounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        .balance-amount {
            color: #ff4d4d !important;
            animation: balancePulse 2s ease-in-out infinite, numberBounce 3s ease-in-out infinite;
            font-variant-numeric: tabular-nums;
        }
        
        .spend-amount {
            color: #28a745 !important;
            animation: spendGlow 2s ease-in-out infinite, numberBounce 3s ease-in-out infinite 0.5s;
            font-variant-numeric: tabular-nums;
        }
        
        /* ÊöóÈªëÊ®°Âºè‰∏ãÊ®°ÂûãÊ†áÁ≠æÈÄÇÈÖç */
        [data-theme="dark"] .model-chip {
            background: var(--card-bg) !important;
            border-color: var(--border-color) !important;
        }
        
        [data-theme="dark"] .model-chip .model-ctx {
            color: var(--text-secondary) !important;
        }

        /* ÊöóÈªëÊ®°Âºè‰∏ãÁöÑÈ¢ùÂ§ñÊ†∑ÂºèË¶ÜÁõñ */
        [data-theme="dark"] .config-input,
        [data-theme="dark"] .filter-select,
        [data-theme="dark"] input[type="text"],
        [data-theme="dark"] input[type="number"],
        [data-theme="dark"] input[type="password"],
        [data-theme="dark"] textarea,
        [data-theme="dark"] select {
            background-color: var(--input-bg) !important;
            color: var(--text-color) !important;
            border-color: var(--input-border) !important;
        }

        [data-theme="dark"] .config-group {
            background-color: var(--card-bg) !important;
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] .config-group h4 {
            color: var(--text-color) !important;
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] .config-note {
            color: var(--text-secondary) !important;
        }

        [data-theme="dark"] .status-badge {
            color: white !important;
        }

        [data-theme="dark"] .btn {
            color: white;
        }

        [data-theme="dark"] .modal-content {
            background-color: var(--container-bg) !important;
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .modal-header,
        [data-theme="dark"] .modal-footer {
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] .modal-title {
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .modal-close {
            color: var(--text-secondary) !important;
        }

        [data-theme="dark"] .modal-close:hover {
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .key-stat-card {
            background-color: var(--card-bg) !important;
        }

        [data-theme="dark"] .key-stat-badge {
            background-color: var(--card-bg) !important;
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .pagination-btn {
            background-color: var(--card-bg) !important;
            color: var(--text-color) !important;
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] .pagination-btn:hover:not(:disabled) {
            background-color: var(--hover-bg) !important;
        }

        [data-theme="dark"] .cred-card,
        [data-theme="dark"] .rate-limit-card,
        [data-theme="dark"] .usage-card {
            background-color: var(--card-bg) !important;
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] .stat-item {
            background: var(--card-bg) !important;
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] .stat-number,
        [data-theme="dark"] .stat-label {
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .upload-area {
            background-color: var(--card-bg) !important;
            border-color: var(--border-color) !important;
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .credentials,
        [data-theme="dark"] .cred-content {
            background-color: var(--code-bg) !important;
            border-color: var(--border-color) !important;
            color: var(--text-color) !important;
        }

        [data-theme="dark"] code {
            background-color: var(--code-bg) !important;
            color: #9cdcfe !important;
        }

        [data-theme="dark"] .progress-bar {
            background-color: var(--border-color) !important;
        }

        [data-theme="dark"] h3, [data-theme="dark"] h4 {
            color: var(--text-color) !important;
        }

        [data-theme="dark"] p {
            color: var(--text-secondary) !important;
        }

        [data-theme="dark"] small {
            color: var(--text-muted) !important;
        }

        [data-theme="dark"] .login-form input[type="password"] {
            background-color: var(--input-bg) !important;
            color: var(--text-color) !important;
            border-color: var(--input-border) !important;
        }

        /* ÊöóÈªëÊ®°Âºè‰∏ãÂºπÁ™óÂÜÖÁöÑÊåâÈíÆÊ†∑Âºè */
        [data-theme="dark"] .modal-content .btn {
            color: white;
        }

        [data-theme="dark"] .modal-content .btn-sm {
            color: white;
        }

        /* ÊöóÈªëÊ®°Âºè‰∏ãË°®Ê†ºÊ†∑Âºè */
        [data-theme="dark"] .table {
            color: var(--text-color);
        }

        [data-theme="dark"] .table thead th {
            background-color: var(--card-bg) !important;
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .table tbody td {
            color: var(--text-color) !important;
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] .table tbody tr {
            background-color: var(--container-bg) !important;
        }

        [data-theme="dark"] .table tbody tr:nth-child(odd) {
            background-color: var(--table-stripe) !important;
        }

        [data-theme="dark"] .table tbody tr:hover {
            background-color: var(--table-hover) !important;
        }

        /* ÊöóÈªëÊ®°Âºè‰∏ãÈ¢ÑËßàÂå∫Âüü */
        [data-theme="dark"] #requestPreviewSection pre {
            background-color: #1e1e1e !important;
            color: #9cdcfe !important;
        }

        /* ÊöóÈªëÊ®°Âºè‰∏ãÁöÑ card Ê†∑Âºè */
        [data-theme="dark"] .card {
            background-color: var(--card-bg) !important;
            border-color: var(--border-color) !important;
            color: var(--text-color) !important;
        }

        /* ÊöóÈªëÊ®°Âºè‰∏ãÁöÑ status Ê†∑Âºè */
        [data-theme="dark"] .status.info {
            background-color: #1e3a5f !important;
            border-color: #2d5a87 !important;
            color: #7ec8e3 !important;
        }

        [data-theme="dark"] .status.success {
            background-color: #1e4620 !important;
            border-color: #2d6930 !important;
            color: #7ec87e !important;
        }

        [data-theme="dark"] .status.error {
            background-color: #4a1e1e !important;
            border-color: #6b2d2d !important;
            color: #e87e7e !important;
        }

        /* ÊöóÈªëÊ®°Âºè‰∏ãÁöÑ tabs ËæπÊ°Ü */
        [data-theme="dark"] .tabs {
            border-color: var(--border-color) !important;
        }

        /* ÊöóÈªëÊ®°Âºè‰∏ãÁöÑ loading ÊñáÂ≠ó */
        [data-theme="dark"] .loading {
            color: var(--text-secondary) !important;
        }

        /* ÊöóÈªëÊ®°Âºè‰∏ãÁöÑ pre Âíå code ÂÖÉÁ¥† */
        [data-theme="dark"] pre {
            background-color: #1e1e1e !important;
            color: #d4d4d4 !important;
            border-color: var(--border-color) !important;
        }

        /* ÊöóÈªëÊ®°Âºè‰∏ãÁöÑÂºπÁ™óÂÜÖÈÉ®ÂÖÉÁ¥† */
        [data-theme="dark"] #keyManagementModal .modal-content {
            background-color: var(--container-bg) !important;
        }

        [data-theme="dark"] #keyManagementModal .key-stat-card {
            background-color: var(--card-bg) !important;
        }

        [data-theme="dark"] #keyManagementModal .key-stat-badge {
            background-color: var(--card-bg) !important;
            color: var(--text-color) !important;
        }

        [data-theme="dark"] #keyManagementModal .filter-select {
            background-color: var(--input-bg) !important;
            color: var(--text-color) !important;
            border-color: var(--input-border) !important;
        }

        [data-theme="dark"] #keyManagementModal .btn {
            color: inherit;
        }

        [data-theme="dark"] #keyManagementModal .progress-bar {
            background-color: var(--border-color) !important;
        }

        /* ÊöóÈªëÊ®°Âºè‰∏ãÁöÑ placeholder */
        [data-theme="dark"] ::placeholder {
            color: var(--text-muted) !important;
            opacity: 1;
        }

        [data-theme="dark"] ::-webkit-input-placeholder {
            color: var(--text-muted) !important;
        }

        [data-theme="dark"] ::-moz-placeholder {
            color: var(--text-muted) !important;
        }

        /* ÊöóÈªëÊ®°Âºè‰∏ãÁöÑÊªöÂä®Êù° */
        [data-theme="dark"] ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        [data-theme="dark"] ::-webkit-scrollbar-track {
            background: var(--card-bg);
        }

        [data-theme="dark"] ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        [data-theme="dark"] ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* ========== ÈÄüÁéáÈôêÂà∂È°µÈù¢ÊöóÈªëÊ®°Âºè ========== */
        [data-theme="dark"] .rate-limit-card {
            background-color: var(--card-bg) !important;
            border-color: var(--border-color) !important;
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .rate-limit-header {
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .rate-limit-key {
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .rate-limit-info-label {
            color: var(--text-secondary) !important;
        }

        [data-theme="dark"] .rate-limit-info-value {
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .rate-limit-progress {
            background-color: var(--border-color) !important;
        }

        [data-theme="dark"] .rate-limit-reset {
            color: var(--text-secondary) !important;
        }

        [data-theme="dark"] #rateLimitList {
            color: var(--text-color) !important;
        }

        /* ========== ‰ΩøÁî®ÁªüËÆ°È°µÈù¢ÊöóÈªëÊ®°Âºè ========== */
        [data-theme="dark"] .usage-card {
            background-color: var(--card-bg) !important;
            border-color: var(--border-color) !important;
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .usage-header {
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .usage-filename {
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .usage-progress-label {
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .usage-progress-bar {
            background-color: var(--border-color) !important;
        }

        [data-theme="dark"] .usage-info-item {
            background-color: var(--card-bg) !important;
            border-color: var(--border-color) !important;
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .usage-info-label {
            color: var(--text-secondary) !important;
        }

        [data-theme="dark"] .usage-info-value {
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .reset-time {
            color: var(--text-muted) !important;
        }

        [data-theme="dark"] .ranking-container {
            background-color: var(--card-bg) !important;
            border-color: var(--border-color) !important;
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .ranking-header {
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .ranking-label {
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .ranking-bar {
            background-color: var(--border-color) !important;
        }

        [data-theme="dark"] .ranking-count {
            color: var(--text-secondary) !important;
        }

        [data-theme="dark"] .legend {
            color: var(--text-secondary) !important;
        }

        /* ========== ÊìçÁªÉÂú∫È°µÈù¢ÊöóÈªëÊ®°Âºè ========== */
        [data-theme="dark"] #playgroundTab .config-group {
            background-color: var(--card-bg) !important;
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] #playgroundMessages .form-group {
            background-color: var(--card-bg) !important;
        }

        [data-theme="dark"] #playgroundOutputContent {
            color: var(--text-color) !important;
        }

        [data-theme="dark"] #playgroundRawJson {
            background-color: #1e1e1e !important;
            color: #d4d4d4 !important;
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] .playground-btn {
            color: white !important;
        }

        [data-theme="dark"] .playground-status .status {
            background-color: var(--card-bg) !important;
            border-color: var(--border-color) !important;
        }

        /* ========== ÂÆûÊó∂Êó•ÂøóÈ°µÈù¢ÊöóÈªëÊ®°Âºè ========== */
        [data-theme="dark"] #logsTab .config-group {
            background-color: var(--card-bg) !important;
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] #logContainer {
            background-color: #1e1e1e !important;
            color: #d4d4d4 !important;
            border-color: var(--border-color) !important;
        }

        /* ========== ÈÄöÁî®ÂÖÉÁ¥†ÊöóÈªëÊ®°Âºè ========== */
        [data-theme="dark"] div[style*="background:#f7f7f7"],
        [data-theme="dark"] div[style*="background: #f7f7f7"],
        [data-theme="dark"] div[style*="background-color:#f7f7f7"],
        [data-theme="dark"] div[style*="background-color: #f7f7f7"] {
            background-color: var(--card-bg) !important;
        }

        [data-theme="dark"] div[style*="background:#f0f0f0"],
        [data-theme="dark"] div[style*="background: #f0f0f0"] {
            background-color: var(--card-bg) !important;
        }

        [data-theme="dark"] div[style*="background:#ffffff"],
        [data-theme="dark"] div[style*="background: #ffffff"],
        [data-theme="dark"] div[style*="background:white"],
        [data-theme="dark"] div[style*="background: white"],
        [data-theme="dark"] div[style*="background-color:#ffffff"],
        [data-theme="dark"] div[style*="background-color: #ffffff"],
        [data-theme="dark"] div[style*="background-color:white"],
        [data-theme="dark"] div[style*="background-color: white"] {
            background-color: var(--card-bg) !important;
        }

        [data-theme="dark"] span[style*="background:#f0f0f0"],
        [data-theme="dark"] span[style*="background: #f0f0f0"] {
            background-color: var(--card-bg) !important;
            color: var(--text-color) !important;
        }

        [data-theme="dark"] button[style*="background:#f0f0f0"],
        [data-theme="dark"] button[style*="background: #f0f0f0"] {
            background-color: var(--card-bg) !important;
            color: var(--text-color) !important;
        }

        [data-theme="dark"] [style*="color:#333"],
        [data-theme="dark"] [style*="color: #333"] {
            color: var(--text-color) !important;
        }

        [data-theme="dark"] [style*="color:#666"],
        [data-theme="dark"] [style*="color: #666"] {
            color: var(--text-secondary) !important;
        }

        /* ========== Êõ¥Â§öÁâπÂÆöÂÖÉÁ¥†ÊöóÈªëÊ®°Âºè ========== */
        [data-theme="dark"] #playgroundResultMessage {
            background-color: var(--card-bg) !important;
            color: var(--text-color) !important;
        }

        [data-theme="dark"] #playgroundResultKey,
        [data-theme="dark"] #playgroundResultTokens,
        [data-theme="dark"] #playgroundResultModel {
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .badge {
            color: white !important;
        }

        [data-theme="dark"] #configMetaBar span {
            color: var(--text-secondary) !important;
        }

        [data-theme="dark"] #configMetaBar .badge {
            color: white !important;
        }

        /* ÈÄüÁéáÈôêÂà∂Âç°ÁâáÂÜÖÁöÑÊâÄÊúâÊñáÂ≠ó */
        [data-theme="dark"] #rateLimitTab * {
            color: inherit;
        }

        [data-theme="dark"] #rateLimitTab {
            color: var(--text-color);
        }

        /* ‰ΩøÁî®ÁªüËÆ°Âç°ÁâáÂÜÖÁöÑÊâÄÊúâÊñáÂ≠ó */
        [data-theme="dark"] #usageTab * {
            color: inherit;
        }

        [data-theme="dark"] #usageTab {
            color: var(--text-color);
        }

        /* ÊìçÁªÉÂú∫ÂÜÖÁöÑÊâÄÊúâÊñáÂ≠ó */
        [data-theme="dark"] #playgroundTab {
            color: var(--text-color);
        }

        [data-theme="dark"] #playgroundTab label {
            color: var(--text-secondary) !important;
        }

        /* ÊäòÂè†Âå∫ÂüüÊ†áÈ¢ò */
        [data-theme="dark"] div[onclick*="toggleSection"] {
            background-color: var(--card-bg) !important;
            color: var(--text-color) !important;
        }

        /* ÊªëÂùóÊ†∑Âºè */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            outline: none;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            border: 3px solid #4285f4;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            border: 3px solid #4285f4;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        [data-theme="dark"] input[type="range"]::-webkit-slider-thumb {
            background: var(--container-bg);
            border-color: #4285f4;
        }

        [data-theme="dark"] input[type="range"]::-moz-range-thumb {
            background: var(--container-bg);
            border-color: #4285f4;
        }

        /* ÊöóÈªëÊ®°ÂºèÂàáÊç¢ÊåâÈíÆ */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            background: var(--container-bg);
            border: 2px solid var(--border-color);
            border-radius: 50px;
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text-color);
            box-shadow: 0 2px 10px var(--shadow-color);
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px var(--shadow-color);
        }

        .theme-toggle:active {
            transform: scale(0.95);
        }

        .theme-toggle .icon {
            font-size: 18px;
            transition: transform 0.3s ease;
        }

        .theme-toggle:hover .icon {
            transform: rotate(20deg);
        }

        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container {
            background-color: var(--container-bg);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px var(--shadow-color);
            transition: background-color 0.3s ease;
            overflow-x: hidden;
        }

        @media (max-width: 480px) {
            .container { padding: 16px; }
        }

        h1 {
            color: var(--text-color);
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--text-secondary);
        }

        input[type="text"], input[type="number"], input[type="password"], textarea, select {
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 2px solid var(--input-border);
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }

        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--input-border);
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }

        input[type="text"]:focus, input[type="number"]:focus, input[type="password"]:focus, textarea:focus, select:focus {
            border-color: #4285f4;
            outline: none;
        }

        .btn {
            background-color: #4285f4;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 10px;
        }

        .btn-sm {
            padding: 6px 14px;
            font-size: 13px;
            border-radius: 6px;
            width: auto;
            margin-bottom: 0;
        }

        .btn:hover {
            background-color: #3367d6;
        }

        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .auth-url {
            background-color: #f8f9fa;
            border: 1px solid #e1e4e8;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
            word-break: break-all;
        }

        .auth-url a {
            color: #4285f4;
            text-decoration: none;
        }

        .auth-url a:hover {
            text-decoration: underline;
        }

        .credentials {
            background-color: #f0f8ff;
            border: 1px solid #b0d4ff;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 400px;
            overflow-y: auto;
        }

        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .status.success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .status.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .status.info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            color: #666;
        }

        .login-form {
            text-align: center;
            padding: 50px 0;
        }

        .login-form input[type="password"] {
            width: 300px;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            margin-bottom: 20px;
            box-sizing: border-box;
        }

        .tabs {
            display: flex;
            gap: 6px;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 20px;
            flex-wrap: nowrap;
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) transparent;
        }
        
        /* Ê†áÁ≠æÈ°µÊªöÂä®Êù°Ê†∑Âºè */
        .tabs::-webkit-scrollbar {
            height: 4px;
        }
        
        .tabs::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .tabs::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 2px;
        }
        
        .tabs::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background: var(--tab-bg);
            border-radius: 8px 8px 0 0;
            font-weight: 600;
            font-size: 16px;
            color: var(--text-secondary);
            transition: background-color 0.3s ease, color 0.3s ease;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .tab:hover {
            background: var(--hover-bg);
            color: var(--text-color);
        }

        .tab.active {
            background: var(--tab-active-bg);
            color: #2563eb;
            border-bottom: 2px solid #2563eb;
            box-shadow: inset 0 -2px 0 #2563eb;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @media (max-width: 768px) {
            .tabs { 
                gap: 4px;
                padding-bottom: 4px;
            }
            .tab { 
                padding: 10px 16px; 
                font-size: 14px;
            }
        }
        
        @media (max-width: 480px) {
            .tabs { 
                gap: 3px;
                margin-left: -12px;
                margin-right: -12px;
                padding-left: 12px;
                padding-right: 12px;
            }
            .tab { 
                padding: 8px 12px; 
                font-size: 13px;
            }
        }

        /* ÊàêÊú¨È°µÁßªÂä®Á´ØÂìçÂ∫îÂºè */
        .responsive-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
        }
        .responsive-item { min-width: 0; }
        .summary-card { text-align: center; padding: 20px; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color); }
        .summary-card .summary-title { font-size: 14px; color: var(--text-secondary); }
        .summary-card .summary-sub { font-size: 14px; color: var(--text-secondary); }
        .summary-card .summary-value { font-size: 42px; font-weight: bold; color: var(--text-color); }
        .summary-card { width: 100%; box-sizing: border-box; }
        .cost-label { word-break: break-word; overflow-wrap: anywhere; }
        @media (max-width: 480px) {
            .summary-card .summary-value { font-size: 30px; }
            .responsive-grid { grid-template-columns: 1fr; }
        }

        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 5px;
            padding: 40px;
            text-align: center;
            background-color: #fafafa;
            margin: 20px 0;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .upload-area:hover {
            border-color: #4285f4;
        }

        .upload-area.dragover {
            border-color: #4285f4;
            background-color: #f0f8ff;
        }

        .file-list {
            margin: 20px 0;
        }

        .file-item {
            background-color: #f8f9fa;
            border: 1px solid #e1e4e8;
            border-radius: 3px;
            padding: 10px;
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-item .file-name {
            font-family: monospace;
            color: #333;
        }

        .file-item .file-size {
            color: #666;
            font-size: 12px;
        }

        .file-item .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 2px 8px;
            cursor: pointer;
            font-size: 12px;
        }

        .upload-progress {
            background-color: #f8f9fa;
            border: 1px solid #e1e4e8;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background-color: #28a745;
            transition: width 0.3s ease;
        }

        /* Êñá‰ª∂ÁÆ°ÁêÜÊ†∑Âºè */
        .cred-card {
            background-color: #f8f9fa;
            border: 1px solid #e1e4e8;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            position: relative;
            min-width: 600px;
        }

        @media (max-width: 480px) {
            .cred-card { min-width: auto; }
        }

        .cred-card.disabled {
            background-color: #f5f5f5;
            border-color: #ccc;
            opacity: 0.7;
        }

        .cred-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            gap: 20px;
        }

        .cred-filename {
            font-family: monospace;
            font-weight: bold;
            color: #333;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 300px;
        }

        @media (max-width: 480px) {
            .cred-filename { min-width: 0; white-space: normal; overflow-wrap: anywhere; }
        }

        .cred-status {
            display: flex;
            gap: 5px;
        }

        .status-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            color: white;
        }

        .status-badge.enabled {
            background-color: #28a745;
        }

        .status-badge.disabled {
            background-color: #6c757d;
        }

        .error-codes {
            background-color: #f8d7da;
            color: #721c24;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .cred-actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .cred-btn {
            padding: 4px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .cred-btn.enable {
            background-color: #28a745;
            color: white;
        }

        .cred-btn.disable {
            background-color: #6c757d;
            color: white;
        }

        .cred-btn.delete {
            background-color: #dc3545;
            color: white;
        }

        .cred-btn.download {
            background-color: #007bff;
            color: white;
        }

        .cred-btn.view {
            background-color: #17a2b8;
            color: white;
        }

        .cred-details {
            margin-top: 10px;
            display: none;
        }

        .cred-details.show {
            display: block;
        }

        .cred-content {
            background-color: #f0f8ff;
            border: 1px solid #b0d4ff;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 11px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 200px;
            overflow-y: auto;
        }

        .manage-actions {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Êñá‰ª∂ÁÆ°ÁêÜÊñ∞Â¢ûÊ†∑Âºè */
        .stats-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-item {
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 12px 20px;
            text-align: center;
            min-width: 120px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            display: block;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            margin-top: 4px;
        }

        .stat-item.total {
            border-left: 4px solid #007bff;
        }

        .stat-item.normal {
            border-left: 4px solid #28a745;
        }

        .stat-item.disabled {
            border-left: 4px solid #6c757d;
        }

        .filter-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 8px 12px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            background-color: var(--input-bg);
            color: var(--text-color);
        }

        .filter-select:focus {
            border-color: #4285f4;
            outline: none;
        }

        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .pagination-info {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .pagination-btn {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-color);
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--input-bg);
            border-color: #4285f4;
        }

        .pagination-btn:disabled {
            background: #f5f5f5;
            color: #ccc;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background: #4285f4;
            color: white;
            border-color: #4285f4;
        }

        .page-size-select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .refresh-btn {
            background-color: #17a2b8;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .download-all-btn {
            background-color: #28a745;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        /* ÊâπÈáèÊìç‰ΩúÊ†∑Âºè */
        .batch-controls {
            background-color: #f8f9fa;
            border: 1px solid #e1e4e8;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            margin-right: 15px;
        }

        .batch-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            margin-top: 10px;
        }

        .batch-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .batch-btn.batch-enable {
            background-color: #28a745;
            color: white;
        }

        .batch-btn.batch-disable {
            background-color: #6c757d;
            color: white;
        }

        .batch-btn.batch-delete {
            background-color: #dc3545;
            color: white;
        }

        .batch-btn.batch-email {
            background-color: #17a2b8;
            color: white;
        }

        .batch-btn:disabled {
            background-color: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
        }

        .cred-btn.email {
            background-color: #17a2b8;
            color: white;
        }

        .cred-btn.email:hover {
            background-color: #138496;
        }

        .selected-count {
            font-weight: bold;
            color: #007bff;
            margin-right: 10px;
        }

        .select-all-checkbox {
            margin-right: 8px;
            transform: scale(1.2);
        }

        /* ÈîôËØØÁ†ÅÁ≠õÈÄâÂ¢ûÂº∫ */
        .error-filter-container {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .error-code-badge {
            display: inline-block;
            background-color: #dc3545;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
            margin: 1px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .error-code-badge:hover {
            background-color: #c82333;
        }

        .error-code-badge.selected {
            background-color: #007bff;
        }

        /* ÈÖçÁΩÆÁÆ°ÁêÜÊ†∑Âºè */
        .config-group {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            transition: background-color 0.3s ease, border-color 0.3s ease;
            overflow-x: hidden;
        }

        .config-group h4 {
            margin-top: 0;
            margin-bottom: 15px;
            color: var(--text-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
        }

        .config-input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
            margin-bottom: 5px;
        }

        .config-input:focus {
            border-color: #4285f4;
            outline: none;
        }

        .config-input:disabled {
            background-color: #f5f5f5;
            color: #666;
            cursor: not-allowed;
        }

        .config-checkbox {
            margin-right: 8px;
            transform: scale(1.2);
        }

        .config-note {
            display: block;
            color: #666;
            font-size: 12px;
            margin-bottom: 10px;
            font-style: italic;
        }

        .config-info {
            background-color: #e3f2fd;
            border: 1px solid #1976d2;
            border-radius: 4px;
            padding: 12px;
            margin-top: 8px;
            font-size: 13px;
            color: #1565c0;
        }

        .config-info ul {
            margin: 8px 0 4px 0;
            color: #424242;
        }

        .config-info li {
            margin: 3px 0;
        }

        .env-locked {
            position: relative;
        }

        .env-locked::after {
            content: "üîí ÁéØÂ¢ÉÂèòÈáèÈîöÂÆö";
            position: absolute;
            right: 10px;
            top: 8px;
            transform: none;
            background-color: #ffc107;
            color: #212529;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 2;
            pointer-events: none;
        }

        /* ‰ΩøÁî®ÁªüËÆ°Ê†∑Âºè */
        .usage-card {
            background-color: #f8f9fa;
            border: 1px solid #e1e4e8;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            position: relative;
        }

        .usage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .usage-filename {
            font-family: monospace;
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .usage-progress {
            margin: 10px 0;
        }

        .usage-progress-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            font-size: 12px;
        }

        .usage-progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .usage-progress-fill {
            height: 100%;
            transition: width 0.3s ease;
        }

        .usage-progress-fill.gemini {
            background-color: #ff6b35;
        }

        .usage-progress-fill.total {
            background-color: #007bff;
        }

        .usage-progress-fill.warning {
            background-color: #ffc107;
        }

        .usage-progress-fill.danger {
            background-color: #dc3545;
        }

        .usage-actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .usage-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .usage-btn.reset {
            background-color: #6c757d;
            color: white;
        }

        .usage-btn.limits {
            background-color: #17a2b8;
            color: white;
        }

        .usage-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
            font-size: 12px;
        }

        .usage-info-item {
            background-color: var(--card-bg);
            padding: 8px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }

        .usage-info-label {
            font-weight: bold;
            color: var(--text-secondary);
            display: block;
            margin-bottom: 2px;
        }
        .table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .table thead th { background: var(--card-bg); color: var(--text-color); text-align: left; padding: 8px; border-bottom: 1px solid var(--border-color); transition: background-color 0.3s ease; }
        .table tbody td { padding: 8px; border-bottom: 1px solid var(--border-color); color: var(--text-color); transition: color 0.3s ease; }
        .table tbody tr:nth-child(odd) { background: var(--table-stripe); }
        .table tbody tr:hover { background: var(--table-hover); }
        .ranking-container { background:var(--card-bg); border:1px solid var(--border-color); border-radius:8px; padding:12px; }
        .ranking-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; font-size:14px; }
        .ranking-list { display:flex; flex-direction:column; gap:8px; max-height:300px; overflow-y:auto; }
        .ranking-item { display:flex; align-items:center; gap:12px; }
        .ranking-label { min-width:200px; font-size:12px; color:var(--text-color); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        .ranking-bar { flex:1; height:18px; background:var(--input-bg); border-radius:9px; position:relative; overflow:hidden; }
        .ranking-bar-success { position:absolute; left:0; top:0; height:100%; background:#4caf50; }
        .ranking-bar-fail { position:absolute; top:0; height:100%; background:#dc3545; }
        .ranking-count { width:60px; text-align:right; font-size:12px; color:#666; }
        .legend { display:flex; gap:12px; font-size:12px; color:#666; margin-bottom:8px; }
        .legend .success-dot { width:10px; height:10px; background:#4caf50; border-radius:50%; display:inline-block; margin-right:6px; }
        .legend .fail-dot { width:10px; height:10px; background:#dc3545; border-radius:50%; display:inline-block; margin-right:6px; }

        /* ÈÄüÁéáÈôêÂà∂Ê†∑Âºè */
        .rate-limit-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            transition: box-shadow 0.2s;
        }
        
        .rate-limit-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        [data-theme="dark"] .rate-limit-card:hover {
            box-shadow: 0 2px 8px rgba(255,255,255,0.1);
        }
        
        .rate-limit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .rate-limit-key {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            font-weight: bold;
            color: #333;
        }
        
        .rate-limit-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        
        .status-exhausted {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-unused {
            background: #e2e3e5;
            color: #383d41;
        }
        
        .rate-limit-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 12px;
        }
        
        .rate-limit-info-item {
            display: flex;
            flex-direction: column;
        }
        
        .rate-limit-info-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }
        
        .rate-limit-info-value {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }
        
        .rate-limit-progress {
            width: 100%;
            height: 24px;
            background: #f1f3f5;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            margin-bottom: 8px;
        }
        
        .rate-limit-progress-bar {
            height: 100%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        .progress-green {
            background: linear-gradient(90deg, #4caf50, #66bb6a);
        }
        
        .progress-yellow {
            background: linear-gradient(90deg, #ffc107, #ffca28);
        }
        
        .progress-red {
            background: linear-gradient(90deg, #f44336, #ef5350);
        }
        
        .rate-limit-reset {
            font-size: 12px;
            color: #666;
            text-align: center;
        }

        /* ÊìçÁªÉÂú∫ÊåâÈíÆÊ†∑Âºè - ÁÆÄÊ¥ÅÁâà */
        .playground-btn {
            padding: 8px 16px;
            font-size: 14px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            color: white;
        }
        
        /* Add button - neutral gray */
        .playground-btn-add {
            background: #6c757d;
        }
        
        .playground-btn-add:hover {
            background: #5a6268;
        }
        
        .playground-btn-add:active {
            background: #545b62;
        }
        
        /* Clear button - warning orange */
        .playground-btn-clear {
            background: #ff9800;
        }
        
        .playground-btn-clear:hover {
            background: #e68900;
        }
        
        .playground-btn-clear:active {
            background: #cc7a00;
        }
        
        /* Send button - primary blue */
        .playground-btn-send {
            background: #4285f4;
        }
        
        .playground-btn-send:hover {
            background: #3367d6;
        }
        
        .playground-btn-send:active {
            background: #2b56c4;
        }

        .usage-info-value {
            color: #333;
        }

        .reset-time {
            font-size: 11px;
            color: #666;
            font-style: italic;
            margin-top: 5px;
        }

        /* ÈôêÂà∂ËÆæÁΩÆÂºπÁ™óÊ†∑Âºè */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-overlay);
        }

        .modal-content {
            background-color: var(--container-bg);
            margin: 5% auto;
            padding: 20px;
            border-radius: 12px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 10px 40px var(--shadow-color);
            transition: background-color 0.3s ease;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .modal-title {
            margin: 0;
            font-size: 16px;
            color: #333;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #999;
        }

        .modal-close:hover {
            color: #333;
        }

        .modal-body {
            margin-bottom: 15px;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .playground-status .status {
            margin-top: 4px;
            margin-bottom: 12px;
        }

        .toggle-wrap {
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 2px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 42px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: .2s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .2s;
            border-radius: 50%;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .switch input:checked + .slider {
            background-color: #34d399;
        }

        .switch input:checked + .slider:before {
            transform: translateX(18px);
        }

        /* ÊöóÈªëÊ®°Âºè‰∏ãÁöÑÂºÄÂÖ≥ÊåâÈíÆ */
        [data-theme="dark"] .slider {
            background-color: #475569;
        }

        [data-theme="dark"] .slider:before {
            background-color: var(--container-bg);
        }

        [data-theme="dark"] .switch input:checked + .slider {
            background-color: #34d399;
        }
    </style>
</head>

<body>
    <!-- ÊöóÈªëÊ®°ÂºèÂàáÊç¢ÊåâÈíÆ -->
    <button class="theme-toggle" onclick="toggleTheme()" title="ÂàáÊç¢ÊöóÈªëÊ®°Âºè">
        <span class="icon" id="themeIcon">üåô</span>
        <span id="themeText">ÊöóÈªë</span>
    </button>

    <div class="container">

        <!-- ÁôªÂΩïÁïåÈù¢ -->
        <div id="loginSection" class="login-form">
            <h1>AMB2API ÁÆ°ÁêÜÈù¢Êùø</h1>
            <p>ËØ∑ËæìÂÖ•ËÆøÈóÆÂØÜÁ†ÅÔºö</p>
            <input type="password" id="loginPassword" placeholder="ËæìÂÖ•ÂØÜÁ†Å" onkeypress="handlePasswordEnter(event)" />
            <br>
            <button class="btn btn-sm" onclick="login()">ÁôªÂΩï</button>
            <div id="loginStatus" style="margin-top:8px"></div>
        </div>

        <!-- ‰∏ªÁïåÈù¢ -->
        <div id="mainSection" class="hidden">
            <h1>AMB2API ÁÆ°ÁêÜÈù¢Êùø</h1>

            <!-- Ê†áÁ≠æÈ°µ -->
            <div class="tabs">
                <button class="tab" onclick="switchTab('account')">Ë¥¶Êà∑ÁÆ°ÁêÜ</button>
                <button class="tab active" onclick="switchTab('config')">ÈÖçÁΩÆÁÆ°ÁêÜ</button>
                <button class="tab" onclick="switchTab('ratelimit')">ÈÄüÁéáÈôêÂà∂</button>
                <button class="tab" onclick="switchTab('usage')">‰ΩøÁî®ÁªüËÆ°</button>
                <button class="tab" onclick="switchTab('playground')">ÊìçÁªÉÂú∫</button>
                <button class="tab" onclick="switchTab('logs')">ÂÆûÊó∂Êó•Âøó</button>
            </div>


            <!-- ÊâπÈáè‰∏ä‰º†Ê†áÁ≠æÈ°µ -->
            <div id="uploadTab" class="tab-content">
                <h3>ÊâπÈáè‰∏ä‰º†ËÆ§ËØÅÊñá‰ª∂</h3>
                <p>ÊîØÊåÅ‰∏ä‰º†Â§ö‰∏™JSONÊ†ºÂºèÁöÑËÆ§ËØÅÊñá‰ª∂Âà∞ÊúçÂä°Âô®</p>

                <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                    <p>ÁÇπÂáªÈÄâÊã©Êñá‰ª∂ÊàñÊãñÊãΩÊñá‰ª∂Âà∞Ê≠§Âå∫Âüü</p>
                    <p style="color: #666; font-size: 14px;">ÊîØÊåÅ .json Âíå .zip Ê†ºÂºèÊñá‰ª∂</p>
                    <p style="color: #888; font-size: 12px;">ZIPÊñá‰ª∂‰ºöËá™Âä®Ëß£ÂéãÊèêÂèñÂÖ∂‰∏≠ÁöÑJSONÂá≠ËØÅ</p>
                </div>

                <input type="file" id="fileInput" multiple accept=".json,.zip" style="display: none;"
                    onchange="handleFileSelect(event)" />

                <div id="fileListSection" class="hidden">
                    <h4>ÈÄâÊã©ÁöÑÊñá‰ª∂Ôºö</h4>
                    <div class="file-list" id="fileList"></div>
                    <button class="btn" onclick="uploadFiles()">‰∏ä‰º†Êñá‰ª∂</button>
                    <button class="btn" style="background-color: #6c757d;" onclick="clearFiles()">Ê∏ÖÁ©∫ÂàóË°®</button>
                </div>

                <div id="uploadProgressSection" class="hidden">
                    <div class="upload-progress">
                        <h4>‰∏ä‰º†ËøõÂ∫¶Ôºö</h4>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                        </div>
                        <p id="progressText">0%</p>
                    </div>
                </div>
            </div>

            <!-- ÁéØÂ¢ÉÂèòÈáèÊ†áÁ≠æÈ°µ -->
            <div id="envloadTab" class="tab-content">
                <h3>ÁéØÂ¢ÉÂèòÈáèÂá≠ËØÅÂØºÂÖ•</h3>
                <p>‰ªéÁéØÂ¢ÉÂèòÈáèÊâπÈáèÂØºÂÖ•ËÆ§ËØÅÊñá‰ª∂ÔºåÊîØÊåÅÈÉ®ÁΩ≤Ëá™Âä®ÂåñÂú∫ÊôØ</p>

                <!-- ÁéØÂ¢ÉÂèòÈáèÁä∂ÊÄÅ‰ø°ÊÅØ -->
                <div id="envStatusSection">
                    <div class="loading" id="envStatusLoading">Ê≠£Âú®Ê£ÄÊü•ÁéØÂ¢ÉÂèòÈáèÁä∂ÊÄÅ...</div>
                    <div id="envStatusContent" class="hidden">
                        <div class="config-group">
                            <h4>ÁéØÂ¢ÉÂèòÈáèÁä∂ÊÄÅ</h4>

                            <div class="form-group">
                                <label>ÂèØÁî®ÁöÑÁéØÂ¢ÉÂèòÈáè:</label>
                                <div id="envVarsList" class="cred-content"></div>
                            </div>

                            <div class="form-group">
                                <label>Ëá™Âä®Âä†ËΩΩËÆæÁΩÆ:</label>
                                <span id="autoLoadStatus" style="font-weight: bold;"></span>
                                <small class="config-note">
                                    Ë¶ÅÂêØÁî®Ëá™Âä®Âä†ËΩΩÔºåËØ∑ËÆæÁΩÆÁéØÂ¢ÉÂèòÈáè AUTO_LOAD_ENV_CREDS=true
                                </small>
                            </div>

                            <div class="form-group">
                                <label>Â∑≤ÂØºÂÖ•ÁöÑÁéØÂ¢ÉÂèòÈáèÊñá‰ª∂:</label>
                                <span id="envFilesCount" style="font-weight: bold;"></span>
                                <div id="envFilesList" class="config-note"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Êìç‰ΩúÊåâÈíÆ -->
                <div class="manage-actions">
                    <button class="btn" onclick="checkEnvCredsStatus()">Âà∑Êñ∞Áä∂ÊÄÅ</button>
                    <button class="btn" onclick="loadEnvCredentials()">‰ªéÁéØÂ¢ÉÂèòÈáèÂØºÂÖ•</button>
                    <button class="btn" style="background-color: #dc3545;"
                        onclick="clearEnvCredentials()">Ê∏ÖÈô§ÁéØÂ¢ÉÂèòÈáèÊñá‰ª∂</button>
                </div>

                <!-- ‰ΩøÁî®ËØ¥Êòé -->
                <div class="config-group" style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 16px;">
                    <h4 style="color: var(--text-color); margin-bottom: 12px;">‰ΩøÁî®ËØ¥Êòé</h4>
                    <div class="config-info" style="color: var(--text-secondary);">
                        <strong style="color: var(--text-color);">ÁéØÂ¢ÉÂèòÈáèÊ†ºÂºèÔºö</strong>
                        <ul style="color: var(--text-secondary);">
                            <li><code style="background: var(--code-bg); color: var(--text-color); padding: 2px 6px; border-radius: 3px;">GCLI_CREDS_1</code>, <code style="background: var(--code-bg); color: var(--text-color); padding: 2px 6px; border-radius: 3px;">GCLI_CREDS_2</code>, ... (ÁºñÂè∑Ê†ºÂºè)</li>
                            <li><code style="background: var(--code-bg); color: var(--text-color); padding: 2px 6px; border-radius: 3px;">GCLI_CREDS_È°πÁõÆÂêç1</code>, <code style="background: var(--code-bg); color: var(--text-color); padding: 2px 6px; border-radius: 3px;">GCLI_CREDS_È°πÁõÆÂêç2</code>, ... (È°πÁõÆÂêçÊ†ºÂºè)</li>
                        </ul>

                        <strong style="color: var(--text-color);">ÁéØÂ¢ÉÂèòÈáèÂÄºÔºö</strong> ÂÆåÊï¥ÁöÑËÆ§ËØÅÊñá‰ª∂JSONÂÜÖÂÆπ

                        <br><br>
                        <strong style="color: var(--text-color);">Á§∫‰æãÔºö</strong>
                        <pre style="background: var(--code-bg); color: var(--text-color); padding: 10px; border-radius: 4px; font-size: 11px; border: 1px solid var(--border-color);">
export GCLI_CREDS_1='{"client_id":"your-client-id","client_secret":"your-secret","refresh_token":"your-token","token_uri":"https://oauth2.googleapis.com/token","project_id":"your-project"}'
export GCLI_CREDS_myproject='{"client_id":"...","project_id":"myproject",...}'
export AUTO_LOAD_ENV_CREDS=true  # ÂêØÁî®Á®ãÂ∫èÂêØÂä®Êó∂Ëá™Âä®ÂØºÂÖ•</pre>

                        <strong style="color: var(--text-color);">DockerÈÉ®ÁΩ≤Á§∫‰æãÔºö</strong>
                        <pre style="background: var(--code-bg); color: var(--text-color); padding: 10px; border-radius: 4px; font-size: 11px; border: 1px solid var(--border-color);">
docker run -e GCLI_CREDS_1='{"client_id":"..."}' \
           -e AUTO_LOAD_ENV_CREDS=true \
           your-image</pre>
                    </div>
                </div>
            </div>

            <!-- Êñá‰ª∂ÁÆ°ÁêÜÊ†áÁ≠æÈ°µ -->
            <div id="manageTab" class="tab-content">
                <h3>Âá≠ËØÅÊñá‰ª∂ÁÆ°ÁêÜ</h3>
                <p>ÁÆ°ÁêÜÊâÄÊúâËÆ§ËØÅÊñá‰ª∂ÔºåÊü•ÁúãÁä∂ÊÄÅÂíåÊâßË°åÊìç‰Ωú</p>

                <!-- Áä∂ÊÄÅÁªüËÆ° -->
                <div class="stats-container" id="statsContainer">
                    <div class="stat-item total">
                        <span class="stat-number" id="statTotal">0</span>
                        <span class="stat-label">ÊÄªËÆ°</span>
                    </div>
                    <div class="stat-item normal">
                        <span class="stat-number" id="statNormal">0</span>
                        <span class="stat-label">Ê≠£Â∏∏</span>
                    </div>
                    <div class="stat-item disabled">
                        <span class="stat-number" id="statDisabled">0</span>
                        <span class="stat-label">Á¶ÅÁî®</span>
                    </div>
                </div>

                <div class="manage-actions">
                    <button class="refresh-btn" onclick="refreshCredsStatus()">Âà∑Êñ∞Áä∂ÊÄÅ</button>
                    <button class="download-all-btn" onclick="downloadAllCreds()">ÊâìÂåÖ‰∏ãËΩΩÊâÄÊúâÊñá‰ª∂</button>
                </div>

                <!-- ÊâπÈáèÊìç‰ΩúÊéß‰ª∂ -->
                <div class="batch-controls">
                    <h4 style="margin-top: 0; margin-bottom: 10px;">ÊâπÈáèÊìç‰Ωú</h4>
                    <div class="batch-actions">
                        <div class="checkbox-container">
                            <input type="checkbox" id="selectAllCheckbox" class="select-all-checkbox"
                                onchange="toggleSelectAll()">
                            <label for="selectAllCheckbox">ÂÖ®ÈÄâ</label>
                        </div>
                        <span class="selected-count" id="selectedCount">Â∑≤ÈÄâÊã© 0 È°π</span>
                        <button class="batch-btn batch-enable" id="batchEnableBtn" onclick="batchAction('enable')"
                            disabled>ÊâπÈáèÂêØÁî®</button>
                        <button class="batch-btn batch-disable" id="batchDisableBtn" onclick="batchAction('disable')"
                            disabled>ÊâπÈáèÁ¶ÅÁî®</button>
                        <button class="batch-btn batch-delete" id="batchDeleteBtn" onclick="batchAction('delete')"
                            disabled>ÊâπÈáèÂà†Èô§</button>
                        <button class="batch-btn batch-email" onclick="refreshAllEmails()">Âà∑Êñ∞ÊâÄÊúâÈÇÆÁÆ±</button>
                    </div>
                </div>

                <!-- Á≠õÈÄâÂíåÂàÜÈ°µÊéß‰ª∂ -->
                <div class="filter-container">
                    <label for="statusFilter">Áä∂ÊÄÅÁ≠õÈÄâÔºö</label>
                    <select id="statusFilter" class="filter-select" onchange="applyFilters()">
                        <option value="all">ÂÖ®ÈÉ®</option>
                        <option value="normal">Ê≠£Â∏∏</option>
                        <option value="disabled">Á¶ÅÁî®</option>
                    </select>

                    <label for="errorCodeFilter">ÈîôËØØÁ†ÅÁ≠õÈÄâÔºö</label>
                    <select id="errorCodeFilter" class="filter-select" onchange="applyFilters()">
                        <option value="all">ÂÖ®ÈÉ®ÈîôËØØÁ†Å</option>
                        <option value="no-errors">Êó†ÈîôËØØ</option>
                        <option value="has-errors">ÊúâÈîôËØØ</option>
                        <option value="400">ÈîôËØØÁ†Å 400</option>
                        <option value="401">ÈîôËØØÁ†Å 401</option>
                        <option value="403">ÈîôËØØÁ†Å 403</option>
                        <option value="404">ÈîôËØØÁ†Å 404</option>
                        <option value="429">ÈîôËØØÁ†Å 429</option>
                        <option value="500">ÈîôËØØÁ†Å 500</option>
                    </select>

                    <label for="pageSizeSelect">ÊØèÈ°µÊòæÁ§∫Ôºö</label>
                    <select id="pageSizeSelect" class="page-size-select" onchange="changePageSize()">
                        <option value="20">20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>

                    <div class="error-filter-container" id="errorFilterContainer">
                        <span>Âø´ÈÄüÁ≠õÈÄâÈîôËØØÁ†ÅÔºö</span>
                        <div id="errorCodeBadges"></div>
                    </div>
                </div>

                <div id="credsListSection">
                    <div class="loading" id="credsLoading">Ê≠£Âú®Âä†ËΩΩÂá≠ËØÅÊñá‰ª∂...</div>
                    <div id="credsList"></div>

                    <!-- ÂàÜÈ°µÊéß‰ª∂ -->
                    <div class="pagination-container" id="paginationContainer" style="display: none;">
                        <button class="pagination-btn" id="prevPageBtn" onclick="changePage(-1)">‰∏ä‰∏ÄÈ°µ</button>
                        <div class="pagination-info" id="paginationInfo">Á¨¨ 1 È°µÔºåÂÖ± 1 È°µ</div>
                        <button class="pagination-btn" id="nextPageBtn" onclick="changePage(1)">‰∏ã‰∏ÄÈ°µ</button>
                    </div>
                </div>
            </div>

            <!-- Â§öÂØÜÈí•ÁÆ°ÁêÜÂºπÁ™ó -->
            <div class="modal" id="keyManagementModal">
                <div class="modal-content" style="width: 900px; max-width: 95%; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
                    <div class="modal-header" style="border-bottom: 1px solid var(--border-color, #e1e4e8); padding-bottom: 12px;">
                        <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                            <h4 class="modal-title" style="margin: 0; display: flex; align-items: center; gap: 8px;">
                                Â§öÂØÜÈí•ÁÆ°ÁêÜ
                                <span style="background: linear-gradient(135deg, #ff6b6b, #ee5a5a); color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px;">‚õ©Ô∏è OpenAI</span>
                            </h4>
                            <span class="key-stat-badge" style="background: var(--card-bg, #f0f0f0); padding: 4px 10px; border-radius: 12px; font-size: 12px;">ÊÄªÂØÜÈí•Êï∞: <span id="modalKeyTotal">0</span></span>
                            <span class="key-stat-badge" style="background: var(--card-bg, #f0f0f0); padding: 4px 10px; border-radius: 12px; font-size: 12px;"><span id="modalAggregationMode">ËΩÆËØ¢Ê®°Âºè</span></span>
                        </div>
                        <button class="modal-close" onclick="closeKeyManagementModal()" style="font-size: 24px; background: none; border: none; cursor: pointer;">&times;</button>
                    </div>
                    
                    <!-- ÁªüËÆ°Âç°Áâá -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; padding: 20px 0; border-bottom: 1px solid var(--border-color, #e1e4e8);">
                        <div class="key-stat-card" style="background: var(--card-bg, #f8f9fa); border-radius: 12px; padding: 15px;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <span style="width: 8px; height: 8px; background: #28a745; border-radius: 50%;"></span>
                                <span style="color: var(--text-secondary, #666); font-size: 13px;">Â∑≤ÂêØÁî®</span>
                            </div>
                            <div style="font-size: 24px; font-weight: bold; color: #28a745;"><span id="modalKeyEnabled">0</span> / <span id="modalKeyTotal2">0</span></div>
                            <div class="progress-bar" style="height: 4px; margin-top: 8px; background: #e9ecef; border-radius: 2px;">
                                <div id="enabledProgressBar" style="height: 100%; background: #28a745; border-radius: 2px; width: 0%; transition: width 0.3s;"></div>
                            </div>
                        </div>
                        <div class="key-stat-card" style="background: var(--card-bg, #f8f9fa); border-radius: 12px; padding: 15px;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <span style="width: 8px; height: 8px; background: #dc3545; border-radius: 50%;"></span>
                                <span style="color: var(--text-secondary, #666); font-size: 13px;">ÊâãÂä®Á¶ÅÁî®</span>
                            </div>
                            <div style="font-size: 24px; font-weight: bold; color: #dc3545;"><span id="modalKeyManualDisabled">0</span> / <span id="modalKeyTotal3">0</span></div>
                            <div class="progress-bar" style="height: 4px; margin-top: 8px; background: #e9ecef; border-radius: 2px;">
                                <div id="manualDisabledProgressBar" style="height: 100%; background: #dc3545; border-radius: 2px; width: 0%; transition: width 0.3s;"></div>
                            </div>
                        </div>
                        <div class="key-stat-card" style="background: var(--card-bg, #f8f9fa); border-radius: 12px; padding: 15px;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <span style="width: 8px; height: 8px; background: #ffc107; border-radius: 50%;"></span>
                                <span style="color: var(--text-secondary, #666); font-size: 13px;">Ëá™Âä®Á¶ÅÁî®</span>
                            </div>
                            <div style="font-size: 24px; font-weight: bold; color: #ffc107;"><span id="modalKeyAutoDisabled">0</span> / <span id="modalKeyTotal4">0</span></div>
                            <div class="progress-bar" style="height: 4px; margin-top: 8px; background: #e9ecef; border-radius: 2px;">
                                <div id="autoDisabledProgressBar" style="height: 100%; background: #ffc107; border-radius: 2px; width: 0%; transition: width 0.3s;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Â∑•ÂÖ∑Ê†è -->
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 0; flex-wrap: wrap; gap: 10px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <select id="modalKeyStatusFilter" class="filter-select" onchange="loadKeyManagementModal()" style="padding: 6px 12px; border-radius: 6px;">
                                <option value="all">ÂÖ®ÈÉ®Áä∂ÊÄÅ</option>
                                <option value="enabled">Â∑≤ÂêØÁî®</option>
                                <option value="disabled">Â∑≤Á¶ÅÁî®</option>
                                <option value="invalid">Â§±ÊïàÂØÜÈí•</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button class="btn btn-sm" onclick="loadKeyManagementModal()" style="background: #f0f0f0; color: #333; border: none;">Âà∑Êñ∞</button>
                            <button class="btn btn-sm" onclick="enableAllKeys()" style="background: transparent; color: #4285f4; border: 1px solid #4285f4;">ÂêØÁî®ÂÖ®ÈÉ®</button>
                            <button class="btn btn-sm" onclick="disableAllKeys()" style="background: transparent; color: #dc3545; border: 1px solid #dc3545;">Á¶ÅÁî®ÂÖ®ÈÉ®</button>
                            <button class="btn btn-sm" onclick="deleteAutoDisabledKeys()" style="background: transparent; color: #ffc107; border: 1px solid #ffc107;">Âà†Èô§Ëá™Âä®Á¶ÅÁî®ÂØÜÈí•</button>
                            <button class="btn btn-sm" onclick="cleanupKeyStats()" style="background: transparent; color: #17a2b8; border: 1px solid #17a2b8;">üßπ Ê∏ÖÁêÜËøáÊúüÁªüËÆ°</button>
                        </div>
                    </div>
                    
                    <!-- ÂØÜÈí•Ë°®Ê†º -->
                    <div style="flex: 1; overflow-y: auto;">
                        <table class="table" style="width: 100%;">
                            <thead style="position: sticky; top: 0; background: var(--container-bg, white); z-index: 1;">
                                <tr>
                                    <th style="width: 60px;">Á¥¢Âºï</th>
                                    <th style="min-width: 300px;">ÂØÜÈí•</th>
                                    <th style="width: 80px;">Áä∂ÊÄÅ</th>
                                    <th>Á¶ÅÁî®ÂéüÂõ†</th>
                                    <th>Á¶ÅÁî®Êó∂Èó¥</th>
                                    <th style="width: 80px; text-align: right;">Êìç‰Ωú</th>
                                </tr>
                            </thead>
                            <tbody id="keyManagementTableBody">
                                <tr><td colspan="6" style="text-align: center; padding: 40px;">Âä†ËΩΩ‰∏≠...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- ÂàÜÈ°µ -->
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-top: 1px solid var(--border-color, #e1e4e8); flex-wrap: wrap; gap: 10px;">
                        <span style="color: var(--text-secondary, #666); font-size: 13px;">ÊòæÁ§∫Á¨¨ <span id="keyPageStart">1</span> Êù°-Á¨¨ <span id="keyPageEnd">10</span> Êù°ÔºåÂÖ± <span id="keyPageTotal">0</span> Êù°</span>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <button class="pagination-btn" id="keyPrevPage" onclick="changeKeyPage(-1)">&lt;</button>
                            <span id="keyCurrentPage" style="padding: 6px 12px; background: #4285f4; color: white; border-radius: 4px;">1</span>
                            <button class="pagination-btn" id="keyNextPage" onclick="changeKeyPage(1)">&gt;</button>
                            <span style="margin-left: 10px;">ÊØèÈ°µÊù°Êï∞:</span>
                            <select id="keyPageSize" class="filter-select" onchange="loadKeyManagementModal()" style="padding: 4px 8px;">
                                <option value="10">10</option>
                                <option value="20">20</option>
                                <option value="50">50</option>
                            </select>
                            <span style="margin-left: 10px;">Ë∑≥Ëá≥</span>
                            <input type="number" id="keyJumpPage" style="width: 50px; padding: 4px; border: 1px solid #ddd; border-radius: 4px;" min="1" onchange="jumpToKeyPage()">
                            <span>È°µ</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ÈÄüÁéáÈôêÂà∂Ê†áÁ≠æÈ°µ -->
            <div id="ratelimitTab" class="tab-content">
                <h3>API Key ÈÄüÁéáÈôêÂà∂ÁõëÊéß</h3>
                <p>ÂÆûÊó∂ÁõëÊéßÊØè‰∏™ API Key ÁöÑÈÄüÁéáÈôêÂà∂Áä∂ÊÄÅÂíåÈÖçÈ¢ù‰ΩøÁî®ÊÉÖÂÜµ</p>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-sm" onclick="loadRateLimits()">üîÑ Âà∑Êñ∞Êï∞ÊçÆ</button>
                    <label style="display: inline-block; margin-left: 20px;">
                        <input type="checkbox" id="autoRefreshRateLimit" onchange="toggleAutoRefresh()" checked>
                        Ëá™Âä®Âà∑Êñ∞ÔºàÊØè5ÁßíÔºâ
                    </label>
                </div>
                
                <div id="rateLimitStatus"></div>
                
                <div id="rateLimitSection">
                    <div class="loading" id="rateLimitLoading">Ê≠£Âú®Âä†ËΩΩÈÄüÁéáÈôêÂà∂‰ø°ÊÅØ...</div>
                    <div id="rateLimitList"></div>
                </div>
            </div>

            <!-- ‰ΩøÁî®ÁªüËÆ°Ê†áÁ≠æÈ°µ -->
            <div id="usageTab" class="tab-content">
                <h3>‰ΩøÁî®ÁªüËÆ°</h3>
                <div id="usageStatus"></div>
                <p>Êü•ÁúãÊØè‰∏™Âá≠ËØÅÊñá‰ª∂ÁöÑAPIË∞ÉÁî®ÁªüËÆ°ÂíåÈÖçÈ¢ù‰ΩøÁî®ÊÉÖÂÜµ</p>

                <!-- ÁªüËÆ°Ê¶ÇËßà -->
                <div class="stats-container" id="usageStatsContainer">
                    <div class="stat-item total">
                        <span class="stat-number" id="totalApiCalls">0</span>
                        <span class="stat-label">ÊÄªË∞ÉÁî®Êï∞</span>
                    </div>
                    <div class="stat-item disabled">
                        <span class="stat-number" id="totalFiles">0</span>
                        <span class="stat-label">Ê¥ªË∑ÉÂØÜÈí•Êï∞</span>
                    </div>
                </div>

                <div class="manage-actions">
                    <button class="refresh-btn" onclick="refreshUsageStats()">Âà∑Êñ∞ÁªüËÆ°</button>
                    <button class="btn" onclick="checkInvalidKeys()" style="background:#6c757d">Ê£ÄÊü•Â§±ÊïàÂØÜÈí•</button>
                    <button class="btn" onclick="deleteInvalidKeys()" style="background:#dc3545">ÁßªÈô§Â§±ÊïàÂØÜÈí•Êï∞ÊçÆ</button>
                </div>

                <div class="config-group">
                    <h4>Êó•ÂøóÁªüËÆ°ÔºàÊåâÊ®°Âûã/ÊåâÂØÜÈí•Ôºâ</h4>
                    <div class="form-group" style="display:flex; gap:10px; flex-wrap:wrap">
                        <select id="modelFilter" class="config-input" style="max-width:260px" onchange="refreshLogSummary()"></select>
                        <select id="keyFilter" class="config-input" style="max-width:260px" onchange="refreshLogSummary()"></select>
                        <select id="onlyFilter" class="config-input" style="max-width:180px" onchange="refreshLogSummary()">
                            <option value="">ÂÖ®ÈÉ®</option>
                            <option value="success">‰ªÖÊàêÂäü</option>
                            <option value="fail">‰ªÖÂ§±Ë¥•</option>
                        </select>
                        <button class="btn" onclick="refreshLogSummary()">Âà∑Êñ∞</button>
                    </div>
                    <div id="logSummaryModels"></div>
                    <div id="logSummaryKeys" style="margin-top:12px"></div>
                    <div id="modelRanking" class="ranking-container" style="margin-top:12px"></div>
                </div>

                <!-- Êñá‰ª∂‰ΩøÁî®ÁªüËÆ°ÂàóË°® -->
                <div id="usageListSection">
                    <div class="loading" id="usageLoading">Ê≠£Âú®Âä†ËΩΩ‰ΩøÁî®ÁªüËÆ°...</div>
                    <div id="usageList"></div>
                </div>

                <!-- ‰ΩøÁî®ËØ¥Êòé -->
                <div class="config-group" style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 16px;">
                    <h4 style="color: var(--text-color); margin-bottom: 12px;">‰ΩøÁî®ËØ¥Êòé</h4>
                    <div class="config-info" style="color: var(--text-secondary);">
                        <strong style="color: var(--text-color);">ÁªüËÆ°ËåÉÂõ¥Ôºö</strong>
                        <ul style="color: var(--text-secondary);">
                            <li><strong style="color: var(--text-color);">ÊâÄÊúâÊ®°ÂûãË∞ÉÁî®Ê¨°Êï∞Ôºö</strong>ÁªüËÆ°ÊâÄÊúâÊ®°ÂûãÁöÑÊàêÂäüË∞ÉÁî®ÊÄªÊï∞</li>
                            <li><strong style="color: var(--text-color);">ÈÖçÈ¢ùÈáçÁΩÆÔºö</strong>ÊØèÂ§© UTC 07:00 Ëá™Âä®ÈáçÁΩÆË∞ÉÁî®ËÆ°Êï∞</li>
                        </ul>

                        <strong style="color: var(--text-color);">Ê≥®ÊÑèÔºö</strong>
                        <ul style="color: var(--text-secondary);">
                            <li>Âè™ÁªüËÆ°ËøîÂõûÊ≠£Â∏∏ÂìçÂ∫îÁöÑAPIË∞ÉÁî®ÔºåÊä•ÈîôÁöÑË∞ÉÁî®‰∏çËÆ°ÂÖ•ÁªüËÆ°</li>
                            <li>ÁªüËÆ°Êï∞ÊçÆÊåÅ‰πÖÂåñ‰øùÂ≠òÂú® creds_state.toml Êñá‰ª∂‰∏≠</li>
                            <li>ÊîØÊåÅÊØè‰∏™Âá≠ËØÅÊñá‰ª∂Áã¨Á´ãÁªüËÆ°ÂíåÈÖçÈ¢ùÁÆ°ÁêÜ</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- ÈÖçÁΩÆÁÆ°ÁêÜÊ†áÁ≠æÈ°µ -->
            <div id="configTab" class="tab-content active">
                <h3>ÈÖçÁΩÆÁÆ°ÁêÜ</h3>
                <div id="configStatus"></div>
                <!-- <p>ÁÆ°ÁêÜÁ≥ªÁªüÈÖçÁΩÆÂèÇÊï∞Ôºå‰øÆÊîπÂêéÁ´ãÂç≥ÁîüÊïà</p> -->

                <div id="configMetaBar" style="margin:6px 0 12px 0; display:flex; gap:8px; align-items:center; flex-wrap:wrap"></div>

                <div id="configSection">
                    <div class="loading" id="configLoading">Ê≠£Âú®Âä†ËΩΩÈÖçÁΩÆ...</div>
                    <div id="configForm" class="hidden">
                        <div class="config-group">
                            <h4>ÂØÜÈí•ÈÖçÁΩÆ</h4>
                            <div class="form-group">
                                <label for="assemblyApiKeys">ÂØÜÈí•</label>
                                <textarea id="assemblyApiKeys" class="config-input" placeholder="ËØ∑ËæìÂÖ•ÂØÜÈí•Ôºå‰∏ÄË°å‰∏Ä‰∏™" style="min-height: 100px; border: 2px solid #4285f4; border-radius: 8px;"></textarea>
                                <div style="display: flex; align-items: center; gap: 15px; margin-top: 8px; flex-wrap: wrap;">
                                    <small class="config-note" style="color: #4285f4; margin: 0;">ËøΩÂä†Ê®°ÂºèÔºöÊñ∞ÂØÜÈí•Â∞ÜÊ∑ªÂä†Âà∞Áé∞ÊúâÂØÜÈí•ÂàóË°®ÁöÑÊú´Â∞æ</small>
                                    <button class="btn btn-sm" onclick="showKeyManagementModal()" style="background: transparent; color: #4285f4; border: 1px solid #4285f4; padding: 4px 12px;">Êü•ÁúãÂØÜÈí•</button>
                                    <label style="display: flex; align-items: center; gap: 5px; margin: 0;">
                                        <input type="checkbox" id="keyAggregationEnabled" class="config-checkbox" checked /> ÂØÜÈí•ËÅöÂêàÊ®°Âºè
                                    </label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="keyUpdateMode">ÂØÜÈí•Êõ¥Êñ∞Ê®°Âºè</label>
                                <select id="keyUpdateMode" class="config-input" style="background: #f5f5f5;">
                                    <option value="append">ËøΩÂä†Ê®°ÂºèÔºöÂ∞ÜÊñ∞ÂØÜÈí•Ê∑ªÂä†Âà∞Áé∞ÊúâÂØÜÈí•ÂàóË°®Êú´Â∞æ</option>
                                    <option value="override">Ë¶ÜÁõñÊ®°ÂºèÔºöÁî®Êñ∞ÂØÜÈí•ÊõøÊç¢ÊâÄÊúâÁé∞ÊúâÂØÜÈí•</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="keyAggregationMode">ÂØÜÈí•ËÅöÂêàÊ®°Âºè</label>
                                <select id="keyAggregationMode" class="config-input" style="background: #f5f5f5;">
                                    <option value="round_robin">ËΩÆËØ¢</option>
                                    <option value="random">ÈöèÊú∫</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="useAssembly" class="config-checkbox" /> ‰ΩøÁî® AssemblyAI ‰Ωú‰∏∫‰∏äÊ∏∏
                                </label>
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="overrideEnv" class="config-checkbox" /> Èù¢Êùø‰ºòÂÖàÔºàÂøΩÁï•ÁéØÂ¢ÉÂèòÈáèÔºâ
                                </label>
                                <small class="config-note">ÂêØÁî®ÂêéÔºåÈù¢Êùø‰øùÂ≠òÁöÑÂÄºÂ∞ÜË¶ÜÁõñÁéØÂ¢ÉÂèòÈáèÁöÑ‰ºòÂÖàÁ∫ß</small>
                            </div>

                            <div class="manage-actions">
                                <button class="refresh-btn btn-sm" onclick="loadConfig()">Âà∑Êñ∞ÈÖçÁΩÆ</button>
                                <button class="btn btn-sm" style="background:#dc3545" onclick="saveConfig()">‰øùÂ≠òÈÖçÁΩÆ</button>
                            </div>
                        </div>
                        <div class="config-group">
                            <h4>Ê®°ÂûãÈÖçÁΩÆ</h4>
                            <div class="form-group">
                                <div id="selectedModelsChips" style="min-height:36px; display:flex; gap:6px; flex-wrap:wrap; margin-bottom:8px"></div>
                                <div class="manage-actions">
                                    <button class="btn btn-sm" onclick="queryModels()">Ëé∑ÂèñÊ®°ÂûãÂàóË°®</button>
                                    <button class="btn btn-sm" style="background:#ffc107" onclick="fillAllModels()">Â°´ÂÖ•ÊâÄÊúâÊ®°Âûã</button>
                                    <button class="btn btn-sm" style="background:#6c757d" onclick="clearSelectedModels()">Ê∏ÖÈô§ÊâÄÊúâÊ®°Âûã</button>
                                    <button class="btn btn-sm" onclick="saveSelectedModels()">‰øùÂ≠òÊâÄÈÄâÊ®°Âûã</button>
                                </div>
                            </div>
                            <small class="config-note">Êü•ËØ¢ÂêéÊåâ‰æõÂ∫îÂïÜÂàÜÁªÑÂ±ïÁ§∫Ê®°ÂûãÔºåÂãæÈÄâÂπ∂‰øùÂ≠òÂç≥ÂèØÁî®‰∫éÊé•Âè£ÂàóË°®‰∏éÊìçÁªÉÂú∫</small>
                        </div>
                        <div class="config-group">
                            <h4>ÊúçÂä°Âô®ÈÖçÁΩÆ</h4>

                            <div class="form-group">
                                <label for="host">ÊúçÂä°Âô®‰∏ªÊú∫Âú∞ÂùÄ:</label>
                                <input type="text" id="host" class="config-input"
                                    placeholder="‰æãÂ¶Ç: 0.0.0.0, 127.0.0.1" />
                                <small class="config-note">ÊúçÂä°Âô®ÁõëÂê¨ÁöÑ‰∏ªÊú∫Âú∞ÂùÄÔºå0.0.0.0Ë°®Á§∫ÁõëÂê¨ÊâÄÊúâÊé•Âè£</small>
                            </div>

                            <div class="form-group">
                                <label for="port">ÊúçÂä°Âô®Á´ØÂè£:</label>
                                <input type="number" id="port" class="config-input" min="1" max="65535"
                                    placeholder="7861" />
                                <small class="config-note">ÊúçÂä°Âô®ÁõëÂê¨ÁöÑÁ´ØÂè£Âè∑Ôºå‰øÆÊîπÂêéÈúÄË¶ÅÈáçÂêØÊúçÂä°Âô®</small>
                            </div>

                            <div class="form-group">
                                <label for="configApiPassword">APIËÆøÈóÆÂØÜÁ†Å:</label>
                                <input type="text" id="configApiPassword" class="config-input" placeholder="pwd" />
                                <small class="config-note">ËÅäÂ§©APIËÆøÈóÆÂØÜÁ†ÅÔºåÁî®‰∫éOpenAIÂíåGemini APIÁ´ØÁÇπÁöÑËÆ§ËØÅ</small>
                            </div>

                            <div class="form-group">
                                <label for="configPanelPassword">ÊéßÂà∂Èù¢ÊùøÂØÜÁ†Å:</label>
                                <input type="text" id="configPanelPassword" class="config-input" placeholder="pwd" />
                                <small class="config-note">ÊéßÂà∂Èù¢ÊùøËÆøÈóÆÂØÜÁ†ÅÔºåÁî®‰∫éwebÁïåÈù¢ÁôªÂΩïËÆ§ËØÅ</small>
                            </div>

                            <div class="form-group">
                                <label for="configPassword">ÈÄöÁî®ÂØÜÁ†Å:</label>
                                <input type="text" id="configPassword" class="config-input" placeholder="pwd" />
                                <small class="config-note">ÔºàÂÖºÂÆπÊÄß‰øùÁïôÔºâËÆæÁΩÆÂêéÂ∞ÜË¶ÜÁõñ‰∏äËø∞‰∏§‰∏™ÂØÜÁ†ÅÔºåÁïôÁ©∫Âàô‰ΩøÁî®ÂàÜÂºÄÁöÑÂØÜÁ†ÅËÆæÁΩÆ</small>
                            </div>
                        </div>

                        <div class="config-group">
                            <h4>Âü∫Á°ÄÈÖçÁΩÆ</h4>

                            <div class="form-group">
                                <label for="credentialsDir">Âá≠ËØÅÁõÆÂΩïË∑ØÂæÑ:</label>
                                <input type="text" id="credentialsDir" class="config-input" />
                                <small class="config-note">Â≠òÂÇ®ËÆ§ËØÅÊñá‰ª∂ÁöÑÁõÆÂΩïË∑ØÂæÑ</small>
                            </div>

                            <div class="form-group">
                                <label for="proxy">‰ª£ÁêÜËÆæÁΩÆ:</label>
                                <input type="text" id="proxy" class="config-input"
                                    placeholder="‰æãÂ¶Ç: http://proxy:8080 Êàñ socks5://proxy:1080" />
                                <small class="config-note">HTTP/HTTPS/SOCKS5EndpointÔºåÁïôÁ©∫Ë°®Á§∫‰∏ç‰ΩøÁî®‰ª£ÁêÜ</small>
                            </div>
                        </div>

                        <div class="config-group">
                            <h4>Ëá™Âä®Â∞ÅÁ¶ÅÈÖçÁΩÆ</h4>

                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="autoBanEnabled" class="config-checkbox" />
                                    ÂêØÁî®Ëá™Âä®Â∞ÅÁ¶Å
                                </label>
                                <small class="config-note">ÈÅáÂà∞ÊåáÂÆöÈîôËØØÁ†ÅÊó∂Ëá™Âä®Á¶ÅÁî®Âá≠ËØÅ</small>
                            </div>

                            <div class="form-group">
                                <label for="autoBanErrorCodes">Ëá™Âä®Â∞ÅÁ¶ÅÈîôËØØÁ†Å:</label>
                                <input type="text" id="autoBanErrorCodes" class="config-input"
                                    placeholder="‰æãÂ¶Ç: 400,403" />
                                <small class="config-note">Áî®ÈÄóÂè∑ÂàÜÈöîÁöÑÈîôËØØÁ†ÅÂàóË°®</small>
                            </div>
                        </div>

                        <div class="config-group">
                            <h4>ÊÄßËÉΩÈÖçÁΩÆ</h4>

                            <div class="form-group">
                                <label for="callsPerRotation">Âá≠ËØÅËΩÆÊç¢Ë∞ÉÁî®Ê¨°Êï∞:</label>
                                <input type="number" id="callsPerRotation" class="config-input" min="1" max="100" />
                                <small class="config-note">ÊØè‰∏™Âá≠ËØÅ‰ΩøÁî®Â§öÂ∞ëÊ¨°ÂêéËΩÆÊç¢Âà∞‰∏ã‰∏Ä‰∏™</small>
                            </div>

                        </div>

                        <div class="config-group">
                            <h4>429ÈáçËØïÈÖçÁΩÆ</h4>

                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="retry429Enabled" class="config-checkbox" />
                                    ÂêØÁî®429ÈáçËØï
                                </label>
                                <small class="config-note">ÈÅáÂà∞429ÈîôËØØÊó∂Ëá™Âä®ÈáçËØï</small>
                            </div>

                            <div class="form-group">
                                <label for="retry429MaxRetries">429ÈáçËØïÊ¨°Êï∞:</label>
                                <input type="number" id="retry429MaxRetries" class="config-input" min="1" max="50" />
                                <small class="config-note">ÈÅáÂà∞429ÈîôËØØÊó∂ÁöÑÊúÄÂ§ßÈáçËØïÊ¨°Êï∞</small>
                            </div>

                            <div class="form-group">
                                <label for="retry429Interval">429ÈáçËØïÈó¥Èöî(Áßí):</label>
                                <input type="number" id="retry429Interval" class="config-input" min="0.01" max="10"
                                    step="0.01" />
                                <small class="config-note">ÈÅáÂà∞429ÈîôËØØÊó∂ÊØè‰∏§Ê¨°ÈáçËØïÈó¥ÁöÑÁ≠âÂæÖÊó∂Èó¥</small>
                            </div>
                        </div>

                        <div class="config-group">
                            <h4>ÂÖ®ÈÉ®ÈÖçÁΩÆÔºàÂè™ËØªÔºâ</h4>
                            <div class="manage-actions">
                                <button class="refresh-btn btn-sm" onclick="refreshAllConfig()">Âà∑Êñ∞ÂÖ®ÈÉ®ÈÖçÁΩÆ</button>
                            </div>
                            <div id="allConfigMeta" class="usage-info"></div>
                            <div class="form-group">
                                <table class="table" id="allConfigTable"></table>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>

            <!-- ÂÆûÊó∂Êó•ÂøóÊ†áÁ≠æÈ°µ -->
            <div id="logsTab" class="tab-content">
                <h3>ÂÆûÊó∂Êó•Âøó</h3>
                <p>Êü•ÁúãÁ≥ªÁªüÂÆûÊó∂Êó•ÂøóËæìÂá∫ÔºåÊîØÊåÅÊó•ÂøóÁ≠õÈÄâÂíåËá™Âä®ÊªöÂä®</p>
                <div id="logsStatus"></div>

                <div class="manage-actions">
                    <button class="refresh-btn" onclick="connectWebSocket()">ËøûÊé•Êó•ÂøóÊµÅ</button>
                    <button class="btn" style="background-color: #dc3545;" onclick="disconnectWebSocket()">Êñ≠ÂºÄËøûÊé•</button>
                    <button class="btn" style="background-color: #28a745;" onclick="downloadLogs()">‰∏ãËΩΩÊó•Âøó</button>
                    <button class="btn" style="background-color: #6c757d;" onclick="clearLogs()">Ê∏ÖÁ©∫Êó•Âøó</button>
                </div>

                <div class="filter-container">
                    <label for="logLevelFilter">Êó•ÂøóÁ∫ßÂà´Á≠õÈÄâÔºö</label>
                    <select id="logLevelFilter" class="filter-select" onchange="filterLogs()">
                        <option value="all">ÂÖ®ÈÉ®</option>
                        <option value="ERROR">ÈîôËØØ</option>
                        <option value="WARNING">Ë≠¶Âëä</option>
                        <option value="INFO">‰ø°ÊÅØ</option>
                        <option value="DEBUG">Ë∞ÉËØï</option>
                    </select>

                    <label>
                        <input type="checkbox" id="autoScroll" checked> Ëá™Âä®ÊªöÂä®Âà∞Â∫ïÈÉ®
                    </label>
                </div>

                <div id="logConnectionStatus" class="status info">
                    <strong>ËøûÊé•Áä∂ÊÄÅÔºö</strong> <span id="connectionStatusText">Êú™ËøûÊé•</span>
                </div>

                <div id="logContainer"
                    style="background-color: #1e1e1e; color: #ffffff; font-family: 'Courier New', monospace; font-size: 12px; height: 600px; overflow-y: auto; border: 1px solid #333; border-radius: 5px; padding: 15px; white-space: pre-wrap; word-break: break-all;">
                    <div id="logContent">Á≠âÂæÖËøûÊé•Êó•ÂøóÊµÅ...</div>
                </div>
            </div>

            <!-- ÊìçÁªÉÂú∫Ê†áÁ≠æÈ°µ -->
            <div id="playgroundTab" class="tab-content">
                <h3>ÊìçÁªÉÂú∫</h3>
                <div id="playgroundStatus" class="playground-status"></div>
                
                <!-- ÂèÇÊï∞ÈÖçÁΩÆÂå∫Âüü -->
                <div class="config-group">
                    <div class="form-group">
                        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:16px; margin-bottom:16px">
                            <div>
                                <label for="playgroundModel">Ê®°Âûã</label>
                                <select id="playgroundModel" class="config-input" style="width:100%" onchange="updateMaxTokensLimit(this.value); updateRequestPreview();"></select>
                            </div>
                            <div>
                                <label for="playgroundApiKey">API KeyÔºàÂèØÈÄâÔºâ</label>
                                <select id="playgroundApiKey" class="config-input" style="width:100%" onchange="updateRequestPreview()">
                                    <option value="">Ëá™Âä®ÈÄâÊã©ÔºàÈªòËÆ§Ôºâ</option>
                                </select>
                                <small class="config-note">ÁïôÁ©∫Âàô‰ΩøÁî®Á≥ªÁªüËá™Âä®ËΩÆÊç¢</small>
                            </div>
                        </div>
                        
                        <!-- Temperature ÊªëÂùó -->
                        <div style="margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <label for="playgroundTemperature" style="color: var(--text-secondary); font-size: 14px;">Temperature ‚ìò</label>
                                <input type="number" id="playgroundTemperatureValue" class="config-input" step="0.1" min="0" max="2" value="0.5" style="width: 80px; padding: 6px; text-align: center; border-radius: 8px;" onchange="updateTemperatureSlider(this.value)" />
                            </div>
                            <input type="range" id="playgroundTemperature" min="0" max="2" step="0.1" value="0.5" style="width: 100%; height: 6px; border-radius: 3px; background: linear-gradient(to right, #4285f4 0%, #4285f4 25%, #e0e0e0 25%, #e0e0e0 100%); outline: none; -webkit-appearance: none;" oninput="updateTemperatureValue(this.value)" />
                        </div>

                        <!-- Max Tokens ÊªëÂùó -->
                        <div style="margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <label for="playgroundMaxTokens" style="color: var(--text-secondary); font-size: 14px;">Max Tokens ‚ìò</label>
                                <input type="number" id="playgroundMaxTokensValue" class="config-input" min="1" max="128000" value="4096" style="width: 100px; padding: 6px; text-align: center; border-radius: 8px;" onchange="updateMaxTokensSlider(this.value)" />
                            </div>
                            <input type="range" id="playgroundMaxTokens" min="1" max="128000" step="1" value="4096" style="width: 100%; height: 6px; border-radius: 3px; background: linear-gradient(to right, #4285f4 0%, #4285f4 3%, #e0e0e0 3%, #e0e0e0 100%); outline: none; -webkit-appearance: none;" oninput="updateMaxTokensValue(this.value)" />
                        </div>

                        <!-- Stream ÂºÄÂÖ≥ -->
                        <div class="toggle-wrap" style="margin-bottom: 20px;">
                            <span>stream</span>
                            <label class="switch">
                                <input type="checkbox" id="playgroundStream" onchange="updateRequestPreview()" />
                                <span class="slider"></span>
                            </label>
                        </div>
                        
                        <!-- Êìç‰ΩúÊåâÈíÆ - ‰∏ÄÊéíÂ±Ö‰∏≠ -->
                        <div style="display:flex; gap:8px; justify-content:center; flex-wrap:wrap">
                            <button class="playground-btn playground-btn-add" onclick="addMessageRow()">Ê∑ªÂä†ÂèÇÊï∞</button>
                            <button class="playground-btn playground-btn-clear" onclick="clearMessages()">Ê∏ÖÁ©∫ÂèÇÊï∞</button>
                            <button class="playground-btn playground-btn-send" onclick="sendPlayground()">ÂèëÈÄÅÊµãËØï</button>
                        </div>
                    </div>
                </div>
                <div class="config-group">
                    <div onclick="toggleSection('playgroundMessagesWrap')" style="cursor:pointer; display:flex; align-items:center; justify-content:space-between; padding:6px 8px; background:#f7f7f7; border-radius:6px">
                        <span>‰ºöËØùÂèÇÊï∞</span>
                        <span id="playgroundMessagesToggle">‚ñº</span>
                    </div>
                    <div id="playgroundMessagesWrap" style="margin-top:8px; display:block">
                        <div id="playgroundMessages"></div>
                    </div>
                </div>
                <div class="config-group">
                    <div onclick="toggleSection('playgroundToolsWrap')" style="cursor:pointer; display:flex; align-items:center; justify-content:space-between; padding:6px 8px; background:#f7f7f7; border-radius:6px">
                        <span>Â∑•ÂÖ∑/ÂáΩÊï∞ÂÆö‰πâÔºàJSONÔºâ</span>
                        <span id="playgroundToolsToggle">‚ñº</span>
                    </div>
                    <div id="playgroundToolsWrap" style="margin-top:8px; display:block">
                        <div class="form-group">
                            <textarea id="playgroundToolsJson" class="config-input" placeholder='[{"type":"function","function":{"name":"get_weather","parameters":{"type":"object","properties":{"city":{"type":"string"}}}}}]' style="min-height:100px" oninput="updateRequestPreview()"></textarea>
                            <small class="config-note">ÁïôÁ©∫Âàô‰∏çÂêØÁî®Â∑•ÂÖ∑Ë∞ÉÁî®ÔºõÂÜÖÂÆπÈúÄ‰∏∫ÂêàÊ≥ï JSON</small>
                        </div>
                    </div>
                </div>
                <!-- ËØ∑Ê±ÇÈ¢ÑËßàÂå∫ÂüüÔºàÊîØÊåÅÊäòÂè†ÔºåÈªòËÆ§ÊòæÁ§∫Ôºâ -->
                <div class="config-group" id="requestPreviewSection">
                    <div onclick="toggleSection('requestPreviewWrap')" style="cursor:pointer; display:flex; align-items:center; justify-content:space-between; padding:6px 8px; background:var(--card-bg); border-radius:6px">
                        <span>üìã ËØ∑Ê±ÇÈ¢ÑËßàÔºàÂÆûÊó∂Ôºâ</span>
                        <span id="requestPreviewToggle">‚ñº</span>
                    </div>
                    <div id="requestPreviewWrap" style="margin-top:12px; display:block">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="font-size: 12px; color: var(--text-secondary);">ËØ∑Ê±ÇÊñπÊ≥ï & URL</label>
                                <div style="background: var(--card-bg); padding: 10px; border-radius: 6px; font-family: monospace; font-size: 12px;">
                                    <span id="previewMethod" style="color: #28a745; font-weight: bold;">POST</span>
                                    <span id="previewUrl" style="color: var(--text-color); margin-left: 10px;"></span>
                                </div>
                            </div>
                            <div>
                                <label style="font-size: 12px; color: var(--text-secondary);">ËØ∑Ê±ÇÂ§¥</label>
                                <pre id="previewHeaders" style="background: var(--card-bg); padding: 10px; border-radius: 6px; font-family: monospace; font-size: 11px; margin: 0; max-height: 80px; overflow: auto;"></pre>
                            </div>
                        </div>
                        <div style="margin-top: 15px;">
                            <label style="font-size: 12px; color: var(--text-secondary);">ËØ∑Ê±Ç‰Ωì (JSON)</label>
                            <textarea id="previewBody" style="width: 100%; background: #1e1e1e; color: #9cdcfe; padding: 12px; border-radius: 6px; font-family: monospace; font-size: 11px; margin: 0; min-height: 200px; border: 1px solid var(--border-color); resize: vertical;"></textarea>
                        </div>
                        <div style="margin-top: 10px; display: flex; gap: 8px; justify-content: flex-end;">
                            <button class="btn btn-sm" onclick="copyRequestBody()" style="background: #6c757d;">Â§çÂà∂ËØ∑Ê±Ç‰Ωì</button>
                            <button class="btn btn-sm" onclick="editRequestBody()" style="background: #17a2b8;">ÁºñËæëËØ∑Ê±Ç‰Ωì</button>
                            <button class="btn btn-sm" onclick="sendCustomRequest()" style="background: #28a745;">ÂèëÈÄÅ</button>
                        </div>
                    </div>
                </div>

                <div class="config-group">
                    <h4>ÁªìÊûú</h4>
                    <div class="form-group" style="display:flex; gap:12px; flex-wrap:wrap; align-items:stretch">
                        <div class="card" style="padding:12px; flex:1; min-width:280px">
                            <div><strong>Response</strong></div>
                            <div id="playgroundOutputContent" style="white-space:pre-wrap; margin-top:6px; max-height:240px; overflow:auto"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>ÂéüÂßãÂìçÂ∫î</label>
                        <pre id="playgroundRawJson" style="background-color:#1e1e1e; color:#ffffff; font-family:'Courier New', monospace; font-size:12px; height:320px; overflow-y:auto; border:1px solid #333; border-radius:5px; padding:12px; white-space:pre-wrap; word-break:break-all"></pre>
                    </div>
                </div>
            </div>

            <!-- Ë¥¶Êà∑ÁÆ°ÁêÜÊ†áÁ≠æÈ°µ -->
            <div id="accountTab" class="tab-content">
                <h3>Ë¥¶Êà∑ÁÆ°ÁêÜ</h3>
                <div id="accountStatus"></div>
                
                <!-- ÁôªÂΩïÂå∫Âüü -->
                <div id="accountLoginSection">
                    <div class="config-group">
                        <h4>ÁôªÂΩï AssemblyAI Dashboard</h4>
                        <p style="color: var(--text-secondary); margin-bottom: 16px;">‰ΩøÁî®‰Ω†ÁöÑ AssemblyAI Ë¥¶Êà∑ÈÇÆÁÆ±ÂíåÂØÜÁ†ÅÁôªÂΩïÔºåÊü•ÁúãË¥¶Êà∑‰ΩôÈ¢ù„ÄÅ‰ΩøÁî®ÈáèÂíåÊàêÊú¨„ÄÇ</p>
                        
                        <!-- ÈÇÆÁÆ±ÂØÜÁ†ÅÁôªÂΩï -->
                        <div class="form-group">
                            <label for="accountEmail">ÈÇÆÁÆ±</label>
                            <input type="text" id="accountEmail" class="config-input" placeholder="your@email.com" />
                        </div>
                        <div class="form-group">
                            <label for="accountPassword">ÂØÜÁ†Å</label>
                            <input type="password" id="accountPassword" class="config-input" placeholder="ËæìÂÖ•ÂØÜÁ†Å" onkeypress="if(event.key==='Enter')accountLogin()" />
                        </div>
                        <button class="btn" onclick="accountLogin()">ÁôªÂΩï</button>
                        <small class="config-note" style="display: block; margin-top: 12px;">
                            <a href="https://www.assemblyai.com/dashboard/signup" target="_blank">Ê≤°ÊúâË¥¶Êà∑ÔºüÊ≥®ÂÜå AssemblyAI</a>
                        </small>
                    </div>
                </div>

                <!-- Â∑≤ÁôªÂΩïÂå∫Âüü -->
                <div id="accountLoggedInSection" class="hidden">
                    <!-- Â≠êÊ†áÁ≠æÈ°µÂØºËà™ -->
                    <div style="display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button class="btn btn-sm" id="accountSubTabOverview" onclick="switchAccountSubTab('overview')" style="background: #4285f4;">Ê¶ÇËßà</button>
                        <button class="btn btn-sm" id="accountSubTabUsage" onclick="switchAccountSubTab('usage')" style="background: #6c757d;">‰ΩøÁî®Èáè</button>
                        <button class="btn btn-sm" id="accountSubTabCost" onclick="switchAccountSubTab('cost')" style="background: #6c757d;">ÊàêÊú¨</button>
                        <button class="btn btn-sm" id="accountSubTabRates" onclick="switchAccountSubTab('rates')" style="background: #6c757d;">Ë¥πÁéá</button>
                        <button class="btn btn-sm" onclick="accountLogout()" style="background: #dc3545; margin-left: auto;">ÁôªÂá∫</button>
                    </div>

                    <!-- Ê¶ÇËßàÂ≠êÈ°µÈù¢ -->
                    <div id="accountSubOverview">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px;">
                            <!-- Ë¥¶Êà∑‰ø°ÊÅØÂç°Áâá -->
                            <div class="config-group">
                                <h4>Ë¥¶Êà∑‰ø°ÊÅØ</h4>
                                <div id="accountInfoContent">
                                    <div class="loading">Âä†ËΩΩ‰∏≠...</div>
                                </div>
                            </div>
                            <!-- ‰ΩôÈ¢ùÂç°Áâá -->
                            <div class="config-group">
                                <h4>‰ΩôÈ¢ù</h4>
                                <div id="accountBalanceContent">
                                    <div class="loading">Âä†ËΩΩ‰∏≠...</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ‰ΩøÁî®ÈáèÂ≠êÈ°µÈù¢ -->
                    <div id="accountSubUsage" class="hidden">
                        <div class="config-group">
                            <h4>‰ΩøÁî®ÈáèÁªüËÆ°</h4>
                            <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; align-items: center;">
                                <button class="btn btn-sm" onclick="loadAccountUsage(true)">Âà∑Êñ∞</button>
                            </div>
                            <div id="accountUsageContent">
                                <div class="loading">Âä†ËΩΩ‰∏≠...</div>
                            </div>
                        </div>
                    </div>

                    <!-- ÊàêÊú¨Â≠êÈ°µÈù¢ -->
                    <div id="accountSubCost" class="hidden">
                        <div class="config-group">
                            <h4>ÊàêÊú¨ÂàÜÊûê</h4>
                            <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; align-items: center;">
                                <button class="btn btn-sm" onclick="loadAccountCost(true)">Âà∑Êñ∞</button>
                                <button class="btn btn-sm" onclick="exportAccountCost('json')" style="background: #17a2b8;">ÂØºÂá∫ JSON</button>
                                <button class="btn btn-sm" onclick="exportAccountCost('csv')" style="background: #17a2b8;">ÂØºÂá∫ CSV</button>
                            </div>
                            <div id="accountCostContent">
                                <div class="loading">Âä†ËΩΩ‰∏≠...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Ë¥πÁéáÂ≠êÈ°µÈù¢ -->
                    <div id="accountSubRates" class="hidden">
                        <div class="config-group">
                            <h4>Ë¥πÁéá‰ø°ÊÅØ</h4>
                            <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                                <select id="accountRatesRegion" class="config-input" style="width: auto;" onchange="loadAccountRates(true)">
                                    <option value="US" selected>US</option>
                                    <option value="Europe">Europe</option>
                                </select>
                                <button class="btn btn-sm" onclick="loadAccountRates(true)">Âà∑Êñ∞</button>
                            </div>
                            <div id="accountRatesContent">
                                <div class="loading">Âä†ËΩΩ‰∏≠...</div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- ÈôêÂà∂ËÆæÁΩÆÂºπÁ™ó -->
    <div id="limitsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ËÆæÁΩÆ‰ΩøÁî®ÈôêÂà∂</h3>
                <button class="modal-close" onclick="closeLimitsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="modalFilename">Êñá‰ª∂Âêç:</label>
                    <input type="text" id="modalFilename" class="config-input" readonly />
                </div>
                <div class="form-group">
                    <label for="modalTotalLimit">ÊâÄÊúâÊ®°ÂûãÊØèÊó•ÈôêÂà∂:</label>
                    <input type="number" id="modalTotalLimit" class="config-input" min="1" max="50000" />
                    <small class="config-note">ÊØèÊó•ÊâÄÊúâÊ®°ÂûãË∞ÉÁî®Ê¨°Êï∞ÊÄªÈôêÂà∂</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeLimitsModal()" style="background-color: #6c757d;">ÂèñÊ∂à</button>
                <button class="btn" onclick="saveLimits()">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>

    <!-- ÊìçÁªÉÂú∫ÁªìÊûúÂºπÁ™ó -->
    <div id="playgroundResultModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">ÊµãËØïÁªìÊûú</h3>
                <button class="modal-close" onclick="closePlaygroundResultModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>ËøîÂõûÊ∂àÊÅØ:</label>
                    <div id="playgroundResultMessage" style="background: var(--card-bg, #f8f9fa); padding: 12px; border-radius: 6px; max-height: 400px; overflow-y: auto; white-space: pre-wrap; word-break: break-word; color: var(--text-color, #333);"></div>
                </div>
                <div class="form-group">
                    <label>‰ΩøÁî®ÁöÑ Key:</label>
                    <div id="playgroundResultKey" style="font-family: 'Courier New', monospace; color: #666;"></div>
                </div>
                <div class="form-group">
                    <label>Token ‰ΩøÁî®:</label>
                    <div id="playgroundResultTokens" style="color: #666;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closePlaygroundResultModal()">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>

    <script>
        let currentProjectId = '';
        let authInProgress = false;
        let uploadSelectedFiles = []; // ‰∏ä‰º†È°µÈù¢Áî®ÁöÑÊñá‰ª∂ÂàóË°®
        let authToken = '';
        let credsData = {};
        let selectedModels = [];
        let queriedModels = { grouped: { Anthropic: [], OpenAI: [], Google: [], Other: [] }, models: [] };

        // ==================== ÊöóÈªëÊ®°Âºè ====================
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeButton(newTheme);
        }

        function updateThemeButton(theme) {
            const icon = document.getElementById('themeIcon');
            const text = document.getElementById('themeText');
            if (theme === 'dark') {
                icon.textContent = '‚òÄÔ∏è';
                text.textContent = '‰∫ÆËâ≤';
            } else {
                icon.textContent = 'üåô';
                text.textContent = 'ÊöóÈªë';
            }
        }

        // ÂàùÂßãÂåñ‰∏ªÈ¢ò
        (function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            // Âª∂ËøüÊõ¥Êñ∞ÊåâÈíÆÔºåÁ°Æ‰øù DOM Â∑≤Âä†ËΩΩ
            setTimeout(() => updateThemeButton(savedTheme), 0);
        })();

        // ÂàÜÈ°µÂíåÁ≠õÈÄâÁõ∏ÂÖ≥ÂèòÈáè
        let filteredCredsData = {};
        let currentPage = 1;
        let pageSize = 20;
        let currentFilter = 'all';
        let currentErrorCodeFilter = 'all';
        let selectedCredFiles = new Set(); // ÈÄâ‰∏≠ÁöÑÂá≠ËØÅÊñá‰ª∂ÂêçÈõÜÂêà
        let availableErrorCodes = new Set(); // ÊâÄÊúâÂèØÁî®ÁöÑÈîôËØØÁ†Å
        let statsData = {
            total: 0,
            normal: 0,
            disabled: 0
        };

        function showStatus(message, type = 'info') {
            const mainHidden = document.getElementById('mainSection')?.classList.contains('hidden');
            let target = null;
            if (mainHidden) {
                target = document.getElementById('loginStatus');
            } else {
                const active = document.querySelector('.tab-content.active');
                const map = {
                    'playgroundTab': 'playgroundStatus',
                    'logsTab': 'logsStatus',
                    'usageTab': 'usageStatus',
                    'configTab': 'configStatus'
                };
                if (active && map[active.id]) {
                    target = document.getElementById(map[active.id]);
                }
            }
            if (target) {
                target.innerHTML = `<div class="status ${type}">${message}</div>`;
            } else {
                alert(message);
            }
        }

        // ÁôªÂΩïÁõ∏ÂÖ≥ÂáΩÊï∞
        async function login() {
            const password = document.getElementById('loginPassword').value;
            if (!password) {
                showStatus('ËØ∑ËæìÂÖ•ÂØÜÁ†Å', 'error');
                return;
            }
            try {
                const res = await fetch('/config/get', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${password}`
                    }
                });
                if (res.ok) {
                    authToken = password;
                    document.getElementById('loginSection').classList.add('hidden');
                    document.getElementById('mainSection').classList.remove('hidden');
                    showStatus('ÁôªÂΩïÊàêÂäü', 'success');
                    switchTab('config');
                    await loadConfig();
                    await refreshUsageStats();
                } else {
                    showStatus('ÂØÜÁ†ÅÈîôËØØ', 'error');
                }
            } catch (error) {
                showStatus(`ÁΩëÁªúÈîôËØØ: ${error.message}`, 'error');
            }
        }

        function handlePasswordEnter(event) {
            if (event.key === 'Enter') {
                login();
            }
        }

        // Ê†áÁ≠æÈ°µÂàáÊç¢
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            const contentEl = document.getElementById(tabName + 'Tab');
            if (contentEl) contentEl.classList.add('active');
            const buttons = document.querySelectorAll('.tabs .tab');
            buttons.forEach(btn => {
                const onclick = btn.getAttribute('onclick') || '';
                if (onclick.includes("'" + tabName + "'")) btn.classList.add('active');
            });
            ['playgroundStatus','logsStatus','usageStatus','configStatus'].forEach(id=>{ const el=document.getElementById(id); if (el) el.innerHTML=''; });
            if (tabName === 'usage') {
                refreshUsageStats();
                refreshLogSummary();
                // Ëá™Âä®Ê£ÄÊü•Â§±ÊïàÂØÜÈí•
                checkInvalidKeys();
            }
            if (tabName === 'config') {
                loadConfig();
                loadSelectedModelsFromConfig();
            }
            if (tabName === 'logs') {
                connectWebSocket();
            }
            if (tabName === 'playground') {
                initPlayground();
            }
            if (tabName === 'ratelimit') {
                loadRateLimits();
            }
            if (tabName === 'account') {
                initAccountTab();
            }
        }

        // ==================== ÂØÜÈí•ÁÆ°ÁêÜÁõ∏ÂÖ≥ÂáΩÊï∞ÔºàÂºπÁ™óÁâàÔºâ ====================
        let keyManagementData = { keys: [], total: 0, active: 0, disabled: 0 };
        let keyCurrentPage = 1;
        let keyPageSize = 10;

        // ÊòæÁ§∫ÂØÜÈí•ÁÆ°ÁêÜÂºπÁ™ó
        function showKeyManagementModal() {
            document.getElementById('keyManagementModal').style.display = 'block';
            loadKeyManagementModal();
        }

        // ÂÖ≥Èó≠ÂØÜÈí•ÁÆ°ÁêÜÂºπÁ™ó
        function closeKeyManagementModal() {
            document.getElementById('keyManagementModal').style.display = 'none';
        }

        // Âä†ËΩΩÂØÜÈí•ÁÆ°ÁêÜÊï∞ÊçÆÔºàÂºπÁ™óÁâàÔºâ
        async function loadKeyManagementModal() {
            const tbody = document.getElementById('keyManagementTableBody');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px;">Âä†ËΩΩ‰∏≠...</td></tr>';
            
            try {
                const statusFilter = document.getElementById('modalKeyStatusFilter')?.value || 'all';
                keyPageSize = parseInt(document.getElementById('keyPageSize')?.value || '10');
                
                // Ëé∑ÂèñÂØÜÈí•ÂàóË°®
                let url = '/api/keys?';
                const params = new URLSearchParams();
                if (statusFilter !== 'all') params.append('status_filter', statusFilter);
                params.append('sort_by', 'index');
                params.append('sort_order', 'asc');
                url += params.toString();
                
                const response = await fetch(url, { headers: getAuthHeaders() });
                const data = await response.json();
                keyManagementData = data;
                
                // Ëé∑ÂèñÈÖçÁΩÆ‰ø°ÊÅØÔºàËÅöÂêàÊ®°ÂºèÔºâ
                try {
                    const configResponse = await fetch('/api/keys/config', { headers: getAuthHeaders() });
                    if (configResponse.ok) {
                        const configData = await configResponse.json();
                        const modeText = configData.aggregation_mode === 'random' ? 'ÈöèÊú∫Ê®°Âºè' : 'ËΩÆËØ¢Ê®°Âºè';
                        document.getElementById('modalAggregationMode').textContent = modeText;
                    }
                } catch (e) {
                    console.error('Failed to load key config:', e);
                }
                
                // Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ - ‰øÆÂ§çÂ§±ÊïàÂà§Êñ≠ÈÄªËæë
                const total = data.total || 0;
                const enabled = data.active || 0;
                
                // ËÆ°ÁÆóÂ§±ÊïàÂØÜÈí•Êï∞ÈáèÔºà‰ªékeysÊï∞ÁªÑ‰∏≠ÁªüËÆ°Ôºâ
                let invalidCount = 0;
                let manualDisabled = 0;
                if (data.keys && Array.isArray(data.keys)) {
                    data.keys.forEach(key => {
                        if (!key.enabled) {
                            // Ê£ÄÊü•ÊòØÂê¶ÊòØÂ§±ÊïàÂØÜÈí•ÔºàÊúâÈîôËØØ‰ø°ÊÅØÊàñÁâπÂÆöÁä∂ÊÄÅÔºâ
                            if (key.status === 'invalid' || key.error || key.exhausted) {
                                invalidCount++;
                            } else {
                                manualDisabled++;
                            }
                        }
                    });
                } else {
                    // ÂõûÈÄÄÂà∞ÂéüÊúâÈÄªËæë
                    manualDisabled = data.disabled || 0;
                }
                
                const autoDisabled = invalidCount;
                
                document.getElementById('modalKeyTotal').textContent = total;
                document.getElementById('modalKeyTotal2').textContent = total;
                document.getElementById('modalKeyTotal3').textContent = total;
                document.getElementById('modalKeyTotal4').textContent = total;
                document.getElementById('modalKeyEnabled').textContent = enabled;
                document.getElementById('modalKeyManualDisabled').textContent = manualDisabled;
                document.getElementById('modalKeyAutoDisabled').textContent = autoDisabled;
                
                // Êõ¥Êñ∞ËøõÂ∫¶Êù°
                const enabledPercent = total > 0 ? (enabled / total * 100) : 0;
                const manualPercent = total > 0 ? (manualDisabled / total * 100) : 0;
                const autoPercent = total > 0 ? (autoDisabled / total * 100) : 0;
                document.getElementById('enabledProgressBar').style.width = enabledPercent + '%';
                document.getElementById('manualDisabledProgressBar').style.width = manualPercent + '%';
                document.getElementById('autoDisabledProgressBar').style.width = autoPercent + '%';
                
                // Ê∏≤ÊüìË°®Ê†º
                renderKeyManagementTable(data.keys);
            } catch (error) {
                console.error('Failed to load key management:', error);
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #dc3545;">Âä†ËΩΩÂ§±Ë¥•: ' + error.message + '</td></tr>';
            }
        }

        // Ê∏≤ÊüìÂØÜÈí•Ë°®Ê†º
        function renderKeyManagementTable(keys) {
            const tbody = document.getElementById('keyManagementTableBody');
            
            if (!keys || keys.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--text-secondary);">ÊöÇÊó†ÂØÜÈí•</td></tr>';
                updateKeyPagination(0);
                return;
            }
            
            // ÂàÜÈ°µ
            const startIndex = (keyCurrentPage - 1) * keyPageSize;
            const endIndex = Math.min(startIndex + keyPageSize, keys.length);
            const pageKeys = keys.slice(startIndex, endIndex);
            
            let html = '';
            pageKeys.forEach(key => {
                // Âà§Êñ≠ÂØÜÈí•Áä∂ÊÄÅ
                const isInvalid = key.status === 'invalid' || key.error || key.exhausted;
                const statusClass = key.enabled ? 'enabled' : (isInvalid ? 'invalid' : 'disabled');
                let statusText = key.enabled ? 'Â∑≤ÂêØÁî®' : 'Â∑≤Á¶ÅÁî®';
                let statusColor = key.enabled ? '#28a745' : '#dc3545';
                
                // Â¶ÇÊûúÊòØÂ§±ÊïàÂØÜÈí•ÔºåÊòæÁ§∫ÁâπÊÆäÁä∂ÊÄÅ
                if (isInvalid && !key.enabled) {
                    statusText = 'Â§±Êïà';
                    statusColor = '#ffc107';
                }
                
                const actionText = key.enabled ? 'Á¶ÅÁî®' : 'ÂêØÁî®';
                const actionColor = key.enabled ? '#dc3545' : '#28a745';
                
                // ÊòæÁ§∫ÂÆåÊï¥ÂØÜÈí•Ôºå‰∏çÈöêÂåø
                const fullKey = key.key || key.masked_key || '';
                
                // Á¶ÅÁî®ÂéüÂõ†
                let disableReason = '-';
                if (!key.enabled) {
                    if (isInvalid) {
                        disableReason = key.error || 'ÂØÜÈí•Â§±Êïà';
                    } else {
                        disableReason = key.disable_reason || 'ÊâãÂä®Á¶ÅÁî®';
                    }
                }
                
                // Á¶ÅÁî®Êó∂Èó¥
                let disableTime = '-';
                if (!key.enabled && key.disable_time) {
                    try {
                        const date = new Date(key.disable_time * 1000);
                        disableTime = date.toLocaleString('zh-CN');
                    } catch (e) {
                        disableTime = '-';
                    }
                }
                
                html += `<tr>
                    <td style="color: var(--text-secondary);">#${key.index}</td>
                    <td><code style="font-size: 11px; color: var(--text-color); word-break: break-all;">${fullKey}</code></td>
                    <td><span class="status-badge ${statusClass}" style="background: ${statusColor}; color: white; padding: 2px 10px; border-radius: 4px; font-size: 12px;">${statusText}</span></td>
                    <td style="color: var(--text-muted); font-size: 12px;">${disableReason}</td>
                    <td style="color: var(--text-muted); font-size: 12px;">${disableTime}</td>
                    <td style="text-align: right;">
                        <button onclick="toggleKeyStatusModal(${key.index}, ${!key.enabled})" style="background: transparent; color: ${actionColor}; border: 1px solid ${actionColor}; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">${actionText}</button>
                    </td>
                </tr>`;
            });
            
            tbody.innerHTML = html;
            updateKeyPagination(keys.length);
        }

        // Êõ¥Êñ∞ÂàÜÈ°µ‰ø°ÊÅØ
        function updateKeyPagination(total) {
            const startIndex = total > 0 ? (keyCurrentPage - 1) * keyPageSize + 1 : 0;
            const endIndex = Math.min(keyCurrentPage * keyPageSize, total);
            
            document.getElementById('keyPageStart').textContent = startIndex;
            document.getElementById('keyPageEnd').textContent = endIndex;
            document.getElementById('keyPageTotal').textContent = total;
            document.getElementById('keyCurrentPage').textContent = keyCurrentPage;
            
            const totalPages = Math.ceil(total / keyPageSize) || 1;
            document.getElementById('keyPrevPage').disabled = keyCurrentPage <= 1;
            document.getElementById('keyNextPage').disabled = keyCurrentPage >= totalPages;
        }

        // ÂàáÊç¢È°µÈù¢
        function changeKeyPage(delta) {
            const total = keyManagementData.keys?.length || 0;
            const totalPages = Math.ceil(total / keyPageSize) || 1;
            const newPage = keyCurrentPage + delta;
            
            if (newPage >= 1 && newPage <= totalPages) {
                keyCurrentPage = newPage;
                renderKeyManagementTable(keyManagementData.keys);
            }
        }

        // Ë∑≥ËΩ¨Âà∞ÊåáÂÆöÈ°µ
        function jumpToKeyPage() {
            const input = document.getElementById('keyJumpPage');
            const page = parseInt(input.value);
            const total = keyManagementData.keys?.length || 0;
            const totalPages = Math.ceil(total / keyPageSize) || 1;
            
            if (page >= 1 && page <= totalPages) {
                keyCurrentPage = page;
                renderKeyManagementTable(keyManagementData.keys);
            }
            input.value = '';
        }

        // ÂàáÊç¢ÂØÜÈí•Áä∂ÊÄÅÔºàÂºπÁ™óÁâàÔºâ
        async function toggleKeyStatusModal(index, enabled) {
            try {
                const response = await fetch(`/api/keys/${index}/status`, {
                    method: 'PUT',
                    headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled: enabled })
                });
                
                if (response.ok) {
                    loadKeyManagementModal();
                } else {
                    const error = await response.json();
                    alert('Êìç‰ΩúÂ§±Ë¥•: ' + (error.detail || 'Êú™Áü•ÈîôËØØ'));
                }
            } catch (error) {
                alert('Êìç‰ΩúÂ§±Ë¥•: ' + error.message);
            }
        }

        // ÂêØÁî®ÂÖ®ÈÉ®ÂØÜÈí•
        async function enableAllKeys() {
            if (!confirm('Á°ÆÂÆöË¶ÅÂêØÁî®ÊâÄÊúâÂØÜÈí•ÂêóÔºü')) return;
            try {
                const indices = keyManagementData.keys.map(k => k.index);
                const response = await fetch('/api/keys/batch-status', {
                    method: 'POST',
                    headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ indices: indices, enabled: true })
                });
                if (response.ok) {
                    loadKeyManagementModal();
                } else {
                    const error = await response.json();
                    alert('Êìç‰ΩúÂ§±Ë¥•: ' + (error.detail || 'Êú™Áü•ÈîôËØØ'));
                }
            } catch (error) {
                alert('Êìç‰ΩúÂ§±Ë¥•: ' + error.message);
            }
        }

        // Á¶ÅÁî®ÂÖ®ÈÉ®ÂØÜÈí•
        async function disableAllKeys() {
            if (!confirm('Á°ÆÂÆöË¶ÅÁ¶ÅÁî®ÊâÄÊúâÂØÜÈí•ÂêóÔºü')) return;
            try {
                const indices = keyManagementData.keys.map(k => k.index);
                const response = await fetch('/api/keys/batch-status', {
                    method: 'POST',
                    headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ indices: indices, enabled: false })
                });
                if (response.ok) {
                    loadKeyManagementModal();
                } else {
                    const error = await response.json();
                    alert('Êìç‰ΩúÂ§±Ë¥•: ' + (error.detail || 'Êú™Áü•ÈîôËØØ'));
                }
            } catch (error) {
                alert('Êìç‰ΩúÂ§±Ë¥•: ' + error.message);
            }
        }

        // Âà†Èô§Ëá™Âä®Á¶ÅÁî®ÁöÑÂØÜÈí•
        async function deleteAutoDisabledKeys() {
            alert('Ê≠§ÂäüËÉΩÊöÇÊú™ÂÆûÁé∞');
        }

        // Ê∏ÖÁêÜËøáÊúüÂØÜÈí•ÁöÑÁªüËÆ°Êï∞ÊçÆ
        async function cleanupKeyStats() {
            if (!confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁêÜËøáÊúüÂØÜÈí•ÁöÑÁªüËÆ°Êï∞ÊçÆÂêóÔºü\n\nËøôÂ∞ÜÂà†Èô§Â∑≤ÁßªÈô§ÂØÜÈí•ÁöÑÂéÜÂè≤ÁªüËÆ°ËÆ∞ÂΩï„ÄÇ')) return;
            try {
                const response = await fetch('/api/keys/cleanup-stats', {
                    method: 'POST',
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                if (response.ok) {
                    showStatus(data.message || 'ÁªüËÆ°Êï∞ÊçÆÊ∏ÖÁêÜÂÆåÊàê', 'success');
                    loadKeyManagementModal();
                } else {
                    showStatus('Ê∏ÖÁêÜÂ§±Ë¥•: ' + (data.detail || 'Êú™Áü•ÈîôËØØ'), 'error');
                }
            } catch (error) {
                console.error('Failed to cleanup key stats:', error);
                showStatus('Ê∏ÖÁêÜÂ§±Ë¥•: ' + error.message, 'error');
            }
        }

        // ==================== ÈÄüÁéáÈôêÂà∂Áõ∏ÂÖ≥ÂáΩÊï∞ ====================
        let rateLimitRefreshInterval = null;

        async function loadRateLimits() {
            const loadingEl = document.getElementById('rateLimitLoading');
            const listEl = document.getElementById('rateLimitList');
            const statusEl = document.getElementById('rateLimitStatus');
            
            if (loadingEl) loadingEl.style.display = 'block';
            if (listEl) listEl.innerHTML = '';
            if (statusEl) statusEl.innerHTML = '';
            
            try {
                const response = await fetch('/rate-limits', {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                displayRateLimits(data.rate_limits || []);
                
            } catch (error) {
                console.error('Âä†ËΩΩÈÄüÁéáÈôêÂà∂Â§±Ë¥•:', error);
                if (statusEl) {
                    statusEl.innerHTML = `<div class="error">Âä†ËΩΩÂ§±Ë¥•: ${error.message}</div>`;
                }
            } finally {
                if (loadingEl) loadingEl.style.display = 'none';
            }
        }

        function displayRateLimits(rateLimits) {
            const listEl = document.getElementById('rateLimitList');
            if (!listEl) return;
            
            if (rateLimits.length === 0) {
                listEl.innerHTML = '<div class="usage-info">ÊöÇÊó†ÈÄüÁéáÈôêÂà∂Êï∞ÊçÆ</div>';
                return;
            }
            
            let html = '';
            
            rateLimits.forEach(key => {
                const usagePercent = key.limit > 0 ? (key.used / key.limit * 100) : 0;
                const statusClass = key.status === 'active' ? 'status-active' : 
                                   key.status === 'exhausted' ? 'status-exhausted' : 'status-unused';
                const statusText = key.status === 'active' ? 'üü¢ ÂèØÁî®' : 
                                  key.status === 'exhausted' ? 'üî¥ Â∑≤ËÄóÂ∞Ω' : '‚ö™ Êú™‰ΩøÁî®';
                
                let progressClass = 'progress-green';
                if (usagePercent > 80) {
                    progressClass = 'progress-red';
                } else if (usagePercent > 50) {
                    progressClass = 'progress-yellow';
                }
                
                const resetText = key.reset_in_seconds > 0 ? 
                    `${key.reset_in_seconds}ÁßíÂêéÈáçÁΩÆ` : 
                    (key.limit > 0 ? 'Â∑≤ÈáçÁΩÆ' : 'Êú™‰ΩøÁî®');
                
                const lastRequestTime = key.last_request_time > 0 ? 
                    new Date(key.last_request_time * 1000).toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    }) : 
                    '‰ªéÊú™‰ΩøÁî®';
                
                html += `
                    <div class="rate-limit-card">
                        <div class="rate-limit-header">
                            <div class="rate-limit-key">Key #${key.index}: ${key.key}</div>
                            <div class="rate-limit-status ${statusClass}">${statusText}</div>
                        </div>
                        
                        ${key.limit > 0 ? `
                            <div class="rate-limit-info">
                                <div class="rate-limit-info-item">
                                    <div class="rate-limit-info-label">ÈôêÈ¢ù</div>
                                    <div class="rate-limit-info-value">${key.limit} Ê¨°/ÂàÜÈíü</div>
                                </div>
                                <div class="rate-limit-info-item">
                                    <div class="rate-limit-info-label">Â∑≤‰ΩøÁî®</div>
                                    <div class="rate-limit-info-value">${key.used} Ê¨°</div>
                                </div>
                                <div class="rate-limit-info-item">
                                    <div class="rate-limit-info-label">Ââ©‰Ωô</div>
                                    <div class="rate-limit-info-value">${key.remaining} Ê¨°</div>
                                </div>
                                <div class="rate-limit-info-item">
                                    <div class="rate-limit-info-label">ÊúÄÂêéËØ∑Ê±Ç</div>
                                    <div class="rate-limit-info-value" style="font-size: 13px;">${lastRequestTime}</div>
                                </div>
                            </div>
                            
                            <div class="rate-limit-progress">
                                <div class="rate-limit-progress-bar ${progressClass}" 
                                     style="width: ${usagePercent}%">
                                    ${usagePercent.toFixed(1)}%
                                </div>
                            </div>
                            
                            <div class="rate-limit-reset">‚è±Ô∏è ${resetText}</div>
                        ` : `
                            <div class="usage-info" style="text-align: center; padding: 20px; color: #999;">
                                ËØ• Key Â∞öÊú™‰ΩøÁî®
                            </div>
                        `}
                    </div>
                `;
            });
            
            listEl.innerHTML = html;
        }

        function toggleAutoRefresh() {
            const checkbox = document.getElementById('autoRefreshRateLimit');
            
            if (checkbox && checkbox.checked) {
                // ÂêØÂä®Ëá™Âä®Âà∑Êñ∞
                if (!rateLimitRefreshInterval) {
                    rateLimitRefreshInterval = setInterval(() => {
                        // Âè™Âú®ÈÄüÁéáÈôêÂà∂Ê†áÁ≠æÈ°µÊøÄÊ¥ªÊó∂Âà∑Êñ∞
                        const tab = document.getElementById('ratelimitTab');
                        if (tab && tab.classList.contains('active')) {
                            loadRateLimits();
                        }
                    }, 5000); // ÊØè5ÁßíÂà∑Êñ∞
                }
            } else {
                // ÂÅúÊ≠¢Ëá™Âä®Âà∑Êñ∞
                if (rateLimitRefreshInterval) {
                    clearInterval(rateLimitRefreshInterval);
                    rateLimitRefreshInterval = null;
                }
            }
        }

        // È°µÈù¢Âç∏ËΩΩÊó∂Ê∏ÖÁêÜÂÆöÊó∂Âô®
        window.addEventListener('beforeunload', () => {
            if (rateLimitRefreshInterval) {
                clearInterval(rateLimitRefreshInterval);
            }
        });

        // Ëé∑ÂèñËÆ§ËØÅÂ§¥
        function getAuthHeaders() {
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            };
        }

        async function startAuth() {
            const projectId = document.getElementById('projectId').value.trim();
            const getAllProjects = document.getElementById('getAllProjectsCreds').checked;
            // È°πÁõÆIDÁé∞Âú®ÊòØÂèØÈÄâÁöÑ
            currentProjectId = projectId || null;

            const btn = document.getElementById('getAuthBtn');
            btn.disabled = true;
            btn.textContent = 'Ê≠£Âú®Ëé∑ÂèñËÆ§ËØÅÈìæÊé•...';

            try {
                const requestBody = {};
                if (projectId) {
                    requestBody.project_id = projectId;
                }
                if (getAllProjects) {
                    requestBody.get_all_projects = true;
                    showStatus('ÊâπÈáèÂπ∂ÂèëËÆ§ËØÅÊ®°ÂºèÔºöÂ∞Ü‰∏∫ÂΩìÂâçË¥¶Âè∑ÊâÄÊúâÈ°πÁõÆÁîüÊàêËÆ§ËØÅÈìæÊé•...', 'info');
                } else if (projectId) {
                    showStatus('‰ΩøÁî®ÊåáÂÆöÁöÑÈ°πÁõÆIDÁîüÊàêËÆ§ËØÅÈìæÊé•...', 'info');
                } else {
                    showStatus('Â∞ÜÂ∞ùËØïËá™Âä®Ê£ÄÊµãÈ°πÁõÆIDÔºåÊ≠£Âú®ÁîüÊàêËÆ§ËØÅÈìæÊé•...', 'info');
                }

                const response = await fetch('/auth/start', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                if (response.ok) {
                    document.getElementById('authUrl').href = data.auth_url;
                    document.getElementById('authUrl').textContent = data.auth_url;
                    document.getElementById('authUrlSection').classList.remove('hidden');

                    if (getAllProjects) {
                        showStatus('ÊâπÈáèÂπ∂ÂèëËÆ§ËØÅÈìæÊé•Â∑≤ÁîüÊàêÔºåÂÆåÊàêÊéàÊùÉÂêéÂ∞ÜÂπ∂Âèë‰∏∫ÊâÄÊúâÂèØËÆøÈóÆÈ°πÁõÆÁîüÊàêÂá≠ËØÅÊñá‰ª∂', 'info');
                    } else if (data.auto_project_detection) {
                        showStatus('ËÆ§ËØÅÈìæÊé•Â∑≤ÁîüÊàêÔºàÂ∞ÜÂú®ËÆ§ËØÅÂÆåÊàêÂêéËá™Âä®Ê£ÄÊµãÈ°πÁõÆIDÔºâÔºåËØ∑ÁÇπÂáªÈìæÊé•ÂÆåÊàêÊéàÊùÉ', 'info');
                    } else {
                        showStatus(`ËÆ§ËØÅÈìæÊé•Â∑≤ÁîüÊàêÔºàÈ°πÁõÆID: ${data.detected_project_id}ÔºâÔºåËØ∑ÁÇπÂáªÈìæÊé•ÂÆåÊàêÊéàÊùÉ`, 'info');
                    }
                    authInProgress = true;
                } else {
                    showStatus(`ÈîôËØØ: ${data.error || 'Ëé∑ÂèñËÆ§ËØÅÈìæÊé•Â§±Ë¥•'}`, 'error');
                }
            } catch (error) {
                showStatus(`ÁΩëÁªúÈîôËØØ: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Ëé∑ÂèñËÆ§ËØÅÈìæÊé•';
            }
        }

        async function getCredentials() {
            if (!authInProgress) {
                showStatus('ËØ∑ÂÖàËé∑ÂèñËÆ§ËØÅÈìæÊé•Âπ∂ÂÆåÊàêÊéàÊùÉ', 'error');
                return;
            }

            const btn = document.getElementById('getCredsBtn');
            const getAllProjects = document.getElementById('getAllProjectsCreds').checked;
            btn.disabled = true;
            btn.textContent = getAllProjects ? 'Âπ∂ÂèëÊâπÈáèËé∑ÂèñÊâÄÊúâÈ°πÁõÆÂá≠ËØÅ‰∏≠...' : 'Á≠âÂæÖOAuthÂõûË∞É‰∏≠...';

            try {
                if (getAllProjects) {
                    showStatus('Ê≠£Âú®Âπ∂Âèë‰∏∫ÊâÄÊúâÈ°πÁõÆËé∑ÂèñËÆ§ËØÅÂá≠ËØÅÔºåÈááÁî®Âπ∂ÂèëÂ§ÑÁêÜÊèêÂçáÈÄüÂ∫¶...', 'info');
                } else {
                    showStatus('Ê≠£Âú®Á≠âÂæÖOAuthÂõûË∞ÉÔºåËøôÂèØËÉΩÈúÄË¶Å‰∏Ä‰∫õÊó∂Èó¥...', 'info');
                }

                const requestBody = {};
                if (currentProjectId) {
                    requestBody.project_id = currentProjectId;
                }
                if (getAllProjects) {
                    requestBody.get_all_projects = true;
                }

                const response = await fetch('/auth/callback', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                if (response.ok) {
                    const credentialsSection = document.getElementById('credentialsSection');
                    const credentialsContent = document.getElementById('credentialsContent');

                    if (getAllProjects && data.multiple_credentials) {
                        // Â§ÑÁêÜÂ§öÈ°πÁõÆËÆ§ËØÅÁªìÊûú
                        const results = data.multiple_credentials;
                        let resultText = `ÊâπÈáèÂπ∂ÂèëËÆ§ËØÅÂÆåÊàêÔºÅÊàêÂäü‰∏∫ ${results.success.length} ‰∏™È°πÁõÆÁîüÊàêÂá≠ËØÅÔºö\n\n`;

                        // ÊòæÁ§∫ÊàêÂäüÁöÑÈ°πÁõÆ
                        results.success.forEach((item, index) => {
                            resultText += `${index + 1}. È°πÁõÆ: ${item.project_name} (${item.project_id})\n`;
                            resultText += `   Êñá‰ª∂: ${item.file_path}\n\n`;
                        });

                        // ÊòæÁ§∫Â§±Ë¥•ÁöÑÈ°πÁõÆÔºàÂ¶ÇÊûúÊúâÔºâ
                        if (results.failed.length > 0) {
                            resultText += `\nÂ§±Ë¥•ÁöÑÈ°πÁõÆ (${results.failed.length} ‰∏™):\n`;
                            results.failed.forEach((item, index) => {
                                resultText += `${index + 1}. È°πÁõÆ: ${item.project_name} (${item.project_id})\n`;
                                resultText += `   ÈîôËØØ: ${item.error}\n\n`;
                            });
                        }

                        credentialsContent.textContent = resultText;
                        showStatus(`‚úÖ ÊâπÈáèÂπ∂ÂèëËÆ§ËØÅÂÆåÊàêÔºÅÊàêÂäüÁîüÊàê ${results.success.length} ‰∏™È°πÁõÆÁöÑÂá≠ËØÅÊñá‰ª∂${results.failed.length > 0 ? `Ôºå${results.failed.length} ‰∏™È°πÁõÆÂ§±Ë¥•` : ''}`, 'success');
                    } else {
                        // Â§ÑÁêÜÂçïÈ°πÁõÆËÆ§ËØÅÁªìÊûú
                        credentialsContent.textContent = JSON.stringify(data.credentials, null, 2);

                        if (data.auto_detected_project) {
                            showStatus(`‚úÖ ËÆ§ËØÅÊàêÂäüÔºÅÈ°πÁõÆIDÂ∑≤Ëá™Âä®Ê£ÄÊµã‰∏∫: ${data.credentials.project_id}ÔºåÊñá‰ª∂Â∑≤‰øùÂ≠òÂà∞: ${data.file_path}`, 'success');
                        } else {
                            showStatus(`‚úÖ ËÆ§ËØÅÊàêÂäüÔºÅÊñá‰ª∂Â∑≤‰øùÂ≠òÂà∞: ${data.file_path}`, 'success');
                        }
                    }

                    credentialsSection.classList.remove('hidden');
                    authInProgress = false;
                } else {
                    // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÈ°πÁõÆÈÄâÊã©
                    if (data.requires_project_selection && data.available_projects) {
                        let projectOptions = "ËØ∑ÈÄâÊã©‰∏Ä‰∏™È°πÁõÆÔºö\n\n";
                        data.available_projects.forEach((project, index) => {
                            projectOptions += `${index + 1}. ${project.name} (${project.projectId})\n`;
                        });
                        projectOptions += `\nËØ∑ËæìÂÖ•Â∫èÂè∑ (1-${data.available_projects.length}):`;

                        const selection = prompt(projectOptions);
                        const projectIndex = parseInt(selection) - 1;

                        if (projectIndex >= 0 && projectIndex < data.available_projects.length) {
                            const selectedProject = data.available_projects[projectIndex];
                            currentProjectId = selectedProject.projectId;
                            btn.textContent = 'ÈáçÊñ∞Â∞ùËØïËé∑ÂèñËÆ§ËØÅÊñá‰ª∂';
                            showStatus(`‰ΩøÁî®ÈÄâÊã©ÁöÑÈ°πÁõÆ ${selectedProject.name} (${selectedProject.projectId}) ÈáçÊñ∞Â∞ùËØï...`, 'info');
                            setTimeout(() => getCredentials(), 1000);
                            return;
                        } else {
                            showStatus('Êó†ÊïàÁöÑÈÄâÊã©ÔºåËØ∑ÈáçÊñ∞ÂºÄÂßãËÆ§ËØÅ', 'error');
                        }
                    }
                    // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊâãÂä®ËæìÂÖ•È°πÁõÆID
                    else if (data.requires_manual_project_id) {
                        const userProjectId = prompt('Êó†Ê≥ïËá™Âä®Ê£ÄÊµãÈ°πÁõÆIDÔºåËØ∑ÊâãÂä®ËæìÂÖ•ÊÇ®ÁöÑGoogle CloudÈ°πÁõÆID:');
                        if (userProjectId && userProjectId.trim()) {
                            // ÈáçÊñ∞Â∞ùËØïÔºå‰ΩøÁî®Áî®Êà∑ËæìÂÖ•ÁöÑÈ°πÁõÆID
                            currentProjectId = userProjectId.trim();
                            btn.textContent = 'ÈáçÊñ∞Â∞ùËØïËé∑ÂèñËÆ§ËØÅÊñá‰ª∂';
                            showStatus('‰ΩøÁî®ÊâãÂä®ËæìÂÖ•ÁöÑÈ°πÁõÆIDÈáçÊñ∞Â∞ùËØï...', 'info');
                            setTimeout(() => getCredentials(), 1000);
                            return;
                        } else {
                            showStatus('ÈúÄË¶ÅÈ°πÁõÆIDÊâçËÉΩÂÆåÊàêËÆ§ËØÅÔºåËØ∑ÈáçÊñ∞ÂºÄÂßãÂπ∂ËæìÂÖ•Ê≠£Á°ÆÁöÑÈ°πÁõÆID', 'error');
                        }
                    } else {
                        showStatus(`‚ùå ÈîôËØØ: ${data.error || 'Ëé∑ÂèñËÆ§ËØÅÊñá‰ª∂Â§±Ë¥•'}`, 'error');
                        if (data.error && data.error.includes('Êú™Êé•Êî∂Âà∞ÊéàÊùÉÂõûË∞É')) {
                            showStatus('ÊèêÁ§∫ÔºöËØ∑Á°Æ‰øùÂ∑≤ÂÆåÊàêÊµèËßàÂô®‰∏≠ÁöÑOAuthËÆ§ËØÅÔºåÂπ∂ÁúãÂà∞‰∫Ü"OAuth authentication successful"È°µÈù¢', 'info');
                        }
                    }
                }
            } catch (error) {
                showStatus(`ÁΩëÁªúÈîôËØØ: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Ëé∑ÂèñËÆ§ËØÅÊñá‰ª∂';
            }
        }

        // Êñá‰ª∂‰∏ä‰º†Áõ∏ÂÖ≥ÂáΩÊï∞
        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            addFiles(files);
        }

        function addFiles(files) {
            files.forEach(file => {
                if (file.type === 'application/json' || file.name.endsWith('.json') ||
                    file.type === 'application/zip' || file.name.endsWith('.zip')) {
                    if (!uploadSelectedFiles.find(f => f.name === file.name && f.size === file.size)) {
                        uploadSelectedFiles.push(file);
                    }
                } else {
                    showStatus(`Êñá‰ª∂ ${file.name} Ê†ºÂºè‰∏çÊîØÊåÅÔºåÂè™ÊîØÊåÅJSONÂíåZIPÊñá‰ª∂`, 'error');
                }
            });

            updateFileList();
        }

        function updateFileList() {
            const fileList = document.getElementById('fileList');
            const fileListSection = document.getElementById('fileListSection');

            if (uploadSelectedFiles.length === 0) {
                fileListSection.classList.add('hidden');
                return;
            }

            fileListSection.classList.remove('hidden');
            fileList.innerHTML = '';

            uploadSelectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                const isZip = file.name.endsWith('.zip');
                const fileIcon = isZip ? 'üì¶' : 'üìÑ';
                const fileType = isZip ? ' (ZIPÂéãÁº©ÂåÖ)' : ' (JSONÊñá‰ª∂)';
                fileItem.innerHTML = `
                    <div>
                        <span class="file-name">${fileIcon} ${file.name}</span>
                        <span class="file-size">(${formatFileSize(file.size)}${fileType})</span>
                    </div>
                    <button class="remove-btn" onclick="removeFile(${index})">Âà†Èô§</button>
                `;
                fileList.appendChild(fileItem);
            });
        }

        function removeFile(index) {
            uploadSelectedFiles.splice(index, 1);
            updateFileList();
        }

        function clearFiles() {
            uploadSelectedFiles = [];
            updateFileList();
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return Math.round(bytes / 1024) + ' KB';
            return Math.round(bytes / (1024 * 1024)) + ' MB';
        }

        async function uploadFiles() {
            if (uploadSelectedFiles.length === 0) {
                showStatus('ËØ∑ÈÄâÊã©Ë¶Å‰∏ä‰º†ÁöÑÊñá‰ª∂', 'error');
                return;
            }

            // Ê£ÄÊü•Êñá‰ª∂Â§ßÂ∞è
            const totalSize = uploadSelectedFiles.reduce((sum, file) => sum + file.size, 0);
            const maxSize = 200 * 1024 * 1024; // 200MB limit
            if (totalSize > maxSize) {
                showStatus(`Êñá‰ª∂ÊÄªÂ§ßÂ∞è ${(totalSize / 1024 / 1024).toFixed(1)}MB Ë∂ÖËøáÈôêÂà∂ ${maxSize / 1024 / 1024}MB„ÄÇËØ∑ÂàÜÊâπ‰∏ä‰º†ÊàñÂà†Èô§ÈÉ®ÂàÜÊñá‰ª∂„ÄÇ`, 'error');
                return;
            }

            // Ê£ÄÊü•Âçï‰∏™Êñá‰ª∂Â§ßÂ∞è
            for (const file of uploadSelectedFiles) {
                if (file.size > 5 * 1024 * 1024) {
                    showStatus(`Êñá‰ª∂ "${file.name}" Â§ßÂ∞è ${(file.size / 1024 / 1024).toFixed(1)}MB Ë∂ÖËøáÂçïÊñá‰ª∂5MBÈôêÂà∂`, 'error');
                    return;
                }
            }

            const progressSection = document.getElementById('uploadProgressSection');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');

            progressSection.classList.remove('hidden');

            const formData = new FormData();
            uploadSelectedFiles.forEach(file => {
                formData.append('files', file);
            });

            // Ê£ÄÊü•ÊòØÂê¶ÊúâZIPÊñá‰ª∂ÔºåÁªôÁî®Êà∑ÊèêÁ§∫
            const hasZipFiles = uploadSelectedFiles.some(file => file.name.endsWith('.zip'));
            if (hasZipFiles) {
                showStatus('Ê≠£Âú®‰∏ä‰º†Âπ∂Ëß£ÂéãZIPÊñá‰ª∂...', 'info');
            }

            try {
                const xhr = new XMLHttpRequest();

                // ËÆæÁΩÆË∂ÖÊó∂Êó∂Èó¥ (5ÂàÜÈíü)
                xhr.timeout = 300000;

                xhr.upload.onprogress = function (event) {
                    if (event.lengthComputable) {
                        const percentComplete = (event.loaded / event.total) * 100;
                        progressFill.style.width = percentComplete + '%';
                        progressText.textContent = Math.round(percentComplete) + '%';
                    }
                };

                xhr.onload = function () {
                    if (xhr.status === 200) {
                        try {
                            const data = JSON.parse(xhr.responseText);
                            showStatus(`ÊàêÂäü‰∏ä‰º† ${data.uploaded_count} ‰∏™Êñá‰ª∂`, 'success');
                            clearFiles();
                            progressSection.classList.add('hidden');
                        } catch (e) {
                            showStatus('‰∏ä‰º†Â§±Ë¥•: ÊúçÂä°Âô®ÂìçÂ∫îÊ†ºÂºèÈîôËØØ', 'error');
                        }
                    } else {
                        try {
                            const error = JSON.parse(xhr.responseText);
                            showStatus(`‰∏ä‰º†Â§±Ë¥•: ${error.detail || error.error || 'Êú™Áü•ÈîôËØØ'}`, 'error');
                        } catch (e) {
                            showStatus(`‰∏ä‰º†Â§±Ë¥•: HTTP ${xhr.status} - ${xhr.statusText || 'Êú™Áü•ÈîôËØØ'}`, 'error');
                        }
                    }
                };

                xhr.onerror = function () {
                    console.error('Upload XHR error:', {
                        readyState: xhr.readyState,
                        status: xhr.status,
                        statusText: xhr.statusText,
                        responseText: xhr.responseText,
                        fileCount: uploadSelectedFiles.length,
                        totalSize: (totalSize / 1024 / 1024).toFixed(1) + 'MB'
                    });
                    showStatus(`‰∏ä‰º†Â§±Ë¥•ÔºöËøûÊé•‰∏≠Êñ≠ - ÂèØËÉΩÂéüÂõ†ÔºöÊñá‰ª∂ËøáÂ§ö(${uploadSelectedFiles.length}‰∏™)ÊàñÁΩëÁªú‰∏çÁ®≥ÂÆö„ÄÇÂª∫ËÆÆÂàÜÊâπ‰∏ä‰º†„ÄÇ`, 'error');
                    progressSection.classList.add('hidden');
                };

                xhr.ontimeout = function () {
                    showStatus('‰∏ä‰º†Â§±Ë¥•ÔºöËØ∑Ê±ÇË∂ÖÊó∂ - Êñá‰ª∂Â§ÑÁêÜÊó∂Èó¥ËøáÈïøÔºåËØ∑ÂáèÂ∞ëÊñá‰ª∂Êï∞ÈáèÊàñÊ£ÄÊü•ÁΩëÁªúËøûÊé•', 'error');
                    progressSection.classList.add('hidden');
                };

                xhr.open('POST', '/auth/upload');
                xhr.setRequestHeader('Authorization', `Bearer ${authToken}`);
                xhr.send(formData);

            } catch (error) {
                showStatus(`‰∏ä‰º†Â§±Ë¥•: ${error.message}`, 'error');
            }
        }

        // ÊãñÊãΩÂäüËÉΩ
        const uploadArea = document.getElementById('uploadArea');

        uploadArea.addEventListener('dragover', function (event) {
            event.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', function (event) {
            event.preventDefault();
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', function (event) {
            event.preventDefault();
            uploadArea.classList.remove('dragover');

            const files = Array.from(event.dataTransfer.files);
            addFiles(files);
        });

        // WebSocketÊó•ÂøóÁõ∏ÂÖ≥ÂèòÈáèÂíåÂáΩÊï∞
        let logWebSocket = null;
        let allLogs = [];
        let filteredLogs = [];
        let currentLogFilter = 'all';

        function connectWebSocket() {
            if (logWebSocket && logWebSocket.readyState === WebSocket.OPEN) {
                showStatus('WebSocketÂ∑≤ÁªèËøûÊé•', 'info');
                return;
            }

            try {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/auth/logs/stream?token=${encodeURIComponent(authToken)}`;

                document.getElementById('connectionStatusText').textContent = 'ËøûÊé•‰∏≠...';
                document.getElementById('logConnectionStatus').className = 'status info';

                logWebSocket = new WebSocket(wsUrl);

                logWebSocket.onopen = function (event) {
                    document.getElementById('connectionStatusText').textContent = 'Â∑≤ËøûÊé•';
                    document.getElementById('logConnectionStatus').className = 'status success';
                    showStatus('Êó•ÂøóÊµÅËøûÊé•ÊàêÂäü', 'success');
                    clearLogsDisplay(); // Âè™Ê∏ÖÁ©∫ÂâçÁ´ØÊòæÁ§∫ÁöÑÊóßÊó•ÂøóÔºå‰∏çÊ∏ÖÁ©∫ÊúçÂä°Âô®Êñá‰ª∂
                };

                logWebSocket.onmessage = function (event) {
                    const logLine = event.data;
                    if (logLine.trim()) {
                        allLogs.push(logLine);

                        // ÈôêÂà∂Êó•ÂøóÊï∞ÈáèÔºå‰øùÁïôÊúÄÂêé1000Êù°
                        if (allLogs.length > 1000) {
                            allLogs = allLogs.slice(-1000);
                        }

                        filterLogs();

                        // Ëá™Âä®ÊªöÂä®Âà∞Â∫ïÈÉ®
                        if (document.getElementById('autoScroll').checked) {
                            const logContainer = document.getElementById('logContainer');
                            logContainer.scrollTop = logContainer.scrollHeight;
                        }
                    }
                };

                logWebSocket.onclose = function (event) {
                    document.getElementById('connectionStatusText').textContent = 'ËøûÊé•Êñ≠ÂºÄ';
                    document.getElementById('logConnectionStatus').className = 'status error';
                    showStatus('Êó•ÂøóÊµÅËøûÊé•Êñ≠ÂºÄ', 'info');
                };

                logWebSocket.onerror = function (error) {
                    document.getElementById('connectionStatusText').textContent = 'ËøûÊé•ÈîôËØØ';
                    document.getElementById('logConnectionStatus').className = 'status error';
                    showStatus('Êó•ÂøóÊµÅËøûÊé•ÈîôËØØ: ' + error, 'error');
                };

            } catch (error) {
                showStatus('ÂàõÂª∫WebSocketËøûÊé•Â§±Ë¥•: ' + error.message, 'error');
                document.getElementById('connectionStatusText').textContent = 'ËøûÊé•Â§±Ë¥•';
                document.getElementById('logConnectionStatus').className = 'status error';
            }
        }

        function disconnectWebSocket() {
            if (logWebSocket) {
                logWebSocket.close();
                logWebSocket = null;
                document.getElementById('connectionStatusText').textContent = 'Êú™ËøûÊé•';
                document.getElementById('logConnectionStatus').className = 'status info';
                showStatus('Êó•ÂøóÊµÅËøûÊé•Â∑≤Êñ≠ÂºÄ', 'info');
            }
        }

        function clearLogsDisplay() {
            // Âè™Ê∏ÖÁ©∫ÂâçÁ´ØÊòæÁ§∫ÁöÑÊó•ÂøóÔºå‰∏çÊ∏ÖÁ©∫ÊúçÂä°Âô®Êñá‰ª∂
            allLogs = [];
            filteredLogs = [];
            document.getElementById('logContent').textContent = 'Êó•ÂøóÂ∑≤Ê∏ÖÁ©∫ÔºåÁ≠âÂæÖÊñ∞Êó•Âøó...';
        }

        async function downloadLogs() {
            try {
                // Ë∞ÉÁî®ÂêéÁ´ØAPI‰∏ãËΩΩÊó•ÂøóÊñá‰ª∂
                const response = await fetch('/auth/logs/download', {
                    method: 'GET',
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    // Ëé∑ÂèñÊñá‰ª∂Âêç
                    const contentDisposition = response.headers.get('Content-Disposition');
                    let filename = 'gcli2api_logs.txt';
                    if (contentDisposition) {
                        const filenameMatch = contentDisposition.match(/filename=(.+)/);
                        if (filenameMatch) {
                            filename = filenameMatch[1];
                        }
                    }

                    // ‰∏ãËΩΩÊñá‰ª∂
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);

                    showStatus(`Êó•ÂøóÊñá‰ª∂‰∏ãËΩΩÊàêÂäü: ${filename}`, 'success');
                } else {
                    const errorText = await response.text();
                    let errorMsg = '‰∏ãËΩΩÂ§±Ë¥•';
                    try {
                        const errorData = JSON.parse(errorText);
                        errorMsg = errorData.detail || errorData.error || 'Êú™Áü•ÈîôËØØ';
                    } catch (e) {
                        errorMsg = errorText || 'Êú™Áü•ÈîôËØØ';
                    }
                    showStatus(`‰∏ãËΩΩÊó•ÂøóÂ§±Ë¥•: ${errorMsg}`, 'error');
                }
            } catch (error) {
                console.error('downloadLogs error:', error);
                showStatus(`‰∏ãËΩΩÊó•ÂøóÊó∂ÁΩëÁªúÈîôËØØ: ${error.message}`, 'error');
            }
        }

        async function clearLogs() {
            try {
                // Ë∞ÉÁî®ÂêéÁ´ØAPIÊ∏ÖÁ©∫Êó•ÂøóÊñá‰ª∂
                const response = await fetch('/auth/logs/clear', {
                    method: 'POST',
                    headers: getAuthHeaders()
                });

                const data = await response.json();

                if (response.ok) {
                    // Ê∏ÖÁ©∫ÂâçÁ´ØÊòæÁ§∫ÁöÑÊó•Âøó
                    clearLogsDisplay();
                    showStatus(data.message, 'success');
                } else {
                    showStatus(`Ê∏ÖÁ©∫Êó•ÂøóÂ§±Ë¥•: ${data.detail || data.error || 'Êú™Áü•ÈîôËØØ'}`, 'error');
                }
            } catch (error) {
                console.error('clearLogs error:', error);
                // Âç≥‰ΩøÂêéÁ´ØÊ∏ÖÁ©∫Â§±Ë¥•Ôºå‰πüÊ∏ÖÁ©∫ÂâçÁ´ØÊòæÁ§∫
                clearLogsDisplay();
                showStatus(`Ê∏ÖÁ©∫Êó•ÂøóÊó∂ÁΩëÁªúÈîôËØØ: ${error.message}`, 'error');
            }
        }

        function filterLogs() {
            const filter = document.getElementById('logLevelFilter').value;
            currentLogFilter = filter;

            if (filter === 'all') {
                filteredLogs = [...allLogs];
            } else {
                filteredLogs = allLogs.filter(log => log.toUpperCase().includes(filter));
            }

            displayLogs();
        }

        function displayLogs() {
            const logContent = document.getElementById('logContent');
            if (filteredLogs.length === 0) {
                logContent.textContent = currentLogFilter === 'all' ?
                    'ÊöÇÊó†Êó•Âøó...' : `ÊöÇÊó†${currentLogFilter}Á∫ßÂà´ÁöÑÊó•Âøó...`;
            } else {
                logContent.textContent = filteredLogs.join('\n');
            }
        }

        // Âá≠ËØÅÊñá‰ª∂ÁÆ°ÁêÜÁõ∏ÂÖ≥ÂáΩÊï∞
        async function refreshCredsStatus() {
            const credsLoading = document.getElementById('credsLoading');
            const credsList = document.getElementById('credsList');

            try {
                credsLoading.style.display = 'block';
                credsList.innerHTML = '';

                console.log('Fetching creds status...');

                const response = await fetch('/creds/status', {
                    method: 'GET',
                    headers: getAuthHeaders()
                });

                console.log('Creds status response:', response.status);

                const data = await response.json();
                console.log('Creds status data:', data);

                if (response.ok) {
                    credsData = data.creds;

                    // ËÆ°ÁÆóÁªüËÆ°Êï∞ÊçÆ
                    calculateStats();

                    // Êõ¥Êñ∞ÁªüËÆ°ÊòæÁ§∫
                    updateStatsDisplay();

                    // Â∫îÁî®Á≠õÈÄâÂπ∂ÊòæÁ§∫Á¨¨‰∏ÄÈ°µ
                    currentPage = 1;
                    applyFilters();

                    showStatus(`Â∑≤Âä†ËΩΩ ${Object.keys(credsData).length} ‰∏™Âá≠ËØÅÊñá‰ª∂`, 'success');
                } else {
                    showStatus(`Âä†ËΩΩÂ§±Ë¥•: ${data.detail || data.error || 'Êú™Áü•ÈîôËØØ'}`, 'error');
                }
            } catch (error) {
                console.error('refreshCredsStatus error:', error);
                showStatus(`ÁΩëÁªúÈîôËØØ: ${error.message}`, 'error');
            } finally {
                credsLoading.style.display = 'none';
            }
        }

        // ËÆ°ÁÆóÁªüËÆ°Êï∞ÊçÆ
        function calculateStats() {
            statsData = {
                total: 0,
                normal: 0,
                disabled: 0
            };

            // Ê∏ÖÁ©∫Âπ∂ÈáçÊñ∞Êî∂ÈõÜÈîôËØØÁ†Å
            availableErrorCodes.clear();

            for (const [fullPath, credInfo] of Object.entries(credsData)) {
                statsData.total++;

                if (credInfo.status.disabled) {
                    statsData.disabled++;
                } else {
                    statsData.normal++;
                }

                // Êî∂ÈõÜÈîôËØØÁ†Å‰ø°ÊÅØ
                if (credInfo.status.error_codes && credInfo.status.error_codes.length > 0) {
                    credInfo.status.error_codes.forEach(code => {
                        availableErrorCodes.add(code);
                    });
                }
            }

            // Êõ¥Êñ∞ÈîôËØØÁ†ÅÂø´ÈÄüÁ≠õÈÄâÊåâÈíÆ
            updateErrorCodeBadges();
        }

        // Êõ¥Êñ∞ÈîôËØØÁ†ÅÁ≠õÈÄâÂø´ÈÄüÊåâÈíÆ
        function updateErrorCodeBadges() {
            const errorCodeBadges = document.getElementById('errorCodeBadges');
            errorCodeBadges.innerHTML = '';

            if (availableErrorCodes.size === 0) {
                errorCodeBadges.innerHTML = '<span style="color: #28a745;">ÊâÄÊúâÊñá‰ª∂ÈÉΩÊó†ÈîôËØØ</span>';
                return;
            }

            const sortedCodes = Array.from(availableErrorCodes).sort((a, b) => a - b);
            sortedCodes.forEach(code => {
                const badge = document.createElement('span');
                badge.className = 'error-code-badge';
                badge.textContent = code;
                badge.onclick = () => filterByErrorCode(code);
                errorCodeBadges.appendChild(badge);
            });
        }

        // ÊåâÈîôËØØÁ†ÅÂø´ÈÄüÁ≠õÈÄâ
        function filterByErrorCode(code) {
            document.getElementById('errorCodeFilter').value = code.toString();
            applyFilters();
        }

        // Êõ¥Êñ∞ÁªüËÆ°ÊòæÁ§∫
        function updateStatsDisplay() {
            document.getElementById('statTotal').textContent = statsData.total;
            document.getElementById('statNormal').textContent = statsData.normal;
            document.getElementById('statDisabled').textContent = statsData.disabled;
        }

        // Â∫îÁî®Á≠õÈÄâ
        function applyFilters() {
            const statusFilter = document.getElementById('statusFilter').value;
            const errorCodeFilter = document.getElementById('errorCodeFilter').value;
            currentFilter = statusFilter;
            currentErrorCodeFilter = errorCodeFilter;
            filteredCredsData = {};

            for (const [fullPath, credInfo] of Object.entries(credsData)) {
                let shouldInclude = false;

                // Áä∂ÊÄÅÁ≠õÈÄâ
                switch (statusFilter) {
                    case 'all':
                        shouldInclude = true;
                        break;
                    case 'normal':
                        shouldInclude = !credInfo.status.disabled;
                        break;
                    case 'disabled':
                        shouldInclude = credInfo.status.disabled;
                        break;
                }

                // Â¶ÇÊûúÁä∂ÊÄÅÁ≠õÈÄâÂ∑≤ÁªèÊéíÈô§ÔºåË∑≥ËøáÈîôËØØÁ†ÅÁ≠õÈÄâ
                if (!shouldInclude) {
                    continue;
                }

                // ÈîôËØØÁ†ÅÁ≠õÈÄâ
                const errorCodes = credInfo.status.error_codes || [];
                switch (errorCodeFilter) {
                    case 'all':
                        // ‰øùÊåÅÂΩìÂâçÁä∂ÊÄÅ
                        break;
                    case 'no-errors':
                        shouldInclude = errorCodes.length === 0;
                        break;
                    case 'has-errors':
                        shouldInclude = errorCodes.length > 0;
                        break;
                    default:
                        // ÂÖ∑‰ΩìÈîôËØØÁ†ÅÁ≠õÈÄâ
                        const targetCode = parseInt(errorCodeFilter);
                        if (!isNaN(targetCode)) {
                            shouldInclude = errorCodes.includes(targetCode);
                        }
                        break;
                }

                if (shouldInclude) {
                    filteredCredsData[fullPath] = credInfo;
                }
            }

            // Ê∏ÖÁ©∫ÈÄâÊã©Áä∂ÊÄÅ
            selectedCredFiles.clear();
            updateBatchControls();

            currentPage = 1;
            renderCredsList();
            updatePagination();
        }

        // Ëé∑ÂèñÂΩìÂâçÈ°µÊï∞ÊçÆ
        function getCurrentPageData() {
            const filteredEntries = Object.entries(filteredCredsData);
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            return filteredEntries.slice(startIndex, endIndex);
        }

        // Ëé∑ÂèñÊÄªÈ°µÊï∞
        function getTotalPages() {
            return Math.ceil(Object.keys(filteredCredsData).length / pageSize);
        }

        // Ê∏≤ÊüìÂá≠ËØÅÂàóË°®
        function renderCredsList() {
            const credsList = document.getElementById('credsList');
            credsList.innerHTML = '';

            const currentPageData = getCurrentPageData();

            if (currentPageData.length === 0) {
                const message = Object.keys(credsData).length === 0 ?
                    'ÊöÇÊó†Âá≠ËØÅÊñá‰ª∂' : 'ÂΩìÂâçÁ≠õÈÄâÊù°‰ª∂‰∏ãÊöÇÊó†Êï∞ÊçÆ';
                credsList.innerHTML = `<p style="text-align: center; color: #666;">${message}</p>`;
                document.getElementById('paginationContainer').style.display = 'none';
                return;
            }

            for (const [fullPath, credInfo] of currentPageData) {
                const card = createCredCard(fullPath, credInfo);
                credsList.appendChild(card);
            }

            document.getElementById('paginationContainer').style.display = getTotalPages() > 1 ? 'flex' : 'none';

            // Êõ¥Êñ∞ÊâπÈáèÊéß‰ª∂Áä∂ÊÄÅ
            updateBatchControls();
        }

        // Êõ¥Êñ∞ÂàÜÈ°µ‰ø°ÊÅØ
        function updatePagination() {
            const totalPages = getTotalPages();
            const totalItems = Object.keys(filteredCredsData).length;
            const startItem = (currentPage - 1) * pageSize + 1;
            const endItem = Math.min(currentPage * pageSize, totalItems);

            document.getElementById('paginationInfo').textContent =
                `Á¨¨ ${currentPage} È°µÔºåÂÖ± ${totalPages} È°µ (ÊòæÁ§∫ ${startItem}-${endItem}ÔºåÂÖ± ${totalItems} È°π)`;

            document.getElementById('prevPageBtn').disabled = currentPage <= 1;
            document.getElementById('nextPageBtn').disabled = currentPage >= totalPages;
        }

        // ÂàáÊç¢È°µÈù¢
        function changePage(direction) {
            const totalPages = getTotalPages();
            const newPage = currentPage + direction;

            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderCredsList();
                updatePagination();
            }
        }

        // ÊîπÂèòÊØèÈ°µÊòæÁ§∫Êï∞Èáè
        function changePageSize() {
            pageSize = parseInt(document.getElementById('pageSizeSelect').value);
            currentPage = 1;
            renderCredsList();
            updatePagination();
        }

        function createCredCard(fullPath, credInfo) {
            const div = document.createElement('div');
            const status = credInfo.status;
            const filename = credInfo.filename;

            // Ë∞ÉËØïÔºöËÆ∞ÂΩïÁä∂ÊÄÅ
            if (filename.includes('atomic-affinity')) {
                console.log(`Creating card for ${filename}:`, status);
            }

            // ËÆæÁΩÆÂç°ÁâáÁä∂ÊÄÅÊ†∑Âºè
            let cardClass = 'cred-card';
            if (status.disabled) cardClass += ' disabled';

            div.className = cardClass;

            // ÂàõÂª∫Áä∂ÊÄÅÊ†áÁ≠æ
            let statusBadges = '';
            if (status.disabled) {
                statusBadges += '<span class="status-badge disabled">Â∑≤Á¶ÅÁî®</span>';
            } else {
                statusBadges += '<span class="status-badge enabled">Â∑≤ÂêØÁî®</span>';
            }


            // Ë∞ÉËØïÔºöËÆ∞ÂΩï error_codes
            console.log(`Error codes for ${filename}:`, status.error_codes);

            if (status.error_codes && status.error_codes.length > 0) {
                statusBadges += `<span class="error-codes">ÈîôËØØÁ†Å: ${status.error_codes.join(', ')}</span>`;
                // Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´Ëá™Âä®Â∞ÅÁ¶ÅÁöÑÈîôËØØÁ†Å
                const autoBanErrors = status.error_codes.filter(code => code === 400 || code === 403);
                if (autoBanErrors.length > 0 && status.disabled) {
                    statusBadges += `<span class="status-badge" style="background-color: #e74c3c; color: white;">AUTO_BAN</span>`;
                }
            } else {
                // ÊòæÁ§∫Êó†ÈîôËØØÁ†ÅÁä∂ÊÄÅ
                statusBadges += `<span class="status-badge" style="background-color: #28a745; color: white;">Êó†ÈîôËØØ</span>`;
            }

            // ‰∏∫HTML IDÁîüÊàêÂÆâÂÖ®ÁöÑÊ†áËØÜÁ¨¶
            const pathId = btoa(encodeURIComponent(fullPath)).replace(/[+/=]/g, '_');

            // ÂàõÂª∫Êìç‰ΩúÊåâÈíÆ - ‰ΩøÁî®Êñá‰ª∂ÂêçËÄå‰∏çÊòØÂÆåÊï¥Ë∑ØÂæÑ
            let actionButtons = '';
            if (status.disabled) {
                actionButtons += `<button class="cred-btn enable" data-filename="${filename}" data-action="enable">ÂêØÁî®</button>`;
            } else {
                actionButtons += `<button class="cred-btn disable" data-filename="${filename}" data-action="disable">Á¶ÅÁî®</button>`;
            }

            actionButtons += `
                <button class="cred-btn view" onclick="toggleCredDetails('${pathId}')">Êü•ÁúãÂÜÖÂÆπ</button>
                <button class="cred-btn download" onclick="downloadCred('${filename}')">‰∏ãËΩΩ</button>
                <button class="cred-btn email" onclick="fetchUserEmail('${filename}')">Êü•ÁúãË¥¶Âè∑ÈÇÆÁÆ±</button>
                <button class="cred-btn delete" data-filename="${filename}" data-action="delete">Âà†Èô§</button>
            `;

            // ÊûÑÂª∫ÈÇÆÁÆ±ÊòæÁ§∫
            let emailInfo = '';
            if (credInfo.user_email) {
                emailInfo = `<div class="cred-email" style="font-size: 12px; color: #666; margin-top: 2px;">${credInfo.user_email}</div>`;
            } else {
                emailInfo = `<div class="cred-email" style="font-size: 12px; color: #999; margin-top: 2px; font-style: italic;">Êú™Ëé∑ÂèñÈÇÆÁÆ±</div>`;
            }

            div.innerHTML = `
                <div class="cred-header">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" class="file-checkbox" data-filename="${filename}" onchange="toggleFileSelection('${filename}')">
                        <div>
                            <div class="cred-filename">${filename}</div>
                            ${emailInfo}
                        </div>
                    </div>
                    <div class="cred-status">${statusBadges}</div>
                </div>
                <div class="cred-actions">${actionButtons}</div>
                <div class="cred-details" id="details-${pathId}">
                    <div class="cred-content"></div>
                </div>
            `;

            // ËÆæÁΩÆÊñá‰ª∂ÂÜÖÂÆπÔºàÈÅøÂÖçHTMLÊ≥®ÂÖ•Ôºâ
            const contentDiv = div.querySelector('.cred-content');
            if (credInfo.content) {
                contentDiv.textContent = JSON.stringify(credInfo.content, null, 2);
            } else {
                contentDiv.textContent = credInfo.error || 'Êó†Ê≥ïËØªÂèñÊñá‰ª∂ÂÜÖÂÆπ';
            }

            // Ê∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨Âô®Âà∞ÊåâÈíÆ
            const actionButtonElements = div.querySelectorAll('[data-filename][data-action]');
            actionButtonElements.forEach(button => {
                button.addEventListener('click', function () {
                    const filename = this.getAttribute('data-filename');
                    const action = this.getAttribute('data-action');

                    if (action === 'delete') {
                        deleteCred(filename);
                    } else {
                        credAction(filename, action);
                    }
                });
            });

            return div;
        }

        async function credAction(filename, action) {
            try {
                console.log('Performing action:', action, 'on file:', filename);
                console.log('Filename type:', typeof filename);
                console.log('Filename length:', filename.length);
                console.log('Ends with .json:', filename.endsWith('.json'));

                const requestBody = {
                    filename: filename,
                    action: action
                };

                console.log('Request body:', requestBody);

                const response = await fetch('/creds/action', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(requestBody)
                });

                console.log('Response status:', response.status);

                const data = await response.json();
                console.log('Response data:', data);

                if (response.ok) {
                    showStatus(data.message, 'success');
                    await refreshCredsStatus(); // Âà∑Êñ∞Áä∂ÊÄÅ
                } else {
                    showStatus(`Êìç‰ΩúÂ§±Ë¥•: ${data.detail || data.error || 'Êú™Áü•ÈîôËØØ'}`, 'error');
                }
            } catch (error) {
                console.error('credAction error:', error);
                showStatus(`ÁΩëÁªúÈîôËØØ: ${error.message}`, 'error');
            }
        }

        function toggleCredDetails(pathId) {
            const detailsId = 'details-' + pathId;
            const details = document.getElementById(detailsId);
            if (details) {
                details.classList.toggle('show');
            }
        }

        async function downloadCred(filename) {
            try {
                const response = await fetch(`/creds/download/${filename}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showStatus(`Â∑≤‰∏ãËΩΩÊñá‰ª∂: ${filename}`, 'success');
                } else {
                    const data = await response.json();
                    showStatus(`‰∏ãËΩΩÂ§±Ë¥•: ${data.error}`, 'error');
                }
            } catch (error) {
                showStatus(`‰∏ãËΩΩÂ§±Ë¥•: ${error.message}`, 'error');
            }
        }

        async function downloadAllCreds() {
            try {
                const response = await fetch('/creds/download-all', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = 'credentials.zip';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showStatus('Â∑≤‰∏ãËΩΩÊâÄÊúâÂá≠ËØÅÊñá‰ª∂', 'success');
                } else {
                    const data = await response.json();
                    showStatus(`ÊâìÂåÖ‰∏ãËΩΩÂ§±Ë¥•: ${data.error}`, 'error');
                }
            } catch (error) {
                showStatus(`ÊâìÂåÖ‰∏ãËΩΩÂ§±Ë¥•: ${error.message}`, 'error');
            }
        }

        async function deleteCred(filename) {
            if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§Âá≠ËØÅÊñá‰ª∂ÂêóÔºü\n${filename}`)) {
                return;
            }

            await credAction(filename, 'delete');
        }

        // ÈÖçÁΩÆÁÆ°ÁêÜÁõ∏ÂÖ≥ÂáΩÊï∞
        let currentConfig = {};
        let envLockedFields = new Set();

        async function loadConfig() {
            const configLoading = document.getElementById('configLoading');
            const configForm = document.getElementById('configForm');
            try {
                configLoading.style.display = 'block';
                configForm.classList.add('hidden');
                const response = await fetch('/config/get', { method: 'GET', headers: getAuthHeaders() });
                const data = await response.json();
                if (response.ok) {
                    currentConfig = data.config || {};
                    envLockedFields = new Set(data.env_locked || []);
                    populateConfigForm();
                    configForm.classList.remove('hidden');
                    refreshAllConfig();
                    showStatus('ÈÖçÁΩÆÂä†ËΩΩÊàêÂäü', 'success');
                } else {
                    showStatus(`Âä†ËΩΩÈÖçÁΩÆÂ§±Ë¥•: ${data.detail || data.error || 'Êú™Áü•ÈîôËØØ'}`, 'error');
                }
            } catch (error) {
                showStatus(`ÁΩëÁªúÈîôËØØ: ${error.message}`, 'error');
            } finally {
                configLoading.style.display = 'none';
            }
        }

        function populateConfigForm() {
            const hostEl = document.getElementById('host');
            const portEl = document.getElementById('port');
            const apiPwdEl = document.getElementById('configApiPassword');
            const panelPwdEl = document.getElementById('configPanelPassword');
            const aaiKeysEl = document.getElementById('assemblyApiKeys');
            const useAssemblyEl = document.getElementById('useAssembly');
            const overrideEl = document.getElementById('overrideEnv');
            if (hostEl) hostEl.value = currentConfig.host || '0.0.0.0';
            if (portEl) portEl.value = currentConfig.port || 7861;
            if (apiPwdEl) apiPwdEl.value = currentConfig.api_password || '';
            if (panelPwdEl) panelPwdEl.value = currentConfig.panel_password || '';
            if (aaiKeysEl) {
                const list = currentConfig.assembly_api_keys || [];
                const single = currentConfig.assembly_api_key || '';
                const lines = Array.isArray(list) && list.length > 0 ? list : (single ? [single] : []);
                aaiKeysEl.value = lines.join('\n');
            }
            if (useAssemblyEl) useAssemblyEl.checked = !!currentConfig.use_assembly;
            if (overrideEl) overrideEl.checked = !!currentConfig.override_env;
            const callsRotEl = document.getElementById('callsPerRotation');
            const r429EnEl = document.getElementById('retry429Enabled');
            const r429MaxEl = document.getElementById('retry429MaxRetries');
            const r429IntEl = document.getElementById('retry429Interval');
            const banEnEl = document.getElementById('autoBanEnabled');
            const banCodesEl = document.getElementById('autoBanErrorCodes');
            if (callsRotEl) callsRotEl.value = currentConfig.calls_per_rotation ?? 100;
            if (r429EnEl) r429EnEl.checked = !!currentConfig.retry_429_enabled;
            if (r429MaxEl) r429MaxEl.value = currentConfig.retry_429_max_retries ?? 5;
            if (r429IntEl) r429IntEl.value = currentConfig.retry_429_interval ?? 1.0;
            if (banEnEl) banEnEl.checked = !!currentConfig.auto_ban_enabled;
            if (banCodesEl) banCodesEl.value = Array.isArray(currentConfig.auto_ban_error_codes) ? currentConfig.auto_ban_error_codes.join(',') : (currentConfig.auto_ban_error_codes||'');
            lockField('assemblyApiKeys','ASSEMBLY_API_KEYS');
            lockField('useAssembly','USE_ASSEMBLY');
            lockField('configApiPassword','API_PASSWORD');
            lockField('configPanelPassword','PANEL_PASSWORD');
            lockField('port','PORT');
            lockField('host','HOST');
            const overrideEl2 = document.getElementById('overrideEnv');
            if (overrideEl2) {
                overrideEl2.addEventListener('change', applyLocks);
            }
        }

        function applyLocks(){
            lockField('assemblyApiKeys','ASSEMBLY_API_KEYS');
            lockField('useAssembly','USE_ASSEMBLY');
            lockField('configApiPassword','API_PASSWORD');
            lockField('configPanelPassword','PANEL_PASSWORD');
            lockField('port','PORT');
            lockField('host','HOST');
            lockField('callsPerRotation','CALLS_PER_ROTATION');
            lockField('retry429Enabled','RETRY_429_ENABLED');
            lockField('retry429MaxRetries','RETRY_429_MAX_RETRIES');
            lockField('retry429Interval','RETRY_429_INTERVAL');
            lockField('autoBanEnabled','AUTO_BAN');
            lockField('autoBanErrorCodes','AUTO_BAN_ERROR_CODES');
        }

        function lockField(id, envName) {
            const el = document.getElementById(id);
            if (!el) return;
            const group = el.closest('.form-group') || el.parentElement;
            const overrideEl = document.getElementById('overrideEnv');
            const overrideOn = overrideEl && overrideEl.checked;
            if (envLockedFields.has(envName) && !overrideOn) {
                el.disabled = true;
                if (group) group.classList.add('env-locked');
            } else {
                el.disabled = false;
                if (group) group.classList.remove('env-locked');
            }
        }

        function setConfigField(fieldId, value) {
            const field = document.getElementById(fieldId);
            if (field) {
                field.value = value;

                // Ê£ÄÊü•ÊòØÂê¶Ë¢´ÁéØÂ¢ÉÂèòÈáèÈîöÂÆö
                const configKey = fieldId.replace(/([A-Z])/g, '_$1').toLowerCase();
                if (envLockedFields.has(configKey)) {
                    field.disabled = true;
                    const group = field.closest('.form-group') || field.parentElement;
                    if (group) group.classList.add('env-locked');
                } else {
                    field.disabled = false;
                    const group = field.closest('.form-group') || field.parentElement;
                    if (group) group.classList.remove('env-locked');
                }
            }
        }

        async function saveConfig() {
            const payload = {
                assembly_api_keys: document.getElementById('assemblyApiKeys').value.split(/\n|,/).map(s=>s.trim()).filter(s=>s.length>0),
                use_assembly: document.getElementById('useAssembly').checked,
                override_env: document.getElementById('overrideEnv').checked,
                api_password: document.getElementById('configApiPassword').value.trim(),
                panel_password: document.getElementById('configPanelPassword').value.trim(),
                host: document.getElementById('host').value.trim(),
                port: parseInt(document.getElementById('port').value) || 7861,
                calls_per_rotation: parseInt(document.getElementById('callsPerRotation').value) || 100,
                retry_429_enabled: !!document.getElementById('retry429Enabled').checked,
                retry_429_max_retries: parseInt(document.getElementById('retry429MaxRetries').value) || 5,
                retry_429_interval: parseFloat(document.getElementById('retry429Interval').value) || 1.0,
                auto_ban_enabled: !!document.getElementById('autoBanEnabled').checked,
                auto_ban_error_codes: document.getElementById('autoBanErrorCodes').value
            };
            const generalPwd = document.getElementById('configPassword').value.trim();
            if (generalPwd) payload.password = generalPwd;
            try {
                const response = await fetch('/config/save', { method: 'POST', headers: getAuthHeaders(), body: JSON.stringify(payload) });
                const data = await response.json();
                if (response.ok) {
                    const passwordChanged = (
                        (payload.panel_password && payload.panel_password !== (currentConfig.panel_password||'')) ||
                        (payload.api_password && payload.api_password !== (currentConfig.api_password||'')) ||
                        (payload.password && payload.password !== (currentConfig.password||''))
                    );
                    if (passwordChanged) {
                        authToken = '';
                        document.getElementById('mainSection').classList.add('hidden');
                        document.getElementById('loginSection').classList.remove('hidden');
                        document.getElementById('loginPassword').value = '';
                        showStatus('ÂØÜÁ†ÅÂ∑≤Êõ¥Êñ∞ÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï', 'info');
                    } else {
                        showStatus('ÈÖçÁΩÆ‰øùÂ≠òÊàêÂäü', 'success');
                        setTimeout(() => loadConfig(), 500);
                    }
                } else {
                    showStatus(`‰øùÂ≠òÈÖçÁΩÆÂ§±Ë¥•: ${data.detail || data.error || 'Êú™Áü•ÈîôËØØ'}`, 'error');
                }
            } catch (error) {
                showStatus(`ÁΩëÁªúÈîôËØØ: ${error.message}`, 'error');
            }
        }

        async function refreshAllConfig(){
            const metaEl = document.getElementById('allConfigMeta');
            const metaBar = document.getElementById('configMetaBar');
            const tbl = document.getElementById('allConfigTable');
            try{
                const res = await fetch('/config/all', {headers: getAuthHeaders()});
                const data = await res.json();
                const cfg = data.config || {};
                const backend = data.backend||'file';
                const prefix = data.prefix||'';
                if (metaEl) metaEl.textContent = `ÂêéÁ´Ø: ${backend} ¬∑ ÂâçÁºÄ: ${prefix}`;
                if (metaBar){
                    const colorMap = {redis:'#28a745', file:'#6c757d', postgres:'#0d6efd', mongodb:'#6f42c1'};
                    const bcol = colorMap[backend]||'#6c757d';
                    metaBar.innerHTML = `
                        <span class="badge" style="background:${bcol}; color:white; padding:4px 8px; border-radius:12px">ÂêéÁ´Ø: ${backend}</span>
                        <span class="badge" style="background:#17a2b8; color:white; padding:4px 8px; border-radius:12px">ÂâçÁºÄ: ${prefix}</span>
                        <span style="margin-left:8px; color:#666; font-size:12px">ÂÖ®ÈÉ®ÈÖçÁΩÆÂ∑≤Âà∑Êñ∞Ôºà${Object.keys(cfg).length} È°πÔºâ</span>
                    `;
                }
                const catMap = {
                    host: 'ÊúçÂä°Âô®', port: 'ÊúçÂä°Âô®',
                    api_password: 'ÂØÜÁ†Å', panel_password: 'ÂØÜÁ†Å', password: 'ÂØÜÁ†Å',
                    proxy: 'ÁΩëÁªú',
                    assembly_api_keys: '‰∏äÊ∏∏', assembly_api_key: '‰∏äÊ∏∏', use_assembly: '‰∏äÊ∏∏',
                    override_env: 'Èù¢Êùø',
                    calls_per_rotation: 'ÊÄßËÉΩ',
                    retry_429_enabled: 'ÈáçËØï', retry_429_max_retries: 'ÈáçËØï', retry_429_interval: 'ÈáçËØï',
                    auto_ban_enabled: 'Â∞ÅÁ¶Å', auto_ban_error_codes: 'Â∞ÅÁ¶Å',
                    credentials_dir: 'Â≠òÂÇ®'
                };
                const rows = Object.keys(cfg).sort().map(k=>{
                    const v = cfg[k];
                    const vs = typeof v === 'object' ? JSON.stringify(v) : String(v);
                    const cat = catMap[k] || 'ÂÖ∂‰ªñ';
                    return `<tr><td style="width:120px;color:#666">${cat}</td><td style="width:220px;color:#555">${k}</td><td style="color:#222;overflow-wrap:anywhere;word-break:break-word;">${vs}</td></tr>`;
                }).join('');
                if (tbl) tbl.innerHTML = `<thead><tr><th>ÂàÜÁ±ª</th><th>ÈîÆ</th><th>ÂÄº</th></tr></thead><tbody>${rows}</tbody>`;
                showStatus('ÂÖ®ÈÉ®ÈÖçÁΩÆÂä†ËΩΩÊàêÂäü','success');
            }catch(e){
                showStatus(`Âä†ËΩΩÂÖ®ÈÉ®ÈÖçÁΩÆÂ§±Ë¥•: ${e.message}`,'error');
            }
        }

        // ÁéØÂ¢ÉÂèòÈáèÂá≠ËØÅÁÆ°ÁêÜÁõ∏ÂÖ≥ÂáΩÊï∞
        async function checkEnvCredsStatus() {
            const envStatusLoading = document.getElementById('envStatusLoading');
            const envStatusContent = document.getElementById('envStatusContent');

            try {
                envStatusLoading.style.display = 'block';
                envStatusContent.classList.add('hidden');

                const response = await fetch('/auth/env-creds-status', {
                    method: 'GET',
                    headers: getAuthHeaders()
                });

                const data = await response.json();

                if (response.ok) {
                    // Êõ¥Êñ∞ÁéØÂ¢ÉÂèòÈáèÂàóË°®
                    const envVarsList = document.getElementById('envVarsList');
                    if (Object.keys(data.available_env_vars).length > 0) {
                        envVarsList.textContent = Object.keys(data.available_env_vars).join(', ');
                    } else {
                        envVarsList.textContent = 'Êú™ÊâæÂà∞GCLI_CREDS_*ÁéØÂ¢ÉÂèòÈáè';
                    }

                    // Êõ¥Êñ∞Ëá™Âä®Âä†ËΩΩÁä∂ÊÄÅ
                    const autoLoadStatus = document.getElementById('autoLoadStatus');
                    autoLoadStatus.textContent = data.auto_load_enabled ? '‚úÖ Â∑≤ÂêØÁî®' : '‚ùå Êú™ÂêØÁî®';
                    autoLoadStatus.style.color = data.auto_load_enabled ? '#28a745' : '#dc3545';

                    // Êõ¥Êñ∞Â∑≤ÂØºÂÖ•Êñá‰ª∂ÁªüËÆ°
                    const envFilesCount = document.getElementById('envFilesCount');
                    envFilesCount.textContent = `${data.existing_env_files_count} ‰∏™Êñá‰ª∂`;

                    const envFilesList = document.getElementById('envFilesList');
                    if (data.existing_env_files.length > 0) {
                        envFilesList.textContent = data.existing_env_files.join(', ');
                    } else {
                        envFilesList.textContent = 'Êó†';
                    }

                    envStatusContent.classList.remove('hidden');
                    showStatus('ÁéØÂ¢ÉÂèòÈáèÁä∂ÊÄÅÊ£ÄÊü•ÂÆåÊàê', 'success');
                } else {
                    showStatus(`Ëé∑ÂèñÁéØÂ¢ÉÂèòÈáèÁä∂ÊÄÅÂ§±Ë¥•: ${data.detail || data.error || 'Êú™Áü•ÈîôËØØ'}`, 'error');
                }
            } catch (error) {
                console.error('checkEnvCredsStatus error:', error);
                showStatus(`ÁΩëÁªúÈîôËØØ: ${error.message}`, 'error');
            } finally {
                envStatusLoading.style.display = 'none';
            }
        }

        async function loadEnvCredentials() {
            try {
                showStatus('Ê≠£Âú®‰ªéÁéØÂ¢ÉÂèòÈáèÂØºÂÖ•Âá≠ËØÅ...', 'info');

                const response = await fetch('/auth/load-env-creds', {
                    method: 'POST',
                    headers: getAuthHeaders()
                });

                const data = await response.json();

                if (response.ok) {
                    if (data.loaded_count > 0) {
                        showStatus(`‚úÖ ÊàêÂäüÂØºÂÖ• ${data.loaded_count}/${data.total_count} ‰∏™Âá≠ËØÅÊñá‰ª∂`, 'success');
                        // Âà∑Êñ∞Áä∂ÊÄÅ
                        setTimeout(() => checkEnvCredsStatus(), 1000);
                    } else {
                        showStatus(`‚ö†Ô∏è ${data.message}`, 'info');
                    }
                } else {
                    showStatus(`ÂØºÂÖ•Â§±Ë¥•: ${data.detail || data.error || 'Êú™Áü•ÈîôËØØ'}`, 'error');
                }
            } catch (error) {
                console.error('loadEnvCredentials error:', error);
                showStatus(`ÁΩëÁªúÈîôËØØ: ${error.message}`, 'error');
            }
        }

        async function clearEnvCredentials() {
            if (!confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâ‰ªéÁéØÂ¢ÉÂèòÈáèÂØºÂÖ•ÁöÑÂá≠ËØÅÊñá‰ª∂ÂêóÔºü\nËøôÂ∞ÜÂà†Èô§ÊâÄÊúâÊñá‰ª∂Âêç‰ª• "env-" ÂºÄÂ§¥ÁöÑËÆ§ËØÅÊñá‰ª∂„ÄÇ')) {
                return;
            }

            try {
                showStatus('Ê≠£Âú®Ê∏ÖÈô§ÁéØÂ¢ÉÂèòÈáèÂá≠ËØÅÊñá‰ª∂...', 'info');

                const response = await fetch('/auth/env-creds', {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                const data = await response.json();

                if (response.ok) {
                    showStatus(`‚úÖ ÊàêÂäüÂà†Èô§ ${data.deleted_count} ‰∏™ÁéØÂ¢ÉÂèòÈáèÂá≠ËØÅÊñá‰ª∂`, 'success');
                    // Âà∑Êñ∞Áä∂ÊÄÅ
                    setTimeout(() => checkEnvCredsStatus(), 1000);
                } else {
                    showStatus(`Ê∏ÖÈô§Â§±Ë¥•: ${data.detail || data.error || 'Êú™Áü•ÈîôËØØ'}`, 'error');
                }
            } catch (error) {
                console.error('clearEnvCredentials error:', error);
                showStatus(`ÁΩëÁªúÈîôËØØ: ${error.message}`, 'error');
            }
        }

        // ÊâπÈáèÊìç‰ΩúÁõ∏ÂÖ≥ÂáΩÊï∞
        function toggleFileSelection(filename) {
            if (selectedCredFiles.has(filename)) {
                selectedCredFiles.delete(filename);
            } else {
                selectedCredFiles.add(filename);
            }
            updateBatchControls();
        }

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const fileCheckboxes = document.querySelectorAll('.file-checkbox');

            if (selectAllCheckbox.checked) {
                // ÂÖ®ÈÄâÂΩìÂâçÈ°µÈù¢ÁöÑÊñá‰ª∂
                fileCheckboxes.forEach(checkbox => {
                    const filename = checkbox.getAttribute('data-filename');
                    selectedCredFiles.add(filename);
                    checkbox.checked = true;
                });
            } else {
                // ÂèñÊ∂àÂÖ®ÈÄâ
                selectedCredFiles.clear();
                fileCheckboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
            }
            updateBatchControls();
        }

        function updateBatchControls() {
            const selectedCount = selectedCredFiles.size;
            const selectedCountElement = document.getElementById('selectedCount');
            const batchEnableBtn = document.getElementById('batchEnableBtn');
            const batchDisableBtn = document.getElementById('batchDisableBtn');
            const batchDeleteBtn = document.getElementById('batchDeleteBtn');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');

            selectedCountElement.textContent = `Â∑≤ÈÄâÊã© ${selectedCount} È°π`;

            // ÂêØÁî®/Á¶ÅÁî®ÊâπÈáèÊìç‰ΩúÊåâÈíÆ
            const hasSelection = selectedCount > 0;
            batchEnableBtn.disabled = !hasSelection;
            batchDisableBtn.disabled = !hasSelection;
            batchDeleteBtn.disabled = !hasSelection;

            // Êõ¥Êñ∞ÂÖ®ÈÄâÂ§çÈÄâÊ°ÜÁä∂ÊÄÅ
            const currentPageFileCount = document.querySelectorAll('.file-checkbox').length;
            const currentPageSelectedCount = Array.from(document.querySelectorAll('.file-checkbox'))
                .filter(checkbox => selectedCredFiles.has(checkbox.getAttribute('data-filename'))).length;

            if (currentPageSelectedCount === 0) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = false;
            } else if (currentPageSelectedCount === currentPageFileCount) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = true;
            } else {
                selectAllCheckbox.indeterminate = true;
                selectAllCheckbox.checked = false;
            }

            // Êõ¥Êñ∞È°µÈù¢‰∏äÁöÑÂ§çÈÄâÊ°ÜÁä∂ÊÄÅ
            document.querySelectorAll('.file-checkbox').forEach(checkbox => {
                const filename = checkbox.getAttribute('data-filename');
                checkbox.checked = selectedCredFiles.has(filename);
            });
        }

        async function batchAction(action) {
            const selectedFiles = Array.from(selectedCredFiles);

            if (selectedFiles.length === 0) {
                showStatus('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÊìç‰ΩúÁöÑÊñá‰ª∂', 'error');
                return;
            }

            let confirmMessage = '';
            switch (action) {
                case 'enable':
                    confirmMessage = `Á°ÆÂÆöË¶ÅÂêØÁî®ÈÄâ‰∏≠ÁöÑ ${selectedFiles.length} ‰∏™Êñá‰ª∂ÂêóÔºü`;
                    break;
                case 'disable':
                    confirmMessage = `Á°ÆÂÆöË¶ÅÁ¶ÅÁî®ÈÄâ‰∏≠ÁöÑ ${selectedFiles.length} ‰∏™Êñá‰ª∂ÂêóÔºü`;
                    break;
                case 'delete':
                    confirmMessage = `Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${selectedFiles.length} ‰∏™Êñá‰ª∂ÂêóÔºü\nÊ≥®ÊÑèÔºöÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ`;
                    break;
            }

            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                showStatus(`Ê≠£Âú®ÊâßË°åÊâπÈáè${action === 'enable' ? 'ÂêØÁî®' : action === 'disable' ? 'Á¶ÅÁî®' : 'Âà†Èô§'}Êìç‰Ωú...`, 'info');

                const requestBody = {
                    action: action,
                    filenames: selectedFiles
                };

                const response = await fetch('/creds/batch-action', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                if (response.ok) {
                    showStatus(`ÊâπÈáèÊìç‰ΩúÂÆåÊàêÔºöÊàêÂäüÂ§ÑÁêÜ ${data.success_count}/${selectedFiles.length} ‰∏™Êñá‰ª∂`, 'success');

                    // Ê∏ÖÁ©∫ÈÄâÊã©
                    selectedCredFiles.clear();
                    updateBatchControls();

                    // Âà∑Êñ∞ÂàóË°®
                    await refreshCredsStatus();
                } else {
                    showStatus(`ÊâπÈáèÊìç‰ΩúÂ§±Ë¥•: ${data.detail || data.error || 'Êú™Áü•ÈîôËØØ'}`, 'error');
                }
            } catch (error) {
                console.error('batchAction error:', error);
                showStatus(`ÊâπÈáèÊìç‰ΩúÁΩëÁªúÈîôËØØ: ${error.message}`, 'error');
            }
        }

        // ÈÇÆÁÆ±Áõ∏ÂÖ≥ÂáΩÊï∞
        async function fetchUserEmail(filename) {
            try {
                showStatus('Ê≠£Âú®Ëé∑ÂèñÁî®Êà∑ÈÇÆÁÆ±...', 'info');

                const response = await fetch(`/creds/fetch-email/${encodeURIComponent(filename)}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok && data.user_email) {
                    showStatus(`ÊàêÂäüËé∑ÂèñÈÇÆÁÆ±: ${data.user_email}`, 'success');
                    // Âà∑Êñ∞Âá≠ËØÅÁä∂ÊÄÅ‰ª•Êõ¥Êñ∞ÊòæÁ§∫
                    await refreshCredsStatus();
                } else {
                    showStatus(data.message || 'Êó†Ê≥ïËé∑ÂèñÁî®Êà∑ÈÇÆÁÆ±', 'error');
                }
            } catch (error) {
                console.error('fetchUserEmail error:', error);
                showStatus(`Ëé∑ÂèñÈÇÆÁÆ±Â§±Ë¥•: ${error.message}`, 'error');
            }
        }

        async function refreshAllEmails() {
            try {
                if (!confirm('Á°ÆÂÆöË¶ÅÂà∑Êñ∞ÊâÄÊúâÂá≠ËØÅÁöÑÁî®Êà∑ÈÇÆÁÆ±ÂêóÔºüËøôÂèØËÉΩÈúÄË¶Å‰∏Ä‰∫õÊó∂Èó¥„ÄÇ')) {
                    return;
                }

                showStatus('Ê≠£Âú®Âà∑Êñ∞ÊâÄÊúâÁî®Êà∑ÈÇÆÁÆ±...', 'info');

                const response = await fetch('/creds/refresh-all-emails', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    showStatus(`ÈÇÆÁÆ±Âà∑Êñ∞ÂÆåÊàêÔºöÊàêÂäüËé∑Âèñ ${data.success_count}/${data.total_count} ‰∏™ÈÇÆÁÆ±Âú∞ÂùÄ`, 'success');
                    // Âà∑Êñ∞Âá≠ËØÅÁä∂ÊÄÅ‰ª•Êõ¥Êñ∞ÊòæÁ§∫
                    await refreshCredsStatus();
                } else {
                    showStatus(data.message || 'ÈÇÆÁÆ±Âà∑Êñ∞Â§±Ë¥•', 'error');
                }
            } catch (error) {
                console.error('refreshAllEmails error:', error);
                showStatus(`ÈÇÆÁÆ±Âà∑Êñ∞ÁΩëÁªúÈîôËØØ: ${error.message}`, 'error');
            }
        }

        // Project ID ÊäòÂè†ÂàáÊç¢ÂáΩÊï∞
        function toggleProjectIdSection() {
            const section = document.getElementById('projectIdSection');
            const icon = document.getElementById('projectIdToggleIcon');

            if (section.style.display === 'none') {
                section.style.display = 'block';
                icon.style.transform = 'rotate(90deg)';
                icon.textContent = '‚ñº';
            } else {
                section.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
                icon.textContent = '‚ñ∂';
            }
        }

        // ÂõûË∞ÉURLËæìÂÖ•Âå∫ÂüüÊäòÂè†ÂàáÊç¢ÂáΩÊï∞
        function toggleCallbackUrlSection() {
            const section = document.getElementById('callbackUrlSection');
            const icon = document.getElementById('callbackUrlToggleIcon');

            if (section.style.display === 'none') {
                section.style.display = 'block';
                icon.style.transform = 'rotate(180deg)';
                icon.textContent = '‚ñ≤';
            } else {
                section.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
                icon.textContent = '‚ñº';
            }
        }

        // Â§ÑÁêÜÂõûË∞ÉURLÁöÑÂáΩÊï∞
        async function processCallbackUrl() {
            const callbackUrlInput = document.getElementById('callbackUrlInput');
            const callbackUrl = callbackUrlInput.value.trim();
            const getAllProjects = document.getElementById('getAllProjectsCreds').checked;

            if (!callbackUrl) {
                showStatus('ËØ∑ËæìÂÖ•ÂõûË∞ÉURL', 'error');
                return;
            }

            // ÁÆÄÂçïÈ™åËØÅURLÊ†ºÂºè
            if (!callbackUrl.startsWith('http://') && !callbackUrl.startsWith('https://')) {
                showStatus('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑURLÔºà‰ª•http://Êàñhttps://ÂºÄÂ§¥Ôºâ', 'error');
                return;
            }

            // Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´ÂøÖË¶ÅÂèÇÊï∞
            if (!callbackUrl.includes('code=') || !callbackUrl.includes('state=')) {
                showStatus('‚ùå Ëøô‰∏çÊòØÊúâÊïàÁöÑÂõûË∞ÉURLÔºÅËØ∑Á°Æ‰øùÔºö\n1. Â∑≤ÂÆåÊàêGoogle OAuthÊéàÊùÉ\n2. Â§çÂà∂ÁöÑÊòØÊµèËßàÂô®Âú∞ÂùÄÊ†èÁöÑÂÆåÊï¥URL\n3. URLÂåÖÂê´codeÂíåstateÂèÇÊï∞', 'error');
                return;
            }

            if (getAllProjects) {
                showStatus('Ê≠£Âú®‰ªéÂõûË∞ÉURLÂπ∂ÂèëÊâπÈáèËé∑ÂèñÊâÄÊúâÈ°πÁõÆÂá≠ËØÅ...', 'info');
            } else {
                showStatus('Ê≠£Âú®‰ªéÂõûË∞ÉURLËé∑ÂèñÂá≠ËØÅ...', 'info');
            }

            try {
                // Ëé∑ÂèñÂΩìÂâçÈ°πÁõÆIDËÆæÁΩÆÔºàÂ¶ÇÊûúÊúâÁöÑËØùÔºâ
                const projectIdInput = document.getElementById('projectId');
                const projectId = projectIdInput ? projectIdInput.value.trim() : null;

                const response = await fetch('/auth/callback-url', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        callback_url: callbackUrl,
                        project_id: projectId || null,
                        get_all_projects: getAllProjects
                    })
                });

                const result = await response.json();

                if (getAllProjects && result.multiple_credentials) {
                    // Â§ÑÁêÜÂ§öÈ°πÁõÆËÆ§ËØÅÁªìÊûú
                    const results = result.multiple_credentials;
                    let resultText = `ÊâπÈáèÂπ∂ÂèëËÆ§ËØÅÂÆåÊàêÔºÅÊàêÂäü‰∏∫ ${results.success.length} ‰∏™È°πÁõÆÁîüÊàêÂá≠ËØÅÔºö\n\n`;

                    // ÊòæÁ§∫ÊàêÂäüÁöÑÈ°πÁõÆ
                    results.success.forEach((item, index) => {
                        resultText += `${index + 1}. È°πÁõÆ: ${item.project_name} (${item.project_id})\n`;
                        resultText += `   Êñá‰ª∂: ${item.file_path}\n\n`;
                    });

                    // ÊòæÁ§∫Â§±Ë¥•ÁöÑÈ°πÁõÆÔºàÂ¶ÇÊûúÊúâÔºâ
                    if (results.failed.length > 0) {
                        resultText += `\nÂ§±Ë¥•ÁöÑÈ°πÁõÆ (${results.failed.length} ‰∏™):\n`;
                        results.failed.forEach((item, index) => {
                            resultText += `${index + 1}. È°πÁõÆ: ${item.project_name} (${item.project_id})\n`;
                            resultText += `   ÈîôËØØ: ${item.error}\n\n`;
                        });
                    }

                    // ÊòæÁ§∫ÁªìÊûú
                    document.getElementById('credentialsContent').textContent = resultText;
                    document.getElementById('credentialsSection').classList.remove('hidden');
                    showStatus(`‚úÖ ÊâπÈáèÂπ∂ÂèëËÆ§ËØÅÂÆåÊàêÔºÅÊàêÂäüÁîüÊàê ${results.success.length} ‰∏™È°πÁõÆÁöÑÂá≠ËØÅÊñá‰ª∂${results.failed.length > 0 ? `Ôºå${results.failed.length} ‰∏™È°πÁõÆÂ§±Ë¥•` : ''}`, 'success');

                } else if (result.credentials) {
                    // Â§ÑÁêÜÂçïÈ°πÁõÆËÆ§ËØÅÁªìÊûú
                    showStatus(result.message || '‰ªéÂõûË∞ÉURLËé∑ÂèñÂá≠ËØÅÊàêÂäüÔºÅ', 'success');

                    // ÊòæÁ§∫Âá≠ËØÅÂÜÖÂÆπ
                    document.getElementById('credentialsContent').innerHTML =
                        '<pre>' + JSON.stringify(result.credentials, null, 2) + '</pre>';
                    document.getElementById('credentialsSection').classList.remove('hidden');

                } else if (result.requires_manual_project_id) {
                    showStatus('ÈúÄË¶ÅÊâãÂä®ÊåáÂÆöÈ°πÁõÆIDÔºåËØ∑Âú®È´òÁ∫ßÈÄâÈ°π‰∏≠Â°´ÂÖ•Google CloudÈ°πÁõÆIDÂêéÈáçËØï', 'error');
                } else if (result.requires_project_selection) {
                    let projectOptions = '<br><strong>ÂèØÁî®È°πÁõÆÔºö</strong><br>';
                    result.available_projects.forEach(project => {
                        projectOptions += `‚Ä¢ ${project.name} (ID: ${project.projectId})<br>`;
                    });
                    showStatus('Ê£ÄÊµãÂà∞Â§ö‰∏™È°πÁõÆÔºåËØ∑Âú®È´òÁ∫ßÈÄâÈ°π‰∏≠ÊåáÂÆöÈ°πÁõÆIDÔºö' + projectOptions, 'error');
                } else {
                    showStatus(result.error || '‰ªéÂõûË∞ÉURLËé∑ÂèñÂá≠ËØÅÂ§±Ë¥•', 'error');
                }

                // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
                callbackUrlInput.value = '';

                // Âà∑Êñ∞Âá≠ËØÅÂàóË°®ÔºàÂ¶ÇÊûúÊúâÔºâ
                setTimeout(() => {
                    if (typeof refreshCredsStatus === 'function') {
                        refreshCredsStatus();
                    }
                }, 1000);

            } catch (error) {
                console.error('‰ªéÂõûË∞ÉURLËé∑ÂèñÂá≠ËØÅÊó∂Âá∫Èîô:', error);
                showStatus(`‰ªéÂõûË∞ÉURLËé∑ÂèñÂá≠ËØÅÂ§±Ë¥•: ${error.message}`, 'error');
            }
        }

        // Â§ÑÁêÜÂãæÈÄâÊ°ÜÁä∂ÊÄÅÂèòÂåñ
        function handleGetAllProjectsChange() {
            const checkbox = document.getElementById('getAllProjectsCreds');
            const note = document.getElementById('allProjectsNote');
            const projectIdSection = document.getElementById('projectIdSection');
            const projectIdToggle = document.querySelector('[onclick="toggleProjectIdSection()"]');

            if (checkbox.checked) {
                // ÊòæÁ§∫ÊâπÈáèËÆ§ËØÅÊèêÁ§∫
                note.style.display = 'block';
                // Á¶ÅÁî®È°πÁõÆIDËæìÂÖ•ÔºàÊâπÈáèÊ®°Âºè‰∏ã‰∏çÈúÄË¶ÅÊåáÂÆöÂçï‰∏™È°πÁõÆÔºâ
                if (projectIdSection.style.display !== 'none') {
                    toggleProjectIdSection();
                }
                projectIdToggle.style.opacity = '0.5';
                projectIdToggle.style.pointerEvents = 'none';
                projectIdToggle.title = 'ÊâπÈáèËÆ§ËØÅÊ®°Âºè‰∏ãÊó†ÈúÄÊåáÂÆöÂçï‰∏™È°πÁõÆID';
            } else {
                // ÈöêËóèÊâπÈáèËÆ§ËØÅÊèêÁ§∫
                note.style.display = 'none';
                // ÈáçÊñ∞ÂêØÁî®È°πÁõÆIDËæìÂÖ•
                projectIdToggle.style.opacity = '1';
                projectIdToggle.style.pointerEvents = 'auto';
                projectIdToggle.title = '';
            }
        }

        // È°µÈù¢Âä†ËΩΩÊó∂Ê£ÄÊü•Áä∂ÊÄÅ
        window.onload = function () {
            console.log('Page loaded');
            console.log('Login section exists:', !!document.getElementById('loginSection'));
            console.log('Main section exists:', !!document.getElementById('mainSection'));

            // Ê∑ªÂä†ÂãæÈÄâÊ°Ü‰∫ã‰ª∂ÁõëÂê¨Âô®
            const checkbox = document.getElementById('getAllProjectsCreds');
            if (checkbox) {
                checkbox.addEventListener('change', handleGetAllProjectsChange);
            }

            showStatus('ËØ∑ËæìÂÖ•ÂØÜÁ†ÅÁôªÂΩï', 'info');
        };

        // =====================================================================
        // ‰ΩøÁî®ÁªüËÆ°Áõ∏ÂÖ≥ÂáΩÊï∞
        // =====================================================================

        let usageStatsData = {};
        let currentEditingFile = '';

        // Âà∑Êñ∞‰ΩøÁî®ÁªüËÆ°
        async function refreshUsageStats() {
            const usageLoading = document.getElementById('usageLoading');
            const usageList = document.getElementById('usageList');

            try {
                usageLoading.style.display = 'block';
                usageList.innerHTML = '';

                // Ëé∑ÂèñËÅöÂêàÊï∞ÊçÆÔºàÂåÖÂê´per-key model statisticsÔºâ
                const aggregatedResponse = await fetch('/usage/aggregated', {
                    method: 'GET',
                    headers: getAuthHeaders()
                });

                const aggregatedData = await aggregatedResponse.json();

                if (aggregatedResponse.ok) {
                    // ‰ªéaggregatedData.log_summary.keysÊûÑÂª∫usageStatsData
                    usageStatsData = {};
                    const keys = (aggregatedData.log_summary && aggregatedData.log_summary.keys) || {};
                    
                    // ‰∏∫ÊØè‰∏™keyÂàõÂª∫ÁªüËÆ°Êï∞ÊçÆÁªìÊûÑ
                    for (const [keyName, keyData] of Object.entries(keys)) {
                        // ËÆ°ÁÆóÊÄªË∞ÉÁî®Ê¨°Êï∞ÔºàÊàêÂäü+Â§±Ë¥•Ôºâ
                        const totalCalls = (keyData.ok || 0) + (keyData.fail || 0);
                        
                        usageStatsData[keyName] = {
                            display_name: keyName,
                            total_calls: totalCalls,
                            daily_limit_total: 1000, // ÈªòËÆ§ÈôêÂà∂
                            model_counts: keyData.model_counts || {},
                            next_reset_time: aggregatedData.next_reset_time || null
                        };
                    }

                    document.getElementById('totalApiCalls').textContent = aggregatedData.total_all_model_calls || 0;
                    document.getElementById('totalFiles').textContent = Object.keys(usageStatsData).length;

                    // Ê∏≤Êüì‰ΩøÁî®ÁªüËÆ°ÂàóË°®
                    renderUsageList();

                    showStatus(`Â∑≤Âä†ËΩΩ ${Object.keys(usageStatsData).length} ‰∏™ÂØÜÈí•ÁöÑ‰ΩøÁî®ÁªüËÆ°`, 'success');
                } else {
                    showStatus('Âä†ËΩΩ‰ΩøÁî®ÁªüËÆ°Â§±Ë¥•', 'error');
                }
            } catch (error) {
                showStatus(`ÁΩëÁªúÈîôËØØ: ${error.message}`, 'error');
            } finally {
                usageLoading.style.display = 'none';
            }
        }

        async function checkInvalidKeys(){
            try{
                const res = await fetch('/keys/invalid', { headers: getAuthHeaders() });
                const data = await res.json();
                const list = (data.invalid_keys||[]).map(it=>it.key).join(', ');
                const msg = `Â§±ÊïàÂØÜÈí• ${data.invalid_keys?.length||0} ‰∏™${list? 'Ôºö'+list: ''}`;
                showStatus(msg, 'info');
            }catch(e){
                showStatus('Ê£ÄÊü•Â§±ÊïàÂØÜÈí•Â§±Ë¥•: '+e.message, 'error');
            }
        }

        async function deleteInvalidKeys(){
            if (!confirm('Á°ÆÂÆöË¶ÅÁßªÈô§ÊâÄÊúâÂ§±ÊïàÂØÜÈí•ÁöÑÊï∞ÊçÆÂêóÔºü\n\nËøôÂ∞ÜÔºö\n1. Ê∏ÖÈô§Â§±ÊïàÂØÜÈí•ÁöÑÊó•ÂøóËÆ∞ÂΩï\n2. Ê∏ÖÈô§Â§±ÊïàÂØÜÈí•ÁöÑÁªüËÆ°Êï∞ÊçÆ\n3. Â∞ÜÂ§±ÊïàÂØÜÈí•Âä†ÂÖ•ÂøΩÁï•ÂàóË°®\n\nÊ≥®ÊÑèÔºöÈÖçÁΩÆ‰∏≠ÁöÑÊúâÊïàÂØÜÈí•‰∏ç‰ºöË¢´ÁßªÈô§ÔºÅ')) {
                return;
            }
            try{
                const res = await fetch('/keys/delete-invalid', { method: 'POST', headers: getAuthHeaders() });
                const data = await res.json();
                if(res.ok){
                    showStatus(`Â∑≤ÁßªÈô§Â§±ÊïàÂØÜÈí•Êï∞ÊçÆÔºö${data.invalid_deleted||0} ‰∏™ÂØÜÈí•ÔºåÂ∑≤Âä†ÂÖ•ÂøΩÁï•ÂàóË°® ${data.ignored_count||0} È°π`, 'success');
                    // ÂêåÊ≠•Âà∑Êñ∞Êó•ÂøóÁªüËÆ°‰∏é‰ΩøÁî®ÁªüËÆ°ÂàóË°®
                    await refreshLogSummary();
                    await refreshUsageStats();
                    // ÈáçÊñ∞Ê£ÄÊü•Â§±ÊïàÂØÜÈí•
                    await checkInvalidKeys();
                }else{
                    showStatus('ÁßªÈô§Â§±Ë¥•: '+(data.detail||'Êú™Áü•ÈîôËØØ'), 'error');
                }
            }catch(e){
                showStatus('ÁßªÈô§Â§±ÊïàÂØÜÈí•Êï∞ÊçÆÂ§±Ë¥•: '+e.message, 'error');
            }
        }

        async function refreshLogSummary() {
            const model = document.getElementById('modelFilter').value || '';
            const key = (document.getElementById('keyFilter').value || '').trim();
            const only = document.getElementById('onlyFilter').value || '';
            let url = '/usage/aggregated';
            const params = [];
            if (model) params.push('model=' + encodeURIComponent(model));
            if (key) params.push('key=' + encodeURIComponent(key));
            if (only) params.push('only=' + encodeURIComponent(only));
            // Ê∑ªÂä†Êó∂Èó¥Êà≥Èò≤Ê≠¢ÁºìÂ≠ò
            params.push('_t=' + Date.now());
            if (params.length) url += '?' + params.join('&');
            
            // ‰∏∫ÂÖ®ÈÉ®Êï∞ÊçÆÁöÑËØ∑Ê±Ç‰πüÊ∑ªÂä†Êó∂Èó¥Êà≥
            const urlAll = '/usage/aggregated?_t=' + Date.now();
            
            const [resFiltered, resAll] = await Promise.all([
                fetch(url, { headers: getAuthHeaders() }),
                fetch(urlAll, { headers: getAuthHeaders() })
            ]);
            const data = await resFiltered.json();
            const dataAll = await resAll.json();
            const ls = data.log_summary || {models:{},keys:{},total:{}};
            const lsAll = dataAll.log_summary || {models:{},keys:{},total:{}};
            renderLogSummary(ls);
            // ‰∏ãÊãâÈÄâÈ°πÂßãÁªàÁî®Êú™ËøáÊª§Êï∞ÊçÆÂ°´ÂÖÖÔºåÈÅøÂÖçÂè™Ââ©‰∏Ä‰∏™ÈÄâÈ°π
            populateModelFilter(lsAll);
            populateKeyFilter(lsAll);
            renderModelRanking(ls);
        }

        function populateModelFilter(data){
            const sel = document.getElementById('modelFilter');
            const prev = sel.value;
            sel.innerHTML = '';
            const opt0 = document.createElement('option');
            opt0.value = '';
            opt0.textContent = 'ÂÖ®ÈÉ®Ê®°Âûã';
            sel.appendChild(opt0);
            Object.keys(data.models||{}).forEach(m=>{
                const opt = document.createElement('option');
                opt.value = m;
                opt.textContent = m;
                sel.appendChild(opt);
            });
            sel.value = prev;
        }

        function populateKeyFilter(data){
            const sel = document.getElementById('keyFilter');
            const prev = sel.value;
            sel.innerHTML = '';
            const opt0 = document.createElement('option');
            opt0.value = '';
            opt0.textContent = 'ÂÖ®ÈÉ®ÂØÜÈí•';
            sel.appendChild(opt0);
            Object.keys(data.keys||{}).forEach(k=>{
                const opt = document.createElement('option');
                opt.value = k;
                opt.textContent = k;
                sel.appendChild(opt);
            });
            sel.value = prev;
        }

        function renderLogSummary(data){
            const mDiv = document.getElementById('logSummaryModels');
            const kDiv = document.getElementById('logSummaryKeys');
            const models = data.models||{};
            const keys = data.keys||{};
            let mHtml = '<table class="table"><thead><tr><th>Ê®°Âûã</th><th>ÊàêÂäü</th><th>Â§±Ë¥•</th></tr></thead><tbody>';
            Object.entries(models).forEach(([m,v])=>{
                mHtml += `<tr><td>${m}</td><td>${v.ok||0}</td><td>${v.fail||0}</td></tr>`;
            });
            mHtml += '</tbody></table>';
            let kHtml = '<table class="table"><thead><tr><th>ÂØÜÈí•</th><th>ÊàêÂäü</th><th>Â§±Ë¥•</th><th>Ê®°ÂûãÂàÜÂ∏É</th></tr></thead><tbody>';
            Object.entries(keys).forEach(([kk,v])=>{
                const md = v.models||{};
                const mdStr = Object.entries(md).map(([m,c])=>`${m}: ${c.ok||0}/${c.fail||0}`).join(', ');
                kHtml += `<tr><td>${kk}</td><td>${v.ok||0}</td><td>${v.fail||0}</td><td>${mdStr}</td></tr>`;
            });
            kHtml += '</tbody></table>';
            mDiv.innerHTML = mHtml;
            kDiv.innerHTML = kHtml;
        }

        function renderModelRanking(data){
            const only = document.getElementById('onlyFilter').value || '';
            const models = data.models || {};
            const entries = Object.entries(models).map(([name, v])=>{
                const ok = v.ok || 0;
                const fail = v.fail || 0;
                const count = only==='success' ? ok : (only==='fail' ? fail : (ok + fail));
                return { name, ok, fail, count };
            }).filter(e=> e.count > 0);
            entries.sort((a,b)=> b.count - a.count);
            const max = Math.max(1, ...entries.map(e=> e.count));
            const total = entries.reduce((sum,e)=> sum + e.count, 0);
            let html = `<div class="ranking-header"><div>Ê®°ÂûãË∞ÉÁî®Ê¨°Êï∞ÊéíË°å</div><div style="font-size:12px; color:#666;">ÊÄªËÆ°: ${total}</div></div>`;
            html += `<div class="legend"><div><span class="success-dot"></span>ÊàêÂäü</div><div><span class="fail-dot"></span>Â§±Ë¥•</div></div>`;
            html += `<div class="ranking-list">`;
            entries.forEach(e=>{
                const totalWidth = Math.round((e.count / max) * 100);
                let okW = 0, failW = 0;
                if (only === 'success') {
                    okW = totalWidth;
                    failW = 0;
                } else if (only === 'fail') {
                    okW = 0;
                    failW = totalWidth;
                } else {
                    const ratio = e.count ? (e.ok / e.count) : 0;
                    okW = Math.round(totalWidth * ratio);
                    failW = totalWidth - okW;
                }
                html += `<div class="ranking-item"><div class="ranking-label" title="${e.name}">${e.name}</div><div class="ranking-bar"><div class="ranking-bar-success" style="width:${okW}%"></div><div class="ranking-bar-fail" style="width:${failW}%; left:${okW}%"></div></div><div class="ranking-count">${e.count}</div></div>`;
            });
            html += `</div>`;
            const container = document.getElementById('modelRanking');
            if (container) container.innerHTML = html;
        }

        // Ê∏≤Êüì‰ΩøÁî®ÁªüËÆ°ÂàóË°®
        function renderUsageList() {
            const usageList = document.getElementById('usageList');
            usageList.innerHTML = '';

            if (Object.keys(usageStatsData).length === 0) {
                usageList.innerHTML = '<p style="text-align: center; color: #666;">ÊöÇÊó†‰ΩøÁî®ÁªüËÆ°Êï∞ÊçÆ</p>';
                return;
            }

            for (const [filename, stats] of Object.entries(usageStatsData)) {
                const card = createUsageCard(filename, stats);
                usageList.appendChild(card);
            }
        }

        // ÂàõÂª∫‰ΩøÁî®ÁªüËÆ°Âç°Áâá
        function createUsageCard(filename, stats) {
            const div = document.createElement('div');
            div.className = 'usage-card';

            // ËÆ°ÁÆó‰ΩøÁî®ÁôæÂàÜÊØî
            const totalPercent = Math.min((stats.total_calls / stats.daily_limit_total) * 100, 100);

            function getTotalProgressClass(percent) {
                if (percent >= 90) return 'danger';
                if (percent >= 70) return 'warning';
                return 'total';
            }

            // Ê†ºÂºèÂåñÊó∂Èó¥
            function formatTime(isoString) {
                if (!isoString) return 'Êú™Áü•';
                try {
                    const date = new Date(isoString);
                    return date.toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' });
                } catch (e) {
                    return 'Ê†ºÂºèÈîôËØØ';
                }
            }

            // Ê†ºÂºèÂåñÊòæÁ§∫ÂêçÁß∞
            let displayName = stats.display_name || filename;
            // Â¶ÇÊûúÊòØ key:hash Ê†ºÂºèÔºåËøõË°åËÑ±ÊïèÂ§ÑÁêÜ
            if (displayName.startsWith('key:') && displayName.length > 20) {
                const hash = displayName.substring(4); // ÁßªÈô§ "key:" ÂâçÁºÄ
                displayName = `Key: ${hash.substring(0, 4)}...${hash.substring(hash.length - 4)}`;
            }
            
            div.innerHTML = `
                <div class="usage-header">
                    <div class="usage-filename">${displayName}</div>
                </div>
                
                <div class="usage-progress">
                    <div class="usage-progress-label">
                        <span>ÊâÄÊúâÊ®°Âûã</span>
                        <span>${stats.total_calls}/${stats.daily_limit_total} (${totalPercent.toFixed(1)}%)</span>
                    </div>
                    <div class="usage-progress-bar">
                        <div class="usage-progress-fill ${getTotalProgressClass(totalPercent)}" style="width: ${totalPercent}%"></div>
                    </div>
                </div>
                
                <div class="usage-info">
                    <div class="usage-info-item" style="grid-column: 1 / -1;">
                        <span class="usage-info-label">‰∏ãÊ¨°ÈáçÁΩÆÊó∂Èó¥</span>
                        <span class="usage-info-value">${formatTime(stats.next_reset_time)}</span>
                    </div>
                </div>
                <div style="margin-top:12px">
                    <div style="font-size:13px; font-weight:600; color:#555; margin-bottom:8px">ÂêÑÊ®°ÂûãË∞ÉÁî®Ê¨°Êï∞</div>
                    <div style="display:flex; gap:6px; flex-wrap:wrap; min-height:24px">
                        ${Object.keys(stats.model_counts||{}).length===0 ? 
                            '<span style="color:#999; font-size:12px">ÊöÇÊó†Êï∞ÊçÆ</span>' : 
                            Object.entries(stats.model_counts||{})
                                .sort((a, b) => b[1] - a[1])  // ÊåâË∞ÉÁî®Ê¨°Êï∞‰ªéÂ§ßÂà∞Â∞èÊéíÂ∫è
                                .map(([m, c]) => {
                                    const cat = getModelCategory(m);
                                    const colors = getCatColors(cat);
                                    return `<span style="display:inline-flex; align-items:center; gap:4px; background:${colors.bg}; color:${colors.text}; padding:4px 10px; border-radius:12px; font-size:12px; border-left:4px solid ${colors.border}">
                                        <span style="font-weight:600; color:${colors.border}">„Äê${c}„Äë</span>
                                        <span>${m}</span>
                                    </span>`;
                                }).join('')
                        }
                    </div>
                </div>
                
                <div class="usage-actions">
                    <button class="usage-btn limits" onclick="openLimitsModal('${filename}')">ËÆæÁΩÆÈôêÂà∂</button>
                </div>
            `;

            return div;
        }

        // ÊâìÂºÄÈôêÂà∂ËÆæÁΩÆÂºπÁ™ó
        function openLimitsModal(filename) {
            const stats = usageStatsData[filename];
            if (!stats) {
                showStatus('Êâæ‰∏çÂà∞Êñá‰ª∂ÁªüËÆ°Êï∞ÊçÆ', 'error');
                return;
            }

            currentEditingFile = filename;
            document.getElementById('modalFilename').value = filename;
            document.getElementById('modalTotalLimit').value = stats.daily_limit_total;
            document.getElementById('limitsModal').style.display = 'block';
        }

        // ÂÖ≥Èó≠ÈôêÂà∂ËÆæÁΩÆÂºπÁ™ó
        function closeLimitsModal() {
            document.getElementById('limitsModal').style.display = 'none';
            currentEditingFile = '';
        }

        // ‰øùÂ≠òÈôêÂà∂ËÆæÁΩÆ
        async function saveLimits() {
            const totalLimit = parseInt(document.getElementById('modalTotalLimit').value);
            if (isNaN(totalLimit) || totalLimit < 1) {
                showStatus('ÊÄªË∞ÉÁî®ÈôêÂà∂ÂøÖÈ°ªÊòØÂ§ß‰∫é0ÁöÑÊï∞Â≠ó', 'error');
                return;
            }

            try {
                const response = await fetch('/usage/update-limits', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        filename: currentEditingFile,
                        total_limit: totalLimit
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showStatus(data.message, 'success');
                    closeLimitsModal();
                    // Âà∑Êñ∞ÁªüËÆ°Êï∞ÊçÆ
                    await refreshUsageStats();
                } else {
                    showStatus(`ËÆæÁΩÆÂ§±Ë¥•: ${data.detail || data.error || 'Êú™Áü•ÈîôËØØ'}`, 'error');
                }
            } catch (error) {
                console.error('saveLimits error:', error);
                showStatus(`ÁΩëÁªúÈîôËØØ: ${error.message}`, 'error');
            }
        }

        

        // ÂÖ≥Èó≠ÂºπÁ™óÂΩìÁÇπÂáªÂºπÁ™óÂ§ñÈÉ®Êó∂
        window.onclick = function (event) {
            const modal = document.getElementById('limitsModal');
            if (event.target == modal) {
                closeLimitsModal();
            }
        }

        
    </script>
    <!-- Ê®°ÂûãÈÄâÊã©ÂºπÁ™ó -->
    <div id="modelsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ÈÄâÊã©Ê®°Âûã</h3>
                <button class="modal-close" onclick="closeModelsModal()">&times;</button>
            </div>
            <div class="modal-body" id="modelsModalBody" style="max-height:420px; overflow:auto"></div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModelsModal()" style="background:#6c757d">ÂèñÊ∂à</button>
                <button class="btn" onclick="saveSelectedModels()">Á°ÆÂÆö</button>
            </div>
        </div>
    </div>
<script>
        // Temperature Âíå Max Tokens ÊªëÂùóÊõ¥Êñ∞ÂáΩÊï∞
        function updateTemperatureValue(value) {
            document.getElementById('playgroundTemperatureValue').value = value;
            const slider = document.getElementById('playgroundTemperature');
            const percent = (value / 2) * 100;
            slider.style.background = `linear-gradient(to right, #4285f4 0%, #4285f4 ${percent}%, #e0e0e0 ${percent}%, #e0e0e0 100%)`;
            // ÂÆûÊó∂Êõ¥Êñ∞È¢ÑËßà
            updateRequestPreview();
        }

        function updateTemperatureSlider(value) {
            const slider = document.getElementById('playgroundTemperature');
            slider.value = value;
            updateTemperatureValue(value);
        }

        function updateMaxTokensValue(value) {
            document.getElementById('playgroundMaxTokensValue').value = value;
            const slider = document.getElementById('playgroundMaxTokens');
            const max = parseInt(slider.max);
            const percent = (value / max) * 100;
            slider.style.background = `linear-gradient(to right, #4285f4 0%, #4285f4 ${percent}%, #e0e0e0 ${percent}%, #e0e0e0 100%)`;
            // ÂÆûÊó∂Êõ¥Êñ∞È¢ÑËßà
            updateRequestPreview();
        }

        function updateMaxTokensSlider(value) {
            const slider = document.getElementById('playgroundMaxTokens');
            slider.value = value;
            updateMaxTokensValue(value);
        }

        // Ê†πÊçÆÊ®°ÂûãÊõ¥Êñ∞ Max Tokens ‰∏äÈôê
        function updateMaxTokensLimit(model) {
            const slider = document.getElementById('playgroundMaxTokens');
            const valueInput = document.getElementById('playgroundMaxTokensValue');
            
            // ‰ºòÂÖà‰ªé playgroundModelsMeta Ëé∑Âèñ max_completion_tokens
            const meta = playgroundModelsMeta[model] || modelMetaFromConfig[model] || (queriedModels.meta || {})[model] || {};
            let maxTokens = parseInt(meta.max_tokens || 0);
            
            // Â¶ÇÊûúÂÖÉÊï∞ÊçÆ‰∏≠Ê≤°ÊúâÔºå‰ΩøÁî®ÈªòËÆ§ÂÄº
            if (!maxTokens || maxTokens <= 0) {
                // ÈªòËÆ§ÂõûÈÄÄÂÄº
                const defaultLimits = {
                    'claude': 64000,
                    'gpt-5': 128000,
                    'gpt-4': 32768,
                    'gemini': 65535,
                    'default': 8192
                };
                
                maxTokens = defaultLimits['default'];
                for (const [key, limit] of Object.entries(defaultLimits)) {
                    if (model && model.toLowerCase().includes(key)) {
                        maxTokens = limit;
                        break;
                    }
                }
            }
            
            slider.max = maxTokens;
            valueInput.max = maxTokens;
            
            // Â¶ÇÊûúÂΩìÂâçÂÄºË∂ÖËøáÊñ∞‰∏äÈôêÔºåË∞ÉÊï¥‰∏∫Êñ∞‰∏äÈôê
            const currentValue = parseInt(slider.value);
            if (currentValue > maxTokens) {
                slider.value = maxTokens;
                valueInput.value = maxTokens;
            }
            
            // ËÆæÁΩÆ‰∏Ä‰∏™ÂêàÁêÜÁöÑÈªòËÆ§ÂÄºÔºà‰∏çË∂ÖËøá‰∏äÈôêÁöÑ‰∏ÄÂçäÊàñ 4096ÔºåÂèñËæÉÂ∞èÂÄºÔºâ
            const defaultValue = Math.min(4096, Math.floor(maxTokens / 2));
            if (currentValue > maxTokens || currentValue <= 0) {
                slider.value = defaultValue;
                valueInput.value = defaultValue;
            }
            
            // ÂßãÁªàÊõ¥Êñ∞ËøõÂ∫¶Êù°ËÉåÊôØ‰ª•ÂèçÊò†Êñ∞ÁöÑ max ÂÄº
            updateMaxTokensValue(parseInt(slider.value));
            
            console.log(`Model ${model}: max_tokens limit set to ${maxTokens}, current value: ${slider.value}`);
        }

        async function initPlayground(){
            try{
                await loadModels();
                await loadPlaygroundApiKeys();
                clearMessages();
                addMessageRow('system','You are a helpful assistant.');
                addMessageRow('user','hello');
                // ÂàùÂßãÂåñÂêéÁ´ãÂç≥ÊòæÁ§∫È¢ÑËßà
                await updateRequestPreview();
                showStatus('ÊìçÁªÉÂú∫Â∑≤Â∞±Áª™','success');
            }catch(e){
                showStatus('Âä†ËΩΩÊ®°ÂûãÂ§±Ë¥•: '+e.message,'error');
            }
        }

        async function loadPlaygroundApiKeys(){
            try{
                const res = await fetch('/config/get', { headers: getAuthHeaders() });
                const data = await res.json();
                const cfg = data.config || {};
                const apiKeys = cfg.assembly_api_keys || [];
                
                const keySelect = document.getElementById('playgroundApiKey');
                if (keySelect && Array.isArray(apiKeys)) {
                    keySelect.innerHTML = '<option value="">Ëá™Âä®ÈÄâÊã©ÔºàÈªòËÆ§Ôºâ</option>';
                    apiKeys.forEach((key, index) => {
                        if (key && key.trim()) {
                            const opt = document.createElement('option');
                            opt.value = key;
                            // ËÑ±ÊïèÊòæÁ§∫
                            const masked = key.length > 8 ? 
                                key.substring(0, 4) + '...' + key.substring(key.length - 4) : 
                                key.substring(0, 2) + '***';
                            opt.textContent = `Key #${index}: ${masked}`;
                            keySelect.appendChild(opt);
                        }
                    });
                }
            }catch(e){
                console.error('Âä†ËΩΩ API Keys Â§±Ë¥•:', e);
            }
        }

        // Â≠òÂÇ®‰ªé /v1/models Ëé∑ÂèñÁöÑÊ®°ÂûãÂÖÉÊï∞ÊçÆ
        let playgroundModelsMeta = {};

        async function loadModels(){
            const sel = document.getElementById('playgroundModel');
            sel.innerHTML = '';
            const res = await fetch('/v1/models', { headers: getAuthHeaders() });
            const data = await res.json();
            const list = (data && data.data) ? data.data : [];
            
            // ‰øùÂ≠òÊ®°ÂûãÂÖÉÊï∞ÊçÆ
            playgroundModelsMeta = {};
            list.forEach(item => {
                const id = item.id || item;
                const opt = document.createElement('option');
                opt.value = id;
                opt.textContent = id;
                sel.appendChild(opt);
                
                // ‰øùÂ≠òÂÖÉÊï∞ÊçÆÔºåÂåÖÊã¨ max_completion_tokens
                if (typeof item === 'object') {
                    const tp = item.top_provider || {};
                    playgroundModelsMeta[id] = {
                        context_length: tp.context_length || item.context_length,
                        max_tokens: tp.max_completion_tokens || item.max_completion_tokens,
                        default_parameters: item.default_parameters || {}
                    };
                }
            });
            
            if (!sel.value && list.length>0){ sel.value = (list[0].id || list[0]); }
            sel.onchange = ()=> applyModelDefaults(sel.value);
            applyModelDefaults(sel.value);
        }

        function applyModelDefaults(modelId){
            // ‰ºòÂÖà‰ΩøÁî® playgroundModelsMetaÔºåÁÑ∂ÂêéÊòØ modelMetaFromConfigÔºåÊúÄÂêéÊòØ queriedModels.meta
            const meta = playgroundModelsMeta[modelId] || modelMetaFromConfig[modelId] || (queriedModels.meta||{})[modelId] || {};
            
            // Êõ¥Êñ∞ max_tokens ÊªëÂùó‰∏äÈôê
            updateMaxTokensLimit(modelId);
            
            // ËÆæÁΩÆÈªòËÆ§ÂèÇÊï∞
            const defs = meta.default_parameters || {};
            if (defs && (defs.temperature !== undefined && defs.temperature !== null)){
                const t = document.getElementById('playgroundTemperature');
                const tv = document.getElementById('playgroundTemperatureValue');
                if (t) {
                    t.value = defs.temperature;
                    if (tv) tv.value = defs.temperature;
                    updateTemperatureValue(defs.temperature);
                }
            }
        }

        function addMessageRow(role='user', content=''){
            const wrap = document.getElementById('playgroundMessages');
            const row = document.createElement('div');
            row.className = 'form-group';
            row.style = 'display:flex; gap:8px; align-items:flex-start; margin-bottom:8px';
            const roleSel = document.createElement('select');
            roleSel.className = 'config-input';
            roleSel.style = 'width:140px; min-width:140px; height:32px; padding:2px 8px';
            ['system','user','assistant','tool'].forEach(r=>{ const o=document.createElement('option'); o.value=r; o.textContent=r; roleSel.appendChild(o); });
            roleSel.value = role;
            // Ê∑ªÂä† onchange ‰∫ã‰ª∂ÁõëÂê¨
            roleSel.onchange = () => updateRequestPreview();
            const ta = document.createElement('textarea');
            ta.className = 'config-input';
            ta.style = 'min-height:80px; flex:1; resize:vertical';
            ta.value = content || '';
            // Ê∑ªÂä† oninput ‰∫ã‰ª∂ÁõëÂê¨ÔºàÂÆûÊó∂Êõ¥Êñ∞Ôºâ
            ta.oninput = () => updateRequestPreview();
            const del = document.createElement('button');
            del.className = 'btn';
            del.style = 'background:#dc3545; padding:4px 8px; font-size:12px; min-width:auto; height:32px; width:auto; flex:0 0 auto';
            del.textContent = 'Âà†Èô§';
            del.onclick = ()=>{ row.remove(); updateRequestPreview(); };
            row.appendChild(roleSel); row.appendChild(ta); row.appendChild(del);
            wrap.appendChild(row);
            // Ê∑ªÂä†ÂêéÊõ¥Êñ∞È¢ÑËßà
            updateRequestPreview();
        }

        function clearMessages(){
            const wrap = document.getElementById('playgroundMessages');
            wrap.innerHTML = '';
            const out = document.getElementById('playgroundOutputContent');
            const raw = document.getElementById('playgroundRawJson');
            if (out) out.textContent = '';
            if (raw) raw.textContent = '';
            // Ê∏ÖÁ©∫ÂêéÊõ¥Êñ∞È¢ÑËßà
            updateRequestPreview();
        }

        // ÂÖ®Â±ÄÂèòÈáèÂ≠òÂÇ®Ê≠£Âú®ËøõË°åÁöÑÊµãËØï
        let playgroundTestInProgress = false;
        let playgroundAbortController = null;

        // È¢ÑËßàËØ∑Ê±Ç
        async function previewRequest() {
            console.log('previewRequest called');
            
            const sel = document.getElementById('playgroundModel');
            if (!sel || !sel.value) {
                alert('ËØ∑ÂÖàÈÄâÊã©Ê®°Âûã');
                return;
            }
            
            const temp = parseFloat(document.getElementById('playgroundTemperature').value) || 0.5;
            const maxT = parseInt(document.getElementById('playgroundMaxTokens').value) || 4096;
            const stream = document.getElementById('playgroundStream')?.checked || false;
            
            const rows = Array.from(document.querySelectorAll('#playgroundMessages .form-group'));
            let messages = rows.map(r => {
                const selectEl = r.querySelector('select');
                const textareaEl = r.querySelector('textarea');
                if (!selectEl || !textareaEl) return null;
                const role = selectEl.value;
                const content = textareaEl.value;
                return { role, content };
            }).filter(m => m && (m.content || '').trim().length > 0);
            
            // Â¶ÇÊûúÊ≤°ÊúâÊ∂àÊÅØÔºå‰ΩøÁî®ÈªòËÆ§Ê∂àÊÅØ
            if (messages.length === 0) {
                messages = [{ role: 'user', content: 'Hello' }];
            }
            
            const requestData = {
                model: sel.value,
                messages: messages,
                temperature: temp,
                max_tokens: maxT,
                stream: stream
            };
            
            // Ê∑ªÂä†Â∑•ÂÖ∑ÂÆö‰πâ
            const toolsStr = document.getElementById('playgroundToolsJson')?.value?.trim() || '';
            if (toolsStr) {
                try {
                    requestData.tools = JSON.parse(toolsStr);
                } catch (e) {
                    alert('Â∑•ÂÖ∑ÂÆö‰πâ JSON Ê†ºÂºèÈîôËØØ: ' + e.message);
                    return;
                }
            }
            
            console.log('Request data:', requestData);
            
            try {
                const response = await fetch('/api/playground/preview', {
                    method: 'POST',
                    headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                
                console.log('Response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Preview data:', data);
                    
                    // ÊòæÁ§∫È¢ÑËßàÂå∫Âüü
                    const previewSection = document.getElementById('requestPreviewSection');
                    if (previewSection) {
                        previewSection.style.display = 'block';
                    }
                    
                    const methodEl = document.getElementById('previewMethod');
                    const urlEl = document.getElementById('previewUrl');
                    const headersEl = document.getElementById('previewHeaders');
                    const bodyEl = document.getElementById('previewBody');
                    
                    if (methodEl) methodEl.textContent = data.method || 'POST';
                    if (urlEl) urlEl.textContent = data.url || '';
                    
                    // Ê†ºÂºèÂåñËØ∑Ê±ÇÂ§¥
                    if (headersEl) {
                        const headers = { ...data.headers };
                        headersEl.textContent = JSON.stringify(headers, null, 2);
                    }
                    
                    // Ê†ºÂºèÂåñËØ∑Ê±Ç‰ΩìÔºà‰ΩøÁî® value ËÄå‰∏çÊòØ textContentÔºåÂõ†‰∏∫Áé∞Âú®ÊòØ textareaÔºâ
                    if (bodyEl) {
                        bodyEl.value = JSON.stringify(data.body, null, 2);
                        bodyEl.readOnly = true; // ÈªòËÆ§Âè™ËØªÔºåÁÇπÂáªÁºñËæëÂêéÂèØÁºñËæë
                    }
                } else {
                    const errorText = await response.text();
                    console.error('Preview error:', errorText);
                    try {
                        const error = JSON.parse(errorText);
                        alert('È¢ÑËßàÂ§±Ë¥•: ' + (error.detail || 'Êú™Áü•ÈîôËØØ'));
                    } catch {
                        alert('È¢ÑËßàÂ§±Ë¥•: ' + errorText);
                    }
                }
            } catch (error) {
                console.error('Preview request error:', error);
                alert('È¢ÑËßàÂ§±Ë¥•: ' + error.message);
            }
        }

        // Â§çÂà∂ËØ∑Ê±Ç‰Ωì
        function copyRequestBody() {
            const body = document.getElementById('previewBody').value;
            navigator.clipboard.writeText(body).then(() => {
                alert('Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
            }).catch(err => {
                alert('Â§çÂà∂Â§±Ë¥•: ' + err.message);
            });
        }

        // ÁºñËæëËØ∑Ê±Ç‰Ωì
        function editRequestBody() {
            const textarea = document.getElementById('previewBody');
            textarea.readOnly = false;
            textarea.focus();
            alert('Áé∞Âú®ÂèØ‰ª•ÁºñËæëËØ∑Ê±Ç‰Ωì‰∫ÜÔºåÁºñËæëÂÆåÊàêÂêéÁÇπÂáª"ÂèëÈÄÅ"ÊåâÈíÆ');
        }

        // ÂèëÈÄÅËá™ÂÆö‰πâËØ∑Ê±Ç
        async function sendCustomRequest() {
            const body = document.getElementById('previewBody').value;
            
            try {
                const requestData = JSON.parse(body);
                
                // ‰ΩøÁî®Áé∞ÊúâÁöÑ sendPlayground ÈÄªËæëÔºå‰ΩÜ‰ΩøÁî®Ëá™ÂÆö‰πâÁöÑËØ∑Ê±Ç‰Ωì
                const sel = document.getElementById('playgroundModel');
                const selectedKey = document.getElementById('playgroundApiKey')?.value || '';
                
                const headers = { ...getAuthHeaders(), 'Content-Type': 'application/json' };
                if (selectedKey) {
                    headers['X-API-Key'] = selectedKey;
                }
                
                const response = await fetch('/v1/chat/completions', {
                    method: 'POST',
                    headers: headers,
                    body: body
                });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('playgroundOutputContent').textContent = data.choices?.[0]?.message?.content || JSON.stringify(data);
                    document.getElementById('playgroundRawJson').textContent = JSON.stringify(data, null, 2);
                    showStatus('ËØ∑Ê±ÇÊàêÂäü', 'success');
                } else {
                    const error = await response.text();
                    showStatus('ËØ∑Ê±ÇÂ§±Ë¥•: ' + error, 'error');
                }
            } catch (e) {
                alert('ËØ∑Ê±Ç‰ΩìÊ†ºÂºèÈîôËØØÊàñÂèëÈÄÅÂ§±Ë¥•: ' + e.message);
            }
        }

        async function sendPlayground(){
            // Â¶ÇÊûúÂ∑≤ÊúâÊµãËØïÂú®ËøõË°åÔºåÊèêÁ§∫Áî®Êà∑
            if (playgroundTestInProgress) {
                if (!confirm('Â∑≤ÊúâÊµãËØïÊ≠£Âú®ËøõË°åÔºåÊòØÂê¶ÂèñÊ∂àÂπ∂ÂºÄÂßãÊñ∞ÊµãËØïÔºü')) {
                    return;
                }
                if (playgroundAbortController) {
                    playgroundAbortController.abort();
                }
            }

            const sel = document.getElementById('playgroundModel');
            const temp = parseFloat(document.getElementById('playgroundTemperatureValue')?.value || document.getElementById('playgroundTemperature').value) || 0.5;
            const maxT = parseInt(document.getElementById('playgroundMaxTokensValue')?.value || document.getElementById('playgroundMaxTokens').value) || 4096;
            const selectedKey = document.getElementById('playgroundApiKey')?.value || '';
            
            const rows = Array.from(document.querySelectorAll('#playgroundMessages .form-group'));
            const messages = rows.map(r=>{
                const role = r.querySelector('select').value;
                const content = r.querySelector('textarea').value;
                return { role, content };
            }).filter(m=> (m.content||'').trim().length>0);
            
            const body = { model: sel.value, messages, temperature: temp, max_tokens: maxT };
            const toolsStr = document.getElementById('playgroundToolsJson').value.trim();
            if (toolsStr) {
                try {
                    const tools = JSON.parse(toolsStr);
                    body.tools = tools;
                    body.tool_choice = 'auto';
                } catch (e) {
                    showStatus('Â∑•ÂÖ∑JSONËß£ÊûêÂ§±Ë¥•: '+e.message,'error');
                    return;
                }
            }
            const enableStream = !!document.getElementById('playgroundStream')?.checked;
            if (enableStream) body.stream = true;
            
            try{
                playgroundTestInProgress = true;
                playgroundAbortController = new AbortController();
                
                collapseAfterSend();
                showStatus('ÊµãËØïËøõË°å‰∏≠...ÔºàÂèØÂàáÊç¢Ê†áÁ≠æÈ°µÔºåÊµãËØïÂ∞ÜÂú®ÂêéÂè∞ÁªßÁª≠Ôºâ','info');
                
                // Â¶ÇÊûúÈÖçÁΩÆËøòÊ≤°ÊúâÂä†ËΩΩÔºåÂÖàÂä†ËΩΩÈÖçÁΩÆ
                if (!currentConfig || Object.keys(currentConfig).length === 0) {
                    try {
                        const response = await fetch('/config/get', { method: 'GET', headers: getAuthHeaders() });
                        const data = await response.json();
                        if (response.ok) {
                            currentConfig = data.config || {};
                        }
                    } catch (e) {
                        console.warn('Failed to load config:', e);
                    }
                }
                
                // Ëé∑ÂèñÊ≠£Á°ÆÁöÑ API ËÆøÈóÆÂØÜÁ†Å
                // ‰ºòÂÖàÁ∫ßÔºöÈÄöÁî®ÂØÜÁ†Å > API ËÆøÈóÆÂØÜÁ†Å > ÊéßÂà∂Èù¢ÊùøÂØÜÁ†ÅÔºàfallbackÔºâ
                let apiPassword = '';
                if (currentConfig.password) {
                    apiPassword = currentConfig.password;
                } else if (currentConfig.api_password) {
                    apiPassword = currentConfig.api_password;
                } else {
                    apiPassword = authToken;
                }
                
                // ÊûÑÂª∫ËØ∑Ê±ÇÂ§¥
                const headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiPassword}`
                };
                // Â¶ÇÊûúÈÄâÊã©‰∫ÜÁâπÂÆöÁöÑ KeyÔºåÊ∑ªÂä†Âà∞ËØ∑Ê±ÇÂ§¥
                if (selectedKey) {
                    headers['X-API-Key'] = selectedKey;
                }
                
                const res = await fetch('/v1/chat/completions', { 
                    method:'POST', 
                    headers: headers, 
                    body: JSON.stringify(body),
                    signal: playgroundAbortController.signal
                });
                
                if (!enableStream) {
                    const data = await res.json();
                    if (!res.ok){ throw new Error(data.detail||'ËØ∑Ê±ÇÂ§±Ë¥•'); }
                    const first = ((data.choices||[])[0]||{});
                    let msg = ((first.message||{}).content);
                    if (Array.isArray(msg)){
                        msg = msg.map(p=> (typeof p==='string')? p : (p && (p.text||''))).join('');
                    }
                    msg = msg || '';
                    
                    // Êõ¥Êñ∞ÊòæÁ§∫Âå∫Âüü
                    document.getElementById('playgroundOutputContent').textContent = msg;
                    document.getElementById('playgroundRawJson').textContent = JSON.stringify(data, null, 2);
                    
                    // ÊòæÁ§∫ÁªìÊûúÂºπÁ™ó
                    showPlaygroundResult(msg, data);
                    showStatus('ÊµãËØïÂÆåÊàê','success');
                } else {
                    const reader = res.body.getReader();
                    const decoder = new TextDecoder('utf-8');
                    let buf = '';
                    const outEl = document.getElementById('playgroundOutputContent');
                    const rawEl = document.getElementById('playgroundRawJson');
                    
                    // Ê∏ÖÁ©∫‰πãÂâçÁöÑÂÜÖÂÆπ
                    if (outEl) outEl.textContent = '';
                    if (rawEl) rawEl.textContent = '';
                    
                    let rawBuf = '';
                    let fullMessage = '';
                    let lastData = null;
                    
                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;
                        buf += decoder.decode(value, { stream: true });
                        const parts = buf.split('\n\n');
                        buf = parts.pop();
                        for (const part of parts) {
                            const line = part.trim();
                            if (!line.startsWith('data:')) continue;
                            const payload = line.slice(5).trim();
                            if (payload === '[DONE]') continue;
                            try {
                                const obj = JSON.parse(payload);
                                lastData = obj;
                                const ch = (obj.choices||[])[0]||{};
                                const delta = ch.delta||{};
                                const content = delta.content||'';
                                if (content) {
                                    fullMessage += content;
                                    if (outEl) outEl.textContent += content;
                                }
                                rawBuf += payload + "\n\n";
                                if (rawEl) rawEl.textContent = rawBuf;
                            } catch(e) {}
                        }
                    }
                    
                    // ÊòæÁ§∫ÁªìÊûúÂºπÁ™ó
                    showPlaygroundResult(fullMessage, lastData);
                    showStatus('ÊµãËØïÂÆåÊàê','success');
                }
            }catch(e){
                if (e.name === 'AbortError') {
                    showStatus('ÊµãËØïÂ∑≤ÂèñÊ∂à','info');
                } else {
                    showStatus('ÊµãËØïÂ§±Ë¥•: ' + e.message,'error');
                }
            } finally {
                playgroundTestInProgress = false;
                playgroundAbortController = null;
            }
        }

        function showPlaygroundResult(message, data) {
            const modal = document.getElementById('playgroundResultModal');
            const messageEl = document.getElementById('playgroundResultMessage');
            const keyEl = document.getElementById('playgroundResultKey');
            const tokensEl = document.getElementById('playgroundResultTokens');
            
            if (messageEl) {
                messageEl.textContent = message || '(Êó†ËøîÂõûÊ∂àÊÅØ)';
            }
            
            if (keyEl && data) {
                // Â∞ùËØï‰ªéÂìçÂ∫îÂ§¥ÊàñÊï∞ÊçÆ‰∏≠Ëé∑Âèñ‰ΩøÁî®ÁöÑ Key
                const usedKey = data.key || 'Á≥ªÁªüËá™Âä®ÈÄâÊã©';
                keyEl.textContent = usedKey;
            }
            
            if (tokensEl && data && data.usage) {
                const usage = data.usage;
                tokensEl.textContent = `ËæìÂÖ•: ${usage.prompt_tokens || 0} tokens, ËæìÂá∫: ${usage.completion_tokens || 0} tokens, ÊÄªËÆ°: ${usage.total_tokens || 0} tokens`;
            } else {
                tokensEl.textContent = 'Êó† token ‰ΩøÁî®‰ø°ÊÅØ';
            }
            
            if (modal) {
                modal.style.display = 'block';
            }
        }

        function closePlaygroundResultModal() {
            const modal = document.getElementById('playgroundResultModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // ÁÇπÂáªÂºπÁ™óÂ§ñÈÉ®ÂÖ≥Èó≠
        window.addEventListener('click', (event) => {
            const modal = document.getElementById('playgroundResultModal');
            if (event.target === modal) {
                closePlaygroundResultModal();
            }
        });

        function toggleSection(id){
            const el = document.getElementById(id);
            if (!el) return;
            const show = (el.style.display === 'none');
            el.style.display = show ? 'block' : 'none';
            const map = {
                'playgroundMessagesWrap': 'playgroundMessagesToggle',
                'playgroundToolsWrap': 'playgroundToolsToggle',
                'requestPreviewWrap': 'requestPreviewToggle'
            };
            const tid = map[id];
            const t = tid ? document.getElementById(tid) : null;
            if (t) t.textContent = show ? '‚ñº' : '‚ñ∂';
        }

        function collapseAfterSend(){
            ['playgroundMessagesWrap','playgroundToolsWrap','requestPreviewWrap'].forEach(id=>{
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });
            const msgToggle = document.getElementById('playgroundMessagesToggle');
            const toolsToggle = document.getElementById('playgroundToolsToggle');
            const previewToggle = document.getElementById('requestPreviewToggle');
            if (msgToggle) msgToggle.textContent = '‚ñ∂';
            if (toolsToggle) toolsToggle.textContent = '‚ñ∂';
            if (previewToggle) previewToggle.textContent = '‚ñ∂';
        }
        
        function getModelCategory(id){
            const s = String(id||'');
            if (s.startsWith('claude')) return 'Anthropic';
            if (s.startsWith('gpt') || s.startsWith('chatgpt')) return 'OpenAI';
            if (s.startsWith('gemini')) return 'Google';
            return 'Other';
        }

        // ==================== ËØ∑Ê±ÇÈ¢ÑËßàÁõ∏ÂÖ≥ÂáΩÊï∞ ====================
        
        // ÂÆûÊó∂Êõ¥Êñ∞ËØ∑Ê±ÇÈ¢ÑËßà
        async function updateRequestPreview() {
            const sel = document.getElementById('playgroundModel');
            if (!sel || !sel.value) {
                // Â¶ÇÊûúÊ≤°ÊúâÈÄâÊã©Ê®°ÂûãÔºåÊ∏ÖÁ©∫È¢ÑËßà
                const bodyEl = document.getElementById('previewBody');
                if (bodyEl) {
                    bodyEl.value = '// ËØ∑ÂÖàÈÄâÊã©Ê®°Âûã';
                }
                return;
            }
            
            // ÊûÑÂª∫ËØ∑Ê±Ç‰Ωì
            const temp = parseFloat(document.getElementById('playgroundTemperatureValue')?.value || document.getElementById('playgroundTemperature').value) || 0.5;
            const maxT = parseInt(document.getElementById('playgroundMaxTokensValue')?.value || document.getElementById('playgroundMaxTokens').value) || 4096;
            const selectedKey = document.getElementById('playgroundApiKey')?.value || '';
            
            const rows = Array.from(document.querySelectorAll('#playgroundMessages .form-group'));
            const messages = rows.map(r => {
                const role = r.querySelector('select')?.value || 'user';
                const content = r.querySelector('textarea')?.value || '';
                return { role, content };
            }).filter(m => (m.content || '').trim().length > 0);
            
            const body = { 
                model: sel.value, 
                messages: messages.length > 0 ? messages : [{ role: 'user', content: '(ËØ∑Ê∑ªÂä†Ê∂àÊÅØ)' }], 
                temperature: temp, 
                max_tokens: maxT 
            };
            
            // Ê∑ªÂä†Â∑•ÂÖ∑ÂÆö‰πâ
            const toolsStr = document.getElementById('playgroundToolsJson')?.value?.trim();
            if (toolsStr) {
                try {
                    const tools = JSON.parse(toolsStr);
                    body.tools = tools;
                    body.tool_choice = 'auto';
                } catch (e) {
                    // JSON Ëß£ÊûêÂ§±Ë¥•Ôºå‰∏çÊ∑ªÂä†Â∑•ÂÖ∑
                }
            }
            
            // Ê∑ªÂä† stream ÂèÇÊï∞
            const enableStream = !!document.getElementById('playgroundStream')?.checked;
            if (enableStream) body.stream = true;
            
            // Êõ¥Êñ∞È¢ÑËßà
            await showRequestPreview(body, selectedKey);
        }
        
        async function showRequestPreview(body, selectedKey) {
            const section = document.getElementById('requestPreviewSection');
            if (!section) return;
            
            // Â¶ÇÊûúÈÖçÁΩÆËøòÊ≤°ÊúâÂä†ËΩΩÔºåÂÖàÂä†ËΩΩÈÖçÁΩÆ
            if (!currentConfig || Object.keys(currentConfig).length === 0) {
                try {
                    const response = await fetch('/config/get', { method: 'GET', headers: getAuthHeaders() });
                    const data = await response.json();
                    if (response.ok) {
                        currentConfig = data.config || {};
                    }
                } catch (e) {
                    console.warn('Failed to load config for preview:', e);
                }
            }
            
            // ÊòæÁ§∫È¢ÑËßàÂå∫Âüü
            section.style.display = 'block';
            
            // Êõ¥Êñ∞ URL
            const urlEl = document.getElementById('previewUrl');
            if (urlEl) {
                urlEl.textContent = window.location.origin + '/v1/chat/completions';
            }
            
            // Êõ¥Êñ∞ËØ∑Ê±ÇÂ§¥
            const headersEl = document.getElementById('previewHeaders');
            if (headersEl) {
                // Ëé∑ÂèñÊ≠£Á°ÆÁöÑ API ËÆøÈóÆÂØÜÁ†Å
                // ‰ºòÂÖàÁ∫ßÔºöÈÄöÁî®ÂØÜÁ†Å > API ËÆøÈóÆÂØÜÁ†Å > ÊéßÂà∂Èù¢ÊùøÂØÜÁ†ÅÔºàfallbackÔºâ
                let apiPassword = '';
                if (currentConfig.password) {
                    // Â¶ÇÊûúËÆæÁΩÆ‰∫ÜÈÄöÁî®ÂØÜÁ†ÅÔºå‰ΩøÁî®ÈÄöÁî®ÂØÜÁ†Å
                    apiPassword = currentConfig.password;
                } else if (currentConfig.api_password) {
                    // Âê¶Âàô‰ΩøÁî® API ËÆøÈóÆÂØÜÁ†Å
                    apiPassword = currentConfig.api_password;
                } else {
                    // Â¶ÇÊûúÈÉΩÊ≤°ÊúâÔºå‰ΩøÁî®ÂΩìÂâçÁôªÂΩïÁöÑ tokenÔºàÊéßÂà∂Èù¢ÊùøÂØÜÁ†ÅÔºå‰Ωú‰∏∫ fallbackÔºâ
                    apiPassword = authToken;
                }
                
                // ÊûÑÂª∫ËØ∑Ê±ÇÂ§¥ÔºöÂåÖÂê´ API ËÆøÈóÆÂØÜÁ†ÅÔºàAuthorizationÔºâÂíåÂèØÈÄâÁöÑ API Key
                const headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiPassword}`  // API ËÆøÈóÆÂØÜÁ†Å
                };
                
                // Â¶ÇÊûúÈÄâÊã©‰∫ÜÁâπÂÆöÁöÑ API KeyÔºåÊ∑ªÂä†Âà∞ËØ∑Ê±ÇÂ§¥
                if (selectedKey) {
                    headers['X-API-Key'] = selectedKey;
                }
                
                headersEl.textContent = JSON.stringify(headers, null, 2);
            }
            
            // Êõ¥Êñ∞ËØ∑Ê±Ç‰Ωì
            const bodyEl = document.getElementById('previewBody');
            if (bodyEl) {
                bodyEl.value = JSON.stringify(body, null, 2);
                bodyEl.readOnly = true;
                bodyEl.style.backgroundColor = '#1e1e1e';
                bodyEl.style.border = '1px solid var(--border-color)';
            }
        }

        function copyRequestBody() {
            const bodyEl = document.getElementById('previewBody');
            if (!bodyEl) return;
            
            bodyEl.select();
            document.execCommand('copy');
            showStatus('ËØ∑Ê±Ç‰ΩìÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø', 'success');
        }

        function editRequestBody() {
            const bodyEl = document.getElementById('previewBody');
            if (!bodyEl) return;
            
            // ‰ΩøËØ∑Ê±Ç‰ΩìÂèØÁºñËæë
            bodyEl.readOnly = false;
            bodyEl.style.backgroundColor = '#2d2d2d';
            bodyEl.style.border = '2px solid #4285f4';
            showStatus('ËØ∑Ê±Ç‰ΩìÁé∞Âú®ÂèØÁºñËæëÔºåÁºñËæëÂÆåÊàêÂêéÁÇπÂáª"ÂèëÈÄÅ"ÊåâÈíÆ', 'info');
        }

        async function sendCustomRequest() {
            const bodyEl = document.getElementById('previewBody');
            if (!bodyEl) return;
            
            try {
                const body = JSON.parse(bodyEl.value);
                
                // Â¶ÇÊûúÂ∑≤ÊúâÊµãËØïÂú®ËøõË°åÔºåÊèêÁ§∫Áî®Êà∑
                if (playgroundTestInProgress) {
                    if (!confirm('Â∑≤ÊúâÊµãËØïÊ≠£Âú®ËøõË°åÔºåÊòØÂê¶ÂèñÊ∂àÂπ∂ÂºÄÂßãÊñ∞ÊµãËØïÔºü')) {
                        return;
                    }
                    if (playgroundAbortController) {
                        playgroundAbortController.abort();
                    }
                }
                
                playgroundTestInProgress = true;
                playgroundAbortController = new AbortController();
                
                collapseAfterSend();
                showStatus('ÊµãËØïËøõË°å‰∏≠...Ôºà‰ΩøÁî®Ëá™ÂÆö‰πâËØ∑Ê±Ç‰ΩìÔºâ', 'info');
                
                // ÊûÑÂª∫ËØ∑Ê±ÇÂ§¥
                const headersEl = document.getElementById('previewHeaders');
                let headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`  // API ËÆøÈóÆÂØÜÁ†Å
                };
                
                // Â¶ÇÊûúÁî®Êà∑ÁºñËæë‰∫ÜËØ∑Ê±ÇÂ§¥Ôºå‰ΩøÁî®ÁºñËæëÂêéÁöÑËØ∑Ê±ÇÂ§¥
                if (headersEl) {
                    try {
                        const customHeaders = JSON.parse(headersEl.textContent);
                        // ÂêàÂπ∂Ëá™ÂÆö‰πâËØ∑Ê±ÇÂ§¥Ôºå‰ΩÜ‰øùÁïô Authorization
                        headers = { ...headers, ...customHeaders };
                    } catch (e) {
                        console.warn('Failed to parse custom headers:', e);
                    }
                }
                
                const enableStream = !!body.stream;
                
                const res = await fetch('/v1/chat/completions', { 
                    method: 'POST', 
                    headers: headers, 
                    body: JSON.stringify(body),
                    signal: playgroundAbortController.signal
                });
                
                if (!enableStream) {
                    const data = await res.json();
                    if (!res.ok) { throw new Error(data.detail || 'ËØ∑Ê±ÇÂ§±Ë¥•'); }
                    const first = ((data.choices || [])[0] || {});
                    let msg = ((first.message || {}).content);
                    if (Array.isArray(msg)) {
                        msg = msg.map(p => (typeof p === 'string') ? p : (p && (p.text || ''))).join('');
                    }
                    msg = msg || '';
                    
                    // Êõ¥Êñ∞ÊòæÁ§∫Âå∫Âüü
                    document.getElementById('playgroundOutputContent').textContent = msg;
                    document.getElementById('playgroundRawJson').textContent = JSON.stringify(data, null, 2);
                    
                    // ÊòæÁ§∫ÁªìÊûúÂºπÁ™ó
                    showPlaygroundResult(msg, data);
                    showStatus('ÊµãËØïÂÆåÊàê', 'success');
                } else {
                    const reader = res.body.getReader();
                    const decoder = new TextDecoder('utf-8');
                    let buf = '';
                    const outEl = document.getElementById('playgroundOutputContent');
                    const rawEl = document.getElementById('playgroundRawJson');
                    
                    // Ê∏ÖÁ©∫‰πãÂâçÁöÑÂÜÖÂÆπ
                    if (outEl) outEl.textContent = '';
                    if (rawEl) rawEl.textContent = '';
                    
                    let rawBuf = '';
                    let fullMessage = '';
                    let lastData = null;
                    
                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;
                        buf += decoder.decode(value, { stream: true });
                        const parts = buf.split('\n\n');
                        buf = parts.pop();
                        for (const part of parts) {
                            const line = part.trim();
                            if (!line.startsWith('data:')) continue;
                            const payload = line.slice(5).trim();
                            if (payload === '[DONE]') continue;
                            try {
                                const obj = JSON.parse(payload);
                                lastData = obj;
                                const ch = (obj.choices || [])[0] || {};
                                const delta = ch.delta || {};
                                const content = delta.content || '';
                                if (content) {
                                    fullMessage += content;
                                    if (outEl) outEl.textContent += content;
                                }
                                rawBuf += payload + "\n\n";
                                if (rawEl) rawEl.textContent = rawBuf;
                            } catch (e) {}
                        }
                    }
                    
                    // ÊòæÁ§∫ÁªìÊûúÂºπÁ™ó
                    showPlaygroundResult(fullMessage, lastData);
                    showStatus('ÊµãËØïÂÆåÊàê', 'success');
                }
            } catch (e) {
                if (e.name === 'AbortError') {
                    showStatus('ÊµãËØïÂ∑≤ÂèñÊ∂à', 'info');
                } else if (e instanceof SyntaxError) {
                    showStatus('ËØ∑Ê±Ç‰Ωì JSON Ê†ºÂºèÈîôËØØ: ' + e.message, 'error');
                } else {
                    showStatus('ÊµãËØïÂ§±Ë¥•: ' + e.message, 'error');
                }
            } finally {
                playgroundTestInProgress = false;
                playgroundAbortController = null;
                
                // ÊÅ¢Â§çËØ∑Ê±Ç‰Ωì‰∏∫Âè™ËØª
                const bodyEl = document.getElementById('previewBody');
                if (bodyEl) {
                    bodyEl.readOnly = true;
                    bodyEl.style.backgroundColor = '#1e1e1e';
                    bodyEl.style.border = '1px solid var(--border-color)';
                }
            }
        }

        function getCatColors(cat){
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const m = isDark ? {
                // ÊöóÈªëÊ®°ÂºèÈ¢úËâ≤
                Anthropic: { bg:'rgba(111, 66, 193, 0.2)', border:'#9f7aea', text:'#d6bcfa' },
                OpenAI: { bg:'rgba(31, 111, 235, 0.2)', border:'#63b3ed', text:'#90cdf4' },
                Google: { bg:'rgba(43, 147, 72, 0.2)', border:'#68d391', text:'#9ae6b4' },
                Other: { bg:'rgba(160, 160, 160, 0.2)', border:'#a0aec0', text:'#cbd5e0' }
            } : {
                // ‰∫ÆËâ≤Ê®°ÂºèÈ¢úËâ≤
                Anthropic: { bg:'#f2e9ff', border:'#6f42c1', text:'#4b2e83' },
                OpenAI: { bg:'#e7f0ff', border:'#1f6feb', text:'#1f3f8a' },
                Google: { bg:'#e8f7ee', border:'#2b9348', text:'#1f6b2e' },
                Other: { bg:'#eee', border:'#999', text:'#555' }
            };
            return m[cat] || m.Other;
        }

        function formatTokensShort(v){
            const n = parseInt(v || 0);
            if (!n || n <= 0) return '-';
            if (n >= 1000000) return Math.round(n/1000000) + 'm';
            if (n >= 1000) return Math.round(n/1000) + 'k';
            return String(n);
        }

        function renderSelectedModelsChips() {
            const wrap = document.getElementById('selectedModelsChips');
            if (!wrap) return;
            wrap.innerHTML = '';
            selectedModels.forEach(m => {
                const chip = document.createElement('span');
                const cat = getModelCategory(m);
                const colors = getCatColors(cat);
                const meta = (modelMetaFromConfig[m] || (queriedModels.meta||{})[m] || {});
                const ctx = formatTokensShort(meta.context_length);
                chip.className = 'badge model-chip';
                chip.style = `display:inline-flex; align-items:center; gap:6px; background:${colors.bg}; color:${colors.text}; padding:4px 10px; border-radius:12px; margin:2px; font-size:12px; border-left:4px solid ${colors.border}; transition: all 0.2s ease;`;
                chip.innerHTML = `<span>${m}</span><span class="model-ctx" style="font-size:11px; color:${colors.text}; opacity:0.7;">${ctx}</span>`;
                wrap.appendChild(chip);
            });
        }

        async function loadSelectedModelsFromConfig(){
            try{
                const res = await fetch('/config/all', { headers: getAuthHeaders() });
                const data = await res.json();
                const cfg = data.config || {};
                const sel = cfg.available_models_selected || [];
                selectedModels = Array.isArray(sel) ? sel : [];
                modelMetaFromConfig = cfg.available_models_meta || {};
                renderSelectedModelsChips();
            }catch(e){
                // ignore
            }
        }

        async function queryModels(){
            try{
                const res = await fetch('/models/query', { headers: getAuthHeaders() });
                const data = await res.json();
                queriedModels = { grouped: data.grouped||{}, models: data.models||[], meta: data.meta||{} };
                openModelsModal();
            }catch(e){
                showStatus('Ëé∑ÂèñÊ®°ÂûãÂàóË°®Â§±Ë¥•: '+e.message, 'error');
            }
        }

        function openModelsModal(){
            const modal = document.getElementById('modelsModal');
            const body = document.getElementById('modelsModalBody');
            if (!modal || !body) return;
            const groups = queriedModels.grouped || {};
            const ordered = ['Anthropic','OpenAI','Google','Other'];
            let html = '';
            ordered.forEach(cat=>{
                const items = groups[cat]||[];
                const colors = getCatColors(cat);
                html += `<div style="margin:8px 0"><div style="font-weight:600; margin-bottom:6px; color:${colors.text}">${cat} (${items.length})</div>`;
                items.forEach(m=>{
                    const checked = selectedModels.includes(m) ? 'checked' : '';
                    const mt = (queriedModels.meta||{})[m] || {};
                    const ctx = formatTokensShort(mt.context_length);
                    const mx = mt.max_tokens ? (mt.max_tokens>=1000? Math.round(mt.max_tokens/1000)+'k' : mt.max_tokens) : '-';
                    html += `<label style="display:inline-flex; align-items:center; gap:6px; margin:4px 8px 4px 0; padding:4px 8px; border-left:4px solid ${colors.border}; background:${colors.bg}; border-radius:8px"><input type="checkbox" class="model-check" value="${m}" ${checked}/> <span style="color:${colors.text}">${m}</span><span style="color:#666; font-size:12px">(ctx:${ctx}, max:${mx})</span></label>`;
                });
                html += `</div>`;
            });
            body.innerHTML = html || '<div>Êú™Êü•ËØ¢Âà∞Ê®°Âûã</div>';
            modal.style.display = 'block';
        }

        function closeModelsModal(){
            const modal = document.getElementById('modelsModal');
            if (modal) modal.style.display = 'none';
        }

        function collectCheckedModels(){
            const checks = Array.from(document.querySelectorAll('.model-check'));
            return checks.filter(c=> c.checked).map(c=> c.value);
        }

        async function fillAllModels(){
            try{
                if (!queriedModels.models || queriedModels.models.length === 0){
                    const res = await fetch('/models/query', { headers: getAuthHeaders() });
                    const data = await res.json();
                    queriedModels = { grouped: data.grouped||{}, models: data.models||[], meta: data.meta||{} };
                }
                selectedModels = Array.from(new Set([...(queriedModels.models||[])]));
                renderSelectedModelsChips();
                const res2 = await fetch('/models/save', { method:'POST', headers:getAuthHeaders(), body: JSON.stringify({ selected_models: selectedModels }) });
                const data2 = await res2.json();
                if (res2.ok){
                    showStatus(`Â∑≤‰øùÂ≠ò ${data2.saved_count} ‰∏™Ê®°Âûã`, 'success');
                } else {
                    showStatus(`‰øùÂ≠òÂ§±Ë¥•: ${data2.detail||data2.error||'Êú™Áü•ÈîôËØØ'}`, 'error');
                }
            }catch(e){
                showStatus('Â°´ÂÖÖÂ§±Ë¥•: '+ e.message, 'error');
            }
        }

        function clearSelectedModels(){
            selectedModels = [];
            renderSelectedModelsChips();
        }

        async function saveSelectedModels(){
            // Â¶ÇÊûúÂºπÁ™óÊâìÂºÄÔºå‰ºòÂÖà‰ªéÂºπÁ™óÂãæÈÄâÊî∂ÈõÜ
            const modal = document.getElementById('modelsModal');
            if (modal && modal.style.display === 'block'){
                selectedModels = collectCheckedModels();
            }
            try{
                const res = await fetch('/models/save', { method:'POST', headers:getAuthHeaders(), body: JSON.stringify({ selected_models: selectedModels }) });
                const data = await res.json();
                if (res.ok){
                    renderSelectedModelsChips();
                    closeModelsModal();
                    showStatus(`Â∑≤‰øùÂ≠ò ${data.saved_count} ‰∏™Ê®°Âûã`, 'success');
                } else {
                    showStatus(`‰øùÂ≠òÂ§±Ë¥•: ${data.detail||data.error||'Êú™Áü•ÈîôËØØ'}`, 'error');
                }
            }catch(e){
                showStatus('‰øùÂ≠òÂ§±Ë¥•: '+e.message, 'error');
            }
        }

        // ==================== Ë¥¶Êà∑ÁÆ°ÁêÜÁõ∏ÂÖ≥ÂáΩÊï∞ ====================
        let accountSessionData = null;
        let currentAccountSubTab = 'overview';
        const ACCOUNT_CACHE_TTL_MS = 5 * 60 * 1000;
        let accountAutoRefreshTimer = null;
        const accountCache = {
            info: { ts: 0, html: '' },
            apiKeys: { ts: 0, html: '' },  // API keys Áã¨Á´ãÁºìÂ≠ò
            billing: { ts: 0, html: '' },
            usage: {},  // key: dateParams -> { ts, html }
            cost: {},   // key: dateParams|group_by -> { ts, html }
            rates: { ts: 0, html: '' }
        };
        function isFresh(ts) { return !!ts && (Date.now() - ts) < ACCOUNT_CACHE_TTL_MS; }
        function startAccountAutoRefresh() {
            if (accountAutoRefreshTimer) clearInterval(accountAutoRefreshTimer);
            accountAutoRefreshTimer = setInterval(() => {
                if (currentAccountSubTab === 'overview') {
                    loadAccountInfo(true);
                    loadAccountBilling(true);
                } else if (currentAccountSubTab === 'usage') {
                    loadAccountUsage(true);
                } else if (currentAccountSubTab === 'cost') {
                    loadAccountCost(true);
                } else if (currentAccountSubTab === 'rates') {
                    loadAccountRates(true);
                }
            }, ACCOUNT_CACHE_TTL_MS);
        }

        // ÂàùÂßãÂåñË¥¶Êà∑ÁÆ°ÁêÜÊ†áÁ≠æÈ°µ
        async function initAccountTab() {
            await checkAccountSession();
        }

        // Ê£ÄÊü•Ë¥¶Êà∑ÁôªÂΩïÁä∂ÊÄÅ
        async function checkAccountSession() {
            try {
                const res = await fetch('/api/account/session', { headers: getAuthHeaders() });
                const data = await res.json();
                accountSessionData = data;
                if (data.logged_in) {
                    document.getElementById('accountLoginSection').classList.add('hidden');
                    document.getElementById('accountLoggedInSection').classList.remove('hidden');
                    // Âπ∂ÂèëÈ¢ÑÂä†ËΩΩÊâÄÊúâÂ≠êÈ°µÊï∞ÊçÆÔºà‰∏çÈòªÂ°ûÔºåÂÜôÂÖ•ÁºìÂ≠òÔºâÔºåÊèêÂçáÂàáÊç¢‰ΩìÈ™å
                    Promise.all([
                        loadAccountOverview(false),
                        loadAccountUsage(false),
                        loadAccountCost(false),
                        loadAccountRates(false)
                    ]).catch(e => console.error('Failed to preload account data:', e));
                    // ÈªòËÆ§ÊòæÁ§∫Ê¶ÇËßà
                    switchAccountSubTab('overview');
                } else {
                    document.getElementById('accountLoginSection').classList.remove('hidden');
                    document.getElementById('accountLoggedInSection').classList.add('hidden');
                }
            } catch (e) {
                console.error('Check session failed:', e);
            }
        }

        // Ë¥¶Êà∑ÁôªÂΩïÔºàÈÇÆÁÆ±ÂØÜÁ†ÅÔºâ
        async function accountLogin() {
            const email = document.getElementById('accountEmail').value;
            const password = document.getElementById('accountPassword').value;
            if (!email || !password) {
                showAccountStatus('ËØ∑ËæìÂÖ•ÈÇÆÁÆ±ÂíåÂØÜÁ†Å', 'error');
                return;
            }
            showAccountStatus('ÁôªÂΩï‰∏≠...', 'info');
            try {
                const res = await fetch('/api/account/login', {
                    method: 'POST',
                    headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();
                if (res.ok && data.success) {
                    showAccountStatus('ÁôªÂΩïÊàêÂäü', 'success');
                    document.getElementById('accountPassword').value = '';
                    await checkAccountSession();
                } else {
                    showAccountStatus(data.detail || 'ÁôªÂΩïÂ§±Ë¥•', 'error');
                }
            } catch (e) {
                showAccountStatus('ÁôªÂΩïÂ§±Ë¥•: ' + e.message, 'error');
            }
        }

        // Ë¥¶Êà∑ÁôªÂá∫
        async function accountLogout() {
            try {
                await fetch('/api/account/logout', { method: 'POST', headers: getAuthHeaders() });
                accountSessionData = null;
                document.getElementById('accountLoginSection').classList.remove('hidden');
                document.getElementById('accountLoggedInSection').classList.add('hidden');
                showAccountStatus('Â∑≤ÁôªÂá∫', 'success');
            } catch (e) {
                showAccountStatus('ÁôªÂá∫Â§±Ë¥•: ' + e.message, 'error');
            }
        }

        // ÊòæÁ§∫Ë¥¶Êà∑Áä∂ÊÄÅÊ∂àÊÅØ
        function showAccountStatus(message, type = 'info') {
            const el = document.getElementById('accountStatus');
            if (el) {
                el.innerHTML = `<div class="status ${type}">${message}</div>`;
            }
        }

        // ÂàáÊç¢Ë¥¶Êà∑Â≠êÊ†áÁ≠æÈ°µ
        function switchAccountSubTab(tabName) {
            currentAccountSubTab = tabName;
            const tabs = ['overview', 'usage', 'cost', 'rates'];
            tabs.forEach(t => {
                const el = document.getElementById('accountSub' + t.charAt(0).toUpperCase() + t.slice(1));
                const btn = document.getElementById('accountSubTab' + t.charAt(0).toUpperCase() + t.slice(1));
                if (el) el.classList.toggle('hidden', t !== tabName);
                if (btn) btn.style.background = (t === tabName) ? '#4285f4' : '#6c757d';
            });
            // Âä†ËΩΩÂØπÂ∫îÊï∞ÊçÆÔºà‰ºòÂÖà‰ΩøÁî®ÁºìÂ≠òÔºåÁºìÂ≠òËøáÊúüÊàñ‰∏çÂ≠òÂú®ÊâçËØ∑Ê±ÇÔºâ
            if (tabName === 'overview') {
                const infoEl = document.getElementById('accountInfoContent');
                const balEl = document.getElementById('accountBalanceContent');
                if (infoEl && accountCache.info.html && isFresh(accountCache.info.ts)) {
                    infoEl.innerHTML = accountCache.info.html;
                    const sek = document.getElementById('apiKeysSection');
                    if (sek && accountCache.apiKeys && accountCache.apiKeys.html && isFresh(accountCache.apiKeys.ts)) {
                        sek.innerHTML = accountCache.apiKeys.html;
                    }
                    loadAccountApiKeys(false);
                } else {
                    loadAccountInfo();
                }
                if (balEl && accountCache.billing.html && isFresh(accountCache.billing.ts)) {
                    balEl.innerHTML = accountCache.billing.html;
                } else {
                    loadAccountBilling();
                }
            } else if (tabName === 'usage') {
                // ‰ºòÂÖà‰ΩøÁî®ÁºìÂ≠ò
                const el = document.getElementById('accountUsageContent');
                const cacheKey = 'default';
                if (el && accountCache.usage[cacheKey] && accountCache.usage[cacheKey].html && isFresh(accountCache.usage[cacheKey].ts)) {
                    el.innerHTML = accountCache.usage[cacheKey].html;
                } else {
                    loadAccountUsage();
                }
            } else if (tabName === 'cost') {
                // ‰ºòÂÖà‰ΩøÁî®ÁºìÂ≠ò
                const el = document.getElementById('accountCostContent');
                const cacheKey = 'default';
                if (el && accountCache.cost[cacheKey] && accountCache.cost[cacheKey].html && isFresh(accountCache.cost[cacheKey].ts)) {
                    el.innerHTML = accountCache.cost[cacheKey].html;
                } else {
                    loadAccountCost();
                }
            } else if (tabName === 'rates') {
                const el = document.getElementById('accountRatesContent');
                if (el && accountCache.rates.html && isFresh(accountCache.rates.ts)) {
                    el.innerHTML = accountCache.rates.html;
                } else {
                    loadAccountRates();
                }
            }
            startAccountAutoRefresh();
        }

        // Âä†ËΩΩË¥¶Êà∑Ê¶ÇËßà
        async function loadAccountOverview(force = false) {
            loadAccountInfo(force);
            loadAccountBilling(force);
        }

        // Âä†ËΩΩË¥¶Êà∑‰ø°ÊÅØÔºàÂø´ÈÄüÂìçÂ∫îÔºå‰∏çÂåÖÂê´ API keysÔºâ
        async function loadAccountInfo(force = false) {
            const el = document.getElementById('accountInfoContent');
            if (!el) return;
            if (!force && accountCache.info.html && isFresh(accountCache.info.ts)) {
                el.innerHTML = accountCache.info.html;
                // ÂºÇÊ≠•Âä†ËΩΩ API keysÔºà‰∏çÈòªÂ°ûÔºâ
                loadAccountApiKeys(force);
                return;
            }
            el.innerHTML = '<div class="loading">Âä†ËΩΩ‰∏≠...</div>';
            try {
                const res = await fetch('/api/account/info', { headers: getAuthHeaders() });
                if (!res.ok) {
                    if (res.status === 401) {
                        await checkAccountSession();
                        return;
                    }
                    throw new Error('Âä†ËΩΩÂ§±Ë¥•');
                }
                const data = await res.json();
                
                // Âü∫Á°Ä‰ø°ÊÅØ HTMLÔºàÁ´ãÂç≥ÊòæÁ§∫Ôºå‰∏çÁ≠âÂæÖ API keysÔºâ
                const html = `
                    <div style="display: grid; gap: 12px;">
                        <div><strong>ÈÇÆÁÆ±:</strong> ${data.email || '-'}</div>
                        <div><strong>Ë¥¶Êà∑ ID:</strong> ${data.id || '-'}</div>
                        <div><strong>Á±ªÂûã:</strong> ${data.customer_type || '-'}</div>
                        <div><strong>ÂàõÂª∫Êó∂Èó¥:</strong> ${data.created ? new Date(data.created).toLocaleDateString() : '-'}</div>
                        <div><strong>ÊîØ‰ªòÊñπÂºè:</strong> ${data.cc_brand ? data.cc_brand.toUpperCase() + ' ****' + data.cc_last4 : 'Êú™ËÆæÁΩÆ'}</div>
                        <div id="apiKeysSection" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                            <div class="loading">Ê≠£Âú®Âä†ËΩΩ API Keys...</div>
                        </div>
                    </div>
                `;
                accountCache.info = { ts: Date.now(), html };
                el.innerHTML = html;
                
                // ÂºÇÊ≠•Âä†ËΩΩ API keysÔºà‰∏çÈòªÂ°ûÂü∫Á°Ä‰ø°ÊÅØÊòæÁ§∫Ôºâ
                const sek = document.getElementById('apiKeysSection');
                if (sek && accountCache.apiKeys && accountCache.apiKeys.html && isFresh(accountCache.apiKeys.ts)) {
                    sek.innerHTML = accountCache.apiKeys.html;
                }
                loadAccountApiKeys(false);
            } catch (e) {
                el.innerHTML = `<div class="status error">Âä†ËΩΩÂ§±Ë¥•: ${e.message}</div>`;
            }
        }
        
        // Áã¨Á´ãÂä†ËΩΩ API KeysÔºàÂºÇÊ≠•Ôºå‰∏çÈòªÂ°ûË¥¶Êà∑‰ø°ÊÅØÔºåÂ∏¶ÁºìÂ≠òÔºåÂ∏¶Ë∂ÖÊó∂Ôºâ
        async function loadAccountApiKeys(force = false) {
            const el = document.getElementById('apiKeysSection');
            if (!el) return;
            
            // ‰ΩøÁî®ÁºìÂ≠ò
            if (!force && accountCache.apiKeys && accountCache.apiKeys.html && isFresh(accountCache.apiKeys.ts)) {
                el.innerHTML = accountCache.apiKeys.html;
                return;
            }
            
            try {
                // Ê∑ªÂä† 15 ÁßíË∂ÖÊó∂
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000);
                
                const res = await fetch('/api/account/api-keys' + (force ? '?force=1' : ''), { 
                    headers: getAuthHeaders(),
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                if (!res.ok) throw new Error('Âä†ËΩΩ API Keys Â§±Ë¥•');
                const data = await res.json();
                
                let apiKeysHtml = '';
                if (data.api_keys && data.api_keys.length > 0) {
                    apiKeysHtml = `
                        <strong style="display: block; margin-bottom: 12px;">API Keys (${data.api_keys.length}):</strong>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            ${data.api_keys.map(key => `
                                <div style="background: var(--card-bg); padding: 12px; border-radius: 6px; border: 1px solid var(--border-color);">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <span style="font-weight: 500; color: var(--text-color);">${key.name || 'Unnamed Key'}</span>
                                        <span style="font-size: 12px; color: ${key.is_disabled ? 'var(--error-color)' : 'var(--success-color)'};">
                                            ${key.is_disabled ? 'Â∑≤Á¶ÅÁî®' : 'Â∑≤ÂêØÁî®'}
                                        </span>
                                    </div>
                                    <div style="font-family: monospace; font-size: 13px; background: var(--bg-color); padding: 8px; border-radius: 4px; word-break: break-all; color: var(--text-color);">
                                        ${key.api_key || '-'}
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 12px; color: var(--text-secondary);">
                                        <span>È°πÁõÆ: ${key.project_name || '-'}</span>
                                        <span>ÂàõÂª∫: ${key.created ? new Date(key.created).toLocaleDateString() : '-'}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    apiKeysHtml = '<div style="color: var(--text-secondary); font-style: italic;">Êú™ÊâæÂà∞ API Keys</div>';
                }
                
                if (data.error) {
                    apiKeysHtml += `<div class="status warning" style="margin-top: 8px;">Ê≥®ÊÑè: ${data.error}</div>`;
                }
                
                // ÁºìÂ≠ò API keys HTML
                accountCache.apiKeys = { ts: Date.now(), html: apiKeysHtml };
                el.innerHTML = apiKeysHtml;
            } catch (e) {
                const errorMsg = e.name === 'AbortError' ? 'ËØ∑Ê±ÇË∂ÖÊó∂ÔºåËØ∑Á®çÂêéÈáçËØï' : e.message;
                el.innerHTML = `<div class="status error">Âä†ËΩΩ API Keys Â§±Ë¥•: ${errorMsg}<br><button class="btn btn-sm" onclick="loadAccountApiKeys(true)" style="margin-top: 8px;">ÈáçËØï</button></div>`;
            }
        }

        // Âä†ËΩΩË¥¶Âçï‰ø°ÊÅØ
        async function loadAccountBilling(force = false) {
            const el = document.getElementById('accountBalanceContent');
            if (!el) return;
            if (!force && accountCache.billing.html && isFresh(accountCache.billing.ts)) {
                el.innerHTML = accountCache.billing.html;
                return;
            }
            el.innerHTML = '<div class="loading">Âä†ËΩΩ‰∏≠...</div>';
            try {
                const res = await fetch('/api/account/billing' + (force ? '?force=1' : ''), { headers: getAuthHeaders() });
                if (!res.ok) throw new Error('Âä†ËΩΩÂ§±Ë¥•');
                const data = await res.json();
                console.log('Billing data:', data);
                
                const balance = data.balance || 0;
                const totalSpend = data.total_spend_30_days || 0;
                
                let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px;">';
                // ‰ΩôÈ¢ùÂç°Áâá - Á∫¢Ëâ≤Âä®ÊÄÅÊïàÊûú
                html += '<div style="text-align: center; padding: 24px; background: linear-gradient(135deg, var(--card-bg) 0%, rgba(255,77,77,0.05) 100%); border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 4px 15px rgba(255,77,77,0.1);">';
                html += '<div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px;">üí∞ ÂΩìÂâç‰ΩôÈ¢ù</div>';
                html += '<div class="balance-amount" style="font-size: 36px; font-weight: bold;">$' + balance.toFixed(5) + '</div>';
                html += '</div>';
                // Ê∂àË¥πÂç°Áâá - ÁªøËâ≤Âä®ÊÄÅÊïàÊûú
                html += '<div style="text-align: center; padding: 24px; background: linear-gradient(135deg, var(--card-bg) 0%, rgba(40,167,69,0.05) 100%); border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 4px 15px rgba(40,167,69,0.1);">';
                html += '<div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px;">üìä 30Â§©Ê∂àË¥π</div>';
                html += '<div class="spend-amount" style="font-size: 36px; font-weight: bold;">$' + totalSpend.toFixed(5) + '</div>';
                html += '</div></div>';
                html += '<div style="margin-top: 16px; text-align: center;">';
                html += '<a href="https://www.assemblyai.com/dashboard/account/billing" target="_blank" class="btn btn-sm" style="background: linear-gradient(135deg, #17a2b8, #138496); border: none; padding: 8px 20px;">üí≥ ÂÖÖÂÄº</a>';
                html += '<button class="btn btn-sm" onclick="loadAccountBilling(true)" style="margin-left: 8px; padding: 8px 20px;">üîÑ Âà∑Êñ∞</button>';
                html += '</div>';
                
                if (data.error) {
                    html += '<div class="status warning" style="margin-top: 12px;">Ê≥®ÊÑè: ' + data.error + '</div>';
                }
                
                accountCache.billing = { ts: Date.now(), html };
                el.innerHTML = html;
            } catch (e) {
                console.error('Failed to load billing:', e);
                el.innerHTML = '<div class="status error">Âä†ËΩΩÂ§±Ë¥•: ' + e.message + '<br><button class="btn btn-sm" onclick="loadAccountBilling()" style="margin-top: 8px;">ÈáçËØï</button></div>';
            }
        }
        // Êó•ÊúüÈÄâÊã©Âô®ÂàáÊç¢ÂáΩÊï∞
        function onUsageWindowChange() {
            const window_size = document.getElementById('accountUsageWindow')?.value || 'month';
            const customRange = document.getElementById('usageCustomDateRange');
            if (customRange) {
                customRange.style.display = window_size === 'custom' ? 'flex' : 'none';
            }
            if (window_size !== 'custom') {
                loadAccountUsage(true);
            }
        }
        
        function onCostWindowChange() {
            const window_size = document.getElementById('accountCostWindow')?.value || 'month';
            const customRange = document.getElementById('costCustomDateRange');
            if (customRange) {
                customRange.style.display = window_size === 'custom' ? 'flex' : 'none';
            }
            if (window_size !== 'custom') {
                loadAccountCost(true);
            }
        }
        
        // Ëé∑ÂèñÊó•ÊúüËåÉÂõ¥ÂèÇÊï∞
        // AssemblyAI API: ending_before ÊòØ exclusive ÁöÑÔºåÊâÄ‰ª•ÈúÄË¶ÅÂä†‰∏ÄÂ§©
        function getNextDay(dateStr) {
            const date = new Date(dateStr);
            date.setDate(date.getDate() + 1);
            return date.toISOString().split('T')[0];
        }
        
        function getUsageDateParams() {
            const window_size = document.getElementById('accountUsageWindow')?.value || 'month';
            if (window_size === 'custom') {
                const startDate = document.getElementById('usageStartDate')?.value;
                const endDate = document.getElementById('usageEndDate')?.value;
                if (startDate && endDate) {
                    // ending_before ÈúÄË¶ÅÊòØÁªìÊùüÊó•ÊúüÁöÑÁ¨¨‰∫åÂ§©ÔºàexclusiveÔºâ
                    const endingBefore = getNextDay(endDate);
                    return `starting_on=${startDate}&ending_before=${endingBefore}`;
                }
                return 'window_size=month';
            }
            return `window_size=${window_size}`;
        }
        
        function getCostDateParams() {
            const window_size = document.getElementById('accountCostWindow')?.value || 'month';
            if (window_size === 'custom') {
                const startDate = document.getElementById('costStartDate')?.value;
                const endDate = document.getElementById('costEndDate')?.value;
                if (startDate && endDate) {
                    // ending_before ÈúÄË¶ÅÊòØÁªìÊùüÊó•ÊúüÁöÑÁ¨¨‰∫åÂ§©ÔºàexclusiveÔºâ
                    const endingBefore = getNextDay(endDate);
                    return `starting_on=${startDate}&ending_before=${endingBefore}`;
                }
                return 'window_size=month';
            }
            return `window_size=${window_size}`;
        }

        async function loadAccountUsage(force = false) {
            const el = document.getElementById('accountUsageContent');
            if (!el) return;
            const key = 'summary';
            
            // Âº∫Âà∂Âà∑Êñ∞Êó∂Ê∏ÖÈô§ÁºìÂ≠ò
            if (force) {
                delete accountCache.usage[key];
            }
            
            if (!force) {
                const cached = accountCache.usage[key];
                if (cached && cached.html && isFresh(cached.ts)) {
                    el.innerHTML = cached.html;
                    return;
                }
            }
            el.innerHTML = '<div class="loading">Âä†ËΩΩ‰∏≠...</div>';
            try {
                // Âº∫Âà∂Âà∑Êñ∞Êó∂Ê∑ªÂä†forceÂèÇÊï∞ÂíåÊó∂Èó¥Êà≥Èò≤Ê≠¢ÁºìÂ≠ò
                const timestamp = Date.now();
                const res = await fetch('/api/account/usage?force=1&_t=' + timestamp, { headers: getAuthHeaders() });
                if (!res.ok) throw new Error('Âä†ËΩΩÂ§±Ë¥•');
                const data = await res.json();
                console.log('Usage data (force=' + force + '):', data);
                
                let html = '<div style="display: grid; gap: 16px;">';
                
                // ÊÄª tokens ÊòæÁ§∫
                const totalTokens = data.total_tokens || 0;
                html += '<div style="text-align: center; padding: 20px; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color);">';
                html += '<div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">LLM Gateway + LeMUR</div>';
                html += '<div style="font-size: 36px; font-weight: bold; color: var(--text-color);">' + totalTokens.toLocaleString() + '</div>';
                html += '<div style="font-size: 14px; color: var(--text-secondary);">Total tokens</div>';
                html += '</div>';
                
                // ÂΩíÁ±ªÂπ∂Â§çÂàª‰ΩøÁî®ÈáèÂàÜÂ∏É‰∏éÂàóË°® - Á°Æ‰øùÊï∞ÊçÆÂßãÁªàÊòæÁ§∫
                const hasModelData = data.by_model && Array.isArray(data.by_model) && data.by_model.length > 0;
                const hasItemsData = data.items && Array.isArray(data.items) && data.items.length > 0;
                
                if (hasModelData) {
                    const models = [...data.by_model];
                    function vendorOf(name) {
                        const n = (name || '').toLowerCase();
                        if (n.includes('gpt')) return 'GPT';
                        if (n.includes('gemini')) return 'Gemini';
                        if (n.includes('claude')) return 'Claude';
                        return 'Other';
                    }
                    const vendorTotals = {};
                    models.forEach(m => { const v = vendorOf(m.model); vendorTotals[v] = (vendorTotals[v] || 0) + (m.tokens || 0); });
                    const vendorsSorted = Object.keys(vendorTotals).sort((a,b)=>vendorTotals[b]-vendorTotals[a]);
                    const groups = vendorsSorted.map(v => ({ vendor: v, items: models.filter(m=>vendorOf(m.model)===v).sort((a,b)=>b.tokens-a.tokens) }));
                    const palette = {
                        'GPT': ['#1e88e5','#1565c0','#64b5f6','#0d47a1'],
                        'Gemini': ['#00bcd4','#26c6da','#80deea','#4dd0e1'],
                        'Claude': ['#ff7043','#fb8c00','#f4511e','#ff9800'],
                        'Other': ['#9c27b0','#ab47bc','#8e24aa','#ba68c8']
                    };
                    const colorMap = {};
                    groups.forEach(g => { g.items.forEach((it, idx)=>{ const c = it.color || (palette[g.vendor] || palette['Other'])[idx % (palette[g.vendor] || palette['Other']).length]; colorMap[it.model] = c; }); });
                    html += '<div style="padding: 16px; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color);">';
                    html += '<h4 style="margin-bottom: 12px; color: var(--text-color);">‰ΩøÁî®ÈáèÂàÜÂ∏É</h4>';
                    html += '<div style="display: flex; height: 6px; border-radius: 4px; overflow: hidden; margin-bottom: 16px;">';
                    groups.forEach(function(group){
                        group.items.forEach(function(item){
                            const percentage = totalTokens > 0 ? (item.tokens / totalTokens) * 100 : 0;
                            const color = colorMap[item.model];
                            html += '<div style="width:' + percentage + '%; background:' + color + ';"></div>';
                        });
                    });
                    html += '</div>';
                    html += '</div>';

                    html += '<div style="padding: 16px; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color);">';
                    html += '<h4 style="margin-bottom: 12px; color: var(--text-color);">ÊåâÊ®°ÂûãÂàÜÁ±ª</h4>';
                    groups.forEach(function(group){
                        html += '<div style="font-weight:600; color: var(--text-secondary); margin:8px 0;">' + group.vendor + '</div>';
                        group.items.forEach(function(item){
                            const color = colorMap[item.model];
                            const percentage = totalTokens > 0 ? ((item.tokens / totalTokens) * 100).toFixed(1) : 0;
                            html += '<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">';
                            html += '<div style="display: flex; align-items: center; flex: 1;">';
                            html += '<span style="width: 12px; height: 12px; border-radius: 50%; background: ' + color + '; margin-right: 8px; flex-shrink: 0;"></span>';
                            html += '<span style="word-break: break-word; color: var(--text-color);">' + item.model + '</span>';
                            html += '</div>';
                            html += '<div style="text-align: right; margin-left: 12px; white-space: nowrap;">';
                            html += '<span style="font-weight: bold; color: var(--text-color);">' + item.tokens.toLocaleString() + '</span>';
                            html += '<span style="color: var(--text-secondary); margin-left: 4px;">tokens</span>';
                            html += '<span style="color: var(--text-muted); margin-left: 8px;">(' + percentage + '%)</span>';
                            html += '</div>';
                            html += '</div>';
                        });
                    });
                    html += '</div>';
                } else if (hasItemsData) {
                    html += '<div style="padding: 16px; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color);">';
                    html += '<table class="table" style="width: 100%;"><thead><tr><th>Êó•Êúü</th><th>‰∫ßÂìÅ</th><th>Ê®°Âûã</th><th>‰ΩøÁî®Èáè</th></tr></thead><tbody>';
                    data.items.forEach(function(item) {
                        html += '<tr><td>' + (item.date || '-') + '</td><td>' + (item.product || '-') + '</td><td>' + (item.model || '-') + '</td><td>' + (item.usage || item.tokens || 0) + ' ' + (item.unit || 'tokens') + '</td></tr>';
                    });
                    html += '</tbody></table>';
                    html += '</div>';
                } else if (totalTokens === 0) {
                    html += '<div class="status info">ÊöÇÊó†‰ΩøÁî®ÈáèÊï∞ÊçÆÔºåËØ∑Á®çÂêéÂà∑Êñ∞ÈáçËØï</div>';
                }
                
                // ÊòæÁ§∫Ë∞ÉËØï‰ø°ÊÅØÔºàÂ¶ÇÊûúÊúâÔºâ
                if (data.debug_info && Object.keys(data.debug_info).length > 0) {
                    console.log('Debug info:', data.debug_info);
                    // Â¶ÇÊûú‰ΩøÁî®‰∫ÜfallbackÔºåÊòæÁ§∫ÊèêÁ§∫
                    if (data.debug_info.fallback_used) {
                        html += '<div class="status info" style="margin-top: 12px; font-size: 12px;">Êï∞ÊçÆÊù•Ê∫ê: ' + (data.debug_info.fallback_source || 'Â§áÁî®Êï∞ÊçÆÊ∫ê') + '</div>';
                    }
                }
                
                // ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
                if (data.error) {
                    html += '<div class="status warning" style="margin-top: 12px;">Ê≥®ÊÑè: ' + data.error + '</div>';
                }
                
                html += '</div>';
                
                // Âè™ÊúâÂú®Êï∞ÊçÆÂÆåÊï¥Êó∂ÊâçÁºìÂ≠òÔºàÊúâby_modelÊàñitemsÊï∞ÊçÆÔºâ
                if (hasModelData || hasItemsData || totalTokens > 0) {
                    accountCache.usage[key] = { ts: Date.now(), html };
                    console.log('Usage data cached successfully');
                } else {
                    console.warn('Usage data incomplete, not caching');
                }
                
                el.innerHTML = html;
            } catch (e) {
                console.error('Failed to load usage:', e);
                el.innerHTML = '<div class="status error">Âä†ËΩΩÂ§±Ë¥•: ' + e.message + '<br><button class="btn btn-sm" onclick="loadAccountUsage()" style="margin-top: 8px;">ÈáçËØï</button></div>';
            }
        }

        // Âä†ËΩΩÊàêÊú¨Êï∞ÊçÆ
        async function loadAccountCost(force = false) {
            const el = document.getElementById('accountCostContent');
            if (!el) return;
            const key = 'summary';
            
            // Âº∫Âà∂Âà∑Êñ∞Êó∂Ê∏ÖÈô§ÁºìÂ≠ò
            if (force) {
                delete accountCache.cost[key];
            }
            
            if (!force) {
                const cached = accountCache.cost[key];
                if (cached && cached.html && isFresh(cached.ts)) {
                    el.innerHTML = cached.html;
                    return;
                }
            }
            el.innerHTML = '<div class="loading">Âä†ËΩΩ‰∏≠...</div>';
            try {
                // Âº∫Âà∂Âà∑Êñ∞Êó∂Ê∑ªÂä†forceÂèÇÊï∞ÂíåÊó∂Èó¥Êà≥Èò≤Ê≠¢ÁºìÂ≠ò
                const timestamp = Date.now();
                const res = await fetch('/api/account/cost?force=1&_t=' + timestamp, { headers: getAuthHeaders() });
                if (!res.ok) throw new Error('Âä†ËΩΩÂ§±Ë¥•');
                const data = await res.json();
                console.log('Cost data (force=' + force + '):', data);
                
                let html = '<div style="display: grid; gap: 16px;">';
                let hasAnyData = false;
                
                // ÊÄªÊàêÊú¨ÊòæÁ§∫
                const totalCost = data.total_cost || 0;
                html += '<div class="summary-card">';
                html += '<div class="summary-title" style="margin-bottom: 8px;">Summary (Last 30 days)</div>';
                html += '<div class="summary-sub">Total spend across account</div>';
                html += '<div class="summary-value">$' + totalCost.toFixed(5) + '</div>';
                html += '</div>';
                if (totalCost > 0) hasAnyData = true;
                
                // ÊåâÊúçÂä°ÂàÜÁ±ªÁöÑÊàêÊú¨
                if (data.by_service && data.by_service.length > 0) {
                    hasAnyData = true;
                    html += '<div style="padding: 16px; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color);">';
                    html += '<h4 style="margin-bottom: 12px; color: var(--text-color);">Cost Breakdown (Last 30 days)</h4>';
                    
                    // ËøõÂ∫¶Êù°
                    html += '<div style="height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden; display: flex; margin-bottom: 16px; width: 100%;">';
                    const colors = ['#4caf50', '#2196f3', '#ff9800', '#9c27b0'];
                    data.by_service.forEach(function(item, index) {
                        const percentage = totalCost > 0 ? (item.cost / totalCost) * 100 : 0;
                        html += '<div style="width: ' + percentage + '%; background: ' + colors[index % colors.length] + ';"></div>';
                    });
                    html += '</div>';
                    
                    // ÊúçÂä°ÂàóË°®
                    html += '<div class="responsive-grid">';
                    data.by_service.forEach(function(item, index) {
                        html += '<div class="responsive-item" style="padding: 12px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--card-bg);">';
                        html += '<div class="cost-label" style="font-size: 12px; color: var(--text-secondary);">' + item.service + '</div>';
                        html += '<div style="font-size: 20px; font-weight: bold; color: ' + colors[index % colors.length] + ';">$' + item.cost.toFixed(2) + '</div>';
                        html += '</div>';
                    });
                    html += '</div>';
                    html += '</div>';
                }
                
                // Ê∂àË¥πË∂ãÂäø
                if (data.spend_trend && data.spend_trend.length > 0) {
                    hasAnyData = true;
                    html += '<div style="padding: 16px; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color);">';
                    html += '<h4 style="margin-bottom: 12px; color: var(--text-color);">Ê∂àË¥πË∂ãÂäø</h4>';
                    const max = Math.max.apply(null, data.spend_trend.map(function(s){ return (s.amount || 0); }));
                    html += '<div>';
                    data.spend_trend.forEach(function(item){
                        const pct = max > 0 ? (item.amount || 0) / max * 100 : 0;
                        html += '<div style="display: flex; align-items: center; gap: 10px; margin: 6px 0;">';
                        html += '<div style="width: 90px; color: var(--text-secondary); font-size: 12px;">' + (item.date || '-') + '</div>';
                        html += '<div style="flex: 1; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden;">';
                        html += '<div style="width: ' + pct + '%; height: 100%; background: #4caf50;"></div>';
                        html += '</div>';
                        html += '<div style="width: 80px; text-align: right; font-size: 12px; color: var(--text-color);">$' + (item.amount || 0).toFixed(5) + '</div>';
                        html += '</div>';
                    });
                    html += '</div>';
                    html += '</div>';
                }
                
                // ÊåâÊ®°ÂûãÂàÜÁ±ªÁöÑÊàêÊú¨ - Á°Æ‰øùÊï∞ÊçÆÂßãÁªàÊòæÁ§∫
                const hasModelCostData = data.by_model && Array.isArray(data.by_model) && data.by_model.length > 0;
                const hasItemsCostData = data.items && Array.isArray(data.items) && data.items.length > 0;
                
                if (hasModelCostData) {
                    hasAnyData = true;
                    html += '<div style="padding: 16px; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color);">';
                    html += '<h4 style="margin-bottom: 12px; color: var(--text-color);">ÊåâÊ®°ÂûãÂàÜÁ±ª</h4>';
                    html += '<div style="overflow-x: auto;">';
                    html += '<table class="table" style="width: 100%; min-width: 360px;"><thead><tr><th style="color: var(--text-color);">Ê®°Âûã</th><th style="color: var(--text-color);">ËæìÂÖ•ÊàêÊú¨</th><th style="color: var(--text-color);">ËæìÂá∫ÊàêÊú¨</th><th style="color: var(--text-color);">ÊÄªÊàêÊú¨</th></tr></thead><tbody>';
                    data.by_model.forEach(function(item) {
                        html += '<tr><td style="color: var(--text-color);">' + (item.model || '-') + '</td><td style="color: var(--text-color);">$' + (item.input_cost || 0).toFixed(5) + '</td><td style="color: var(--text-color);">$' + (item.output_cost || 0).toFixed(5) + '</td><td style="color: var(--text-color);">$' + (item.cost || 0).toFixed(5) + '</td></tr>';
                    });
                    html += '</tbody></table>';
                    html += '</div>';
                    html += '</div>';
                }
                if (hasItemsCostData) {
                    hasAnyData = true;
                    html += '<div style="padding: 16px; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color);">';
                    html += '<div style="overflow-x: auto;">';
                    html += '<table class="table" style="width: 100%; min-width: 420px;"><thead><tr><th style="color: var(--text-color);">Êó•Êúü</th><th style="color: var(--text-color);">Ê®°Âûã</th><th style="color: var(--text-color);">ËæìÂÖ•ÊàêÊú¨</th><th style="color: var(--text-color);">ËæìÂá∫ÊàêÊú¨</th><th style="color: var(--text-color);">ÊÄªÊàêÊú¨</th></tr></thead><tbody>';
                    data.items.forEach(function(item) {
                        html += '<tr><td style="color: var(--text-color);">' + (item.date || '-') + '</td><td style="color: var(--text-color);">' + (item.model || '-') + '</td><td style="color: var(--text-color);">$' + (item.input_cost || 0).toFixed(5) + '</td><td style="color: var(--text-color);">$' + (item.output_cost || 0).toFixed(5) + '</td><td style="color: var(--text-color);">$' + (item.cost || 0).toFixed(5) + '</td></tr>';
                    });
                    html += '</tbody></table>';
                    html += '</div>';
                    html += '</div>';
                }
                
                if (!hasAnyData) {
                    html += '<div class="status info">ÊöÇÊó†ÊàêÊú¨Êï∞ÊçÆ</div>';
                }
                
                // ÊòæÁ§∫Ë∞ÉËØï‰ø°ÊÅØÔºàÂ¶ÇÊûúÊúâÔºâ
                if (data.debug_info && Object.keys(data.debug_info).length > 0) {
                    console.log('Cost debug info:', data.debug_info);
                    if (data.debug_info.fallback_used) {
                        html += '<div class="status info" style="margin-top: 12px; font-size: 12px;">Êï∞ÊçÆÊù•Ê∫ê: Â§áÁî®Êï∞ÊçÆÊ∫ê</div>';
                    }
                }
                
                if (data.error) {
                    html += '<div class="status warning" style="margin-top: 12px;">Ê≥®ÊÑè: ' + data.error + '</div>';
                }
                
                html += '</div>';
                
                // Âè™ÊúâÂú®Êï∞ÊçÆÂÆåÊï¥Êó∂ÊâçÁºìÂ≠òÔºàÊúâby_modelÊàñby_serviceÊï∞ÊçÆÔºâ
                if (hasModelCostData || (data.by_service && data.by_service.length > 0) || totalCost > 0) {
                    accountCache.cost[key] = { ts: Date.now(), html };
                    console.log('Cost data cached successfully, by_model count:', data.by_model ? data.by_model.length : 0);
                } else {
                    console.warn('Cost data incomplete, not caching');
                }
                
                el.innerHTML = html;
            } catch (e) {
                console.error('Failed to load cost:', e);
                el.innerHTML = '<div class="status error">Âä†ËΩΩÂ§±Ë¥•: ' + e.message + '<br><button class="btn btn-sm" onclick="loadAccountCost()" style="margin-top: 8px;">ÈáçËØï</button></div>';
            }
        }
        // ÂØºÂá∫ÊàêÊú¨Êï∞ÊçÆ
        async function exportAccountCost(format) {
            try {
                const res = await fetch(`/api/account/export/cost?format=${format}`, { headers: getAuthHeaders() });
                if (!res.ok) throw new Error('ÂØºÂá∫Â§±Ë¥•');
                const data = await res.json();
                const content = format === 'csv' ? data.data : JSON.stringify(data.data, null, 2);
                const blob = new Blob([content], { type: format === 'csv' ? 'text/csv' : 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `cost_export.${format}`;
                a.click();
                URL.revokeObjectURL(url);
                showAccountStatus('ÂØºÂá∫ÊàêÂäü', 'success');
            } catch (e) {
                showAccountStatus('ÂØºÂá∫Â§±Ë¥•: ' + e.message, 'error');
            }
        }

        // Âä†ËΩΩË¥πÁéáÊï∞ÊçÆ
        async function loadAccountRates(force = false) {
            const el = document.getElementById('accountRatesContent');
            if (!el) return;
            if (!force && accountCache.rates.html && isFresh(accountCache.rates.ts)) {
                el.innerHTML = accountCache.rates.html;
                return;
            }
            el.innerHTML = '<div class="loading">Âä†ËΩΩ‰∏≠...</div>';
            const region = document.getElementById('accountRatesRegion')?.value || 'US';
            try {
                const res = await fetch(`/api/account/rates?region=${region}` + (force ? '&force=1' : ''), { headers: getAuthHeaders() });
                if (!res.ok) throw new Error('Âä†ËΩΩÂ§±Ë¥•');
                const data = await res.json();
                let html = '<div style="display: grid; gap: 20px;">';
                
                // LLM Gateway - ÂêàÂπ∂ËæìÂÖ•/ËæìÂá∫‰∏§ÂàóÂπ∂‰ºòÂÖàÂ±ïÁ§∫
                if ((data.llm_gateway_input && data.llm_gateway_input.length > 0) || (data.llm_gateway_output && data.llm_gateway_output.length > 0)) {
                    const map = {};
                    (data.llm_gateway_input || []).forEach(item => {
                        const k = item.model || '-';
                        if (!map[k]) map[k] = { in: 0, out: 0, unit: item.unit || '' };
                        map[k].in = item.rate || 0;
                        map[k].unit = item.unit || map[k].unit || '';
                    });
                    (data.llm_gateway_output || []).forEach(item => {
                        const k = item.model || '-';
                        if (!map[k]) map[k] = { in: 0, out: 0, unit: item.unit || '' };
                        map[k].out = item.rate || 0;
                        map[k].unit = item.unit || map[k].unit || '';
                    });
                    const rows = Object.keys(map).map(k => ({ model: k, in: map[k].in, out: map[k].out, unit: map[k].unit })).sort((a,b)=>{
                        function vendor(n){ const s=(n||'').toLowerCase(); if(s.includes('gpt'))return 0; if(s.includes('claude'))return 1; if(s.includes('gemini'))return 2; return 3; }
                        const v = vendor(a.model)-vendor(b.model); if(v!==0) return v; return (b.out||0)-(a.out||0);
                    });
                    html += '<div style="padding: 16px; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color);">';
                    html += '<h5 style="color: var(--text-color);">LLM Gateway</h5>';
                    html += '<div style="overflow-x:auto;">';
                    html += '<table class="table" style="width: 100%; min-width: 460px;"><thead><tr><th>Ê®°Âûã</th><th>ËæìÂÖ•</th><th>ËæìÂá∫</th><th>Âçï‰Ωç</th></tr></thead><tbody>';
                    rows.forEach(r => {
                        const inTxt = (typeof r.in === 'number') ? ('$' + r.in.toFixed(2)) : '-';
                        const outTxt = (typeof r.out === 'number') ? ('$' + r.out.toFixed(2)) : '-';
                        html += `<tr><td style="word-break: break-word;">${r.model}</td><td>${inTxt}</td><td>${outTxt}</td><td>${r.unit||'-'}</td></tr>`;
                    });
                    html += '</tbody></table>';
                    html += '</div>';
                    html += '</div>';
                }
                
                // Speech-to-Text
                if (data.speech_to_text && data.speech_to_text.length > 0) {
                    html += '<div style="padding: 16px; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color);"><h5 style="color: var(--text-color);">Speech-to-Text</h5><table class="table" style="width: 100%;"><thead><tr><th>Ê®°Âûã</th><th>Ë¥πÁéá</th></tr></thead><tbody>';
                    data.speech_to_text.forEach(item => {
                        html += `<tr><td>${item.model}${item.beta ? ' <span style="color: #ffc107; font-size: 11px;">Beta</span>' : ''}</td><td>$${item.rate} / ${item.unit}</td></tr>`;
                    });
                    html += '</tbody></table></div>';
                }
                
                // Streaming
                if (data.streaming && data.streaming.length > 0) {
                    html += '<div style="padding: 16px; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color);"><h5 style="color: var(--text-color);">Streaming</h5><table class="table" style="width: 100%;"><thead><tr><th>Ê®°Âûã</th><th>Ë¥πÁéá</th></tr></thead><tbody>';
                    data.streaming.forEach(item => {
                        html += `<tr><td>${item.model}${item.beta ? ' <span style="color: #ffc107; font-size: 11px;">Beta</span>' : ''}</td><td>$${item.rate} / ${item.unit}</td></tr>`;
                    });
                    html += '</tbody></table></div>';
                }
                
                // Notes
                if (data.notes && data.notes.length > 0) {
                    html += '<div style="color: var(--text-secondary); font-size: 12px; margin-top: 12px;">';
                    data.notes.forEach(note => {
                        html += `<div>${note}</div>`;
                    });
                    html += '</div>';
                }
                
                html += '</div>';
                accountCache.rates = { ts: Date.now(), html };
                el.innerHTML = html;
            } catch (e) {
                el.innerHTML = `<div class="status error">Âä†ËΩΩÂ§±Ë¥•: ${e.message}</div>`;
            }
        }

        // ÂàùÂßãÂåñË¥¶Êà∑ÁÆ°ÁêÜÊ†áÁ≠æÈ°µ
        function initAccountTab() {
            checkAccountSession();
            startAccountAutoRefresh();
        }
    </script>
    </body>
    </html>
