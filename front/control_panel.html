<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AMB2API 管理面板</title>
    <style>
        /* 全局溢出修复 */
        html,
        body {
            overflow-x: hidden;
            max-width: 100vw;
        }

        * {
            box-sizing: border-box;
        }

        /* CSS 变量 - 亮色模式 */
        :root {
            --bg-color: #f5f5f5;
            --container-bg: white;
            --text-color: #333;
            --text-secondary: #666;
            --text-muted: #999;
            --border-color: #e1e4e8;
            --input-bg: white;
            --input-border: #ddd;
            --card-bg: #f8f9fa;
            --hover-bg: #f1f5f9;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --tab-bg: #f8fafc;
            --tab-active-bg: #ffffff;
            --table-stripe: #fcfcfc;
            --table-hover: #f8fbff;
            --code-bg: #f0f8ff;
            --modal-overlay: rgba(0, 0, 0, 0.5);
        }

        /* 暗黑模式 */
        [data-theme="dark"] {
            --bg-color: #1a1a2e;
            --container-bg: #16213e;
            --text-color: #e8e8e8;
            --text-secondary: #a0a0a0;
            --text-muted: #707070;
            --border-color: #2d3748;
            --input-bg: #1e2a47;
            --input-border: #3d4f6f;
            --card-bg: #1e2a47;
            --hover-bg: #243b55;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --tab-bg: #1e2a47;
            --tab-active-bg: #243b55;
            --table-stripe: #1e2a47;
            --table-hover: #243b55;
            --code-bg: #1e2a47;
            --modal-overlay: rgba(0, 0, 0, 0.7);
        }

        /* 金额动态特效 - 余额红色闪烁 */
        @keyframes balancePulse {

            0%,
            100% {
                text-shadow: 0 0 5px rgba(255, 77, 77, 0.5);
            }

            50% {
                text-shadow: 0 0 20px rgba(255, 77, 77, 0.8), 0 0 30px rgba(255, 77, 77, 0.4);
            }
        }

        /* 金额动态特效 - 消费绿色流动 */
        @keyframes spendGlow {

            0%,
            100% {
                text-shadow: 0 0 5px rgba(40, 167, 69, 0.5);
            }

            50% {
                text-shadow: 0 0 15px rgba(40, 167, 69, 0.8), 0 0 25px rgba(40, 167, 69, 0.4);
            }
        }

        /* 数字跳动效果 */
        @keyframes numberBounce {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.02);
            }
        }

        /* 已选中账户脉冲效果 */
        @keyframes selectedAccountPulse {

            0%,
            100% {
                box-shadow: 0 0 8px rgba(66, 133, 244, 0.3);
            }

            50% {
                box-shadow: 0 0 16px rgba(66, 133, 244, 0.6), 0 0 24px rgba(66, 133, 244, 0.3);
            }
        }

        .balance-amount {
            color: #ff4d4d !important;
            animation: balancePulse 2s ease-in-out infinite, numberBounce 3s ease-in-out infinite;
            font-variant-numeric: tabular-nums;
        }

        .spend-amount {
            color: #28a745 !important;
            animation: spendGlow 2s ease-in-out infinite, numberBounce 3s ease-in-out infinite 0.5s;
            font-variant-numeric: tabular-nums;
        }

        /* 暗黑模式下模型标签适配 - 保留分类颜色，仅调整透明度 */
        [data-theme="dark"] .model-chip {
            /* 不覆盖背景和边框颜色，让 getCatColors 的暗黑模式颜色生效 */
            opacity: 0.95;
        }

        [data-theme="dark"] .model-chip .model-ctx {
            /* 保留原有颜色，仅微调透明度 */
            opacity: 0.8;
        }

        /* 暗黑模式下的额外样式覆盖 */
        [data-theme="dark"] .config-input,
        [data-theme="dark"] .filter-select,
        [data-theme="dark"] input[type="text"],
        [data-theme="dark"] input[type="number"],
        [data-theme="dark"] input[type="password"],
        [data-theme="dark"] textarea,
        [data-theme="dark"] select {
            background-color: var(--input-bg) !important;
            color: var(--text-color) !important;
            border-color: var(--input-border) !important;
        }

        [data-theme="dark"] .config-group {
            background-color: var(--card-bg) !important;
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] .config-group h4 {
            color: var(--text-color) !important;
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] .config-note {
            color: var(--text-secondary) !important;
        }

        [data-theme="dark"] .status-badge {
            color: white !important;
        }

        [data-theme="dark"] .btn {
            color: white;
        }

        [data-theme="dark"] .modal-content {
            background-color: var(--container-bg) !important;
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .modal-header,
        [data-theme="dark"] .modal-footer {
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] .modal-title {
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .modal-close {
            color: var(--text-secondary) !important;
        }

        [data-theme="dark"] .modal-close:hover {
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .key-stat-card {
            background-color: var(--card-bg) !important;
        }

        [data-theme="dark"] .key-stat-badge {
            background-color: var(--card-bg) !important;
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .pagination-btn {
            background-color: var(--card-bg) !important;
            color: var(--text-color) !important;
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] .pagination-btn:hover:not(:disabled) {
            background-color: var(--hover-bg) !important;
        }

        [data-theme="dark"] .cred-card,
        [data-theme="dark"] .rate-limit-card,
        [data-theme="dark"] .usage-card {
            background-color: var(--card-bg) !important;
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] .stat-item {
            background: var(--card-bg) !important;
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] .stat-number,
        [data-theme="dark"] .stat-label {
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .upload-area {
            background-color: var(--card-bg) !important;
            border-color: var(--border-color) !important;
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .credentials,
        [data-theme="dark"] .cred-content {
            background-color: var(--code-bg) !important;
            border-color: var(--border-color) !important;
            color: var(--text-color) !important;
        }

        [data-theme="dark"] code {
            background-color: var(--code-bg) !important;
            color: #9cdcfe !important;
        }

        [data-theme="dark"] .progress-bar {
            background-color: var(--border-color) !important;
        }

        [data-theme="dark"] h3,
        [data-theme="dark"] h4 {
            color: var(--text-color) !important;
        }

        [data-theme="dark"] p {
            color: var(--text-secondary) !important;
        }

        [data-theme="dark"] small {
            color: var(--text-muted) !important;
        }

        [data-theme="dark"] .login-form input[type="password"] {
            background-color: var(--input-bg) !important;
            color: var(--text-color) !important;
            border-color: var(--input-border) !important;
        }

        /* 暗黑模式下弹窗内的按钮样式 */
        [data-theme="dark"] .modal-content .btn {
            color: white;
        }

        [data-theme="dark"] .modal-content .btn-sm {
            color: white;
        }

        /* 暗黑模式下表格样式 */
        [data-theme="dark"] .table {
            color: var(--text-color);
        }

        [data-theme="dark"] .table thead th {
            background-color: var(--card-bg) !important;
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .table tbody td {
            color: var(--text-color) !important;
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] .table tbody tr {
            background-color: var(--container-bg) !important;
        }

        [data-theme="dark"] .table tbody tr:nth-child(odd) {
            background-color: var(--table-stripe) !important;
        }

        [data-theme="dark"] .table tbody tr:hover {
            background-color: var(--table-hover) !important;
        }

        /* 暗黑模式下预览区域 */
        [data-theme="dark"] #requestPreviewSection pre {
            background-color: #1e1e1e !important;
            color: #9cdcfe !important;
        }

        /* 暗黑模式下的 card 样式 */
        [data-theme="dark"] .card {
            background-color: var(--card-bg) !important;
            border-color: var(--border-color) !important;
            color: var(--text-color) !important;
        }

        /* 暗黑模式下的成本筛选器样式 */
        [data-theme="dark"] .cost-filter-tag {
            background: var(--card-bg) !important;
            border-color: var(--border-color) !important;
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .cost-filter-tag:hover {
            background: var(--hover-bg) !important;
        }

        [data-theme="dark"] .cost-filter-tag.active {
            background: rgba(66, 133, 244, 0.2) !important;
            border-color: #4285f4 !important;
            color: #6ea8fe !important;
        }

        [data-theme="dark"] .cost-filter-panel {
            background: var(--card-bg) !important;
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] .cost-window-btn {
            background: var(--card-bg) !important;
            border-color: var(--border-color) !important;
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .cost-window-btn:hover {
            background: var(--hover-bg) !important;
        }

        [data-theme="dark"] .cost-window-btn.active {
            background: #4285f4 !important;
            color: white !important;
        }

        [data-theme="dark"] .cost-model-category-title {
            color: var(--text-secondary) !important;
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] .cost-model-item:hover {
            background: var(--hover-bg) !important;
        }

        [data-theme="dark"] #costActiveFilters {
            background: rgba(66, 133, 244, 0.15) !important;
        }

        /* 暗黑模式下的 status 样式 */
        [data-theme="dark"] .status.info {
            background-color: #1e3a5f !important;
            border-color: #2d5a87 !important;
            color: #7ec8e3 !important;
        }

        [data-theme="dark"] .status.success {
            background-color: #1e4620 !important;
            border-color: #2d6930 !important;
            color: #7ec87e !important;
        }

        [data-theme="dark"] .status.error {
            background-color: #4a1e1e !important;
            border-color: #6b2d2d !important;
            color: #e87e7e !important;
        }

        /* 暗黑模式下的 tabs 边框 */
        [data-theme="dark"] .tabs {
            border-color: var(--border-color) !important;
        }

        /* 暗黑模式下的 loading 文字 */
        [data-theme="dark"] .loading {
            color: var(--text-secondary) !important;
        }

        /* 暗黑模式下的 pre 和 code 元素 */
        [data-theme="dark"] pre {
            background-color: #1e1e1e !important;
            color: #d4d4d4 !important;
            border-color: var(--border-color) !important;
        }

        /* 暗黑模式下的弹窗内部元素 */
        [data-theme="dark"] #keyManagementModal .modal-content {
            background-color: var(--container-bg) !important;
        }

        [data-theme="dark"] #keyManagementModal .key-stat-card {
            background-color: var(--card-bg) !important;
        }

        [data-theme="dark"] #keyManagementModal .key-stat-badge {
            background-color: var(--card-bg) !important;
            color: var(--text-color) !important;
        }

        [data-theme="dark"] #keyManagementModal .filter-select {
            background-color: var(--input-bg) !important;
            color: var(--text-color) !important;
            border-color: var(--input-border) !important;
        }

        [data-theme="dark"] #keyManagementModal .btn {
            color: inherit;
        }

        [data-theme="dark"] #keyManagementModal .progress-bar {
            background-color: var(--border-color) !important;
        }

        /* 暗黑模式下的 placeholder */
        [data-theme="dark"] ::placeholder {
            color: var(--text-muted) !important;
            opacity: 1;
        }

        [data-theme="dark"] ::-webkit-input-placeholder {
            color: var(--text-muted) !important;
        }

        [data-theme="dark"] ::-moz-placeholder {
            color: var(--text-muted) !important;
        }

        /* 暗黑模式下的滚动条 */
        [data-theme="dark"] ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        [data-theme="dark"] ::-webkit-scrollbar-track {
            background: var(--card-bg);
        }

        [data-theme="dark"] ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        [data-theme="dark"] ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* ========== 速率限制页面暗黑模式 ========== */
        [data-theme="dark"] .rate-limit-card {
            background-color: var(--card-bg) !important;
            border-color: var(--border-color) !important;
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .rate-limit-header {
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .rate-limit-key {
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .rate-limit-info-label {
            color: var(--text-secondary) !important;
        }

        [data-theme="dark"] .rate-limit-info-value {
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .rate-limit-progress {
            background-color: var(--border-color) !important;
        }

        [data-theme="dark"] .rate-limit-reset {
            color: var(--text-secondary) !important;
        }

        [data-theme="dark"] #rateLimitList {
            color: var(--text-color) !important;
        }

        /* ========== 使用统计页面暗黑模式 ========== */
        [data-theme="dark"] .usage-card {
            background-color: var(--card-bg) !important;
            border-color: var(--border-color) !important;
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .usage-card-disabled {
            opacity: 0.5;
            background-color: rgba(30, 30, 30, 0.5) !important;
            border-color: rgba(100, 100, 100, 0.3) !important;
        }

        [data-theme="dark"] .usage-card-disabled .usage-filename {
            color: #888 !important;
        }

        [data-theme="dark"] .usage-header {
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .usage-filename {
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .usage-progress-label {
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .usage-progress-bar {
            background-color: var(--border-color) !important;
        }

        [data-theme="dark"] .usage-info-item {
            background-color: var(--card-bg) !important;
            border-color: var(--border-color) !important;
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .usage-info-label {
            color: var(--text-secondary) !important;
        }

        [data-theme="dark"] .usage-info-value {
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .reset-time {
            color: var(--text-muted) !important;
        }

        [data-theme="dark"] .ranking-container {
            background-color: var(--card-bg) !important;
            border-color: var(--border-color) !important;
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .ranking-header {
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .ranking-label {
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .ranking-bar {
            background-color: var(--border-color) !important;
        }

        [data-theme="dark"] .ranking-count {
            color: var(--text-secondary) !important;
        }

        [data-theme="dark"] .legend {
            color: var(--text-secondary) !important;
        }

        /* ========== 操练场页面暗黑模式 ========== */
        [data-theme="dark"] #playgroundTab .config-group {
            background-color: var(--card-bg) !important;
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] #playgroundMessages .playground-message-row {
            background-color: var(--card-bg) !important;
        }

        [data-theme="dark"] #playgroundOutputContent {
            color: var(--text-color) !important;
        }

        [data-theme="dark"] #playgroundRawJson {
            background-color: #1e1e1e !important;
            color: #d4d4d4 !important;
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] .playground-btn {
            color: white !important;
        }

        [data-theme="dark"] .playground-status .status {
            background-color: var(--card-bg) !important;
            border-color: var(--border-color) !important;
        }

        /* ========== 实时日志页面暗黑模式 ========== */
        [data-theme="dark"] #logsTab .config-group {
            background-color: var(--card-bg) !important;
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] #logContainer {
            background-color: #1e1e1e !important;
            color: #d4d4d4 !important;
            border-color: var(--border-color) !important;
        }

        /* ========== 通用元素暗黑模式 ========== */
        [data-theme="dark"] div[style*="background:#f7f7f7"],
        [data-theme="dark"] div[style*="background: #f7f7f7"],
        [data-theme="dark"] div[style*="background-color:#f7f7f7"],
        [data-theme="dark"] div[style*="background-color: #f7f7f7"] {
            background-color: var(--card-bg) !important;
        }

        [data-theme="dark"] div[style*="background:#f0f0f0"],
        [data-theme="dark"] div[style*="background: #f0f0f0"] {
            background-color: var(--card-bg) !important;
        }

        [data-theme="dark"] div[style*="background:#ffffff"],
        [data-theme="dark"] div[style*="background: #ffffff"],
        [data-theme="dark"] div[style*="background:white"],
        [data-theme="dark"] div[style*="background: white"],
        [data-theme="dark"] div[style*="background-color:#ffffff"],
        [data-theme="dark"] div[style*="background-color: #ffffff"],
        [data-theme="dark"] div[style*="background-color:white"],
        [data-theme="dark"] div[style*="background-color: white"] {
            background-color: var(--card-bg) !important;
        }

        [data-theme="dark"] span[style*="background:#f0f0f0"],
        [data-theme="dark"] span[style*="background: #f0f0f0"] {
            background-color: var(--card-bg) !important;
            color: var(--text-color) !important;
        }

        [data-theme="dark"] button[style*="background:#f0f0f0"],
        [data-theme="dark"] button[style*="background: #f0f0f0"] {
            background-color: var(--card-bg) !important;
            color: var(--text-color) !important;
        }

        [data-theme="dark"] [style*="color:#333"],
        [data-theme="dark"] [style*="color: #333"] {
            color: var(--text-color) !important;
        }

        [data-theme="dark"] [style*="color:#666"],
        [data-theme="dark"] [style*="color: #666"] {
            color: var(--text-secondary) !important;
        }

        /* ========== 更多特定元素暗黑模式 ========== */
        [data-theme="dark"] #playgroundResultMessage {
            background-color: var(--card-bg) !important;
            color: var(--text-color) !important;
        }

        [data-theme="dark"] #playgroundResultKey,
        [data-theme="dark"] #playgroundResultTokens,
        [data-theme="dark"] #playgroundResultModel {
            color: var(--text-color) !important;
        }

        [data-theme="dark"] .badge {
            color: white !important;
        }

        [data-theme="dark"] #configMetaBar span {
            color: var(--text-secondary) !important;
        }

        [data-theme="dark"] #configMetaBar .badge {
            color: white !important;
        }

        /* 速率限制卡片内的所有文字 */
        [data-theme="dark"] #rateLimitTab * {
            color: inherit;
        }

        [data-theme="dark"] #rateLimitTab {
            color: var(--text-color);
        }

        /* 使用统计卡片内的所有文字 */
        [data-theme="dark"] #usageTab * {
            color: inherit;
        }

        [data-theme="dark"] #usageTab {
            color: var(--text-color);
        }

        /* 操练场内的所有文字 */
        [data-theme="dark"] #playgroundTab {
            color: var(--text-color);
        }

        [data-theme="dark"] #playgroundTab label {
            color: var(--text-secondary) !important;
        }

        /* 折叠区域标题 */
        [data-theme="dark"] div[onclick*="toggleSection"] {
            background-color: var(--card-bg) !important;
            color: var(--text-color) !important;
        }

        /* 滑块样式 */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            outline: none;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            border: 3px solid #4285f4;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            border: 3px solid #4285f4;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        [data-theme="dark"] input[type="range"]::-webkit-slider-thumb {
            background: var(--container-bg);
            border-color: #4285f4;
        }

        [data-theme="dark"] input[type="range"]::-moz-range-thumb {
            background: var(--container-bg);
            border-color: #4285f4;
        }

        /* 暗黑模式切换按钮 */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10001;
            background: var(--container-bg);
            border: 2px solid var(--border-color);
            border-radius: 50px;
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text-color);
            box-shadow: 0 2px 10px var(--shadow-color);
            transition: box-shadow 0.3s ease, transform 0.3s ease;
            overflow: hidden;
            max-width: 200px;
            user-select: none;
            touch-action: manipulation;
        }

        .theme-toggle.dragging {
            cursor: move;
            transition: none;
            z-index: 10000;
            box-shadow: 0 4px 20px var(--shadow-color);
        }

        .theme-toggle:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px var(--shadow-color);
        }

        .theme-toggle:active {
            transform: scale(0.95);
        }

        .theme-toggle .icon {
            font-size: 18px;
            transition: transform 0.3s ease;
            flex-shrink: 0;
        }

        .theme-toggle:hover .icon {
            transform: rotate(20deg);
        }

        .theme-toggle #themeText {
            transition: opacity 0.3s ease, width 0.3s ease;
            white-space: nowrap;
        }

        /* 移动端暗黑模式按钮 - 支持四边悬浮拖拽吸附 */
        @media (max-width: 768px) {
            .theme-toggle {
                padding: 0;
                width: 44px;
                height: 44px;
                min-width: 44px;
                min-height: 44px;
                border-radius: 50%;
                justify-content: center;
                gap: 0;
                /* 移动端默认位置，但允许拖拽覆盖 */
                top: 12px;
                right: 12px;
                z-index: 99999;
            }

            .theme-toggle .icon {
                margin: 0;
                font-size: 20px;
            }

            .theme-toggle #themeText {
                display: none;
            }
        }

        @media (max-width: 480px) {
            .theme-toggle {
                width: 40px;
                height: 40px;
                min-width: 40px;
                min-height: 40px;
                top: 10px;
                right: 10px;
            }

            .theme-toggle .icon {
                font-size: 18px;
            }
        }

        html {
            overflow-x: hidden;
        }

        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow-x: hidden;
        }

        @media (max-width: 768px) {
            body {
                padding: 12px;
                max-width: 100%;
                overflow-x: hidden;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 8px;
                max-width: 100%;
                overflow-x: hidden;
            }
        }

        .container {
            background-color: var(--container-bg);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px var(--shadow-color);
            transition: background-color 0.3s ease;
            position: relative;
            z-index: 10;
            /* 不设置overflow，让sticky正常工作 */
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px 16px;
                border-radius: 8px;
                max-width: 100%;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 16px 12px;
                border-radius: 6px;
                max-width: 100%;
            }
        }

        /* 登录模式下的容器样式 - 透明背景 */
        .container.login-mode {
            background-color: transparent !important;
            box-shadow: none !important;
            border: none !important;
            border-radius: 0 !important;
            padding-top: 10vh;
            /* 让登录框在垂直方向更美观 */
            overflow: hidden;
        }

        [data-theme="dark"] .container.login-mode {
            background-color: transparent !important;
            border: none !important;
        }

        @media (max-width: 768px) {
            .container.login-mode {
                padding: 16px 8px;
                padding-top: 15vh;
                border-radius: 0 !important;
                max-width: 100%;
                overflow: hidden;
            }
        }

        @media (max-width: 480px) {
            .container.login-mode {
                padding: 8px 0;
                padding-top: 12vh;
                border-radius: 0 !important;
                max-width: 100%;
            }
        }

        h1 {
            color: var(--text-color);
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--text-secondary);
        }

        input[type="text"],
        input[type="number"],
        input[type="password"],
        textarea,
        select {
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 2px solid var(--input-border);
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }

        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--input-border);
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="password"]:focus,
        textarea:focus,
        select:focus {
            border-color: #4285f4;
            outline: none;
        }

        .btn {
            background-color: #4285f4;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 10px;
        }

        .btn-sm {
            padding: 6px 14px;
            font-size: 13px;
            border-radius: 6px;
            width: auto;
            margin-bottom: 0;
        }

        .btn:hover {
            background-color: #3367d6;
        }

        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }



        .credentials {
            background-color: #f0f8ff;
            border: 1px solid #b0d4ff;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 400px;
            overflow-y: auto;
        }

        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .status.success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .status.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .status.info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .hidden {
            display: none !important;
        }

        /* 主界面样式 */
        #mainSection {
            width: 100%;
        }

        #mainSection>h1 {
            margin-top: 0;
            padding-top: 10px;
        }

        .loading {
            text-align: center;
            color: #666;
        }

        /* 漂亮的加载动画 */
        .loading-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            gap: 16px;
        }

        .loading-spinner .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: #4285f4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-spinner .spinner-text {
            color: var(--text-secondary);
            font-size: 14px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* 骨架屏加载动画 */
        .skeleton-loader {
            padding: 20px;
        }

        .skeleton-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .skeleton-line {
            height: 16px;
            background: linear-gradient(90deg, var(--border-color) 25%, var(--card-bg) 50%, var(--border-color) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
            margin-bottom: 12px;
        }

        .skeleton-line.short {
            width: 40%;
        }

        .skeleton-line.medium {
            width: 70%;
        }

        .skeleton-line.long {
            width: 100%;
        }

        .skeleton-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(90deg, var(--border-color) 25%, var(--card-bg) 50%, var(--border-color) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            margin: 0 auto 16px;
        }

        .skeleton-big-number {
            height: 40px;
            width: 150px;
            margin: 0 auto 8px;
            background: linear-gradient(90deg, var(--border-color) 25%, var(--card-bg) 50%, var(--border-color) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        /* ========== 全新登录页面设计 ========== */
        .login-form {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 30px 20px;
            position: relative;
            animation: loginFadeIn 0.8s ease-out;
        }

        @keyframes loginFadeIn {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* 登录卡片容器 */
        .login-card {
            background: var(--container-bg);
            border-radius: 24px;
            padding: 40px 36px;
            padding-top: 40px;
            width: 100%;
            max-width: 520px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.08),
                0 8px 24px rgba(0, 0, 0, 0.06);
            position: relative;
            overflow: visible;
        }

        [data-theme="dark"] .login-card {
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4),
                0 8px 24px rgba(0, 0, 0, 0.3);
        }

        /* Logo 区域 - 蓝白渐变 */
        .login-logo {
            width: 72px;
            height: 72px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #4285f4 0%, #87ceeb 100%);
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            box-shadow: 0 10px 30px rgba(66, 133, 244, 0.3);
            animation: logoFloat 3s ease-in-out infinite;
        }

        @keyframes logoFloat {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-6px);
            }
        }

        [data-theme="dark"] .login-logo {
            background: linear-gradient(135deg, #4285f4 0%, #5b9bd5 100%);
            box-shadow: 0 10px 30px rgba(66, 133, 244, 0.4);
        }

        .login-form h1 {
            font-size: 26px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-color);
            text-align: center;
            letter-spacing: -0.5px;
        }

        .login-form .login-subtitle {
            color: var(--text-secondary);
            margin-bottom: 28px;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .login-form .login-subtitle .lock-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 22px;
            height: 22px;
            background: linear-gradient(135deg, rgba(66, 133, 244, 0.1), rgba(135, 206, 235, 0.1));
            border-radius: 6px;
            font-size: 11px;
        }

        [data-theme="dark"] .login-form .login-subtitle .lock-icon {
            background: linear-gradient(135deg, rgba(91, 155, 213, 0.2), rgba(102, 126, 234, 0.2));
        }

        /* 输入框容器 */
        .login-input-wrapper {
            position: relative;
            margin-bottom: 24px;
        }

        .login-input-wrapper .input-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 18px;
            transition: color 0.3s ease;
            z-index: 1;
        }

        .login-form input[type="password"] {
            width: 100%;
            padding: 16px 16px 16px 48px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            letter-spacing: 2px;
            box-sizing: border-box;
            transition: all 0.3s ease;
            background: var(--input-bg);
            color: var(--text-color);
        }

        .login-form input[type="password"]:focus {
            border-color: #4285f4;
            box-shadow: 0 0 0 4px rgba(66, 133, 244, 0.1);
            outline: none;
        }

        .login-form input[type="password"]:focus+.input-icon,
        .login-input-wrapper:focus-within .input-icon {
            color: #4285f4;
        }

        [data-theme="dark"] .login-form input[type="password"]:focus {
            border-color: #4285f4;
            box-shadow: 0 0 0 4px rgba(66, 133, 244, 0.15);
        }

        [data-theme="dark"] .login-form input[type="password"]:focus+.input-icon,
        [data-theme="dark"] .login-input-wrapper:focus-within .input-icon {
            color: #4285f4;
        }

        .login-form input[type="password"]::placeholder {
            letter-spacing: 0;
            font-weight: 400;
            color: var(--text-muted);
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            10%,
            30%,
            50%,
            70%,
            90% {
                transform: translateX(-8px);
            }

            20%,
            40%,
            60%,
            80% {
                transform: translateX(8px);
            }
        }

        .login-form input[type="password"].error {
            border-color: #ea4335;
            animation: shake 0.5s ease-in-out;
            box-shadow: 0 0 0 4px rgba(234, 67, 53, 0.1);
        }

        [data-theme="dark"] .login-form input[type="password"].error {
            border-color: #ff6b6b;
            box-shadow: 0 0 0 4px rgba(255, 107, 107, 0.15);
        }

        /* 登录按钮 - 蓝白渐变 */
        .login-form .btn {
            width: 100%;
            padding: 14px 24px;
            font-size: 15px;
            font-weight: 600;
            letter-spacing: 0.5px;
            background: linear-gradient(135deg, #4285f4 0%, #34a9ff 100%);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3);
            transition: all 0.3s ease;
            border: none;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            color: white;
        }

        .login-form .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(66, 133, 244, 0.4);
        }

        .login-form .btn:active {
            transform: translateY(0);
            box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3);
        }

        .login-form .btn:disabled {
            background: var(--border-color);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        [data-theme="dark"] .login-form .btn {
            background: linear-gradient(135deg, #4285f4 0%, #5b9bd5 100%);
            box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3);
        }

        [data-theme="dark"] .login-form .btn:hover {
            box-shadow: 0 8px 25px rgba(66, 133, 244, 0.4);
        }

        /* 按钮加载状态 */
        .login-form .btn.loading {
            pointer-events: none;
            color: transparent;
        }

        .login-form .btn.loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            top: 50%;
            left: 50%;
            margin-left: -10px;
            margin-top: -10px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .login-form .btn.loading span {
            opacity: 0;
        }

        /* 底部装饰 */
        .login-footer {
            margin-top: 24px;
            text-align: center;
            color: var(--text-muted);
            font-size: 13px;
        }

        .login-footer a {
            color: #4285f4;
            text-decoration: none;
            font-weight: 500;
        }

        .login-footer a:hover {
            text-decoration: underline;
        }

        [data-theme="dark"] .login-footer a {
            color: #4285f4;
        }

        /* 登录框移动端响应式样式 */
        @media (max-width: 768px) {
            .login-form {
                padding: 20px 16px;
                width: 100%;
                box-sizing: border-box;
            }

            .login-card {
                padding: 32px 24px;
                border-radius: 20px;
                max-width: 100%;
                box-sizing: border-box;
            }

            .login-card-wrapper {
                max-width: 100%;
                padding: 0 8px;
                margin: 0 auto;
                box-sizing: border-box;
            }

            .login-logo {
                width: 64px;
                height: 64px;
                font-size: 28px;
                border-radius: 16px;
            }

            .login-form h1 {
                font-size: 24px;
            }

            .login-form .login-subtitle {
                font-size: 13px;
                margin-bottom: 24px;
            }

            .login-form input[type="password"] {
                padding: 14px 14px 14px 44px;
                font-size: 15px;
            }

            .login-input-wrapper .input-icon {
                left: 14px;
                font-size: 16px;
            }

            .login-form .btn {
                padding: 12px 20px;
                font-size: 14px;
            }

            .login-bg-decoration.circle-1 {
                width: 150px;
                height: 150px;
                top: -50px;
                right: -50px;
            }

            .login-bg-decoration.circle-2 {
                width: 120px;
                height: 120px;
                bottom: -30px;
                left: -30px;
            }
        }

        @media (max-width: 480px) {
            .login-form {
                padding: 16px 8px;
                width: 100%;
            }

            .login-card {
                padding: 28px 20px;
                border-radius: 16px;
            }

            .login-card-wrapper {
                padding: 0;
                margin: 0 auto;
            }

            .login-logo {
                width: 56px;
                height: 56px;
                font-size: 24px;
                border-radius: 14px;
                margin-bottom: 16px;
            }

            .login-form h1 {
                font-size: 22px;
                margin-bottom: 6px;
            }

            .login-form .login-subtitle {
                font-size: 12px;
                margin-bottom: 20px;
            }

            .login-input-wrapper {
                margin-bottom: 20px;
            }

            .login-form input[type="password"] {
                padding: 12px 12px 12px 40px;
                font-size: 14px;
                border-radius: 10px;
            }

            .login-input-wrapper .input-icon {
                left: 12px;
                font-size: 14px;
            }

            .login-form .btn {
                padding: 11px 18px;
                font-size: 13px;
                border-radius: 10px;
            }

            .login-footer {
                margin-top: 20px;
                font-size: 12px;
            }

            .login-bg-decoration.circle-1 {
                width: 100px;
                height: 100px;
                top: -30px;
                right: -30px;
            }

            .login-bg-decoration.circle-2 {
                width: 80px;
                height: 80px;
                bottom: -20px;
                left: -20px;
            }
        }

        /* 背景装饰元素 - 蓝白配色 */
        .login-bg-decoration {
            position: absolute;
            border-radius: 50%;
            opacity: 0.5;
            pointer-events: none;
        }

        .login-bg-decoration.circle-1 {
            width: 250px;
            height: 250px;
            background: radial-gradient(circle, rgba(66, 133, 244, 0.1) 0%, transparent 70%);
            top: -80px;
            right: -80px;
        }

        .login-bg-decoration.circle-2 {
            width: 180px;
            height: 180px;
            background: radial-gradient(circle, rgba(135, 206, 235, 0.15) 0%, transparent 70%);
            bottom: -40px;
            left: -40px;
        }

        [data-theme="dark"] .login-bg-decoration.circle-1 {
            background: radial-gradient(circle, rgba(66, 133, 244, 0.15) 0%, transparent 70%);
        }

        [data-theme="dark"] .login-bg-decoration.circle-2 {
            background: radial-gradient(circle, rgba(91, 155, 213, 0.15) 0%, transparent 70%);
        }

        /* ========== 登录页面高级动态特效 ========== */

        /* 粒子画布 */
        #particleCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        /* 彩带/五彩纸屑画布 */
        #confettiCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9998;
        }

        /* 涟漪画布 - 用于不规则椭圆波浪涟漪 */
        #rippleCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
        }

        /* 渐变背景层 - 持久浸染效果 */
        #gradientOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            opacity: 0;
            transition: opacity 1.5s ease;
            background: linear-gradient(135deg,
                    rgba(66, 133, 244, 0.08) 0%,
                    rgba(52, 168, 83, 0.06) 25%,
                    rgba(251, 188, 5, 0.05) 50%,
                    rgba(234, 67, 53, 0.06) 75%,
                    rgba(66, 133, 244, 0.08) 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }

        @keyframes gradientShift {

            0%,
            100% {
                background-position: 0% 50%;
            }

            25% {
                background-position: 50% 0%;
            }

            50% {
                background-position: 100% 50%;
            }

            75% {
                background-position: 50% 100%;
            }
        }

        [data-theme="dark"] #gradientOverlay {
            background: linear-gradient(135deg,
                    rgba(66, 133, 244, 0.12) 0%,
                    rgba(52, 168, 83, 0.08) 25%,
                    rgba(251, 188, 5, 0.07) 50%,
                    rgba(234, 67, 53, 0.08) 75%,
                    rgba(66, 133, 244, 0.12) 100%);
            background-size: 400% 400%;
        }

        /* 点击涟漪效果 */
        .click-ripple {
            position: fixed;
            border-radius: 50%;
            pointer-events: none;
            z-index: 9997;
            animation: rippleExpand 0.6s ease-out forwards;
        }

        @keyframes rippleExpand {
            0% {
                transform: scale(0);
                opacity: 0.6;
            }

            100% {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* 登录卡片包装器 - 用于边框动画 */
        .login-card-wrapper {
            position: relative;
            border-radius: 24px;
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
            max-width: 520px;
            margin: 0 auto;
            padding: 0;
            background: none;
            border: none;
            animation: none;
        }

        @property --angle {
            syntax: '<angle>';
            initial-value: 0deg;
            inherits: false;
        }

        @keyframes rotateBorder {
            to {
                --angle: 360deg;
            }
        }

        .login-card-wrapper:hover {
            transform: translateY(-8px);
        }

        /* 登录卡片悬浮效果增强 */
        .login-card-wrapper:hover .login-card {
            box-shadow: 0 30px 100px rgba(0, 0, 0, 0.12),
                0 0 40px rgba(66, 133, 244, 0.1);
        }

        [data-theme="dark"] .login-card-wrapper:hover .login-card {
            box-shadow: 0 30px 100px rgba(0, 0, 0, 0.5),
                0 0 40px rgba(66, 133, 244, 0.2);
        }

        /* 浮动光点动画（全局显示） */
        .floating-orb {
            position: fixed;
            border-radius: 50%;
            pointer-events: none;
            filter: blur(1px);
            z-index: 4;
            animation: floatOrb 6s ease-in-out infinite;
        }

        @keyframes floatOrb {

            0%,
            100% {
                transform: translateY(0) translateX(0) scale(1);
                opacity: 0.6;
            }

            25% {
                transform: translateY(-20px) translateX(10px) scale(1.1);
                opacity: 0.8;
            }

            50% {
                transform: translateY(-10px) translateX(-15px) scale(0.9);
                opacity: 0.5;
            }

            75% {
                transform: translateY(-25px) translateX(5px) scale(1.05);
                opacity: 0.7;
            }
        }

        /* 鼠标跟随光晕 */
        .mouse-glow {
            position: fixed;
            width: 400px;
            height: 400px;
            border-radius: 50%;
            background: radial-gradient(ellipse, rgba(66, 133, 244, 0.12) 0%, transparent 70%);
            pointer-events: none;
            z-index: 3;
            transform: translate(-50%, -50%);
            transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
        }

        [data-theme="dark"] .mouse-glow {
            background: radial-gradient(ellipse, rgba(66, 133, 244, 0.18) 0%, transparent 70%);
        }

        /* 星星闪烁效果（全局显示） */
        .twinkle-star {
            position: fixed;
            width: 4px;
            height: 4px;
            background: rgba(100, 100, 100, 0.3);
            border-radius: 50%;
            pointer-events: none;
            z-index: 4;
            animation: twinkle 2s ease-in-out infinite;
        }

        @keyframes twinkle {

            0%,
            100% {
                opacity: 0.2;
                transform: scale(0.8);
            }

            50% {
                opacity: 0.8;
                transform: scale(1.2);
            }
        }

        [data-theme="dark"] .twinkle-star {
            background: rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 6px rgba(255, 255, 255, 0.5);
        }

        /* 状态消息样式 */
        #loginStatus .status {
            margin-top: 16px;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
        }

        @keyframes gradientMove {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        /* 主界面使用flex布局实现固定头部 */
        #mainSection {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 60px);
            max-height: calc(100vh - 60px);
        }

        /* 固定头部区域 */
        .fixed-header {
            flex-shrink: 0;
            background-color: var(--card-bg);
            padding: 15px 20px 0 20px;
            margin: 0;
            border-radius: 12px;
            box-shadow: 0 2px 8px var(--shadow-color);
            z-index: 100;
            transition: box-shadow 0.3s ease;
        }

        .fixed-header.scrolled {
            box-shadow: 0 4px 12px var(--shadow-color);
        }

        .fixed-header h1 {
            margin-top: 0;
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            #mainSection {
                height: calc(100vh - 44px);
                max-height: calc(100vh - 44px);
            }

            .fixed-header {
                padding: 12px 16px 10px 16px;
                border-radius: 10px;
            }

            .fixed-header h1 {
                font-size: 1.5em;
                margin-bottom: 12px;
            }
        }

        @media (max-width: 480px) {
            #mainSection {
                height: calc(100vh - 36px);
                max-height: calc(100vh - 36px);
            }

            .fixed-header {
                padding: 10px 12px 8px 12px;
                border-radius: 8px;
            }

            .fixed-header h1 {
                font-size: 1.3em;
                margin-bottom: 10px;
            }
        }

        /* 标签栏容器 - 限制在圆角内 */
        .tabs-wrapper {
            overflow: hidden;
            margin: 0 -20px -12px -20px;
            padding: 0 20px 12px 20px;
        }

        @media (max-width: 768px) {
            .tabs-wrapper {
                margin: 0 -16px -10px -16px;
                padding: 0 16px 10px 16px;
            }
        }

        @media (max-width: 480px) {
            .tabs-wrapper {
                margin: 0 -12px -8px -12px;
                padding: 0 12px 8px 12px;
            }
        }

        .tabs {
            display: flex;
            gap: 6px;
            border-bottom: none;
            margin-bottom: 0;
            flex-wrap: nowrap;
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) transparent;
        }

        /* 内容区域 - 可滚动 */
        .tab-content-wrapper {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding-top: 20px;
            padding-bottom: 10px;
        }

        @media (max-width: 768px) {
            .tab-content-wrapper {
                padding-top: 16px;
                padding-bottom: 8px;
            }
        }

        @media (max-width: 480px) {
            .tab-content-wrapper {
                padding-top: 12px;
                padding-bottom: 6px;
            }
        }

        /* 标签页滚动条样式 */
        .tabs::-webkit-scrollbar {
            height: 4px;
        }

        .tabs::-webkit-scrollbar-track {
            background: transparent;
        }

        .tabs::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 2px;
        }

        .tabs::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background: var(--tab-bg);
            border-radius: 8px 8px 0 0;
            font-weight: 600;
            font-size: 16px;
            color: var(--text-secondary);
            transition: background-color 0.3s ease, color 0.3s ease;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .tab:hover {
            background: var(--hover-bg);
            color: var(--text-color);
        }

        .tab.active {
            background: var(--tab-active-bg);
            color: #2563eb;
            border-bottom: 2px solid #2563eb;
            box-shadow: inset 0 -2px 0 #2563eb;
        }

        .tab-content {
            display: none;
            overflow-x: hidden;
            max-width: 100%;
        }

        .tab-content.active {
            display: block;
        }

        @media (max-width: 768px) {
            .tab-content {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
        }

        @media (max-width: 768px) {
            .tabs {
                gap: 4px;
                padding-bottom: 8px;
                margin-left: -16px;
                margin-right: -16px;
                padding-left: 16px;
                padding-right: 16px;
            }

            .tab {
                padding: 10px 16px;
                font-size: 14px;
            }
        }

        @media (max-width: 480px) {
            .tabs {
                gap: 3px;
                margin-left: -16px;
                margin-right: -16px;
                padding-left: 16px;
                padding-right: 16px;
                padding-bottom: 10px;
            }

            .tab {
                padding: 8px 12px;
                font-size: 13px;
            }
        }

        /* 账户管理子标签页移动端优化 */
        .account-sub-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: nowrap;
            align-items: center;
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) transparent;
            padding-bottom: 8px;
        }

        .account-sub-tabs::-webkit-scrollbar {
            height: 4px;
        }

        .account-sub-tabs::-webkit-scrollbar-track {
            background: transparent;
        }

        .account-sub-tabs::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 2px;
        }

        @media (max-width: 480px) {
            .account-sub-tabs {
                gap: 6px;
                margin-left: -12px;
                margin-right: -12px;
                padding-left: 12px;
                padding-right: 12px;
            }

            .account-sub-tabs .btn-sm {
                flex-shrink: 0;
                white-space: nowrap;
            }
        }

        /* 成本筛选器样式 */
        .cost-filter-tag {
            transition: all 0.2s ease;
        }

        .cost-filter-tag:hover {
            background: var(--hover-bg) !important;
            border-color: #4285f4 !important;
        }

        .cost-filter-tag.active {
            background: rgba(66, 133, 244, 0.1) !important;
            border-color: #4285f4 !important;
            color: #4285f4 !important;
        }

        /* 成本视图切换按钮样式 */
        .cost-view-btn {
            transition: all 0.2s ease;
            color: var(--text-secondary);
        }

        .cost-view-btn:hover {
            background: var(--hover-bg) !important;
            border-color: #4285f4 !important;
            color: var(--text-color);
        }

        .cost-view-btn.active {
            background: #4285f4 !important;
            border-color: #4285f4 !important;
            color: white !important;
        }

        .cost-filter-panel {
            animation: slideDown 0.2s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .cost-window-btn {
            transition: all 0.2s ease;
            color: var(--text-color);
        }

        .cost-window-btn:hover {
            background: var(--hover-bg) !important;
        }

        .cost-window-btn.active {
            background: #4285f4 !important;
            color: white !important;
            border-color: #4285f4 !important;
        }

        .cost-model-category {
            margin-bottom: 12px;
        }

        .cost-model-category-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 1px solid var(--border-color);
        }

        .cost-model-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.15s;
        }

        .cost-model-item:hover {
            background: var(--hover-bg);
        }

        .cost-model-item input[type="checkbox"] {
            width: 14px;
            height: 14px;
            cursor: pointer;
        }

        .cost-active-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: #4285f4;
            color: white;
            border-radius: 12px;
            font-size: 11px;
        }

        .cost-active-tag button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 0;
            font-size: 14px;
            line-height: 1;
            opacity: 0.8;
        }

        .cost-active-tag button:hover {
            opacity: 1;
        }

        /* 成本页移动端响应式 */
        .responsive-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
        }

        .responsive-item {
            min-width: 0;
        }

        .summary-card {
            text-align: center;
            padding: 20px;
            background: var(--card-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            width: 100%;
            box-sizing: border-box;
            overflow: hidden;
        }

        .summary-card .summary-title {
            font-size: 14px;
            color: var(--text-secondary);
            word-break: break-word;
            overflow-wrap: anywhere;
        }

        .summary-card .summary-sub {
            font-size: 14px;
            color: var(--text-secondary);
            word-break: break-word;
            overflow-wrap: anywhere;
        }

        .summary-card .summary-value {
            font-size: 42px;
            font-weight: bold;
            color: var(--text-color);
            word-break: break-all;
        }

        .cost-label {
            word-break: break-word;
            overflow-wrap: anywhere;
        }

        @media (max-width: 768px) {
            .summary-card {
                padding: 16px;
            }

            .summary-card .summary-value {
                font-size: 36px;
            }

            .summary-card .summary-title,
            .summary-card .summary-sub {
                font-size: 13px;
            }
        }

        @media (max-width: 480px) {
            .summary-card {
                padding: 12px;
            }

            .summary-card .summary-value {
                font-size: 28px;
            }

            .summary-card .summary-title,
            .summary-card .summary-sub {
                font-size: 12px;
            }

            .responsive-grid {
                grid-template-columns: 1fr;
            }
        }

        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 5px;
            padding: 40px;
            text-align: center;
            background-color: #fafafa;
            margin: 20px 0;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .upload-area:hover {
            border-color: #4285f4;
        }

        .upload-area.dragover {
            border-color: #4285f4;
            background-color: #f0f8ff;
        }

        .file-list {
            margin: 20px 0;
        }

        .file-item {
            background-color: #f8f9fa;
            border: 1px solid #e1e4e8;
            border-radius: 3px;
            padding: 10px;
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-item .file-name {
            font-family: monospace;
            color: #333;
        }

        .file-item .file-size {
            color: #666;
            font-size: 12px;
        }

        .file-item .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 2px 8px;
            cursor: pointer;
            font-size: 12px;
        }

        .upload-progress {
            background-color: #f8f9fa;
            border: 1px solid #e1e4e8;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background-color: #28a745;
            transition: width 0.3s ease;
        }

        /* 文件管理样式 */
        .cred-card {
            background-color: #f8f9fa;
            border: 1px solid #e1e4e8;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            position: relative;
            min-width: 600px;
        }

        @media (max-width: 480px) {
            .cred-card {
                min-width: auto;
            }
        }

        .cred-card.disabled {
            background-color: #f5f5f5;
            border-color: #ccc;
            opacity: 0.7;
        }

        .cred-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            gap: 20px;
        }

        .cred-filename {
            font-family: monospace;
            font-weight: bold;
            color: #333;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 300px;
        }

        @media (max-width: 768px) {
            .cred-filename {
                min-width: 0;
                white-space: normal;
                overflow-wrap: anywhere;
            }

            /* 移动端表格优化 */
            .rates-table {
                font-size: 12px;
            }

            .rates-table th,
            .rates-table td {
                padding: 6px 3px !important;
                word-break: break-word;
            }

            .rates-table th:first-child,
            .rates-table td:first-child {
                padding-left: 6px !important;
            }

            .rates-table th:last-child,
            .rates-table td:last-child {
                padding-right: 6px !important;
            }

            /* 移动端 config-group 优化 */
            .config-group {
                padding: 12px;
                margin: 10px 0;
            }

            .config-group h4 {
                font-size: 16px;
                margin-bottom: 10px;
            }

            /* 移动端表格通用优化 */
            .table {
                font-size: 12px;
            }

            .table th,
            .table td {
                padding: 6px 4px;
                word-break: break-word;
                overflow-wrap: break-word;
            }

            /* 移动端配置表格优化 */
            #allConfigTable {
                display: block;
                overflow-x: visible;
                -webkit-overflow-scrolling: touch;
            }

            #allConfigTable thead {
                display: none;
                /* 移动端隐藏表头 */
            }

            #allConfigTable tbody {
                display: block;
            }

            #allConfigTable tbody tr {
                display: flex;
                flex-direction: column;
                margin-bottom: 12px;
                padding: 12px;
                border: 1px solid var(--border-color);
                border-radius: 8px;
                background: var(--card-bg);
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            }

            #allConfigTable tbody td {
                display: block;
                padding: 6px 0;
                border: none;
                width: 100% !important;
                min-width: 0 !important;
            }

            #allConfigTable tbody td:first-child {
                font-weight: 600;
                color: var(--text-secondary);
                font-size: 11px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                margin-bottom: 4px;
                padding-bottom: 2px;
            }

            #allConfigTable tbody td:nth-child(2) {
                font-weight: 500;
                color: var(--text-color);
                font-size: 13px;
                margin-bottom: 6px;
                word-break: break-word;
                padding-bottom: 4px;
                border-bottom: 1px solid var(--border-color);
            }

            #allConfigTable tbody td:nth-child(3) {
                color: var(--text-color);
                font-size: 12px;
                line-height: 1.5;
                padding-top: 6px;
                padding-bottom: 6px;
                border-bottom: 1px solid var(--border-color);
            }

            /* 移动端操作列优化 */
            #allConfigTable tbody td.config-actions-cell {
                padding-top: 8px;
                padding-bottom: 4px;
                border-top: none;
                margin-top: 0;
                text-align: left;
            }

            .config-value-actions {
                display: flex;
                flex-wrap: wrap;
                gap: 6px;
                justify-content: flex-start;
                align-items: center;
                margin: 0;
                width: 100%;
            }

            .config-toggle-btn,
            .config-copy-btn {
                font-size: 11px;
                padding: 5px 12px;
                width: 55px;
                height: 28px;
                line-height: 1;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                box-sizing: border-box;
                margin: 0;
            }

            .config-value-preview,
            .config-value-full {
                display: block;
                margin-bottom: 0;
            }

            /* 移动端账户管理标签栏优化 */
            .account-sub-tabs {
                gap: 6px !important;
            }

            .account-logout-btn {
                margin-left: auto !important;
                flex-shrink: 0;
            }

            /* 移动端登录表单优化 */
            .login-form {
                padding: 20px 16px;
            }

            .login-card {
                padding: 32px 24px;
                border-radius: 20px;
            }

            .login-logo {
                width: 64px;
                height: 64px;
                font-size: 28px;
                border-radius: 16px;
                margin-bottom: 20px;
            }

            .login-form h1 {
                font-size: 22px;
            }

            .login-form .login-subtitle {
                font-size: 14px;
                margin-bottom: 24px;
            }

            .login-form input[type="password"] {
                padding: 14px 14px 14px 44px;
                font-size: 15px;
            }

            .login-input-wrapper .input-icon {
                left: 14px;
                font-size: 16px;
            }

            .login-form .btn {
                padding: 14px 20px;
                font-size: 15px;
            }

            .login-bg-decoration.circle-1 {
                width: 200px;
                height: 200px;
                top: -80px;
                right: -80px;
            }

            .login-bg-decoration.circle-2 {
                width: 150px;
                height: 150px;
                bottom: -40px;
                left: -40px;
            }

            /* 移动端卡片和容器优化 */
            .summary-card {
                padding: 12px;
            }

            .summary-value {
                font-size: 28px !important;
            }

            .summary-title {
                font-size: 13px;
            }

            /* 移动端按钮组优化 */
            .btn-sm {
                font-size: 12px;
                padding: 5px 10px;
            }

            /* 移动端响应式网格 */
            .responsive-grid {
                grid-template-columns: 1fr !important;
            }

            /* 移动端成本分析优化 */
            #accountCostContent h4,
            #accountUsageContent h4,
            #accountRatesContent h5 {
                font-size: 15px;
                word-break: break-word;
            }

            /* 移动端筛选器优化 */
            .cost-filter-tags {
                gap: 6px !important;
            }

            .cost-filter-tag {
                padding: 5px 10px !important;
                font-size: 12px !important;
            }

            .cost-filter-panel {
                padding: 12px !important;
            }

            #costModelList {
                grid-template-columns: 1fr !important;
            }

            .cost-model-item {
                font-size: 11px !important;
            }

            /* ========== 费率和成本表格等比例缩小 ========== */
            /* 取消横向滚动，改为等比例缩小 */
            .rates-table-wrap,
            .cost-table-wrap {
                overflow-x: visible !important;
            }

            /* 费率表格等比例缩小 */
            .rates-table {
                font-size: 11px !important;
                width: 100% !important;
                min-width: 0 !important;
                table-layout: fixed;
            }

            .rates-table th,
            .rates-table td {
                padding: 6px 3px !important;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .rates-table th:first-child,
            .rates-table td:first-child {
                width: 42%;
                white-space: normal;
                word-break: break-word;
            }

            .rates-table th:nth-child(2),
            .rates-table td:nth-child(2),
            .rates-table th:nth-child(3),
            .rates-table td:nth-child(3) {
                width: 26%;
                text-align: right;
                white-space: nowrap;
            }

            /* 隐藏单位列 - 移动端节省空间 */
            .rates-unit-col {
                display: none !important;
            }

            /* 成本分析表格等比例缩小 */
            .cost-model-table,
            .cost-items-table {
                font-size: 11px !important;
                width: 100% !important;
                min-width: 0 !important;
                table-layout: fixed;
            }

            .cost-model-table th,
            .cost-model-table td,
            .cost-items-table th,
            .cost-items-table td {
                padding: 6px 3px !important;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            /* 按模型分类表格 - 隐藏输入输出成本列 */
            .cost-model-table th:nth-child(2),
            .cost-model-table td:nth-child(2),
            .cost-model-table th:nth-child(3),
            .cost-model-table td:nth-child(3) {
                display: none;
            }

            .cost-model-table th:first-child,
            .cost-model-table td:first-child {
                width: 55%;
                white-space: normal;
                word-break: break-word;
            }

            .cost-model-table th:last-child,
            .cost-model-table td:last-child {
                width: 45%;
                text-align: right;
                white-space: nowrap;
            }

            /* 日期明细表格 - 隐藏输入输出成本列 */
            .cost-items-table th:nth-child(3),
            .cost-items-table td:nth-child(3),
            .cost-items-table th:nth-child(4),
            .cost-items-table td:nth-child(4) {
                display: none;
            }

            .cost-items-table th:first-child,
            .cost-items-table td:first-child {
                width: 25%;
                white-space: nowrap;
            }

            .cost-items-table th:nth-child(2),
            .cost-items-table td:nth-child(2) {
                width: 50%;
                white-space: normal;
                word-break: break-word;
            }

            .cost-items-table th:last-child,
            .cost-items-table td:last-child {
                width: 25%;
                text-align: right;
                white-space: nowrap;
            }

            /* 成本卡片内边距优化 */
            .cost-card,
            .rates-card,
            .usage-card {
                padding: 12px !important;
            }

            /* ========== 使用量页面模型列表优化 ========== */
            .usage-model-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 6px 0;
                border-bottom: 1px solid var(--border-color);
                gap: 8px;
            }

            .usage-model-info {
                display: flex;
                align-items: center;
                flex: 1;
                min-width: 0;
            }

            .usage-model-dot {
                width: 10px;
                height: 10px;
                border-radius: 50%;
                margin-right: 6px;
                flex-shrink: 0;
            }

            .usage-model-name {
                color: var(--text-color);
                font-size: 12px;
                word-break: break-word;
                line-height: 1.3;
            }

            .usage-model-stats {
                display: flex;
                align-items: center;
                flex-shrink: 0;
                gap: 3px;
                font-size: 11px;
            }

            .usage-model-tokens {
                font-weight: bold;
                color: var(--text-color);
            }

            .usage-model-unit {
                color: var(--text-secondary);
            }

            .usage-model-percent {
                color: var(--text-muted);
            }

            /* 简单2列费率表格样式 */
            .rates-simple-table {
                font-size: 11px !important;
                width: 100% !important;
                table-layout: fixed;
            }

            .rates-simple-table th,
            .rates-simple-table td {
                padding: 6px 3px !important;
            }

            .rates-simple-table th:first-child,
            .rates-simple-table td:first-child {
                width: 60%;
                white-space: normal;
                word-break: break-word;
            }

            .rates-simple-table th:last-child,
            .rates-simple-table td:last-child {
                width: 40%;
                text-align: right;
                white-space: nowrap;
            }
        }

        /* 更小屏幕进一步优化 */
        @media (max-width: 480px) {

            /* 费率表格进一步缩小 */
            .rates-table {
                font-size: 10px !important;
            }

            .rates-table th,
            .rates-table td {
                padding: 4px 2px !important;
            }

            .rates-table th:first-child,
            .rates-table td:first-child {
                width: 45%;
            }

            .rates-table th:nth-child(2),
            .rates-table td:nth-child(2),
            .rates-table th:nth-child(3),
            .rates-table td:nth-child(3) {
                width: 27%;
            }

            /* 成本分析表格进一步缩小 */
            .cost-model-table,
            .cost-items-table {
                font-size: 10px !important;
            }

            .cost-model-table th,
            .cost-model-table td,
            .cost-items-table th,
            .cost-items-table td {
                padding: 4px 2px !important;
            }

            /* 卡片边距更紧凑 */
            .cost-card,
            .rates-card,
            .usage-card {
                padding: 8px !important;
            }

            /* 使用量页面进一步优化 */
            .usage-model-name {
                font-size: 11px;
            }

            .usage-model-stats {
                font-size: 10px;
            }

            .usage-model-dot {
                width: 8px;
                height: 8px;
            }

            /* 简单费率表格进一步缩小 */
            .rates-simple-table {
                font-size: 10px !important;
            }

            .rates-simple-table th,
            .rates-simple-table td {
                padding: 4px 2px !important;
            }

            /* 标题更小 */
            .cost-card h4,
            .rates-card h5 {
                font-size: 13px !important;
                margin-bottom: 8px !important;
            }

            /* 总结卡片字体缩小 */
            #accountCostContent div[style*="font-size: 36px"] {
                font-size: 28px !important;
            }

            #accountCostContent div[style*="font-size: 14px"] {
                font-size: 12px !important;
            }
        }

        /* 确保桌面端不受影响 */
        @media (min-width: 769px) {

            .table th,
            .table td {
                word-break: normal;
                overflow-wrap: normal;
            }

            /* 桌面端使用量页面样式 */
            .usage-model-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 8px 0;
                border-bottom: 1px solid var(--border-color);
            }

            .usage-model-info {
                display: flex;
                align-items: center;
                flex: 1;
            }

            .usage-model-dot {
                width: 12px;
                height: 12px;
                border-radius: 50%;
                margin-right: 8px;
                flex-shrink: 0;
            }

            .usage-model-name {
                word-break: break-word;
                color: var(--text-color);
            }

            .usage-model-stats {
                text-align: right;
                margin-left: 12px;
                white-space: nowrap;
            }

            .usage-model-tokens {
                font-weight: bold;
                color: var(--text-color);
            }

            .usage-model-unit {
                color: var(--text-secondary);
                margin-left: 4px;
            }

            .usage-model-percent {
                color: var(--text-muted);
                margin-left: 8px;
            }
        }

        .cred-status {
            display: flex;
            gap: 5px;
        }

        .status-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            color: white;
        }

        .status-badge.enabled {
            background-color: #28a745;
        }

        .status-badge.disabled {
            background-color: #6c757d;
        }

        .error-codes {
            background-color: #f8d7da;
            color: #721c24;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .cred-actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .cred-btn {
            padding: 4px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .cred-btn.enable {
            background-color: #28a745;
            color: white;
        }

        .cred-btn.disable {
            background-color: #6c757d;
            color: white;
        }

        .cred-btn.delete {
            background-color: #dc3545;
            color: white;
        }

        .cred-btn.download {
            background-color: #007bff;
            color: white;
        }

        .cred-btn.view {
            background-color: #17a2b8;
            color: white;
        }

        .cred-details {
            margin-top: 10px;
            display: none;
        }

        .cred-details.show {
            display: block;
        }

        .cred-content {
            background-color: #f0f8ff;
            border: 1px solid #b0d4ff;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 11px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 200px;
            overflow-y: auto;
        }

        .manage-actions {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* 文件管理新增样式 */
        .stats-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-item {
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 12px 20px;
            text-align: center;
            min-width: 120px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            display: block;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            margin-top: 4px;
        }

        .stat-item.total {
            border-left: 4px solid #007bff;
        }

        .stat-item.normal {
            border-left: 4px solid #28a745;
        }

        .stat-item.disabled {
            border-left: 4px solid #6c757d;
        }

        .filter-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 8px 12px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            background-color: var(--input-bg);
            color: var(--text-color);
        }

        .filter-select:focus {
            border-color: #4285f4;
            outline: none;
        }

        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .pagination-info {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .pagination-btn {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-color);
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--input-bg);
            border-color: #4285f4;
        }

        .pagination-btn:disabled {
            background: #f5f5f5;
            color: #ccc;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background: #4285f4;
            color: white;
            border-color: #4285f4;
        }

        .page-size-select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .refresh-btn {
            background-color: #17a2b8;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .download-all-btn {
            background-color: #28a745;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        /* 实时日志按钮组样式 */
        .log-btn-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .log-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            font-size: 13px;
            font-weight: 500;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
        }

        .log-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
        }

        .log-btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .log-btn-connect {
            background: linear-gradient(135deg, #17a2b8, #138496);
        }

        .log-btn-connect:hover {
            background: linear-gradient(135deg, #138496, #117a8b);
        }

        .log-btn-disconnect {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }

        .log-btn-disconnect:hover {
            background: linear-gradient(135deg, #c82333, #bd2130);
        }

        .log-btn-download {
            background: linear-gradient(135deg, #28a745, #218838);
        }

        .log-btn-download:hover {
            background: linear-gradient(135deg, #218838, #1e7e34);
        }

        .log-btn-clear {
            background: linear-gradient(135deg, #6c757d, #5a6268);
        }

        .log-btn-clear:hover {
            background: linear-gradient(135deg, #5a6268, #545b62);
        }

        .log-btn .btn-icon {
            font-size: 14px;
        }

        /* 暗黑模式下日志按钮样式 */
        [data-theme="dark"] .log-btn {
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        [data-theme="dark"] .log-btn:hover {
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.4);
        }

        /* 移动端日志按钮优化 */
        @media (max-width: 480px) {
            .log-btn-group {
                gap: 6px;
            }

            .log-btn {
                padding: 6px 10px;
                font-size: 12px;
                gap: 4px;
            }

            .log-btn .btn-icon {
                font-size: 12px;
            }
        }

        /* 批量操作样式 */
        .batch-controls {
            background-color: #f8f9fa;
            border: 1px solid #e1e4e8;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            margin-right: 15px;
        }

        .batch-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            margin-top: 10px;
        }

        .batch-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .batch-btn.batch-enable {
            background-color: #28a745;
            color: white;
        }

        .batch-btn.batch-disable {
            background-color: #6c757d;
            color: white;
        }

        .batch-btn.batch-delete {
            background-color: #dc3545;
            color: white;
        }

        .batch-btn.batch-email {
            background-color: #17a2b8;
            color: white;
        }

        .batch-btn:disabled {
            background-color: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
        }

        .cred-btn.email {
            background-color: #17a2b8;
            color: white;
        }

        .cred-btn.email:hover {
            background-color: #138496;
        }

        .selected-count {
            font-weight: bold;
            color: #007bff;
            margin-right: 10px;
        }

        .select-all-checkbox {
            margin-right: 8px;
            transform: scale(1.2);
        }

        /* 错误码筛选增强 */
        .error-filter-container {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .error-code-badge {
            display: inline-block;
            background-color: #dc3545;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
            margin: 1px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .error-code-badge:hover {
            background-color: #c82333;
        }

        .error-code-badge.selected {
            background-color: #007bff;
        }

        /* 配置管理样式 */
        .config-group {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            transition: background-color 0.3s ease, border-color 0.3s ease;
            overflow-x: hidden;
        }

        .config-group h4 {
            margin-top: 0;
            margin-bottom: 15px;
            color: var(--text-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
        }

        .config-input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
            margin-bottom: 5px;
        }

        .config-input:focus {
            border-color: #4285f4;
            outline: none;
        }

        .config-input:disabled {
            background-color: #f5f5f5;
            color: #666;
            cursor: not-allowed;
        }

        .config-checkbox {
            margin-right: 8px;
            transform: scale(1.2);
        }

        .config-note {
            display: block;
            color: #666;
            font-size: 12px;
            margin-bottom: 10px;
            font-style: italic;
        }

        .config-info {
            background-color: #e3f2fd;
            border: 1px solid #1976d2;
            border-radius: 4px;
            padding: 12px;
            margin-top: 8px;
            font-size: 13px;
            color: #1565c0;
        }

        .config-info ul {
            margin: 8px 0 4px 0;
            color: #424242;
        }

        .config-info li {
            margin: 3px 0;
        }

        /* 暗黑模式下的使用说明样式 */
        [data-theme="dark"] .config-info {
            background-color: rgba(33, 150, 243, 0.1);
            border-color: rgba(33, 150, 243, 0.3);
            color: #90caf9;
        }

        [data-theme="dark"] .config-info ul {
            color: var(--text-secondary);
        }

        [data-theme="dark"] .config-info strong {
            color: var(--text-color) !important;
        }

        .env-locked {
            position: relative;
            opacity: 0.6;
            filter: grayscale(50%);
            cursor: pointer;
        }

        .env-locked::after {
            content: "Locked";
            position: absolute;
            right: 12px;
            top: 6px;
            background-color: #4a5568;
            color: #e2e8f0;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
            z-index: 2;
            pointer-events: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
            animation: floatIsland 3s ease-in-out infinite;
            opacity: 1;
            filter: none;
        }

        @keyframes floatIsland {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-3px);
            }
        }

        [data-theme="dark"] .env-locked::after {
            background-color: #2d3748;
            color: #a0aec0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
        }

        .env-locked input:disabled,
        .env-locked select:disabled,
        .env-locked textarea:disabled {
            cursor: not-allowed;
            pointer-events: none;
        }

        /* 配置页面浮动按钮 */
        .config-floating-actions {
            position: fixed;
            bottom: 50px;
            right: calc(50% - 480px);
            display: none;
            flex-direction: column;
            gap: 10px;
            z-index: 9998;
        }

        .config-floating-actions.visible {
            display: flex;
        }

        .config-floating-btn {
            padding: 10px 20px;
            border-radius: 25px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            animation: floatBtn 3s ease-in-out infinite;
        }

        .config-floating-btn:hover {
            transform: scale(1.08);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
        }

        .config-floating-btn:active {
            transform: scale(0.95);
        }

        .config-floating-btn.refresh {
            background: linear-gradient(135deg, #4285f4 0%, #5c9aff 100%);
            color: white;
        }

        .config-floating-btn.save {
            background: linear-gradient(135deg, #34a853 0%, #5cb85c 100%);
            color: white;
        }

        @keyframes floatBtn {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-3px);
            }
        }

        .config-floating-btn:hover {
            animation: none;
            transform: scale(1.08);
        }

        /* 暗黑模式浮动按钮 */
        [data-theme="dark"] .config-floating-btn {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        [data-theme="dark"] .config-floating-btn:hover {
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.5);
        }

        /* 当屏幕宽度小于1040px时，按钮靠右边距 */
        @media (max-width: 1040px) {
            .config-floating-actions {
                right: 30px;
            }
        }

        @media (max-width: 768px) {
            .config-floating-actions {
                bottom: 30px;
                right: 20px;
            }

            .config-floating-btn {
                padding: 10px 20px;
                font-size: 14px;
                border-radius: 25px;
            }
        }

        @media (max-width: 480px) {
            .config-floating-actions {
                bottom: 25px;
                right: 15px;
            }

            .config-floating-btn {
                padding: 8px 16px;
                font-size: 13px;
            }
        }

        /* 暗黑模式面板优先配置区块 */
        [data-theme="dark"] .config-group[style*="fff9e6"] {
            background: linear-gradient(135deg, #3d3520 0%, #4a4025 100%) !important;
            border-color: #6b5a1e !important;
        }

        [data-theme="dark"] .config-group[style*="fff9e6"] h4,
        [data-theme="dark"] .config-group[style*="fff9e6"] span,
        [data-theme="dark"] .config-group[style*="fff9e6"] .config-note {
            color: #ffc107 !important;
        }

        /* 使用统计样式 */
        .usage-card {
            background-color: #f8f9fa;
            border: 1px solid #e1e4e8;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            position: relative;
        }

        .usage-card-disabled {
            opacity: 0.6;
            background-color: #f5f5f5;
            border-color: #d0d0d0;
        }

        .usage-card-disabled .usage-filename {
            color: #999;
        }

        .usage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .usage-filename {
            font-family: monospace;
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .usage-progress {
            margin: 10px 0;
        }

        .usage-progress-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            font-size: 12px;
        }

        .usage-progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .usage-progress-fill {
            height: 100%;
            transition: width 0.3s ease;
        }

        .usage-progress-fill.gemini {
            background-color: #ff6b35;
        }

        .usage-progress-fill.total {
            background-color: #007bff;
        }

        .usage-progress-fill.warning {
            background-color: #ffc107;
        }

        .usage-progress-fill.danger {
            background-color: #dc3545;
        }

        .usage-actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .usage-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .usage-btn.reset {
            background-color: #6c757d;
            color: white;
        }

        .usage-btn.limits {
            background-color: #17a2b8;
            color: white;
        }

        .usage-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
            font-size: 12px;
        }

        .usage-info-item {
            background-color: var(--card-bg);
            padding: 8px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }

        .usage-info-label {
            font-weight: bold;
            color: var(--text-secondary);
            display: block;
            margin-bottom: 2px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .table thead th {
            background: var(--card-bg);
            color: var(--text-color);
            text-align: left;
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.3s ease;
        }

        .table tbody td {
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-color);
            transition: color 0.3s ease;
            vertical-align: top;
        }

        .table tbody tr:nth-child(odd) {
            background: var(--table-stripe);
        }

        .table tbody tr:hover {
            background: var(--table-hover);
        }

        /* 表格移动端响应式 - 水平滚动容器 */
        .table-responsive {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 16px;
        }

        .table-responsive .table {
            min-width: 500px;
        }

        /* 移动端表格优化 */
        @media (max-width: 768px) {
            .table {
                font-size: 11px;
            }

            .table thead th,
            .table tbody td {
                padding: 6px 4px;
                white-space: nowrap;
            }

            .table thead th:first-child,
            .table tbody td:first-child {
                max-width: 60px;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .model-tag {
                font-size: 10px !important;
                padding: 1px 4px !important;
                margin: 1px !important;
            }
        }

        /* 配置值显示优化 */
        .config-value-cell {
            position: relative;
            max-width: 100%;
            word-break: break-word;
            overflow-wrap: break-word;
        }

        .config-value-preview {
            display: block;
            max-width: 100%;
            word-break: break-all;
            overflow-wrap: break-word;
            line-height: 1.4;
        }

        .config-value-full {
            display: none;
            word-break: break-all;
            overflow-wrap: break-word;
            white-space: pre-wrap;
            line-height: 1.5;
            background: var(--code-bg);
            padding: 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }

        .config-value-cell.expanded .config-value-preview {
            display: none;
        }

        .config-value-cell.expanded .config-value-full {
            display: block;
        }

        /* 操作列样式 */
        .config-actions-cell {
            text-align: left;
            vertical-align: top;
            white-space: nowrap;
            width: 120px;
            padding: 8px !important;
        }

        .config-value-actions {
            display: flex;
            gap: 6px;
            justify-content: flex-start;
            align-items: center;
            width: 100%;
        }

        .config-toggle-btn,
        .config-copy-btn {
            font-size: 11px;
            padding: 5px 12px;
            border: 1px solid var(--border-color);
            background: var(--input-bg);
            color: var(--text-color);
            border-radius: 4px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            width: 55px;
            height: 28px;
            line-height: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
            margin: 0;
        }

        .config-toggle-btn:hover,
        .config-copy-btn:hover {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        [data-theme="dark"] .config-toggle-btn:hover,
        [data-theme="dark"] .config-copy-btn:hover {
            background: #0056b3;
            color: white;
            border-color: #0056b3;
        }

        .config-copy-btn.copied {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }

        /* 模型调用次数排行 - 柱状图样式 */
        .ranking-container {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .ranking-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .ranking-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-color);
        }

        .ranking-total {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .ranking-body {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 8px;
        }

        .ranking-chart-area {
            flex: 0 0 auto;
            min-width: max-content;
            overflow-x: visible;
        }

        .ranking-y-axis {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: flex-end;
            padding-right: 4px;
            font-size: 10px;
            color: var(--text-secondary);
            height: 160px;
            min-width: 24px;
            flex-shrink: 0;
        }

        .ranking-chart-wrapper {
            position: relative;
        }

        .ranking-grid-lines {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 160px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            pointer-events: none;
        }

        .ranking-grid-line {
            border-top: 1px dashed var(--border-color);
            width: 100%;
        }

        .ranking-chart {
            display: flex;
            align-items: flex-end;
            gap: 3px;
            height: 160px;
            padding-bottom: 0;
            min-width: max-content;
        }

        .ranking-bar-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 0 0 32px;
            width: 32px;
        }

        .ranking-bar-col {
            width: 100%;
            border-radius: 3px 3px 0 0;
            min-height: 2px;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .ranking-bar-col:hover {
            opacity: 0.85;
        }

        .ranking-x-labels {
            position: relative;
            display: flex;
            gap: 3px;
            margin-top: 8px;
            height: 20px;
        }

        .ranking-x-label {
            flex: 0 0 32px;
            width: 32px;
            font-size: 10px;
            color: var(--text-secondary);
            text-align: left;
            white-space: nowrap;
            overflow: visible;
        }

        .ranking-x-label:empty {
            visibility: hidden;
        }

        .ranking-pager {
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 4px;
            margin-left: 8px;
            flex-shrink: 0;
        }

        /* 移动端隐藏分页器，改用滚动 */
        @media (max-width: 768px) {
            .ranking-pager {
                display: none;
            }
        }

        .ranking-pager-btn {
            background: transparent;
            border: none;
            font-size: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px 8px;
            line-height: 1;
        }

        .ranking-pager-btn:hover:not(:disabled) {
            color: var(--text-color);
        }

        .ranking-pager-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .ranking-pager-info {
            font-size: 11px;
            color: var(--text-secondary);
            text-align: center;
        }

        .ranking-legend-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 8px 16px;
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
            max-height: 120px;
            overflow-y: auto;
        }

        .ranking-legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .ranking-legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            flex-shrink: 0;
        }

        /* 柱状图 tooltip */
        .ranking-tooltip {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px 14px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            pointer-events: none;
            white-space: nowrap;
        }

        [data-theme="dark"] .ranking-tooltip {
            background: #2d2d2d;
            border-color: #444;
        }

        .ranking-tooltip-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 4px;
        }

        .ranking-tooltip-row {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .ranking-tooltip-dot {
            width: 10px;
            height: 10px;
            border-radius: 2px;
            flex-shrink: 0;
        }

        .ranking-tooltip-count {
            font-weight: 600;
            color: var(--text-color);
            margin-left: auto;
        }

        /* 图例分页 */
        .ranking-legend-wrapper {
            position: relative;
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }

        .ranking-legend-pager {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            position: absolute;
            right: 0;
            top: 12px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .ranking-legend-pager-btn {
            background: none;
            border: none;
            font-size: 10px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 2px 4px;
        }

        .ranking-legend-pager-btn:hover:not(:disabled) {
            color: var(--text-color);
        }

        .ranking-legend-pager-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* 环形图样式 */
        .donut-chart-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .donut-chart {
            position: relative;
            width: 200px;
            height: 200px;
        }

        .donut-chart svg {
            transform: rotate(-90deg);
        }

        .donut-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .donut-center-total {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-color);
        }

        .donut-center-label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .donut-legend {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 280px;
            overflow-y: auto;
            padding-right: 12px;
        }

        .donut-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .donut-legend-item:hover {
            background: var(--input-bg);
        }

        .donut-legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .donut-legend-name {
            flex: 1;
            overflow: hidden;
            min-width: 0;
            position: relative;
        }

        /* 内部滚动的文字 */
        .donut-legend-name-inner {
            display: inline-block;
            white-space: nowrap;
        }

        /* 长名称自动滚动 - 向左滚动，首尾相连 */
        .donut-legend-name-inner.marquee-scroll {
            display: inline-flex;
            animation: marquee-scroll-left 12s linear infinite;
        }

        .donut-legend-name-inner.marquee-scroll .marquee-text {
            padding-right: 50px;
            /* 两份文本之间的间距 */
        }

        .donut-legend-count {
            font-weight: 600;
            color: var(--text-color);
            flex-shrink: 0;
        }

        /* 向左滚动动画 - 首尾相连效果 */
        @keyframes marquee-scroll-left {
            0% {
                transform: translateX(0);
            }

            100% {
                transform: translateX(-50%);
            }
        }

        .donut-legend-pager {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .donut-legend-pager button {
            background: none;
            border: none;
            font-size: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 2px 6px;
        }

        .donut-legend-pager button:hover:not(:disabled) {
            color: var(--text-color);
        }

        .donut-legend-pager button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .donut-tooltip {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 8px 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            pointer-events: none;
            white-space: nowrap;
            font-size: 12px;
        }

        [data-theme="dark"] .donut-tooltip {
            background: #2d2d2d;
            border-color: #444;
        }

        /* 模型分布图移动端响应式样式 */
        @media (max-width: 768px) {
            .ranking-header {
                flex-direction: column;
                gap: 8px;
                align-items: flex-start;
            }

            .ranking-title {
                white-space: nowrap;
            }

            #distributionChart {
                flex-direction: column !important;
                align-items: center !important;
                gap: 16px !important;
            }

            #distributionChart>div:first-child {
                min-width: auto !important;
                width: 100% !important;
                overflow: visible;
                display: flex;
                justify-content: center;
                padding: 10px 0;
            }

            /* JS现在会动态调整移动端尺寸，无需CSS强制宽度 */
            #distributionChart svg {
                max-width: 100%;
            }

            #distributionLegendContainer {
                width: 100% !important;
                height: auto !important;
                max-height: none;
            }

            .donut-legend {
                flex-direction: row !important;
                flex-wrap: wrap;
                gap: 6px !important;
                max-height: none;
                padding-right: 0;
                justify-content: center;
            }

            .donut-legend-item {
                flex: 0 0 auto;
                width: calc(50% - 6px);
                font-size: 11px;
                padding: 5px 8px;
                background: var(--card-bg);
                border: 1px solid var(--border-color);
                border-radius: 6px;
                display: flex;
                align-items: center;
                gap: 6px;
            }

            .donut-legend-dot {
                flex-shrink: 0;
                width: 10px;
                height: 10px;
                border-radius: 50%;
            }

            /* 名称容器 - 固定宽度，内部滚动 */
            .donut-legend-name {
                flex: 1;
                min-width: 0;
                overflow: hidden;
                position: relative;
            }

            /* 内部滚动的文字 */
            .donut-legend-name-inner {
                display: inline-block;
                white-space: nowrap;
                animation: auto-scroll-name 5s linear infinite;
                animation-delay: 1s;
            }

            /* 短名称不需要滚动 */
            .donut-legend-name-inner.no-scroll {
                animation: none;
            }

            .donut-legend-count {
                flex-shrink: 0;
                font-weight: 600;
                margin-left: 4px;
            }

            /* 确保tooltip不被遮挡 */
            .donut-tooltip {
                z-index: 99999 !important;
            }
        }

        @media (max-width: 480px) {
            .donut-legend-item {
                width: calc(50% - 4px);
                font-size: 10px;
                padding: 4px 6px;
            }
        }



        .ranking-bar-fail {
            position: absolute;
            top: 0;
            height: 100%;
            background: #dc3545;
            border-radius: 0 9px 9px 0;
        }

        .ranking-count {
            text-align: right;
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .legend {
            display: flex;
            gap: 12px;
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }

        .legend .success-dot {
            width: 10px;
            height: 10px;
            background: #4caf50;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }

        .legend .fail-dot {
            width: 10px;
            height: 10px;
            background: #dc3545;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }

        /* 速率限制样式 */
        .rate-limit-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            transition: box-shadow 0.2s;
        }

        .rate-limit-card:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] .rate-limit-card:hover {
            box-shadow: 0 2px 8px rgba(255, 255, 255, 0.1);
        }

        .rate-limit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .rate-limit-key {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            font-weight: bold;
            color: #333;
        }

        .rate-limit-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-exhausted {
            background: #f8d7da;
            color: #721c24;
        }

        .status-unused {
            background: #e2e3e5;
            color: #383d41;
        }

        .rate-limit-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 12px;
        }

        .rate-limit-info-item {
            display: flex;
            flex-direction: column;
        }

        .rate-limit-info-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }

        .rate-limit-info-value {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        .rate-limit-progress {
            width: 100%;
            height: 24px;
            background: #f1f3f5;
            border-radius: 12px;
            overflow: visible;
            position: relative;
            margin-bottom: 8px;
        }

        .rate-limit-progress-bar {
            height: 100%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
            border-radius: 12px;
        }

        .rate-limit-progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
            font-weight: bold;
            color: var(--text-secondary);
            pointer-events: none;
        }

        .progress-green {
            background: linear-gradient(90deg, #4caf50, #66bb6a);
        }

        .progress-yellow {
            background: linear-gradient(90deg, #ffc107, #ffca28);
        }

        .progress-red {
            background: linear-gradient(90deg, #f44336, #ef5350);
        }

        .rate-limit-reset {
            font-size: 12px;
            color: #666;
            text-align: center;
        }

        /* 操练场按钮样式 - 简洁版 */
        .playground-btn {
            padding: 8px 16px;
            font-size: 14px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            color: white;
        }

        /* Add button - neutral gray */
        .playground-btn-add {
            background: #6c757d;
        }

        .playground-btn-add:hover {
            background: #5a6268;
        }

        .playground-btn-add:active {
            background: #545b62;
        }

        /* Clear button - warning orange */
        .playground-btn-clear {
            background: #ff9800;
        }

        .playground-btn-clear:hover {
            background: #e68900;
        }

        .playground-btn-clear:active {
            background: #cc7a00;
        }

        /* Send button - primary blue */
        .playground-btn-send {
            background: #4285f4;
        }

        .playground-btn-send:hover {
            background: #3367d6;
        }

        .playground-btn-send:active {
            background: #2b56c4;
        }

        .usage-info-value {
            color: #333;
        }

        .reset-time {
            font-size: 11px;
            color: #666;
            font-style: italic;
            margin-top: 5px;
        }

        /* 限制设置弹窗样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-overlay);
            overflow-y: auto;
        }

        .modal-content {
            background-color: var(--container-bg);
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            border-radius: 12px;
            width: 400px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px var(--shadow-color);
            transition: background-color 0.3s ease;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .modal-title {
            margin: 0;
            font-size: 16px;
            color: #333;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #999;
        }

        .modal-close:hover {
            color: #333;
        }

        .modal-body {
            margin-bottom: 15px;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .playground-status .status {
            margin-top: 4px;
            margin-bottom: 12px;
        }

        .toggle-wrap {
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 2px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 42px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: .2s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .2s;
            border-radius: 50%;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .switch input:checked+.slider {
            background-color: #34d399;
        }

        .switch input:checked+.slider:before {
            transform: translateX(18px);
        }

        /* 暗黑模式下的开关按钮 */
        [data-theme="dark"] .slider {
            background-color: #475569;
        }

        [data-theme="dark"] .slider:before {
            background-color: var(--container-bg);
        }

        [data-theme="dark"] .switch input:checked+.slider {
            background-color: #34d399;
        }

        /* ========== 密钥管理弹窗基础样式 ========== */
        .key-modal-content {
            width: 900px;
            max-width: 95%;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            /* 覆盖基础modal-content的定位，确保视口居中 */
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .key-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 1px solid var(--border-color, #e1e4e8);
            padding-bottom: 12px;
        }

        .key-modal-title-wrap {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .key-modal-title {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .key-modal-tag {
            background: linear-gradient(135deg, #ff6b6b, #ee5a5a);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .key-stat-badge {
            background: var(--card-bg, #f0f0f0);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
        }

        .key-stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            padding: 20px 0;
            border-bottom: 1px solid var(--border-color, #e1e4e8);
        }

        .key-stat-card {
            background: var(--card-bg, #f8f9fa);
            border-radius: 12px;
            padding: 15px;
        }

        .key-stat-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .key-stat-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .key-stat-label {
            color: var(--text-secondary, #666);
            font-size: 13px;
        }

        .key-stat-value {
            font-size: 24px;
            font-weight: bold;
        }

        .key-stat-card .progress-bar {
            height: 4px;
            margin-top: 8px;
            background: #e9ecef;
            border-radius: 2px;
        }

        .key-stat-card .progress-fill {
            height: 100%;
            border-radius: 2px;
            width: 0%;
            transition: width 0.3s;
        }

        .key-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            flex-wrap: wrap;
            gap: 10px;
        }

        .key-toolbar-filter {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 140px;
        }

        .key-toolbar-filter .custom-select-wrapper {
            min-width: 120px;
        }

        .key-toolbar-filter .custom-select-trigger {
            padding: 8px 12px;
            font-size: 13px;
        }

        .key-toolbar-filter .custom-select-options {
            z-index: 10001;
        }

        .key-toolbar-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .key-toolbar-actions .btn {
            background: #f0f0f0;
            color: #333;
            border: none;
        }

        .key-toolbar-actions .btn-outline-primary {
            background: transparent;
            color: #4285f4;
            border: 1px solid #4285f4;
        }

        .key-toolbar-actions .btn-outline-danger {
            background: transparent;
            color: #dc3545;
            border: 1px solid #dc3545;
        }

        .key-toolbar-actions .btn-outline-warning {
            background: transparent;
            color: #ffc107;
            border: 1px solid #ffc107;
        }

        .key-toolbar-actions .btn-outline-info {
            background: transparent;
            color: #17a2b8;
            border: 1px solid #17a2b8;
        }

        .key-toolbar-actions .btn-outline-success {
            background: transparent;
            color: #28a745;
            border: 1px solid #28a745;
        }

        .key-table-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: auto;
        }

        .key-table {
            width: 100%;
            min-width: 500px;
        }

        .key-table thead {
            position: sticky;
            top: 0;
            background: var(--container-bg, white);
            z-index: 1;
        }

        .key-col-index {
            width: 60px;
        }

        .key-col-key {
            min-width: 200px;
        }

        .key-col-status {
            width: 80px;
        }

        .key-col-reason {
            min-width: 100px;
        }

        .key-col-time {
            min-width: 100px;
        }

        .key-col-action {
            width: 80px;
            text-align: right;
        }

        .key-pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-top: 1px solid var(--border-color, #e1e4e8);
            flex-wrap: wrap;
            gap: 10px;
        }

        .key-pagination-info {
            color: var(--text-secondary, #666);
            font-size: 13px;
        }

        .key-pagination-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .key-pagination-current {
            padding: 6px 12px;
            background: #4285f4;
            color: white;
            border-radius: 4px;
        }

        .key-pagination-label {
            margin-left: 10px;
            font-size: 13px;
        }

        .key-pagination-input {
            width: 50px;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        /* ========== 密钥管理弹窗移动端适配 ========== */
        @media (max-width: 768px) {

            /* 弹窗整体 - 不再全屏，改为自适应高度 */
            .key-modal-content {
                width: 95% !important;
                max-width: 95% !important;
                height: auto !important;
                max-height: 90vh !important;
                margin: 5vh auto !important;
                border-radius: 12px !important;
                padding: 12px !important;
                /* 手机模式下居中定位 */
                position: fixed !important;
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%) !important;
                display: flex;
                flex-direction: column;
            }

            /* 头部优化 */
            .key-modal-header {
                gap: 8px;
                padding-bottom: 10px;
                flex-shrink: 0;
            }

            .key-modal-title-wrap {
                gap: 6px;
            }

            .key-modal-title {
                font-size: 16px;
                width: 100%;
            }

            .key-stat-badge {
                font-size: 11px;
                padding: 3px 8px;
            }

            /* 统计卡片紧凑横向布局 */
            .key-stats-grid {
                display: flex;
                flex-wrap: wrap;
                gap: 6px;
                padding: 10px 0;
                flex-shrink: 0;
            }

            .key-stat-card {
                flex: 1;
                min-width: 90px;
                padding: 8px 10px;
                display: flex;
                flex-direction: column;
                align-items: center;
                text-align: center;
            }

            .key-stat-value {
                font-size: 16px;
            }

            .key-stat-label {
                font-size: 10px;
            }

            .key-stat-card .progress-bar {
                display: none;
            }

            /* 工具栏垂直布局 */
            .key-toolbar {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
                padding: 8px 0;
                flex-shrink: 0;
            }

            /* 按钮组横向滚动 */
            .key-toolbar-actions {
                display: flex;
                flex-wrap: nowrap;
                overflow-x: auto;
                padding-bottom: 5px;
                gap: 6px;
                -webkit-overflow-scrolling: touch;
            }

            .key-toolbar-actions::-webkit-scrollbar {
                height: 3px;
            }

            .key-toolbar-actions .btn-sm {
                padding: 5px 8px;
                font-size: 11px;
                white-space: nowrap;
                flex-shrink: 0;
            }

            /* 筛选下拉框 */
            .key-toolbar-filter .filter-select {
                font-size: 12px;
                padding: 6px 8px;
            }

            .key-toolbar-filter {
                min-width: auto !important;
                width: auto !important;
            }

            .key-toolbar-filter .custom-select-wrapper {
                min-width: 90px !important;
                max-width: 110px !important;
            }

            .key-toolbar-filter .custom-select-trigger {
                padding: 6px 10px !important;
                font-size: 12px !important;
            }

            /* 表格容器 - 关键：限制高度并允许滚动 */
            .key-table-container {
                flex: 1;
                min-height: 150px;
                max-height: 40vh;
                overflow-y: auto;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            /* 表格隐藏禁用原因和禁用时间列 */
            .key-col-reason,
            .key-col-time,
            .key-table th:nth-child(4),
            .key-table td:nth-child(4),
            .key-table th:nth-child(5),
            .key-table td:nth-child(5) {
                display: none;
            }

            .key-col-index {
                width: 28px;
                font-size: 10px;
            }

            .key-col-key {
                min-width: 80px;
                max-width: 120px;
                word-break: break-all;
                font-size: 10px;
            }

            .key-col-status {
                width: 42px;
                font-size: 10px;
                text-align: center;
            }

            .key-col-status .status-badge,
            .key-table td:nth-child(3) .status-badge,
            .key-table td:nth-child(3) span {
                padding: 2px 5px !important;
                font-size: 10px !important;
                white-space: nowrap !important;
                transform: scale(0.9);
                display: inline-block;
            }

            .key-col-action {
                width: 58px;
            }

            /* 表头一行显示 */
            .key-table th {
                font-size: 10px;
                padding: 4px 2px;
                white-space: nowrap;
            }

            .key-table {
                min-width: auto;
                font-size: 11px;
            }

            /* 密钥列一行显示 */
            .key-table td:nth-child(2) code {
                font-size: 9px !important;
                word-break: break-all;
            }

            /* 分页优化 */
            .key-pagination {
                flex-direction: column;
                align-items: center;
                gap: 8px;
                padding: 10px 0;
                flex-shrink: 0;
            }

            .key-pagination-controls {
                justify-content: center;
                flex-wrap: wrap;
            }

            .key-pagination-info,
            .key-pagination-label {
                font-size: 12px;
            }

            .key-pagination-label {
                margin-left: 6px;
            }
        }

        @media (max-width: 480px) {

            /* 更小屏幕进一步优化 */
            .key-modal-content {
                width: 98% !important;
                padding: 8px !important;
                margin: 2vh auto !important;
                max-height: 96vh !important;
            }

            /* 工具栏按钮更小 */
            .key-toolbar-actions .btn-sm {
                padding: 4px 6px !important;
                font-size: 10px !important;
            }

            .key-toolbar-filter .filter-select {
                font-size: 11px !important;
                padding: 5px 6px !important;
            }

            /* 统计卡片更紧凑 */
            .key-stats-grid {
                gap: 4px;
                padding: 8px 0;
            }

            .key-stat-card {
                min-width: 80px;
                padding: 6px 8px;
            }

            .key-stat-header {
                margin-bottom: 2px;
            }

            .key-stat-dot {
                width: 6px;
                height: 6px;
            }

            .key-stat-value {
                font-size: 14px;
            }

            .key-stat-label {
                font-size: 9px;
            }

            /* 表格容器高度调整 */
            .key-table-container {
                max-height: 35vh;
            }

            /* 表格进一步缩小 */
            .key-table {
                font-size: 10px;
            }

            .key-table th,
            .key-table td {
                padding: 4px 2px;
            }

            .key-col-index {
                width: 30px !important;
            }

            .key-col-key {
                max-width: 90px;
                font-size: 10px !important;
            }

            .key-col-status {
                width: 42px !important;
            }

            .key-col-status .status-badge {
                padding: 1px 3px !important;
                font-size: 8px !important;
                white-space: nowrap !important;
            }

            .key-col-action {
                width: 65px !important;
            }

            /* 操作按钮缩小 */
            .key-table td:last-child .btn,
            .key-table td:last-child button {
                padding: 3px 5px !important;
                font-size: 9px !important;
            }

            /* 分页更紧凑 */
            .key-pagination {
                gap: 6px;
                padding: 8px 0;
            }

            .key-pagination-info {
                font-size: 11px;
            }

            .key-pagination-controls {
                gap: 4px;
            }

            .key-pagination-label {
                font-size: 11px;
                margin-left: 4px;
            }

            .key-pagination-input {
                width: 40px;
                padding: 2px;
                font-size: 11px;
            }

            .pagination-btn {
                padding: 4px 8px;
                font-size: 12px;
            }

            .key-pagination-current {
                padding: 4px 8px;
                font-size: 12px;
            }

            #keyPageSize {
                padding: 2px 4px;
                font-size: 11px;
            }
        }

        /* ========== Playground 会话参数与工具定义并排布局 ========== */
        .playground-params-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
            align-items: start;
            /* 让每个卡片独立控制高度 */
        }

        .playground-param-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            overflow: hidden;
            transition: box-shadow 0.2s ease, border-color 0.2s ease, height 0.2s ease;
            display: flex;
            flex-direction: column;
        }

        .playground-param-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        /* 折叠状态：只显示header */
        .playground-param-card.collapsed {
            height: auto !important;
        }

        .playground-param-card.collapsed .playground-param-content {
            display: none !important;
            height: 0 !important;
            padding: 0 !important;
            overflow: hidden !important;
        }

        .playground-param-card.collapsed .playground-param-header {
            border-bottom: none;
        }

        .playground-param-header {
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: linear-gradient(135deg, var(--card-bg) 0%, var(--bg-color) 100%);
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s ease;
            flex-shrink: 0;
        }

        .playground-param-header:hover {
            background: linear-gradient(135deg, var(--hover-bg) 0%, var(--card-bg) 100%);
        }

        .playground-param-title {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-color);
        }

        .playground-toggle-icon {
            font-size: 12px;
            color: var(--text-secondary);
            transition: transform 0.2s ease;
        }

        .playground-param-content {
            padding: 12px 16px;
            display: block;
        }

        .playground-tools-textarea {
            width: 100%;
            min-height: 120px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            line-height: 1.5;
            resize: vertical;
        }

        /* 会话参数卡片特殊样式 */
        .playground-messages-card .playground-param-header {
            background: linear-gradient(135deg, #e8f4fd 0%, #f0f7ff 100%);
        }

        .playground-messages-card:hover .playground-param-header {
            background: linear-gradient(135deg, #d4ebfc 0%, #e8f4fd 100%);
        }

        /* 工具定义卡片特殊样式 */
        .playground-tools-card .playground-param-header {
            background: linear-gradient(135deg, #f0f9e8 0%, #f5fbf0 100%);
        }

        .playground-tools-card:hover .playground-param-header {
            background: linear-gradient(135deg, #e4f5d4 0%, #f0f9e8 100%);
        }

        /* 暗黑模式适配 */
        [data-theme="dark"] .playground-param-card {
            background: var(--card-bg);
            border-color: var(--border-color);
        }

        [data-theme="dark"] .playground-param-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.3);
        }

        [data-theme="dark"] .playground-param-header {
            background: linear-gradient(135deg, var(--card-bg) 0%, #1e2a3a 100%);
            border-bottom-color: var(--border-color);
        }

        [data-theme="dark"] .playground-param-header:hover {
            background: linear-gradient(135deg, var(--hover-bg) 0%, var(--card-bg) 100%);
        }

        [data-theme="dark"] .playground-messages-card .playground-param-header {
            background: linear-gradient(135deg, #1a2a3a 0%, #1e3045 100%);
        }

        [data-theme="dark"] .playground-messages-card:hover .playground-param-header {
            background: linear-gradient(135deg, #1e3045 0%, #243850 100%);
        }

        [data-theme="dark"] .playground-tools-card .playground-param-header {
            background: linear-gradient(135deg, #1a2a1e 0%, #1e3525 100%);
        }

        [data-theme="dark"] .playground-tools-card:hover .playground-param-header {
            background: linear-gradient(135deg, #1e3525 0%, #244030 100%);
        }

        [data-theme="dark"] .playground-param-title {
            color: var(--text-color);
        }

        [data-theme="dark"] .playground-toggle-icon {
            color: var(--text-secondary);
        }

        [data-theme="dark"] .playground-tools-textarea {
            background: #1e1e1e;
            color: #9cdcfe;
            border-color: var(--border-color);
        }

        /* ========== 会话参数消息行样式 ========== */
        .playground-message-row {
            display: flex !important;
            flex-direction: column !important;
            gap: 8px;
            padding-bottom: 12px;
            margin-bottom: 12px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        }

        .playground-message-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .playground-message-top {
            display: flex !important;
            align-items: center;
            justify-content: flex-start !important;
            gap: 10px;
            width: 100%;
        }

        .playground-role-select {
            flex: 0 0 auto !important;
            width: 120px !important;
            min-width: 120px !important;
            max-width: 120px !important;
            height: 32px !important;
            padding: 4px 8px !important;
            font-size: 13px !important;
            border-radius: 6px;
        }

        .playground-delete-btn {
            background: #dc3545 !important;
            color: white !important;
            padding: 4px 10px !important;
            font-size: 12px !important;
            height: 32px !important;
            min-width: 50px !important;
            max-width: 50px !important;
            border-radius: 6px !important;
            flex: 0 0 auto !important;
            line-height: 1 !important;
        }

        .playground-delete-btn:hover {
            background: #c82333 !important;
        }

        .playground-message-textarea {
            min-height: 70px;
            resize: vertical;
            border-radius: 6px;
            font-size: 13px;
            line-height: 1.5;
            width: 100% !important;
        }

        /* 暗黑模式下的消息行分隔线 */
        [data-theme="dark"] .playground-message-row {
            border-bottom-color: rgba(255, 255, 255, 0.1);
        }

        /* 手机模式适配 */
        @media (max-width: 768px) {
            .playground-params-row {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .playground-param-header {
                padding: 10px 12px;
            }

            .playground-param-title {
                font-size: 13px;
            }

            .playground-param-content {
                padding: 10px 12px;
            }

            .playground-tools-textarea {
                min-height: 100px;
                font-size: 11px;
            }

            /* 手机模式下消息行优化 */
            .playground-message-row {
                padding-bottom: 10px;
                margin-bottom: 10px;
            }

            .playground-message-top {
                gap: 8px;
            }

            .playground-role-select {
                flex: 1 1 auto !important;
                width: auto !important;
                min-width: 80px !important;
                max-width: none !important;
                height: 34px !important;
                font-size: 13px !important;
            }

            .playground-delete-btn {
                height: 34px !important;
                padding: 4px 12px !important;
                font-size: 12px !important;
                min-width: 50px !important;
                max-width: 60px !important;
            }

            .playground-message-textarea {
                min-height: 60px;
                font-size: 14px;
            }
        }

        /* ========== 密钥模式并排布局 ========== */
        .key-mode-row {
            display: flex;
            gap: 16px;
            margin-bottom: 60px;
        }

        .key-mode-item {
            flex: 1;
            min-width: 0;
        }

        .key-mode-item label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-color);
            margin-bottom: 6px;
        }

        .key-mode-item .config-input {
            width: 100%;
            background: var(--input-bg);
        }

        /* 自定义下拉框样式 */
        .custom-select-wrapper {
            position: relative;
            width: 100%;
            z-index: 10;
        }

        .custom-select-wrapper.open {
            z-index: 1000;
        }

        .custom-select-trigger {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: var(--input-bg);
            border: 2px solid var(--input-border);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-color);
            transition: border-color 0.2s, border-radius 0.2s;
        }

        .custom-select-trigger:hover {
            border-color: #4285f4;
        }

        .custom-select-trigger::after {
            content: "▼";
            font-size: 10px;
            color: var(--text-secondary);
            transition: transform 0.2s;
        }

        .custom-select-wrapper.open .custom-select-trigger {
            border-color: #4285f4;
            border-radius: 6px 6px 0 0;
            border-bottom-color: transparent;
        }

        .custom-select-wrapper.open .custom-select-trigger::after {
            transform: rotate(180deg);
        }

        .custom-select-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--container-bg);
            border: 2px solid transparent;
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 0;
            overflow: hidden;
            z-index: 1000;
            transition: max-height 0.2s ease-out, border-color 0.2s;
        }

        .custom-select-wrapper.open .custom-select-options {
            max-height: 200px;
            border-color: #4285f4;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .custom-select-option {
            padding: 10px 12px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-color);
            transition: background 0.15s;
        }

        .custom-select-option:hover {
            background: var(--hover-bg);
        }

        .custom-select-option.selected {
            background: rgba(66, 133, 244, 0.1);
            color: #4285f4;
            font-weight: 500;
        }

        /* 手机模式下密钥模式垂直排列 */
        @media (max-width: 480px) {
            .key-mode-row {
                flex-direction: column;
                gap: 12px;
            }
        }
    </style>
</head>

<body>
    <!-- 暗黑模式切换按钮 -->
    <button class="theme-toggle" title="拖动移动 | 点击切换暗黑模式">
        <span class="icon" id="themeIcon">🌙</span>
        <span id="themeText">暗黑</span>
    </button>

    <div class="container">

        <!-- 粒子背景画布 -->
        <canvas id="particleCanvas"></canvas>
        <!-- 渐变背景层 - 持久浸染效果 -->
        <div id="gradientOverlay"></div>
        <!-- 涟漪画布 - 不规则椭圆波浪 -->
        <canvas id="rippleCanvas"></canvas>
        <!-- 彩带/五彩纸屑画布 -->
        <canvas id="confettiCanvas"></canvas>
        <!-- 鼠标跟随光晕 -->
        <div class="mouse-glow" id="mouseGlow"></div>

        <!-- 浮动光点（全局显示） -->
        <div class="floating-orb"
            style="width: 8px; height: 8px; background: rgba(66, 133, 244, 0.6); top: 20%; left: 15%; animation-delay: 0s;">
        </div>
        <div class="floating-orb"
            style="width: 6px; height: 6px; background: rgba(52, 168, 83, 0.5); top: 30%; right: 20%; animation-delay: 1s;">
        </div>
        <div class="floating-orb"
            style="width: 10px; height: 10px; background: rgba(251, 188, 5, 0.4); bottom: 25%; left: 25%; animation-delay: 2s;">
        </div>
        <div class="floating-orb"
            style="width: 5px; height: 5px; background: rgba(234, 67, 53, 0.5); top: 60%; right: 15%; animation-delay: 3s;">
        </div>
        <div class="floating-orb"
            style="width: 7px; height: 7px; background: rgba(66, 133, 244, 0.5); bottom: 40%; right: 30%; animation-delay: 4s;">
        </div>

        <!-- 星星闪烁（全局显示） -->
        <div class="twinkle-star" style="top: 15%; left: 10%; animation-delay: 0s;"></div>
        <div class="twinkle-star" style="top: 25%; right: 12%; animation-delay: 0.5s;"></div>
        <div class="twinkle-star" style="bottom: 30%; left: 8%; animation-delay: 1s;"></div>
        <div class="twinkle-star" style="top: 45%; left: 5%; animation-delay: 1.5s;"></div>
        <div class="twinkle-star" style="bottom: 20%; right: 8%; animation-delay: 2s;"></div>
        <div class="twinkle-star" style="top: 70%; left: 15%; animation-delay: 2.5s;"></div>

        <!-- 登录界面 -->
        <div id="loginSection" class="login-form">
            <!-- 背景装饰 -->
            <div class="login-bg-decoration circle-1"></div>
            <div class="login-bg-decoration circle-2"></div>

            <!-- 登录卡片包装器（用于边框动画） -->
            <div class="login-card-wrapper">
                <div class="login-card">
                    <!-- Logo -->
                    <div class="login-logo">⛵️</div>

                    <!-- 标题 -->
                    <h1>AMB2API</h1>
                    <p class="login-subtitle">
                        <span class="lock-icon">⛩️</span>
                        请输入访问密码以继续
                    </p>

                    <!-- 密码输入 -->
                    <div class="login-input-wrapper">
                        <input type="password" id="loginPassword" placeholder="输入访问密码"
                            onkeypress="handlePasswordEnter(event)" autocomplete="current-password" />
                        <span class="input-icon">👁️‍🗨️</span>
                    </div>

                    <!-- 登录按钮 -->
                    <button class="btn" id="loginBtn" onclick="login()">
                        <span>登录</span>
                    </button>

                    <!-- 状态消息 -->
                    <div id="loginStatus"></div>

                    <!-- 底部信息 -->
                    <div class="login-footer">
                        <p><a href="https://github.com/GolovinElics/amb2api" target="_blank"
                                rel="noopener noreferrer">项目地址🪴 GolovinElics·Amb2api</a></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 主界面 -->
        <div id="mainSection" class="hidden">
            <!-- 固定头部区域 -->
            <div class="fixed-header" id="fixedHeader">
                <div style="position: relative; width: 100%;">
                    <h1 style="margin: 0; text-align: center;">AMB2API 管理面板</h1>
                    <button class="btn btn-sm" onclick="logout()"
                        style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); background: #6c757d; font-size: 12px; padding: 6px 12px;">退出登录</button>
                </div>

                <!-- 标签页 -->
                <div class="tabs-wrapper">
                    <div class="tabs">
                        <button class="tab" onclick="switchTab('account')">账户管理</button>
                        <button class="tab active" onclick="switchTab('config')">配置管理</button>
                        <button class="tab" onclick="switchTab('ratelimit')">速率限制</button>
                        <button class="tab" onclick="switchTab('usage')">使用统计</button>
                        <button class="tab" onclick="switchTab('playground')">操练场</button>
                        <button class="tab" onclick="switchTab('logs')">实时日志</button>
                    </div>
                </div>
            </div>

            <!-- 内容区域 -->
            <div class="tab-content-wrapper">

                <!-- 批量上传标签页 -->
                <div id="uploadTab" class="tab-content">
                    <h3>批量上传认证文件</h3>
                    <p>支持上传多个JSON格式的认证文件到服务器</p>

                    <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                        <p>点击选择文件或拖拽文件到此区域</p>
                        <p style="color: #666; font-size: 14px;">支持 .json 和 .zip 格式文件</p>
                        <p style="color: #888; font-size: 12px;">ZIP文件会自动解压提取其中的JSON凭证</p>
                    </div>

                    <input type="file" id="fileInput" multiple accept=".json,.zip" style="display: none;"
                        onchange="handleFileSelect(event)" />

                    <div id="fileListSection" class="hidden">
                        <h4>选择的文件：</h4>
                        <div class="file-list" id="fileList"></div>
                        <button class="btn" onclick="uploadFiles()">上传文件</button>
                        <button class="btn" style="background-color: #6c757d;" onclick="clearFiles()">清空列表</button>
                    </div>

                    <div id="uploadProgressSection" class="hidden">
                        <div class="upload-progress">
                            <h4>上传进度：</h4>
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                            </div>
                            <p id="progressText">0%</p>
                        </div>
                    </div>
                </div>



                <!-- 文件管理标签页 -->
                <div id="manageTab" class="tab-content">
                    <h3>凭证文件管理</h3>
                    <p>管理所有认证文件，查看状态和执行操作</p>

                    <!-- 状态统计 -->
                    <div class="stats-container" id="statsContainer">
                        <div class="stat-item total">
                            <span class="stat-number" id="statTotal">0</span>
                            <span class="stat-label">总计</span>
                        </div>
                        <div class="stat-item normal">
                            <span class="stat-number" id="statNormal">0</span>
                            <span class="stat-label">正常</span>
                        </div>
                        <div class="stat-item disabled">
                            <span class="stat-number" id="statDisabled">0</span>
                            <span class="stat-label">禁用</span>
                        </div>
                    </div>

                    <div class="manage-actions">
                        <button class="refresh-btn" onclick="refreshCredsStatus()">刷新状态</button>
                        <button class="download-all-btn" onclick="downloadAllCreds()">打包下载所有文件</button>
                    </div>

                    <!-- 批量操作控件 -->
                    <div class="batch-controls">
                        <h4 style="margin-top: 0; margin-bottom: 10px;">批量操作</h4>
                        <div class="batch-actions">
                            <div class="checkbox-container">
                                <input type="checkbox" id="selectAllCheckbox" class="select-all-checkbox"
                                    onchange="toggleSelectAll()">
                                <label for="selectAllCheckbox">全选</label>
                            </div>
                            <span class="selected-count" id="selectedCount">已选择 0 项</span>
                            <button class="batch-btn batch-enable" id="batchEnableBtn" onclick="batchAction('enable')"
                                disabled>批量启用</button>
                            <button class="batch-btn batch-disable" id="batchDisableBtn"
                                onclick="batchAction('disable')" disabled>批量禁用</button>
                            <button class="batch-btn batch-delete" id="batchDeleteBtn" onclick="batchAction('delete')"
                                disabled>批量删除</button>
                            <button class="batch-btn batch-email" onclick="refreshAllEmails()">刷新所有邮箱</button>
                        </div>
                    </div>

                    <!-- 筛选和分页控件 -->
                    <div class="filter-container">
                        <label for="statusFilter">状态筛选：</label>
                        <select id="statusFilter" class="filter-select" onchange="applyFilters()">
                            <option value="all">全部</option>
                            <option value="normal">正常</option>
                            <option value="disabled">禁用</option>
                        </select>

                        <label for="errorCodeFilter">错误码筛选：</label>
                        <select id="errorCodeFilter" class="filter-select" onchange="applyFilters()">
                            <option value="all">全部错误码</option>
                            <option value="no-errors">无错误</option>
                            <option value="has-errors">有错误</option>
                            <option value="400">错误码 400</option>
                            <option value="401">错误码 401</option>
                            <option value="403">错误码 403</option>
                            <option value="404">错误码 404</option>
                            <option value="429">错误码 429</option>
                            <option value="500">错误码 500</option>
                        </select>

                        <label for="pageSizeSelect">每页显示：</label>
                        <select id="pageSizeSelect" class="page-size-select" onchange="changePageSize()">
                            <option value="20">20</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>

                        <div class="error-filter-container" id="errorFilterContainer">
                            <span>快速筛选错误码：</span>
                            <div id="errorCodeBadges"></div>
                        </div>
                    </div>

                    <div id="credsListSection">
                        <div class="loading" id="credsLoading">正在加载凭证文件...</div>
                        <div id="credsList"></div>

                        <!-- 分页控件 -->
                        <div class="pagination-container" id="paginationContainer" style="display: none;">
                            <button class="pagination-btn" id="prevPageBtn" onclick="changePage(-1)">上一页</button>
                            <div class="pagination-info" id="paginationInfo">第 1 页，共 1 页</div>
                            <button class="pagination-btn" id="nextPageBtn" onclick="changePage(1)">下一页</button>
                        </div>
                    </div>
                </div>

                <!-- 速率限制标签页 -->
                <div id="ratelimitTab" class="tab-content">
                    <h3>API Key 速率限制监控</h3>
                    <p>实时监控每个 API Key 的速率限制状态和配额使用情况</p>

                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-sm" onclick="loadRateLimits()">刷新数据</button>
                        <label style="display: inline-block; margin-left: 20px;">
                            <input type="checkbox" id="autoRefreshRateLimit" onchange="toggleAutoRefresh()" checked>
                            自动刷新（每5秒）
                        </label>
                    </div>

                    <div id="rateLimitStatus"></div>

                    <div id="rateLimitSection">
                        <div class="loading" id="rateLimitLoading">正在加载速率限制信息...</div>
                        <div id="rateLimitList"></div>
                    </div>
                </div>

                <!-- 使用统计标签页 -->
                <div id="usageTab" class="tab-content">
                    <h3>使用统计</h3>
                    <div id="usageStatus"></div>
                    <p>查看每个凭证文件的API调用统计和配额使用情况</p>

                    <!-- 统计概览 -->
                    <div class="stats-container" id="usageStatsContainer">
                        <div class="stat-item total">
                            <span class="stat-number" id="totalApiCalls">0</span>
                            <span class="stat-label">总调用数</span>
                        </div>
                        <div class="stat-item" style="border-left: 4px solid #28a745;">
                            <span class="stat-number" id="activeKeys">0</span>
                            <span class="stat-label">活跃密钥数</span>
                        </div>
                        <div class="stat-item disabled">
                            <span class="stat-number" id="disabledKeys">0</span>
                            <span class="stat-label">禁用密钥数</span>
                        </div>
                    </div>

                    <div class="manage-actions">
                        <button class="refresh-btn" onclick="refreshUsageStats()">刷新统计</button>
                        <button class="btn btn-sm" onclick="checkInvalidKeys()"
                            style="background:#6c757d">检查失效密钥</button>
                        <button class="btn btn-sm" onclick="deleteInvalidKeys()"
                            style="background:#dc3545">移除失效密钥数据</button>
                    </div>

                    <div class="config-group">
                        <div
                            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                            <h4 style="margin:0;">日志统计（按模型/按密钥）</h4>
                            <button class="btn btn-sm" style="background:#dc3545;"
                                onclick="resetAllStats()">重置所有统计</button>
                        </div>
                        <div class="form-group" style="display:flex; gap:10px; flex-wrap:wrap">
                            <select id="modelFilter" class="config-input" style="max-width:260px"
                                onchange="refreshLogSummary()"></select>
                            <select id="keyFilter" class="config-input" style="max-width:260px"
                                onchange="refreshLogSummary()"></select>
                            <select id="onlyFilter" class="config-input" style="max-width:180px"
                                onchange="refreshLogSummary()">
                                <option value="">全部</option>
                                <option value="success">仅成功</option>
                                <option value="fail">仅失败</option>
                            </select>
                        </div>
                        <div id="logSummaryModels"></div>
                        <div id="logSummaryKeys" style="margin-top:12px"></div>
                        <div id="modelRanking" class="ranking-container" style="margin-top:12px"></div>

                        <!-- 模型调用次数占比（环形图） -->
                        <div class="ranking-container" style="margin-top:16px;">
                            <div class="ranking-header">
                                <div class="ranking-title">模型调用次数占比</div>
                                <select id="distributionKeyFilter" class="config-input"
                                    style="max-width:200px; font-size:12px;" onchange="renderDistributionChart()">
                                    <option value="">所有密钥</option>
                                </select>
                            </div>
                            <div id="distributionChart"
                                style="display:flex; gap:20px; flex-wrap:wrap; align-items:flex-start; padding:16px 0;">
                            </div>
                        </div>
                    </div>

                    <!-- 文件使用统计列表 -->
                    <div id="usageListSection">
                        <div class="loading" id="usageLoading">正在加载使用统计...</div>
                        <div id="usageList"></div>
                    </div>

                    <!-- 使用说明 -->
                    <div class="config-group"
                        style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 16px;">
                        <h4 style="color: var(--text-color); margin-bottom: 12px;">使用说明</h4>
                        <div class="config-info" style="color: var(--text-secondary);">
                            <strong style="color: var(--text-color);">统计范围：</strong>
                            <ul style="color: var(--text-secondary);">
                                <li><strong style="color: var(--text-color);">所有模型调用次数：</strong>统计所有模型的成功调用总数</li>
                                <li><strong style="color: var(--text-color);">配额重置：</strong>每天 UTC 07:00 自动重置调用计数</li>
                            </ul>

                            <strong style="color: var(--text-color);">注意：</strong>
                            <ul style="color: var(--text-secondary);">
                                <li>统计数据持久化保存在 creds_state.toml 文件中</li>
                                <li>支持每个凭证文件独立统计和配额管理</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- 配置管理标签页 -->
                <div id="configTab" class="tab-content active">
                    <h3>配置管理</h3>
                    <div id="configStatus"></div>
                    <!-- <p>管理系统配置参数，修改后立即生效</p> -->

                    <div id="configMetaBar"
                        style="margin:6px 0 12px 0; display:flex; gap:8px; align-items:center; flex-wrap:wrap"></div>

                    <!-- 配置页面浮动操作按钮 -->
                    <div class="config-floating-actions" id="configFloatingActions">
                        <button class="config-floating-btn refresh" onclick="loadConfig()">Flash</button>
                        <button class="config-floating-btn save" onclick="saveConfig()">Save</button>
                    </div>

                    <div id="configSection">
                        <div class="loading" id="configLoading">正在加载配置...</div>
                        <div id="configForm" class="hidden">
                            <!-- 面板优先配置 - 独立区块 -->
                            <div class="config-group"
                                style="background: linear-gradient(135deg, #fff9e6 0%, #fff3cd 100%); border: 1px solid #ffc107;">
                                <h4 style="color: #856404;">⚙️ 优先级配置</h4>
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label style="display: flex; align-items: center; gap: 10px;">
                                        <input type="checkbox" id="overrideEnv" class="config-checkbox" />
                                        <span style="font-weight: 600; color: #856404;">面板优先（忽略环境变量）</span>
                                    </label>
                                    <small class="config-note"
                                        style="color: #856404; margin-top: 8px;">启用后，面板保存的值将覆盖环境变量的优先级，被锁定的配置项将可以编辑</small>
                                </div>
                            </div>

                            <div class="config-group">
                                <h4>密钥配置</h4>
                                <div class="form-group">
                                    <label for="assemblyApiKeys">密钥</label>
                                    <textarea id="assemblyApiKeys" class="config-input"
                                        placeholder="请输入要新增的密钥，一行一个（查看现有密钥请点击右侧" 查看密钥"按钮）"
                                        style="min-height: 100px; border: 2px solid #4285f4; border-radius: 8px;"></textarea>
                                    <div
                                        style="display: flex; align-items: center; gap: 15px; margin-top: 8px; flex-wrap: wrap;">
                                        <small class="config-note"
                                            style="color: #4285f4; margin: 0;">此输入框仅用于新增密钥，不会显示现有密钥</small>
                                        <button class="btn btn-sm" onclick="showKeyManagementModal()"
                                            style="background: transparent; color: #4285f4; border: 1px solid #4285f4; padding: 4px 12px;">查看密钥</button>
                                    </div>
                                </div>
                                <!-- 密钥更新模式和聚合模式并排 -->
                                <div class="key-mode-row">
                                    <div class="key-mode-item">
                                        <label>更新模式</label>
                                        <div class="custom-select-wrapper" data-select-id="keyUpdateMode">
                                            <div class="custom-select-trigger">追加</div>
                                            <div class="custom-select-options">
                                                <div class="custom-select-option selected" data-value="append">追加</div>
                                                <div class="custom-select-option" data-value="override">覆盖</div>
                                            </div>
                                        </div>
                                        <input type="hidden" id="keyUpdateMode" value="append">
                                    </div>
                                    <div class="key-mode-item">
                                        <label>聚合模式</label>
                                        <div class="custom-select-wrapper" data-select-id="keyAggregationMode">
                                            <div class="custom-select-trigger">轮询</div>
                                            <div class="custom-select-options">
                                                <div class="custom-select-option selected" data-value="round_robin">轮询
                                                </div>
                                                <div class="custom-select-option" data-value="random">随机</div>
                                            </div>
                                        </div>
                                        <input type="hidden" id="keyAggregationMode" value="round_robin">
                                    </div>
                                </div>
                                <small class="config-note"
                                    style="margin-top: -8px; display: block;">更新模式：追加=新增密钥到末尾，覆盖=替换所有密钥；聚合模式：轮询=依次使用，随机=随机选择</small>
                                <!-- 隐藏的兼容性字段 -->
                                <input type="hidden" id="useAssembly" value="true" />
                                <input type="hidden" id="keyAggregationEnabled" value="true" />
                            </div>
                            <div class="config-group">
                                <h4>模型配置</h4>
                                <div class="form-group">
                                    <div id="selectedModelsChips"
                                        style="min-height:36px; display:flex; gap:6px; flex-wrap:wrap; margin-bottom:8px">
                                    </div>
                                    <div class="manage-actions">
                                        <button class="btn btn-sm" onclick="queryModels()">获取模型列表</button>
                                        <button class="btn btn-sm" style="background:#ffc107"
                                            onclick="fillAllModels()">填入所有模型</button>
                                        <button class="btn btn-sm" style="background:#6c757d"
                                            onclick="clearSelectedModels()">清除所有模型</button>
                                        <button class="btn btn-sm" onclick="saveSelectedModels()">保存所选模型</button>
                                    </div>
                                </div>
                                <small class="config-note">查询后按供应商分组展示模型，勾选并保存即可用于接口列表与操练场</small>
                            </div>

                            <div class="config-group">
                                <h4>界面特效配置</h4>

                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="confettiEnabled" class="config-checkbox" />
                                        主页面彩带效果
                                    </label>
                                    <small class="config-note">登录后的页面是否显示鼠标彩带掉落效果</small>
                                </div>

                                <div class="form-group">
                                    <label for="confettiProbability">彩带掉落概率: <span
                                            id="confettiProbabilityValue">10</span>%</label>
                                    <input type="range" id="confettiProbability" min="1" max="100" value="10"
                                        oninput="document.getElementById('confettiProbabilityValue').textContent = this.value; this.style.background = 'linear-gradient(to right, #4285f4 0%, #4285f4 ' + this.value + '%, #ddd ' + this.value + '%, #ddd 100%)';"
                                        style="background: linear-gradient(to right, #4285f4 0%, #4285f4 10%, #ddd 10%, #ddd 100%); margin-bottom: 12px;" />
                                    <small class="config-note"
                                        style="margin-top: 8px; display: block;">鼠标移动时彩带掉落的概率（1-100%）</small>
                                </div>

                                <div class="form-group">
                                    <label class="lava-ripple-label"
                                        style="display: flex; align-items: center; gap: 8px;">
                                        <input type="checkbox" id="lavaRippleEnabled" class="config-checkbox" checked />
                                        <span class="lava-ripple-text"
                                            style="background: linear-gradient(135deg, #ff6b35 0%, #f7931e 25%, #ffcc00 50%, #8bc34a 75%, #4caf50 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-weight: bold; font-size: 14px;">层林尽染特效</span>
                                        <span class="lava-ripple-icon" style="font-size: 16px;">🍂</span>
                                    </label>
                                    <small class="config-note">登录页面的熔岩波涟漪效果，关闭可提升旧电脑性能</small>
                                </div>
                            </div>

                            <div class="config-group">
                                <h4>服务器配置</h4>

                                <div class="form-group">
                                    <label for="host">服务器主机地址:</label>
                                    <input type="text" id="host" class="config-input"
                                        placeholder="例如: 0.0.0.0, 127.0.0.1" />
                                    <small class="config-note">服务器监听的主机地址，0.0.0.0表示监听所有接口</small>
                                </div>

                                <div class="form-group">
                                    <label for="port">服务器端口:</label>
                                    <input type="number" id="port" class="config-input" min="1" max="65535"
                                        placeholder="7861" />
                                    <small class="config-note">服务器监听的端口号，修改后需要重启服务器</small>
                                </div>

                                <div class="form-group">
                                    <label for="configApiPassword">API访问密码:</label>
                                    <input type="text" id="configApiPassword" class="config-input" placeholder="pwd" />
                                    <small class="config-note">聊天API访问密码，用于OpenAI和Gemini API端点的认证</small>
                                </div>

                                <div class="form-group">
                                    <label for="configPanelPassword">控制面板密码:</label>
                                    <input type="text" id="configPanelPassword" class="config-input"
                                        placeholder="pwd" />
                                    <small class="config-note">控制面板访问密码，用于web界面登录认证</small>
                                </div>

                                <div class="form-group">
                                    <label for="configPassword">通用密码:</label>
                                    <input type="text" id="configPassword" class="config-input" placeholder="pwd" />
                                    <small class="config-note">（兼容性保留）设置后将覆盖上述两个密码，留空则使用分开的密码设置</small>
                                </div>
                            </div>

                            <div class="config-group">
                                <h4>基础配置</h4>

                                <div class="form-group">
                                    <label for="credentialsDir">凭证目录路径:</label>
                                    <input type="text" id="credentialsDir" class="config-input" />
                                    <small class="config-note">存储认证文件的目录路径</small>
                                </div>

                                <div class="form-group">
                                    <label for="proxy">代理设置:</label>
                                    <input type="text" id="proxy" class="config-input"
                                        placeholder="例如: http://proxy:8080 或 socks5://proxy:1080" />
                                    <small class="config-note">HTTP/HTTPS/SOCKS5Endpoint，留空表示不使用代理</small>
                                </div>
                            </div>

                            <div class="config-group">
                                <h4>自动封禁配置</h4>

                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="autoBanEnabled" class="config-checkbox" />
                                        启用自动封禁
                                    </label>
                                    <small class="config-note">遇到指定错误码时自动禁用凭证</small>
                                </div>

                                <div class="form-group">
                                    <label for="autoBanErrorCodes">自动封禁错误码:</label>
                                    <input type="text" id="autoBanErrorCodes" class="config-input"
                                        placeholder="例如: 400,403" />
                                    <small class="config-note">用逗号分隔的错误码列表</small>
                                </div>
                            </div>

                            <div class="config-group">
                                <h4>性能配置</h4>

                                <div class="form-group">
                                    <label for="callsPerRotation">凭证轮换调用次数:</label>
                                    <input type="number" id="callsPerRotation" class="config-input" min="1" max="100" />
                                    <small class="config-note">每个凭证使用多少次后轮换到下一个</small>
                                </div>

                            </div>

                            <div class="config-group">
                                <h4>429重试配置</h4>

                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="retry429Enabled" class="config-checkbox" />
                                        启用429重试
                                    </label>
                                    <small class="config-note">遇到429错误时自动重试</small>
                                </div>

                                <div class="form-group">
                                    <label for="retry429MaxRetries">429重试次数:</label>
                                    <input type="number" id="retry429MaxRetries" class="config-input" min="1"
                                        max="50" />
                                    <small class="config-note">遇到429错误时的最大重试次数</small>
                                </div>

                                <div class="form-group">
                                    <label for="retry429Interval">429重试间隔(秒):</label>
                                    <input type="number" id="retry429Interval" class="config-input" min="0.01" max="10"
                                        step="0.01" />
                                    <small class="config-note">遇到429错误时每两次重试间的等待时间</small>
                                </div>
                            </div>

                            <div class="config-group">
                                <h4>全部配置（只读）</h4>
                                <div class="manage-actions">
                                    <button class="refresh-btn btn-sm" onclick="refreshAllConfig()">刷新全部配置</button>
                                </div>
                                <div id="allConfigMeta" class="usage-info"></div>
                                <div class="form-group">
                                    <table class="table" id="allConfigTable"></table>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- 实时日志标签页 -->
                <div id="logsTab" class="tab-content">
                    <h3>实时日志</h3>

                    <div class="log-btn-group" style="margin-bottom: 16px;">
                        <button class="log-btn log-btn-connect" onclick="connectWebSocket()">
                            <span class="btn-icon">🔗</span>连接日志流
                        </button>
                        <button class="log-btn log-btn-disconnect" onclick="disconnectWebSocket()">
                            <span class="btn-icon">⛔</span>断开连接
                        </button>
                        <button class="log-btn log-btn-download" onclick="downloadLogs()">
                            <span class="btn-icon">📥</span>下载日志
                        </button>
                        <button class="log-btn log-btn-clear" onclick="clearLogs()">
                            <span class="btn-icon">🗑️</span>清空日志
                        </button>
                    </div>

                    <div class="filter-container">
                        <label for="logLevelFilter">日志级别筛选：</label>
                        <select id="logLevelFilter" class="filter-select" onchange="filterLogs()">
                            <option value="all">全部</option>
                            <option value="ERROR">错误</option>
                            <option value="WARNING">警告</option>
                            <option value="INFO">信息</option>
                            <option value="DEBUG">调试</option>
                        </select>

                        <label>
                            <input type="checkbox" id="autoScroll" checked> 自动滚动到底部
                        </label>
                    </div>

                    <div id="logConnectionStatus" class="status info">
                        <strong>连接状态：</strong> <span id="connectionStatusText">未连接</span>
                    </div>

                    <div id="logContainer"
                        style="background-color: #1e1e1e; color: #ffffff; font-family: 'Courier New', monospace; font-size: 12px; height: 600px; overflow-y: auto; border: 1px solid #333; border-radius: 5px; padding: 15px; white-space: pre-wrap; word-break: break-all;">
                        <div id="logContent">等待连接日志流...</div>
                    </div>
                </div>

                <!-- 操练场标签页 -->
                <div id="playgroundTab" class="tab-content">
                    <h3>操练场</h3>
                    <div id="playgroundStatus" class="playground-status"></div>

                    <!-- 参数配置区域 -->
                    <div class="config-group">
                        <div class="form-group">
                            <div
                                style="display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:16px; margin-bottom:16px">
                                <div>
                                    <label for="playgroundModel">模型</label>
                                    <select id="playgroundModel" class="config-input" style="width:100%"
                                        onchange="updateMaxTokensLimit(this.value); updateRequestPreview();"></select>
                                </div>
                                <div>
                                    <label for="playgroundApiKey">API Key（可选）</label>
                                    <select id="playgroundApiKey" class="config-input" style="width:100%"
                                        onchange="updateRequestPreview()">
                                        <option value="">自动选择（默认）</option>
                                    </select>
                                    <small class="config-note">留空则使用系统自动轮换</small>
                                </div>
                            </div>

                            <!-- Temperature 滑块 -->
                            <div style="margin-bottom: 20px;">
                                <div
                                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <label for="playgroundTemperature"
                                        style="color: var(--text-secondary); font-size: 14px;">Temperature ⓘ</label>
                                    <input type="number" id="playgroundTemperatureValue" class="config-input" step="0.1"
                                        min="0" max="2" value="0.5"
                                        style="width: 80px; padding: 6px; text-align: center; border-radius: 8px;"
                                        onchange="updateTemperatureSlider(this.value)" />
                                </div>
                                <input type="range" id="playgroundTemperature" min="0" max="2" step="0.1" value="0.5"
                                    style="width: 100%; height: 6px; border-radius: 3px; background: linear-gradient(to right, #4285f4 0%, #4285f4 25%, #e0e0e0 25%, #e0e0e0 100%); outline: none; -webkit-appearance: none; appearance: none;"
                                    oninput="updateTemperatureValue(this.value)" />
                            </div>

                            <!-- Max Tokens 滑块 -->
                            <div style="margin-bottom: 20px;">
                                <div
                                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <label for="playgroundMaxTokens"
                                        style="color: var(--text-secondary); font-size: 14px;">Max Tokens ⓘ</label>
                                    <input type="number" id="playgroundMaxTokensValue" class="config-input" min="1"
                                        max="128000" value="4096"
                                        style="width: 100px; padding: 6px; text-align: center; border-radius: 8px;"
                                        onchange="updateMaxTokensSlider(this.value)" />
                                </div>
                                <input type="range" id="playgroundMaxTokens" min="1" max="128000" step="1" value="4096"
                                    style="width: 100%; height: 6px; border-radius: 3px; background: linear-gradient(to right, #4285f4 0%, #4285f4 3%, #e0e0e0 3%, #e0e0e0 100%); outline: none; -webkit-appearance: none; appearance: none;"
                                    oninput="updateMaxTokensValue(this.value)" />
                            </div>

                            <!-- Stream 开关 -->
                            <div class="toggle-wrap" style="margin-bottom: 20px;">
                                <span>stream</span>
                                <label class="switch">
                                    <input type="checkbox" id="playgroundStream" onchange="updateRequestPreview()" />
                                    <span class="slider"></span>
                                </label>
                            </div>

                            <!-- 操作按钮 - 一排居中 -->
                            <div style="display:flex; gap:8px; justify-content:center; flex-wrap:wrap">
                                <button class="playground-btn playground-btn-add"
                                    onclick="addMessageRow()">添加参数</button>
                                <button class="playground-btn playground-btn-clear"
                                    onclick="clearMessages()">清空参数</button>
                                <button class="playground-btn playground-btn-send"
                                    onclick="sendPlayground()">发送测试</button>
                            </div>
                        </div>
                    </div>
                    <!-- 会话参数与工具定义并排布局 -->
                    <div class="playground-params-row">
                        <div class="playground-param-card playground-messages-card">
                            <div class="playground-param-header" onclick="toggleSection('playgroundMessagesWrap')">
                                <span class="playground-param-title">💬 会话参数</span>
                                <span id="playgroundMessagesToggle" class="playground-toggle-icon">▼</span>
                            </div>
                            <div id="playgroundMessagesWrap" class="playground-param-content">
                                <div id="playgroundMessages"></div>
                            </div>
                        </div>
                        <div class="playground-param-card playground-tools-card">
                            <div class="playground-param-header" onclick="toggleSection('playgroundToolsWrap')">
                                <span class="playground-param-title">🔧 工具定义</span>
                                <span id="playgroundToolsToggle" class="playground-toggle-icon">▼</span>
                            </div>
                            <div id="playgroundToolsWrap" class="playground-param-content">
                                <div class="form-group" style="margin:0">
                                    <textarea id="playgroundToolsJson" class="config-input playground-tools-textarea"
                                        placeholder='[{"type":"function","function":{"name":"get_weather","parameters":{"type":"object","properties":{"city":{"type":"string"}}}}}]'
                                        oninput="updateRequestPreview()"></textarea>
                                    <small class="config-note" style="margin-top:6px; display:block">留空则不启用工具调用；内容需为合法
                                        JSON</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- 请求预览区域（支持折叠，默认显示） -->
                    <div class="config-group" id="requestPreviewSection">
                        <div onclick="toggleSection('requestPreviewWrap')"
                            style="cursor:pointer; display:flex; align-items:center; justify-content:space-between; padding:6px 8px; background:var(--card-bg); border-radius:6px">
                            <span>📋 请求预览（实时）</span>
                            <span id="requestPreviewToggle">▼</span>
                        </div>
                        <div id="requestPreviewWrap" style="margin-top:12px; display:block">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label style="font-size: 12px; color: var(--text-secondary);">请求方法 & URL</label>
                                    <div
                                        style="background: var(--card-bg); padding: 10px; border-radius: 6px; font-family: monospace; font-size: 12px;">
                                        <span id="previewMethod" style="color: #28a745; font-weight: bold;">POST</span>
                                        <span id="previewUrl"
                                            style="color: var(--text-color); margin-left: 10px;"></span>
                                    </div>
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: var(--text-secondary);">请求头</label>
                                    <pre id="previewHeaders"
                                        style="background: var(--card-bg); padding: 10px; border-radius: 6px; font-family: monospace; font-size: 11px; margin: 0; max-height: 80px; overflow: auto;"></pre>
                                </div>
                            </div>
                            <div style="margin-top: 15px;">
                                <label style="font-size: 12px; color: var(--text-secondary);">请求体 (JSON)</label>
                                <textarea id="previewBody"
                                    style="width: 100%; background: #1e1e1e; color: #9cdcfe; padding: 12px; border-radius: 6px; font-family: monospace; font-size: 11px; margin: 0; min-height: 200px; border: 1px solid var(--border-color); resize: vertical;"></textarea>
                            </div>
                            <div style="margin-top: 10px; display: flex; gap: 8px; justify-content: flex-end;">
                                <button class="btn btn-sm" onclick="copyRequestBody()"
                                    style="background: #6c757d;">复制请求体</button>
                                <button class="btn btn-sm" onclick="editRequestBody()"
                                    style="background: #17a2b8;">编辑请求体</button>
                                <button class="btn btn-sm" onclick="sendCustomRequest()"
                                    style="background: #28a745;">发送</button>
                            </div>
                        </div>
                    </div>

                    <div class="config-group">
                        <h4>结果</h4>
                        <div class="form-group" style="display:flex; gap:12px; flex-wrap:wrap; align-items:stretch">
                            <div class="card" style="padding:12px; flex:1; min-width:280px">
                                <div><strong>Response</strong></div>
                                <div id="playgroundOutputContent"
                                    style="white-space:pre-wrap; margin-top:6px; max-height:240px; overflow:auto"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>原始响应</label>
                            <pre id="playgroundRawJson"
                                style="background-color:#1e1e1e; color:#ffffff; font-family:'Courier New', monospace; font-size:12px; height:320px; overflow-y:auto; border:1px solid #333; border-radius:5px; padding:12px; white-space:pre-wrap; word-break:break-all"></pre>
                        </div>
                    </div>
                </div>

                <!-- 账户管理标签页 -->
                <div id="accountTab" class="tab-content">
                    <h3>账户管理</h3>
                    <div id="accountStatus"></div>

                    <!-- 登录区域 -->
                    <div id="accountLoginSection">
                        <div class="config-group">
                            <h4>登录 AssemblyAI Dashboard</h4>
                            <p style="color: var(--text-secondary); margin-bottom: 16px;">使用你的 AssemblyAI
                                账户邮箱和密码登录，查看账户余额、使用量和成本。</p>

                            <!-- 邮箱密码登录 -->
                            <div class="form-group">
                                <label for="accountEmail">邮箱</label>
                                <input type="text" id="accountEmail" class="config-input"
                                    placeholder="your@email.com" />
                            </div>
                            <div class="form-group">
                                <label for="accountPassword">密码</label>
                                <input type="password" id="accountPassword" class="config-input" placeholder="输入密码"
                                    onkeypress="if(event.key==='Enter')accountLogin()" />
                            </div>
                            <button class="btn" onclick="accountLogin()">登录</button>
                            <small class="config-note" style="display: block; margin-top: 12px;">
                                <a href="https://www.assemblyai.com/dashboard/signup" target="_blank">没有账户？注册
                                    AssemblyAI</a>
                            </small>
                        </div>
                    </div>

                    <!-- 已登录区域 -->
                    <div id="accountLoggedInSection" class="hidden">
                        <!-- 账户列表和选择器 -->
                        <div class="config-group" style="margin-bottom: 20px;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <h4 style="margin: 0;">账户管理</h4>
                                <button class="btn btn-sm" onclick="showAddAccountForm()" style="background: #28a745;">
                                    ➕ 添加账户
                                </button>
                            </div>

                            <!-- 添加账户表单（默认隐藏） -->
                            <div id="addAccountForm" class="hidden"
                                style="margin-bottom: 20px; padding: 16px; background: var(--card-bg); border-radius: 8px; border: 2px solid var(--border-color);">
                                <div
                                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                    <h5 style="margin: 0; color: var(--text-color);">添加新账户</h5>
                                    <button class="btn btn-sm" onclick="hideAddAccountForm()"
                                        style="background: #6c757d; padding: 4px 12px;">✕ 取消</button>
                                </div>
                                <div class="form-group">
                                    <label for="newAccountEmail">邮箱</label>
                                    <input type="text" id="newAccountEmail" class="config-input"
                                        placeholder="your@email.com" />
                                </div>
                                <div class="form-group">
                                    <label for="newAccountPassword">密码</label>
                                    <input type="password" id="newAccountPassword" class="config-input"
                                        placeholder="输入密码" onkeypress="if(event.key==='Enter')addNewAccount()" />
                                </div>
                                <button class="btn" onclick="addNewAccount()" style="background: #28a745;">添加账户</button>
                            </div>

                            <div id="accountListContainer">
                                <div class="loading-spinner">
                                    <div class="spinner"></div>
                                    <div class="spinner-text">正在加载账户列表...</div>
                                </div>
                            </div>
                        </div>

                        <!-- 账户详情区域（只有选择了账户后才显示） -->
                        <div id="accountDetailsSection" class="hidden">
                            <!-- 子标签页导航 -->
                            <div class="account-sub-tabs">
                                <button class="btn btn-sm" id="accountSubTabOverview"
                                    onclick="switchAccountSubTab('overview')" style="background: #4285f4;">概览</button>
                                <button class="btn btn-sm" id="accountSubTabCost" onclick="switchAccountSubTab('cost')"
                                    style="background: #6c757d;">成本</button>
                                <button class="btn btn-sm" id="accountSubTabUsage"
                                    onclick="switchAccountSubTab('usage')" style="background: #6c757d;">使用量</button>
                                <button class="btn btn-sm" id="accountSubTabRates"
                                    onclick="switchAccountSubTab('rates')" style="background: #6c757d;">费率</button>
                            </div>

                            <!-- 概览子页面 -->
                            <div id="accountSubOverview">
                                <div
                                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px;">
                                    <!-- 账户信息卡片 -->
                                    <div class="config-group">
                                        <h4>账户信息</h4>
                                        <div id="accountInfoContent">
                                            <div class="skeleton-loader">
                                                <div class="skeleton-card">
                                                    <div class="skeleton-line medium" style="margin-bottom: 12px;">
                                                    </div>
                                                    <div class="skeleton-line long"></div>
                                                    <div class="skeleton-line long"></div>
                                                    <div class="skeleton-line medium"></div>
                                                </div>
                                                <div class="loading-spinner" style="padding: 20px 0;">
                                                    <div class="spinner"></div>
                                                    <div class="spinner-text">正在加载账户信息...</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- 余额卡片 -->
                                    <div class="config-group">
                                        <h4>余额</h4>
                                        <div id="accountBalanceContent">
                                            <div class="skeleton-loader">
                                                <div
                                                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                                                    <div class="skeleton-card" style="text-align: center;">
                                                        <div class="skeleton-line short" style="margin: 0 auto 12px;">
                                                        </div>
                                                        <div class="skeleton-big-number"></div>
                                                    </div>
                                                    <div class="skeleton-card" style="text-align: center;">
                                                        <div class="skeleton-line short" style="margin: 0 auto 12px;">
                                                        </div>
                                                        <div class="skeleton-big-number"></div>
                                                    </div>
                                                </div>
                                                <div class="loading-spinner" style="padding: 20px 0;">
                                                    <div class="spinner"></div>
                                                    <div class="spinner-text">正在加载余额信息...</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 使用量子页面 -->
                            <div id="accountSubUsage" class="hidden">
                                <div class="config-group">
                                    <h4>使用量统计 <button class="btn btn-sm" onclick="loadAccountUsageAll(true)"
                                            style="margin-left: 8px; padding: 2px 8px; font-size: 11px;">刷新</button>
                                    </h4>

                                    <!-- 总览区域（固定，不受筛选影响） -->
                                    <div id="accountUsageSummarySection">
                                        <div class="skeleton-loader">
                                            <div class="skeleton-card" style="text-align: center;">
                                                <div class="skeleton-line short" style="margin: 0 auto 8px;"></div>
                                                <div class="skeleton-big-number"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 详情区域（受筛选影响） -->
                                    <div
                                        style="margin-top: 24px; padding: 16px; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color);">
                                        <!-- 标题：按模型分类 + 日期范围 -->
                                        <h4 style="margin: 0 0 12px 0; font-size: 14px; color: var(--text-color);">使用详情
                                            <span id="usageDetailDateRange"
                                                style="font-weight: normal; color: var(--text-secondary);"></span>
                                        </h4>

                                        <!-- 筛选器标签栏 -->
                                        <div
                                            style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom: 16px;">
                                            <span style="font-size: 12px; color: var(--text-secondary);">Filter
                                                by:</span>

                                            <!-- 日期筛选 -->
                                            <button id="usageFilterDateBtn" class="cost-filter-tag"
                                                onclick="toggleUsageFilterPanel('Date')"
                                                style="padding: 4px 10px; border-radius: 16px; border: 1px solid var(--border-color); background: var(--card-bg); cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 4px;">
                                                <span id="usageFilterDateLabel">Date: Last 7 days</span>
                                                <span style="font-size: 10px;">▼</span>
                                            </button>

                                            <!-- 产品筛选 -->
                                            <button id="usageFilterProductBtn" class="cost-filter-tag"
                                                onclick="toggleUsageFilterPanel('Product')"
                                                style="padding: 4px 10px; border-radius: 16px; border: 1px solid var(--border-color); background: var(--card-bg); cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 4px;">
                                                <span id="usageFilterProductLabel">Product: LLM</span>
                                                <span style="font-size: 10px;">▼</span>
                                            </button>

                                            <!-- 视图切换 -->
                                            <div style="margin-left: auto; display: flex; gap: 4px;">
                                                <button id="usageViewChart" onclick="setUsageViewMode('chart')"
                                                    class="cost-view-btn active"
                                                    style="padding: 4px 8px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--card-bg); cursor: pointer; font-size: 12px;">图表</button>
                                                <button id="usageViewTable" onclick="setUsageViewMode('table')"
                                                    class="cost-view-btn"
                                                    style="padding: 4px 8px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--card-bg); cursor: pointer; font-size: 12px;">列表</button>
                                            </div>
                                        </div>

                                        <!-- 日期筛选面板 -->
                                        <div id="usageFilterDatePanel" class="hidden"
                                            style="margin-bottom: 16px; padding: 12px; background: var(--container-bg); border-radius: 8px; border: 1px solid var(--border-color);">
                                            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px;">
                                                <button class="btn btn-sm usage-date-preset" data-days="7"
                                                    onclick="setUsageDatePreset(7)" style="padding: 4px 12px;">Last 7
                                                    days</button>
                                                <button class="btn btn-sm usage-date-preset" data-days="14"
                                                    onclick="setUsageDatePreset(14)" style="padding: 4px 12px;">Last 14
                                                    days</button>
                                                <button class="btn btn-sm usage-date-preset" data-days="30"
                                                    onclick="setUsageDatePreset(30)" style="padding: 4px 12px;">Last 30
                                                    days</button>
                                            </div>
                                            <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                                                <input type="date" id="usageStartDate"
                                                    style="width: 140px; padding: 4px 8px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--card-bg); color: var(--text-color); font-size: 12px;">
                                                <span style="color: var(--text-secondary);">to</span>
                                                <input type="date" id="usageEndDate"
                                                    style="width: 140px; padding: 4px 8px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--card-bg); color: var(--text-color); font-size: 12px;">
                                                <button class="btn btn-sm" onclick="applyUsageDateFilter()"
                                                    style="padding: 4px 12px; background: #4285f4;">Apply</button>
                                            </div>
                                        </div>

                                        <!-- 产品筛选面板 -->
                                        <div id="usageFilterProductPanel" class="hidden"
                                            style="margin-bottom: 16px; padding: 12px; background: var(--container-bg); border-radius: 8px; border: 1px solid var(--border-color);">
                                            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                                <button class="btn btn-sm usage-product-btn active"
                                                    data-product="LLM Gateway + LeMUR"
                                                    onclick="setUsageProduct('LLM Gateway + LeMUR')"
                                                    style="padding: 4px 12px;">LLM Gateway + LeMUR</button>
                                                <button class="btn btn-sm usage-product-btn"
                                                    data-product="Speech-to-Text"
                                                    onclick="setUsageProduct('Speech-to-Text')"
                                                    style="padding: 4px 12px;">Speech-to-Text</button>
                                                <button class="btn btn-sm usage-product-btn" data-product="Streaming"
                                                    onclick="setUsageProduct('Streaming')"
                                                    style="padding: 4px 12px;">Streaming</button>
                                            </div>
                                        </div>

                                        <!-- 详情总额 -->
                                        <div
                                            style="margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                            <div style="font-size: 14px; color: var(--text-color);">
                                                Total tokens: <strong id="usageDetailTotal">0</strong>
                                            </div>
                                        </div>

                                        <!-- 详情内容区域 -->
                                        <div id="accountUsageDetails">
                                            <div style="text-align: center; padding: 40px;">
                                                <div class="spinner"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 成本子页面 -->
                            <div id="accountSubCost" class="hidden">
                                <div class="config-group">
                                    <h4>成本分析 <button class="btn btn-sm"
                                            onclick="console.log('Refresh clicked'); loadAccountCost(true)"
                                            style="margin-left: 12px; padding: 6px 16px; font-size: 13px;">刷新</button>
                                    </h4>

                                    <!-- 总览区域（固定，不受筛选影响） -->
                                    <div id="accountCostSummarySection">
                                        <div class="skeleton-loader">
                                            <div class="skeleton-card" style="text-align: center;">
                                                <div class="skeleton-line short" style="margin: 0 auto 8px;"></div>
                                                <div class="skeleton-big-number"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 详情区域（受筛选影响） -->
                                    <div
                                        style="margin-top: 24px; padding: 16px; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color);">
                                        <!-- 标题：按模型分类 + 日期范围 -->
                                        <h4 style="margin: 0 0 12px 0; font-size: 14px; color: var(--text-color);">Cost
                                            Details <span id="costDetailDateRange"
                                                style="font-weight: normal; color: var(--text-secondary);"></span></h4>

                                        <!-- 筛选器标签栏 -->
                                        <div
                                            style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;">
                                            <span style="font-size: 12px; color: var(--text-secondary);">Filter
                                                by:</span>
                                            <button class="cost-filter-tag" id="costFilterDateBtn"
                                                onclick="toggleCostFilterPanel('date')"
                                                style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 16px; border: 1px solid var(--border-color); background: var(--container-bg); color: var(--text-color); cursor: pointer; font-size: 12px;">
                                                <span id="costFilterDateLabel">Date: Last 7 days</span>
                                            </button>
                                            <button class="cost-filter-tag" id="costFilterServiceBtn"
                                                onclick="toggleCostFilterPanel('service')"
                                                style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 16px; border: 1px solid var(--border-color); background: var(--container-bg); color: var(--text-color); cursor: pointer; font-size: 12px;">
                                                <span id="costFilterServiceLabel">Service: All</span>
                                            </button>
                                            <button class="cost-filter-tag" id="costFilterRegionBtn"
                                                onclick="toggleCostFilterPanel('region')"
                                                style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 16px; border: 1px solid var(--border-color); background: var(--container-bg); color: var(--text-color); cursor: pointer; font-size: 12px;">
                                                <span id="costFilterRegionLabel">Region: All</span>
                                            </button>
                                            <button class="cost-filter-tag" id="costFilterModelBtn"
                                                onclick="toggleCostFilterPanel('model')"
                                                style="display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 16px; border: 1px solid var(--border-color); background: var(--container-bg); color: var(--text-color); cursor: pointer; font-size: 12px;">
                                                <span id="costFilterModelLabel">Models: All</span>
                                            </button>
                                            <!-- 视图切换 -->
                                            <div style="margin-left: auto; display: flex; gap: 4px;">
                                                <button id="costViewChart" onclick="setCostViewMode('chart')"
                                                    class="cost-view-btn active"
                                                    style="padding: 4px 8px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--card-bg); cursor: pointer; font-size: 12px;">图表</button>
                                                <button id="costViewTable" onclick="setCostViewMode('table')"
                                                    class="cost-view-btn"
                                                    style="padding: 4px 8px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--card-bg); cursor: pointer; font-size: 12px;">列表</button>
                                            </div>
                                        </div>

                                        <!-- 日期筛选面板 -->
                                        <div id="costFilterDatePanel" class="cost-filter-panel hidden"
                                            style="padding: 12px; background: var(--container-bg); border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 12px;">
                                            <!-- 快速预设按钮 -->
                                            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px;">
                                                <button class="btn btn-sm cost-date-preset active" data-days="7"
                                                    onclick="setCostDatePreset(7)" style="padding: 4px 12px;">Last 7
                                                    days</button>
                                                <button class="btn btn-sm cost-date-preset" data-days="14"
                                                    onclick="setCostDatePreset(14)" style="padding: 4px 12px;">Last 14
                                                    days</button>
                                                <button class="btn btn-sm cost-date-preset" data-days="30"
                                                    onclick="setCostDatePreset(30)" style="padding: 4px 12px;">Last 30
                                                    days</button>
                                            </div>
                                            <div
                                                style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
                                                <div style="display: flex; gap: 4px;">
                                                    <button class="cost-window-btn active" data-window="day"
                                                        onclick="setCostWindow('day')"
                                                        style="padding: 4px 10px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--card-bg); cursor: pointer; font-size: 11px;">day</button>
                                                    <button class="cost-window-btn" data-window="hour"
                                                        onclick="setCostWindow('hour')"
                                                        style="padding: 4px 10px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--card-bg); cursor: pointer; font-size: 11px;">hour</button>
                                                </div>
                                                <div style="display: flex; gap: 6px; align-items: center;">
                                                    <input type="date" id="costStartDate" class="config-input"
                                                        style="width: 140px; padding: 4px 8px; font-size: 12px;"
                                                        onchange="validateCostDateRange()">
                                                    <span
                                                        style="color: var(--text-secondary); font-size: 12px;">-</span>
                                                    <input type="date" id="costEndDate" class="config-input"
                                                        style="width: 140px; padding: 4px 8px; font-size: 12px;"
                                                        onchange="validateCostDateRange()">
                                                </div>
                                                <div id="costDateError"
                                                    style="color: #dc3545; font-size: 11px; display: none;">Invalid date
                                                    range</div>
                                                <div style="margin-left: auto; display: flex; gap: 6px;">
                                                    <button class="btn btn-sm" onclick="resetCostDateFilter()"
                                                        style="background: #6c757d; padding: 4px 10px; font-size: 11px;">Reset</button>
                                                    <button class="btn btn-sm" id="costDateApplyBtn"
                                                        onclick="applyCostFilters()"
                                                        style="padding: 4px 10px; font-size: 11px;">Apply</button>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 服务筛选面板 -->
                                        <div id="costFilterServicePanel" class="cost-filter-panel hidden"
                                            style="padding: 12px; background: var(--container-bg); border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 12px;">
                                            <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
                                                <label
                                                    style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 12px;">
                                                    <input type="checkbox" id="costServiceAPI" value="API" checked
                                                        onchange="updateCostServiceLabel()"> API
                                                </label>
                                                <label
                                                    style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 12px;">
                                                    <input type="checkbox" id="costServicePlayground" value="Playground"
                                                        checked onchange="updateCostServiceLabel()"> Playground
                                                </label>
                                                <div style="margin-left: auto; display: flex; gap: 6px;">
                                                    <button class="btn btn-sm" onclick="resetCostServiceFilter()"
                                                        style="background: #6c757d; padding: 4px 10px; font-size: 11px;">Reset</button>
                                                    <button class="btn btn-sm" onclick="applyCostFilters()"
                                                        style="padding: 4px 10px; font-size: 11px;">Apply</button>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 区域筛选面板 -->
                                        <div id="costFilterRegionPanel" class="cost-filter-panel hidden"
                                            style="padding: 12px; background: var(--container-bg); border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 12px;">
                                            <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
                                                <label
                                                    style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 12px;">
                                                    <input type="checkbox" id="costRegionUS" value="US" checked
                                                        onchange="updateCostRegionLabel()"> US
                                                </label>
                                                <label
                                                    style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 12px;">
                                                    <input type="checkbox" id="costRegionEurope" value="Europe" checked
                                                        onchange="updateCostRegionLabel()"> Europe
                                                </label>
                                                <div style="margin-left: auto; display: flex; gap: 6px;">
                                                    <button class="btn btn-sm" onclick="resetCostRegionFilter()"
                                                        style="background: #6c757d; padding: 4px 10px; font-size: 11px;">Reset</button>
                                                    <button class="btn btn-sm" onclick="applyCostFilters()"
                                                        style="padding: 4px 10px; font-size: 11px;">Apply</button>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 模型筛选面板 -->
                                        <div id="costFilterModelPanel" class="cost-filter-panel hidden"
                                            style="padding: 12px; background: var(--container-bg); border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 12px; max-height: 300px; overflow-y: auto;">
                                            <div
                                                style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                                <label
                                                    style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 12px; font-weight: 500;">
                                                    <input type="checkbox" id="costModelSelectAll" checked
                                                        onchange="toggleAllCostModels(this.checked)"> Select all
                                                </label>
                                                <span style="color: var(--text-muted); font-size: 11px;"
                                                    id="costModelCountLabel"></span>
                                                <div style="margin-left: auto; display: flex; gap: 6px;">
                                                    <button class="btn btn-sm" onclick="resetCostModelFilter()"
                                                        style="background: #6c757d; padding: 4px 10px; font-size: 11px;">Reset</button>
                                                    <button class="btn btn-sm" onclick="applyCostFilters()"
                                                        style="padding: 4px 10px; font-size: 11px;">Apply</button>
                                                </div>
                                            </div>
                                            <div id="costModelList"
                                                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 4px; font-size: 11px;">
                                            </div>
                                        </div>

                                        <!-- 详情总额 -->
                                        <div
                                            style="margin-bottom: 12px; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                            <div style="font-size: 14px; color: var(--text-color);">
                                                Total spend: <strong id="costDetailTotal">$0.00</strong>
                                            </div>
                                        </div>

                                        <!-- 详情内容区域 -->
                                        <div id="accountCostDetails">
                                            <div class="skeleton-loader" style="padding: 0;">
                                                <!-- 模拟图表区域 -->
                                                <div class="skeleton-card" style="margin: 0; padding: 16px;">
                                                    <div
                                                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                                        <div class="skeleton-line short"
                                                            style="width: 80px; margin: 0;"></div>
                                                        <div style="display: flex; gap: 8px;">
                                                            <div class="skeleton-line"
                                                                style="width: 60px; height: 12px; margin: 0;"></div>
                                                            <div class="skeleton-line"
                                                                style="width: 60px; height: 12px; margin: 0;"></div>
                                                            <div class="skeleton-line"
                                                                style="width: 60px; height: 12px; margin: 0;"></div>
                                                        </div>
                                                    </div>
                                                    <!-- 模拟曲线图区域 -->
                                                    <div
                                                        style="height: 200px; background: linear-gradient(180deg, var(--card-bg) 0%, var(--border-color) 100%); border-radius: 8px; position: relative; overflow: hidden;">
                                                        <div
                                                            style="position: absolute; bottom: 0; left: 0; right: 0; height: 60%; background: linear-gradient(90deg, var(--border-color) 25%, var(--card-bg) 50%, var(--border-color) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; opacity: 0.5;">
                                                        </div>
                                                    </div>
                                                    <!-- 模拟X轴标签 -->
                                                    <div
                                                        style="display: flex; justify-content: space-between; margin-top: 8px;">
                                                        <div class="skeleton-line"
                                                            style="width: 40px; height: 10px; margin: 0;"></div>
                                                        <div class="skeleton-line"
                                                            style="width: 40px; height: 10px; margin: 0;"></div>
                                                        <div class="skeleton-line"
                                                            style="width: 40px; height: 10px; margin: 0;"></div>
                                                        <div class="skeleton-line"
                                                            style="width: 40px; height: 10px; margin: 0;"></div>
                                                    </div>
                                                </div>
                                                <div class="loading-spinner" style="padding: 16px 0;">
                                                    <div class="spinner"></div>
                                                    <div class="spinner-text">正在加载成本详情...</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 兼容旧的accountCostContent -->
                                    <div id="accountCostContent" style="display: none;"></div>
                                </div>
                            </div>

                            <!-- 费率子页面 -->
                            <div id="accountSubRates" class="hidden">
                                <div class="config-group">
                                    <h4>费率信息</h4>
                                    <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                                        <select id="accountRatesRegion" class="config-input"
                                            style="width: auto; min-width: 100px;" onchange="loadAccountRates(true)">
                                            <option value="US" selected="selected">US</option>
                                            <option value="Europe">Europe</option>
                                        </select>
                                        <button class="btn btn-sm" onclick="loadAccountRates(true)">刷新</button>
                                    </div>
                                    <div id="accountRatesContent">
                                        <div class="skeleton-loader">
                                            <div class="skeleton-card">
                                                <div class="skeleton-line medium" style="margin-bottom: 16px;"></div>
                                                <div class="skeleton-line long"></div>
                                                <div class="skeleton-line long"></div>
                                                <div class="skeleton-line long"></div>
                                                <div class="skeleton-line medium"></div>
                                            </div>
                                            <div class="loading-spinner" style="padding: 20px 0;">
                                                <div class="spinner"></div>
                                                <div class="spinner-text">正在加载费率信息...</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div><!-- 关闭 tab-content-wrapper -->
        </div>
    </div>

    <!-- 多密钥管理弹窗 -->
    <div class="modal" id="keyManagementModal">
        <div class="modal-content key-modal-content">
            <div class="modal-header key-modal-header">
                <div class="key-modal-title-wrap">
                    <h4 class="modal-title key-modal-title">
                        多密钥管理
                        <span class="key-modal-tag">⛩️ OpenAI</span>
                    </h4>
                    <span class="key-stat-badge">总密钥数: <span id="modalKeyTotal">0</span></span>
                    <span class="key-stat-badge"><span id="modalAggregationMode">轮询模式</span></span>
                </div>
                <button class="modal-close" onclick="closeKeyManagementModal()">&times;</button>
            </div>

            <!-- 统计卡片 -->
            <div class="key-stats-grid">
                <div class="key-stat-card">
                    <div class="key-stat-header">
                        <span class="key-stat-dot" style="background: #28a745;"></span>
                        <span class="key-stat-label">已启用</span>
                    </div>
                    <div class="key-stat-value" style="color: #28a745;"><span id="modalKeyEnabled">0</span> / <span
                            id="modalKeyTotal2">0</span></div>
                    <div class="progress-bar">
                        <div id="enabledProgressBar" class="progress-fill" style="background: #28a745;"></div>
                    </div>
                </div>
                <div class="key-stat-card">
                    <div class="key-stat-header">
                        <span class="key-stat-dot" style="background: #dc3545;"></span>
                        <span class="key-stat-label">手动禁用</span>
                    </div>
                    <div class="key-stat-value" style="color: #dc3545;"><span id="modalKeyManualDisabled">0</span> /
                        <span id="modalKeyTotal3">0</span>
                    </div>
                    <div class="progress-bar">
                        <div id="manualDisabledProgressBar" class="progress-fill" style="background: #dc3545;"></div>
                    </div>
                </div>
                <div class="key-stat-card">
                    <div class="key-stat-header">
                        <span class="key-stat-dot" style="background: #ffc107;"></span>
                        <span class="key-stat-label">自动禁用</span>
                    </div>
                    <div class="key-stat-value" style="color: #ffc107;"><span id="modalKeyAutoDisabled">0</span> / <span
                            id="modalKeyTotal4">0</span></div>
                    <div class="progress-bar">
                        <div id="autoDisabledProgressBar" class="progress-fill" style="background: #ffc107;"></div>
                    </div>
                </div>
            </div>

            <!-- 工具栏 -->
            <div class="key-toolbar">
                <div class="key-toolbar-filter">
                    <div class="custom-select-wrapper" data-select-id="modalKeyStatusFilter"
                        data-onchange="loadKeyManagementModal()">
                        <div class="custom-select-trigger">全部状态</div>
                        <div class="custom-select-options">
                            <div class="custom-select-option selected" data-value="all">全部状态</div>
                            <div class="custom-select-option" data-value="enabled">已启用</div>
                            <div class="custom-select-option" data-value="disabled">已禁用</div>
                            <div class="custom-select-option" data-value="invalid">失效密钥</div>
                        </div>
                    </div>
                    <input type="hidden" id="modalKeyStatusFilter" value="all">
                </div>
                <div class="key-toolbar-actions">
                    <button class="btn btn-sm btn-outline-primary" onclick="enableAllKeys()">启用全部</button>
                    <button class="btn btn-sm btn-outline-danger" onclick="disableAllKeys()">禁用全部</button>
                    <button class="btn btn-sm btn-outline-warning" onclick="deleteAutoDisabledKeys()">删除自动禁用密钥</button>
                    <button class="btn btn-sm btn-outline-info" onclick="cleanupKeyStats()">清理过期统计</button>
                    <button class="btn btn-sm btn-outline-success" onclick="loadKeyManagementModal()">刷新</button>
                </div>
            </div>

            <!-- 密钥表格 -->
            <div class="key-table-container">
                <table class="table key-table">
                    <thead>
                        <tr>
                            <th class="key-col-index">索引</th>
                            <th class="key-col-key">密钥</th>
                            <th class="key-col-status">状态</th>
                            <th class="key-col-reason">禁用原因</th>
                            <th class="key-col-time">禁用时间</th>
                            <th class="key-col-action">操作</th>
                        </tr>
                    </thead>
                    <tbody id="keyManagementTableBody">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px;">加载中...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- 分页 -->
            <div class="key-pagination">
                <span class="key-pagination-info">显示第 <span id="keyPageStart">1</span> 条-第 <span
                        id="keyPageEnd">10</span> 条，共 <span id="keyPageTotal">0</span> 条</span>
                <div class="key-pagination-controls">
                    <button class="pagination-btn" id="keyPrevPage" onclick="changeKeyPage(-1)">&lt;</button>
                    <span id="keyCurrentPage" class="key-pagination-current">1</span>
                    <button class="pagination-btn" id="keyNextPage" onclick="changeKeyPage(1)">&gt;</button>
                    <span class="key-pagination-label">每页条数:</span>
                    <select id="keyPageSize" class="filter-select" onchange="loadKeyManagementModal()">
                        <option value="5" selected>5</option>
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                    </select>
                    <span class="key-pagination-label">跳至</span>
                    <input type="number" id="keyJumpPage" class="key-pagination-input" min="1"
                        onchange="jumpToKeyPage()">
                </div>
            </div>
        </div>
    </div>

    <!-- 限制设置弹窗 -->
    <div id="limitsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">设置使用限制</h3>
                <button class="modal-close" onclick="closeLimitsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="modalFilename">文件名:</label>
                    <input type="text" id="modalFilename" class="config-input" readonly />
                </div>
                <div class="form-group">
                    <label for="modalTotalLimit">所有模型每日限制:</label>
                    <input type="number" id="modalTotalLimit" class="config-input" min="1" max="50000" />
                    <small class="config-note">每日所有模型调用次数总限制</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeLimitsModal()" style="background-color: #6c757d;">取消</button>
                <button class="btn" onclick="saveLimits()">保存</button>
            </div>
        </div>
    </div>

    <!-- 操练场结果弹窗 -->
    <div id="playgroundResultModal" class="modal">
        <div class="modal-content" style="max-width: 600px; width: 90%; box-sizing: border-box;">
            <div class="modal-header">
                <h3 class="modal-title">测试结果</h3>
                <button class="modal-close" onclick="closePlaygroundResultModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>返回消息:</label>
                    <div id="playgroundResultMessage"
                        style="background: var(--card-bg, #f8f9fa); padding: 12px; border-radius: 6px; max-height: 400px; overflow-y: auto; white-space: pre-wrap; word-break: break-word; color: var(--text-color, #333);">
                    </div>
                </div>
                <div class="form-group">
                    <label>使用的 Key:</label>
                    <div id="playgroundResultKey" style="font-family: 'Courier New', monospace; color: #666;"></div>
                </div>
                <div class="form-group">
                    <label>Token 使用:</label>
                    <div id="playgroundResultTokens" style="color: #666;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closePlaygroundResultModal()">关闭</button>
            </div>
        </div>
    </div>

    <script>
        let currentProjectId = '';
        let authInProgress = false;
        let uploadSelectedFiles = []; // 上传页面用的文件列表
        let authToken = '';
        let credsData = {};
        let selectedModels = [];
        let queriedModels = { grouped: { Anthropic: [], OpenAI: [], Google: [], Other: [] }, models: [] };

        // ==================== 暗黑模式 ====================
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeButton(newTheme);

            // 重新渲染使用动态颜色的组件
            refreshThemeAwareComponents();
        }

        // 刷新需要响应主题变化的组件
        function refreshThemeAwareComponents() {
            // 刷新模型配置标签
            if (typeof renderSelectedModelsChips === 'function') {
                renderSelectedModelsChips();
            }
            // 刷新使用统计卡片（如果已加载）
            if (typeof renderUsageList === 'function' && usageStatsData && Object.keys(usageStatsData).length > 0) {
                renderUsageList(usageStatsData);
            }
        }

        function updateThemeButton(theme) {
            const icon = document.getElementById('themeIcon');
            const text = document.getElementById('themeText');
            if (theme === 'dark') {
                icon.textContent = '☀️';
                text.textContent = '亮色';
            } else {
                icon.textContent = '🌙';
                text.textContent = '暗黑';
            }
        }

        // 初始化主题
        (function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            // 延迟更新按钮，确保 DOM 已加载
            setTimeout(() => updateThemeButton(savedTheme), 0);
        })();

        // ==================== 暗黑模式按钮拖动和吸附 ====================
        (function initThemeToggleDrag() {
            const themeToggle = document.querySelector('.theme-toggle');
            if (!themeToggle) return;

            let isDragging = false;
            let hasMoved = false;
            let startX, startY;
            let initialX, initialY;
            let clickStartTime = 0;
            const CLICK_THRESHOLD = 300; // 300ms内的操作视为点击
            const MOVE_THRESHOLD = 8; // 移动8px以上才视为拖动

            // 检测是否为移动设备
            const isMobile = () => window.innerWidth <= 768;

            // 从 localStorage 加载位置 (所有设备)
            const savedPosition = localStorage.getItem('themeTogglePosition');
            if (savedPosition) {
                try {
                    const { top, right, bottom, left } = JSON.parse(savedPosition);
                    if (top !== null) themeToggle.style.top = top + 'px';
                    if (right !== null) themeToggle.style.right = right + 'px';
                    if (bottom !== null) themeToggle.style.bottom = bottom + 'px';
                    if (left !== null) themeToggle.style.left = left + 'px';
                } catch (e) {
                    console.error('Failed to load theme toggle position:', e);
                }
            }

            function startDrag(e) {
                clickStartTime = Date.now();
                hasMoved = false;
                const touch = e.type.includes('touch') ? e.touches[0] : e;
                startX = touch.clientX;
                startY = touch.clientY;

                const rect = themeToggle.getBoundingClientRect();
                initialX = rect.left;
                initialY = rect.top;

                document.addEventListener('mousemove', onDrag);
                document.addEventListener('mouseup', stopDrag);
                document.addEventListener('touchmove', onDrag, { passive: false });
                document.addEventListener('touchend', stopDrag);
            }

            function onDrag(e) {
                const touch = e.type.includes('touch') ? e.touches[0] : e;
                const deltaX = touch.clientX - startX;
                const deltaY = touch.clientY - startY;

                // 判断是否超过移动阈值
                if (!isDragging && (Math.abs(deltaX) > MOVE_THRESHOLD || Math.abs(deltaY) > MOVE_THRESHOLD)) {
                    isDragging = true;
                    hasMoved = true;
                    themeToggle.classList.add('dragging');
                }

                if (isDragging) {
                    e.preventDefault();
                    const newX = initialX + deltaX;
                    const newY = initialY + deltaY;

                    // 清除自动定位
                    themeToggle.style.top = newY + 'px';
                    themeToggle.style.left = newX + 'px';
                    themeToggle.style.right = 'auto';
                    themeToggle.style.bottom = 'auto';
                }
            }

            function stopDrag(e) {
                document.removeEventListener('mousemove', onDrag);
                document.removeEventListener('mouseup', stopDrag);
                document.removeEventListener('touchmove', onDrag);
                document.removeEventListener('touchend', stopDrag);

                if (isDragging) {
                    themeToggle.classList.remove('dragging');
                    snapToEdge();
                    hasMoved = true; // 标记为已移动，阻止click事件
                }
                // 注意：不在这里调用toggleTheme()，由click事件统一处理

                // 重置拖动状态
                isDragging = false;
            }

            function snapToEdge() {
                const rect = themeToggle.getBoundingClientRect();
                const windowWidth = window.innerWidth;
                const windowHeight = window.innerHeight;
                const buttonWidth = rect.width;
                const buttonHeight = rect.height;

                const centerX = rect.left + buttonWidth / 2;
                const centerY = rect.top + buttonHeight / 2;

                // 计算到四个边的距离
                const distToLeft = centerX;
                const distToRight = windowWidth - centerX;
                const distToTop = centerY;
                const distToBottom = windowHeight - centerY;

                // 找到最近的边
                const minDist = Math.min(distToLeft, distToRight, distToTop, distToBottom);

                let finalTop = null, finalRight = null, finalBottom = null, finalLeft = null;

                // 移动端使用更小的边距
                const edgePadding = isMobile() ? 10 : 20;

                // 吸附到最近的边，保持垂直或水平位置
                if (minDist === distToLeft) {
                    // 吸附到左边
                    finalLeft = edgePadding;
                    finalTop = Math.max(edgePadding, Math.min(rect.top, windowHeight - buttonHeight - edgePadding));
                } else if (minDist === distToRight) {
                    // 吸附到右边
                    finalRight = edgePadding;
                    finalTop = Math.max(edgePadding, Math.min(rect.top, windowHeight - buttonHeight - edgePadding));
                } else if (minDist === distToTop) {
                    // 吸附到顶部
                    finalTop = edgePadding;
                    finalLeft = Math.max(edgePadding, Math.min(rect.left, windowWidth - buttonWidth - edgePadding));
                } else {
                    // 吸附到底部
                    finalBottom = edgePadding;
                    finalLeft = Math.max(edgePadding, Math.min(rect.left, windowWidth - buttonWidth - edgePadding));
                }

                // 应用吸附位置
                themeToggle.style.transition = 'all 0.3s ease';
                if (finalTop !== null) {
                    themeToggle.style.top = finalTop + 'px';
                    themeToggle.style.bottom = 'auto';
                } else {
                    themeToggle.style.bottom = finalBottom + 'px';
                    themeToggle.style.top = 'auto';
                }

                if (finalLeft !== null) {
                    themeToggle.style.left = finalLeft + 'px';
                    themeToggle.style.right = 'auto';
                } else {
                    themeToggle.style.right = finalRight + 'px';
                    themeToggle.style.left = 'auto';
                }

                // 保存位置到 localStorage
                setTimeout(() => {
                    themeToggle.style.transition = '';
                    localStorage.setItem('themeTogglePosition', JSON.stringify({
                        top: finalTop,
                        right: finalRight,
                        bottom: finalBottom,
                        left: finalLeft
                    }));
                }, 300);
            }

            // 所有设备添加拖动事件
            themeToggle.addEventListener('mousedown', startDrag);
            themeToggle.addEventListener('touchstart', startDrag, { passive: true });

            // 所有设备都支持直接点击切换主题
            themeToggle.addEventListener('click', (e) => {
                // 如果发生了拖动，不触发点击
                if (hasMoved) {
                    hasMoved = false;
                    return;
                }
                toggleTheme();
            });
        })();

        // 分页和筛选相关变量
        let filteredCredsData = {};
        let currentPage = 1;
        let pageSize = 20;
        let currentFilter = 'all';
        let currentErrorCodeFilter = 'all';
        let selectedCredFiles = new Set(); // 选中的凭证文件名集合
        let availableErrorCodes = new Set(); // 所有可用的错误码
        let statsData = {
            total: 0,
            normal: 0,
            disabled: 0
        };

        function showStatus(message, type = 'info') {
            const mainHidden = document.getElementById('mainSection')?.classList.contains('hidden');
            let target = null;
            if (mainHidden) {
                target = document.getElementById('loginStatus');
            } else {
                const active = document.querySelector('.tab-content.active');
                const map = {
                    'playgroundTab': 'playgroundStatus',
                    'logsTab': 'logConnectionStas',
                    'usageTab': 'usageStatus',
                    'configTab': 'configStatus'
                };
                if (active && map[active.id]) {
                    target = document.getElementById(map[active.id]);
                }
            }
            if (target) {
                target.innerHTML = `<div class="status ${type}">${message}</div>`;
            } else {
                alert(message);
            }
        }

        // 登录相关函数
        async function login() {
            const password = document.getElementById('loginPassword').value;
            const loginBtn = document.getElementById('loginBtn');
            const passwordInput = document.getElementById('loginPassword');
            const formGroup = passwordInput.closest('.form-group');

            if (!password) {
                showStatus('请输入密码', 'error');
                passwordInput.classList.add('error');
                if (formGroup) formGroup.classList.add('error');
                passwordInput.style.animation = 'shake 0.5s ease-in-out';
                setTimeout(() => {
                    passwordInput.style.animation = '';
                    passwordInput.classList.remove('error');
                    if (formGroup) formGroup.classList.remove('error');
                }, 500);
                return;
            }

            // 添加按钮加载状态
            if (loginBtn) {
                loginBtn.classList.add('loading');
                loginBtn.disabled = true;
            }

            try {
                const res = await fetch('/config/get', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${password}`
                    }
                });
                if (res.ok) {
                    authToken = password;
                    // 保存登录状态到 localStorage
                    localStorage.setItem('amb2api_auth_token', password);
                    // 添加成功动画
                    if (loginBtn) {
                        loginBtn.style.background = 'linear-gradient(135deg, #34a853, #28a745)';
                        const span = loginBtn.querySelector('span');
                        if (span) span.textContent = '✓ 登录成功';
                    }

                    setTimeout(() => {
                        const loginEl = document.getElementById('loginSection');
                        const mainEl = document.getElementById('mainSection');
                        const container = document.querySelector('.container');
                        const rippleCanvas = document.getElementById('rippleCanvas');
                        const gradientOverlay = document.getElementById('gradientOverlay');

                        // 立即隐藏涟漪和渐变背景
                        if (rippleCanvas) rippleCanvas.style.display = 'none';
                        if (gradientOverlay) gradientOverlay.style.display = 'none';

                        // 先移除登录模式样式，恢复容器正常布局
                        container.classList.remove('login-mode');

                        // 隐藏登录框，显示主界面
                        loginEl.classList.add('hidden');
                        loginEl.style.opacity = '';

                        // 显示主界面
                        mainEl.classList.remove('hidden');

                        // 显示配置页面浮动按钮
                        const configFloatingActions = document.getElementById('configFloatingActions');
                        if (configFloatingActions) configFloatingActions.classList.add('visible');
                    }, 400);

                    showStatus('登录成功', 'success');
                    switchTab('config');
                    await loadConfig();
                    await refreshUsageStats();
                    // 触发后台预加载账户数据（非阻塞）
                    triggerAccountPreload();
                } else {
                    showStatus('密码错误', 'error');
                    // 添加错误动画
                    passwordInput.classList.add('error');
                    if (formGroup) formGroup.classList.add('error');
                    passwordInput.style.animation = 'shake 0.5s ease-in-out';
                    passwordInput.value = '';
                    passwordInput.focus();
                    setTimeout(() => {
                        passwordInput.style.animation = '';
                        passwordInput.classList.remove('error');
                        if (formGroup) formGroup.classList.remove('error');
                    }, 500);
                }
            } catch (error) {
                showStatus(`网络错误: ${error.message}`, 'error');
            } finally {
                // 恢复按钮状态
                if (loginBtn) {
                    loginBtn.classList.remove('loading');
                    loginBtn.disabled = false;
                    const span = loginBtn.querySelector('span');
                    if (span && span.textContent !== '✓ 登录成功') {
                        span.textContent = '登录';
                    }
                }
            }
        }

        function handlePasswordEnter(event) {
            if (event.key === 'Enter') {
                login();
            }
        }

        // 退出登录
        function logout() {
            // 清除 localStorage 中的 token
            localStorage.removeItem('amb2api_auth_token');
            authToken = '';

            // 切换到登录界面
            const loginEl = document.getElementById('loginSection');
            const mainEl = document.getElementById('mainSection');
            const container = document.querySelector('.container');
            const rippleCanvas = document.getElementById('rippleCanvas');
            const gradientOverlay = document.getElementById('gradientOverlay');
            const configFloatingActions = document.getElementById('configFloatingActions');

            // 隐藏主界面
            mainEl.classList.add('hidden');
            if (configFloatingActions) configFloatingActions.classList.remove('visible');

            // 显示登录界面
            container.classList.add('login-mode');
            loginEl.classList.remove('hidden');
            if (rippleCanvas) rippleCanvas.style.display = '';
            if (gradientOverlay) gradientOverlay.style.display = '';

            // 清空密码输入框
            const passwordInput = document.getElementById('loginPassword');
            if (passwordInput) {
                passwordInput.value = '';
                passwordInput.focus();
            }

            // 恢复登录按钮状态
            const loginBtn = document.getElementById('loginBtn');
            if (loginBtn) {
                loginBtn.style.background = '';
                const span = loginBtn.querySelector('span');
                if (span) span.textContent = '登录';
            }
        }

        // 检查自动登录
        async function checkAutoLogin() {
            const savedToken = localStorage.getItem('amb2api_auth_token');
            if (!savedToken) return false;

            try {
                // 验证 token 是否仍然有效
                const res = await fetch('/config/get', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${savedToken}`
                    }
                });

                if (res.ok) {
                    authToken = savedToken;
                    return true;
                } else {
                    // token 无效，清除
                    localStorage.removeItem('amb2api_auth_token');
                    return false;
                }
            } catch (error) {
                console.error('自动登录检查失败:', error);
                return false;
            }
        }

        // 标签页切换
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            const contentEl = document.getElementById(tabName + 'Tab');
            if (contentEl) contentEl.classList.add('active');
            const buttons = document.querySelectorAll('.tabs .tab');
            buttons.forEach(btn => {
                const onclick = btn.getAttribute('onclick') || '';
                if (onclick.includes("'" + tabName + "'")) btn.classList.add('active');
            });
            ['playgroundStatus', 'usageStatus', 'configStatus'].forEach(id => { const el = document.getElementById(id); if (el) el.innerHTML = ''; });

            // 控制配置页面浮动按钮显示/隐藏
            const configFloatingActions = document.getElementById('configFloatingActions');
            if (configFloatingActions) {
                if (tabName === 'config') {
                    configFloatingActions.classList.add('visible');
                } else {
                    configFloatingActions.classList.remove('visible');
                }
            }

            if (tabName === 'usage') {
                refreshUsageStats();
                refreshLogSummary();
                // 自动检查失效密钥
                checkInvalidKeys();
            }
            if (tabName === 'config') {
                loadConfig();
                loadSelectedModelsFromConfig();
            }
            if (tabName === 'logs') {
                connectWebSocket();
            }
            if (tabName === 'playground') {
                initPlayground();
            }
            if (tabName === 'ratelimit') {
                loadRateLimits();
            }
            if (tabName === 'account') {
                initAccountTab();
            }
        }

        // ==================== 密钥管理相关函数（弹窗版） ====================
        let keyManagementData = { keys: [], total: 0, active: 0, disabled: 0 };
        let keyCurrentPage = 1;
        let keyPageSize = 5;

        // 显示密钥管理弹窗
        function showKeyManagementModal() {
            const modal = document.getElementById('keyManagementModal');
            modal.style.display = 'block';
            // 初始化弹窗内的自定义下拉框
            initCustomSelects(modal);
            loadKeyManagementModal();
        }

        // 关闭密钥管理弹窗
        function closeKeyManagementModal() {
            document.getElementById('keyManagementModal').style.display = 'none';
        }

        // 加载密钥管理数据（弹窗版）
        async function loadKeyManagementModal() {
            const tbody = document.getElementById('keyManagementTableBody');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px;">加载中...</td></tr>';

            try {
                const statusFilter = document.getElementById('modalKeyStatusFilter')?.value || 'all';
                keyPageSize = parseInt(document.getElementById('keyPageSize')?.value || '5');

                // 获取密钥列表
                let url = '/api/keys?';
                const params = new URLSearchParams();
                if (statusFilter !== 'all') params.append('status_filter', statusFilter);
                params.append('sort_by', 'index');
                params.append('sort_order', 'asc');
                url += params.toString();

                const response = await fetch(url, { headers: getAuthHeaders() });
                const data = await response.json();
                keyManagementData = data;

                // 获取配置信息（聚合模式）
                try {
                    const configResponse = await fetch('/api/keys/config', { headers: getAuthHeaders() });
                    if (configResponse.ok) {
                        const configData = await configResponse.json();
                        const modeText = configData.aggregation_mode === 'random' ? '随机模式' : '轮询模式';
                        document.getElementById('modalAggregationMode').textContent = modeText;
                    }
                } catch (e) {
                    console.error('Failed to load key config:', e);
                }

                // 更新统计信息 - 修复失效判断逻辑
                const total = data.total || 0;
                const enabled = data.active || 0;

                // 计算失效密钥数量（从keys数组中统计）
                let invalidCount = 0;
                let manualDisabled = 0;
                if (data.keys && Array.isArray(data.keys)) {
                    data.keys.forEach(key => {
                        if (!key.enabled) {
                            // 检查是否是失效密钥（有错误信息或特定状态）
                            if (key.status === 'invalid' || key.error || key.exhausted) {
                                invalidCount++;
                            } else {
                                manualDisabled++;
                            }
                        }
                    });
                } else {
                    // 回退到原有逻辑
                    manualDisabled = data.disabled || 0;
                }

                const autoDisabled = invalidCount;

                document.getElementById('modalKeyTotal').textContent = total;
                document.getElementById('modalKeyTotal2').textContent = total;
                document.getElementById('modalKeyTotal3').textContent = total;
                document.getElementById('modalKeyTotal4').textContent = total;
                document.getElementById('modalKeyEnabled').textContent = enabled;
                document.getElementById('modalKeyManualDisabled').textContent = manualDisabled;
                document.getElementById('modalKeyAutoDisabled').textContent = autoDisabled;

                // 更新进度条
                const enabledPercent = total > 0 ? (enabled / total * 100) : 0;
                const manualPercent = total > 0 ? (manualDisabled / total * 100) : 0;
                const autoPercent = total > 0 ? (autoDisabled / total * 100) : 0;
                document.getElementById('enabledProgressBar').style.width = enabledPercent + '%';
                document.getElementById('manualDisabledProgressBar').style.width = manualPercent + '%';
                document.getElementById('autoDisabledProgressBar').style.width = autoPercent + '%';

                // 渲染表格
                renderKeyManagementTable(data.keys);
            } catch (error) {
                console.error('Failed to load key management:', error);
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #dc3545;">加载失败: ' + error.message + '</td></tr>';
            }
        }

        // 渲染密钥表格
        function renderKeyManagementTable(keys) {
            const tbody = document.getElementById('keyManagementTableBody');

            if (!keys || keys.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--text-secondary);">暂无密钥</td></tr>';
                updateKeyPagination(0);
                return;
            }

            // 分页
            const startIndex = (keyCurrentPage - 1) * keyPageSize;
            const endIndex = Math.min(startIndex + keyPageSize, keys.length);
            const pageKeys = keys.slice(startIndex, endIndex);

            let html = '';
            pageKeys.forEach(key => {
                // 判断密钥状态
                const isInvalid = key.status === 'invalid' || key.error || key.exhausted;
                const statusClass = key.enabled ? 'enabled' : (isInvalid ? 'invalid' : 'disabled');
                let statusText = key.enabled ? '已启用' : '已禁用';
                let statusColor = key.enabled ? '#28a745' : '#dc3545';

                // 如果是失效密钥，显示特殊状态
                if (isInvalid && !key.enabled) {
                    statusText = '失效';
                    statusColor = '#ffc107';
                }

                const actionText = key.enabled ? '禁用' : '启用';
                const actionColor = key.enabled ? '#dc3545' : '#28a745';

                // 显示完整密钥，不隐匿
                const fullKey = key.key || key.masked_key || '';

                // 禁用原因
                let disableReason = '-';
                if (!key.enabled) {
                    if (isInvalid) {
                        disableReason = key.error || '密钥失效';
                    } else {
                        disableReason = key.disable_reason || '手动禁用';
                    }
                }

                // 禁用时间
                let disableTime = '-';
                if (!key.enabled && key.disable_time) {
                    try {
                        const date = new Date(key.disable_time * 1000);
                        disableTime = date.toLocaleString('zh-CN');
                    } catch (e) {
                        disableTime = '-';
                    }
                }

                html += `<tr>
                    <td style="color: var(--text-secondary);">#${key.index}</td>
                    <td><code style="font-size: 11px; color: var(--text-color); word-break: break-all;">${fullKey}</code></td>
                    <td><span class="status-badge ${statusClass}" style="background: ${statusColor}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; white-space: nowrap; display: inline-block;">${statusText}</span></td>
                    <td style="color: var(--text-muted); font-size: 12px;">${disableReason}</td>
                    <td style="color: var(--text-muted); font-size: 12px;">${disableTime}</td>
                    <td style="text-align: right;">
                        <div style="display: flex; gap: 6px; justify-content: flex-end;">
                            <button onclick="toggleKeyStatusModal(${key.index}, ${!key.enabled})" style="background: transparent; color: ${actionColor}; border: 1px solid ${actionColor}; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">${actionText}</button>
                            <button onclick="deleteKeyModal(${key.index})" style="background: transparent; color: #dc3545; border: 1px solid #dc3545; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">删除</button>
                        </div>
                    </td>
                </tr>`;
            });

            tbody.innerHTML = html;
            updateKeyPagination(keys.length);
        }

        // 更新分页信息
        function updateKeyPagination(total) {
            const startIndex = total > 0 ? (keyCurrentPage - 1) * keyPageSize + 1 : 0;
            const endIndex = Math.min(keyCurrentPage * keyPageSize, total);

            document.getElementById('keyPageStart').textContent = startIndex;
            document.getElementById('keyPageEnd').textContent = endIndex;
            document.getElementById('keyPageTotal').textContent = total;
            document.getElementById('keyCurrentPage').textContent = keyCurrentPage;

            const totalPages = Math.ceil(total / keyPageSize) || 1;
            document.getElementById('keyPrevPage').disabled = keyCurrentPage <= 1;
            document.getElementById('keyNextPage').disabled = keyCurrentPage >= totalPages;
        }

        // 切换页面
        function changeKeyPage(delta) {
            const total = keyManagementData.keys?.length || 0;
            const totalPages = Math.ceil(total / keyPageSize) || 1;
            const newPage = keyCurrentPage + delta;

            if (newPage >= 1 && newPage <= totalPages) {
                keyCurrentPage = newPage;
                renderKeyManagementTable(keyManagementData.keys);
            }
        }

        // 跳转到指定页
        function jumpToKeyPage() {
            const input = document.getElementById('keyJumpPage');
            const page = parseInt(input.value);
            const total = keyManagementData.keys?.length || 0;
            const totalPages = Math.ceil(total / keyPageSize) || 1;

            if (page >= 1 && page <= totalPages) {
                keyCurrentPage = page;
                renderKeyManagementTable(keyManagementData.keys);
            }
            input.value = '';
        }

        // 切换密钥状态（弹窗版）
        async function toggleKeyStatusModal(index, enabled) {
            try {
                const response = await fetch(`/api/keys/${index}/status`, {
                    method: 'PUT',
                    headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled: enabled })
                });

                if (response.ok) {
                    loadKeyManagementModal();
                } else {
                    const error = await response.json();
                    alert('操作失败: ' + (error.detail || '未知错误'));
                }
            } catch (error) {
                alert('操作失败: ' + error.message);
            }
        }

        // 启用全部密钥
        async function enableAllKeys() {
            if (!confirm('确定要启用所有密钥吗？')) return;
            try {
                const indices = keyManagementData.keys.map(k => k.index);
                const response = await fetch('/api/keys/batch-status', {
                    method: 'POST',
                    headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ indices: indices, enabled: true })
                });
                if (response.ok) {
                    loadKeyManagementModal();
                } else {
                    const error = await response.json();
                    alert('操作失败: ' + (error.detail || '未知错误'));
                }
            } catch (error) {
                alert('操作失败: ' + error.message);
            }
        }

        // 禁用全部密钥
        async function disableAllKeys() {
            if (!confirm('确定要禁用所有密钥吗？')) return;
            try {
                const indices = keyManagementData.keys.map(k => k.index);
                const response = await fetch('/api/keys/batch-status', {
                    method: 'POST',
                    headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ indices: indices, enabled: false })
                });
                if (response.ok) {
                    loadKeyManagementModal();
                } else {
                    const error = await response.json();
                    alert('操作失败: ' + (error.detail || '未知错误'));
                }
            } catch (error) {
                alert('操作失败: ' + error.message);
            }
        }

        // 删除单个密钥
        async function deleteKeyModal(index) {
            const key = keyManagementData.keys.find(k => k.index === index);
            const keyDisplay = key ? (key.masked_key || key.key || `密钥 #${index}`) : `密钥 #${index}`;

            if (!confirm(`确定要删除密钥吗？\n\n${keyDisplay}\n\n删除后无法恢复，请谨慎操作！`)) {
                return;
            }

            try {
                const response = await fetch(`/api/keys/${index}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const data = await response.json();
                    showStatus(data.message || `密钥 #${index} 已删除`, 'success');
                    // 重新加载密钥列表
                    await loadKeyManagementModal();
                } else {
                    const error = await response.json();
                    showStatus(`删除失败: ${error.detail || '未知错误'}`, 'error');
                }
            } catch (error) {
                showStatus(`删除失败: ${error.message}`, 'error');
            }
        }

        // 删除自动禁用的密钥
        async function deleteAutoDisabledKeys() {
            // 获取所有自动禁用的密钥（失效的密钥）
            const autoDisabledKeys = keyManagementData.keys.filter(k =>
                !k.enabled && (k.status === 'invalid' || k.status === 'exhausted' || k.error || k.exhausted)
            );

            if (autoDisabledKeys.length === 0) {
                showStatus('没有自动禁用的密钥', 'info');
                return;
            }

            if (!confirm(`确定要删除 ${autoDisabledKeys.length} 个自动禁用的密钥吗？\n\n删除后无法恢复，请谨慎操作！`)) {
                return;
            }

            try {
                // 从后往前删除，避免索引变化
                const sortedKeys = [...autoDisabledKeys].sort((a, b) => b.index - a.index);
                let successCount = 0;
                let failCount = 0;

                for (const key of sortedKeys) {
                    try {
                        const response = await fetch(`/api/keys/${key.index}`, {
                            method: 'DELETE',
                            headers: getAuthHeaders()
                        });

                        if (response.ok) {
                            successCount++;
                        } else {
                            failCount++;
                        }
                    } catch (error) {
                        failCount++;
                    }
                }

                if (successCount > 0) {
                    showStatus(`成功删除 ${successCount} 个密钥${failCount > 0 ? `，失败 ${failCount} 个` : ''}`, 'success');
                    // 重新加载密钥列表
                    await loadKeyManagementModal();
                } else {
                    showStatus(`删除失败: 所有 ${autoDisabledKeys.length} 个密钥删除都失败了`, 'error');
                }
            } catch (error) {
                showStatus(`删除失败: ${error.message}`, 'error');
            }
        }

        // 清理过期密钥的统计数据
        async function cleanupKeyStats() {
            if (!confirm('确定要清理过期密钥的统计数据吗？\n\n这将删除已移除密钥的历史统计记录。')) return;
            try {
                const response = await fetch('/api/keys/cleanup-stats', {
                    method: 'POST',
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                if (response.ok) {
                    showStatus(data.message || '统计数据清理完成', 'success');
                    loadKeyManagementModal();
                } else {
                    showStatus('清理失败: ' + (data.detail || '未知错误'), 'error');
                }
            } catch (error) {
                console.error('Failed to cleanup key stats:', error);
                showStatus('清理失败: ' + error.message, 'error');
            }
        }

        // ==================== 速率限制相关函数 ====================
        let rateLimitRefreshInterval = null;

        async function loadRateLimits() {
            const loadingEl = document.getElementById('rateLimitLoading');
            const listEl = document.getElementById('rateLimitList');
            const statusEl = document.getElementById('rateLimitStatus');

            if (loadingEl) loadingEl.style.display = 'block';
            if (listEl) listEl.innerHTML = '';
            if (statusEl) statusEl.innerHTML = '';

            try {
                const response = await fetch('/rate-limits', {
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                displayRateLimits(data.rate_limits || []);

            } catch (error) {
                console.error('加载速率限制失败:', error);
                if (statusEl) {
                    statusEl.innerHTML = `<div class="error">加载失败: ${error.message}</div>`;
                }
            } finally {
                if (loadingEl) loadingEl.style.display = 'none';
            }
        }

        function displayRateLimits(rateLimits) {
            const listEl = document.getElementById('rateLimitList');
            if (!listEl) return;

            if (rateLimits.length === 0) {
                listEl.innerHTML = '<div class="usage-info">暂无速率限制数据</div>';
                return;
            }

            let html = '';

            rateLimits.forEach(key => {
                const usagePercent = key.limit > 0 ? (key.used / key.limit * 100) : 0;
                const statusClass = key.status === 'active' ? 'status-active' :
                    key.status === 'exhausted' ? 'status-exhausted' : 'status-unused';
                const statusText = key.status === 'active' ? '🟢 可用' :
                    key.status === 'exhausted' ? '🔴 已耗尽' : '⚪ 未使用';

                let progressClass = 'progress-green';
                if (usagePercent > 80) {
                    progressClass = 'progress-red';
                } else if (usagePercent > 50) {
                    progressClass = 'progress-yellow';
                }

                const resetText = key.reset_in_seconds > 0 ?
                    `${key.reset_in_seconds}秒后重置` :
                    (key.limit > 0 ? '已重置' : '未使用');

                const lastRequestTime = key.last_request_time > 0 ?
                    new Date(key.last_request_time * 1000).toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    }) :
                    '从未使用';

                html += `
                    <div class="rate-limit-card">
                        <div class="rate-limit-header">
                            <div class="rate-limit-key">Key #${key.index}: ${key.key}</div>
                            <div class="rate-limit-status ${statusClass}">${statusText}</div>
                        </div>
                        
                        ${key.limit > 0 ? `
                            <div class="rate-limit-info">
                                <div class="rate-limit-info-item">
                                    <div class="rate-limit-info-label">限额</div>
                                    <div class="rate-limit-info-value">${key.limit} 次/分钟</div>
                                </div>
                                <div class="rate-limit-info-item">
                                    <div class="rate-limit-info-label">已使用</div>
                                    <div class="rate-limit-info-value">${key.used} 次</div>
                                </div>
                                <div class="rate-limit-info-item">
                                    <div class="rate-limit-info-label">剩余</div>
                                    <div class="rate-limit-info-value">${key.remaining} 次</div>
                                </div>
                                <div class="rate-limit-info-item">
                                    <div class="rate-limit-info-label">最后请求</div>
                                    <div class="rate-limit-info-value" style="font-size: 13px;">${lastRequestTime}</div>
                                </div>
                            </div>
                            
                            <div class="rate-limit-progress">
                                <div class="rate-limit-progress-bar ${progressClass}" 
                                     style="width: ${usagePercent}%">
                                    ${usagePercent >= 10 ? usagePercent.toFixed(1) + '%' : ''}
                                </div>
                                ${usagePercent < 10 ? `<div class="rate-limit-progress-text">${usagePercent.toFixed(1)}%</div>` : ''}
                            </div>
                            
                            <div class="rate-limit-reset">⏱️ ${resetText}</div>
                        ` : `
                            <div class="usage-info" style="text-align: center; padding: 20px; color: #999;">
                                该 Key 尚未使用
                            </div>
                        `}
                    </div>
                `;
            });

            listEl.innerHTML = html;
        }

        function toggleAutoRefresh() {
            const checkbox = document.getElementById('autoRefreshRateLimit');

            if (checkbox && checkbox.checked) {
                // 启动自动刷新
                if (!rateLimitRefreshInterval) {
                    rateLimitRefreshInterval = setInterval(() => {
                        // 只在速率限制标签页激活时刷新
                        const tab = document.getElementById('ratelimitTab');
                        if (tab && tab.classList.contains('active')) {
                            loadRateLimits();
                        }
                    }, 5000); // 每5秒刷新
                }
            } else {
                // 停止自动刷新
                if (rateLimitRefreshInterval) {
                    clearInterval(rateLimitRefreshInterval);
                    rateLimitRefreshInterval = null;
                }
            }
        }

        // 页面卸载时清理定时器
        window.addEventListener('beforeunload', () => {
            if (rateLimitRefreshInterval) {
                clearInterval(rateLimitRefreshInterval);
            }
        });

        // 获取认证头
        function getAuthHeaders() {
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            };
        }

        // 触发后台预加载账户数据（非阻塞，静默执行）
        async function triggerAccountPreload() {
            try {
                console.log('[Preload] Triggering account preload after panel login');
                const res = await fetch('/api/account/preload/trigger', {
                    method: 'POST',
                    headers: getAuthHeaders()
                });
                if (res.ok) {
                    const data = await res.json();
                    console.log('[Preload] Preload triggered:', data);
                } else {
                    console.log('[Preload] Preload trigger failed:', res.status);
                }
            } catch (e) {
                console.log('[Preload] Preload trigger error:', e.message);
            }
        }


        // 文件上传相关函数
        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            addFiles(files);
        }

        function addFiles(files) {
            files.forEach(file => {
                if (file.type === 'application/json' || file.name.endsWith('.json') ||
                    file.type === 'application/zip' || file.name.endsWith('.zip')) {
                    if (!uploadSelectedFiles.find(f => f.name === file.name && f.size === file.size)) {
                        uploadSelectedFiles.push(file);
                    }
                } else {
                    showStatus(`文件 ${file.name} 格式不支持，只支持JSON和ZIP文件`, 'error');
                }
            });

            updateFileList();
        }

        function updateFileList() {
            const fileList = document.getElementById('fileList');
            const fileListSection = document.getElementById('fileListSection');

            if (uploadSelectedFiles.length === 0) {
                fileListSection.classList.add('hidden');
                return;
            }

            fileListSection.classList.remove('hidden');
            fileList.innerHTML = '';

            uploadSelectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                const isZip = file.name.endsWith('.zip');
                const fileIcon = isZip ? '📦' : '📄';
                const fileType = isZip ? ' (ZIP压缩包)' : ' (JSON文件)';
                fileItem.innerHTML = `
                    <div>
                        <span class="file-name">${fileIcon} ${file.name}</span>
                        <span class="file-size">(${formatFileSize(file.size)}${fileType})</span>
                    </div>
                    <button class="remove-btn" onclick="removeFile(${index})">删除</button>
                `;
                fileList.appendChild(fileItem);
            });
        }

        function removeFile(index) {
            uploadSelectedFiles.splice(index, 1);
            updateFileList();
        }

        function clearFiles() {
            uploadSelectedFiles = [];
            updateFileList();
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return Math.round(bytes / 1024) + ' KB';
            return Math.round(bytes / (1024 * 1024)) + ' MB';
        }

        async function uploadFiles() {
            if (uploadSelectedFiles.length === 0) {
                showStatus('请选择要上传的文件', 'error');
                return;
            }

            // 检查文件大小
            const totalSize = uploadSelectedFiles.reduce((sum, file) => sum + file.size, 0);
            const maxSize = 200 * 1024 * 1024; // 200MB limit
            if (totalSize > maxSize) {
                showStatus(`文件总大小 ${(totalSize / 1024 / 1024).toFixed(1)}MB 超过限制 ${maxSize / 1024 / 1024}MB。请分批上传或删除部分文件。`, 'error');
                return;
            }

            // 检查单个文件大小
            for (const file of uploadSelectedFiles) {
                if (file.size > 5 * 1024 * 1024) {
                    showStatus(`文件 "${file.name}" 大小 ${(file.size / 1024 / 1024).toFixed(1)}MB 超过单文件5MB限制`, 'error');
                    return;
                }
            }

            const progressSection = document.getElementById('uploadProgressSection');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');

            progressSection.classList.remove('hidden');

            const formData = new FormData();
            uploadSelectedFiles.forEach(file => {
                formData.append('files', file);
            });

            // 检查是否有ZIP文件，给用户提示
            const hasZipFiles = uploadSelectedFiles.some(file => file.name.endsWith('.zip'));
            if (hasZipFiles) {
                showStatus('正在上传并解压ZIP文件...', 'info');
            }

            try {
                const xhr = new XMLHttpRequest();

                // 设置超时时间 (5分钟)
                xhr.timeout = 300000;

                xhr.upload.onprogress = function (event) {
                    if (event.lengthComputable) {
                        const percentComplete = (event.loaded / event.total) * 100;
                        progressFill.style.width = percentComplete + '%';
                        progressText.textContent = Math.round(percentComplete) + '%';
                    }
                };

                xhr.onload = function () {
                    if (xhr.status === 200) {
                        try {
                            const data = JSON.parse(xhr.responseText);
                            showStatus(`成功上传 ${data.uploaded_count} 个文件`, 'success');
                            clearFiles();
                            progressSection.classList.add('hidden');
                        } catch (e) {
                            showStatus('上传失败: 服务器响应格式错误', 'error');
                        }
                    } else {
                        try {
                            const error = JSON.parse(xhr.responseText);
                            showStatus(`上传失败: ${error.detail || error.error || '未知错误'}`, 'error');
                        } catch (e) {
                            showStatus(`上传失败: HTTP ${xhr.status} - ${xhr.statusText || '未知错误'}`, 'error');
                        }
                    }
                };

                xhr.onerror = function () {
                    console.error('Upload XHR error:', {
                        readyState: xhr.readyState,
                        status: xhr.status,
                        statusText: xhr.statusText,
                        responseText: xhr.responseText,
                        fileCount: uploadSelectedFiles.length,
                        totalSize: (totalSize / 1024 / 1024).toFixed(1) + 'MB'
                    });
                    showStatus(`上传失败：连接中断 - 可能原因：文件过多(${uploadSelectedFiles.length}个)或网络不稳定。建议分批上传。`, 'error');
                    progressSection.classList.add('hidden');
                };

                xhr.ontimeout = function () {
                    showStatus('上传失败：请求超时 - 文件处理时间过长，请减少文件数量或检查网络连接', 'error');
                    progressSection.classList.add('hidden');
                };

                xhr.open('POST', '/auth/upload');
                xhr.setRequestHeader('Authorization', `Bearer ${authToken}`);
                xhr.send(formData);

            } catch (error) {
                showStatus(`上传失败: ${error.message}`, 'error');
            }
        }

        // 拖拽功能
        const uploadArea = document.getElementById('uploadArea');

        uploadArea.addEventListener('dragover', function (event) {
            event.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', function (event) {
            event.preventDefault();
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', function (event) {
            event.preventDefault();
            uploadArea.classList.remove('dragover');

            const files = Array.from(event.dataTransfer.files);
            addFiles(files);
        });

        // WebSocket日志相关变量和函数
        let logWebSocket = null;
        let allLogs = [];
        let filteredLogs = [];
        let currentLogFilter = 'all';

        function connectWebSocket() {
            if (logWebSocket && logWebSocket.readyState === WebSocket.OPEN) {
                return;
            }

            try {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/auth/logs/stream?token=${encodeURIComponent(authToken)}`;

                document.getElementById('connectionStatusText').textContent = '连接中...';
                document.getElementById('logConnectionStatus').className = 'status info';

                logWebSocket = new WebSocket(wsUrl);

                logWebSocket.onopen = function (event) {
                    document.getElementById('connectionStatusText').textContent = '已连接';
                    document.getElementById('logConnectionStatus').className = 'status success';
                    clearLogsDisplay(); // 只清空前端显示的旧日志，不清空服务器文件
                };

                logWebSocket.onmessage = function (event) {
                    const logLine = event.data;
                    if (logLine.trim()) {
                        allLogs.push(logLine);

                        // 限制日志数量，保留最后1000条
                        if (allLogs.length > 1000) {
                            allLogs = allLogs.slice(-1000);
                        }

                        filterLogs();

                        // 自动滚动到底部
                        if (document.getElementById('autoScroll').checked) {
                            const logContainer = document.getElementById('logContainer');
                            logContainer.scrollTop = logContainer.scrollHeight;
                        }
                    }
                };

                logWebSocket.onclose = function (event) {
                    document.getElementById('connectionStatusText').textContent = '连接断开';
                    document.getElementById('logConnectionStatus').className = 'status error';
                };

                logWebSocket.onerror = function (error) {
                    document.getElementById('connectionStatusText').textContent = '连接错误';
                    document.getElementById('logConnectionStatus').className = 'status error';
                    showStatus('日志流连接错误: ' + error, 'error');
                };

            } catch (error) {
                showStatus('创建WebSocket连接失败: ' + error.message, 'error');
                document.getElementById('connectionStatusText').textContent = '连接失败';
                document.getElementById('logConnectionStatus').className = 'status error';
            }
        }

        function disconnectWebSocket() {
            if (logWebSocket) {
                logWebSocket.close();
                logWebSocket = null;
                document.getElementById('connectionStatusText').textContent = '未连接';
                document.getElementById('logConnectionStatus').className = 'status info';
            }
        }

        function clearLogsDisplay() {
            // 只清空前端显示的日志，不清空服务器文件
            allLogs = [];
            filteredLogs = [];
            document.getElementById('logContent').textContent = '日志已清空，等待新日志...';
        }

        async function downloadLogs() {
            try {
                // 调用后端API下载日志文件
                const response = await fetch('/auth/logs/download', {
                    method: 'GET',
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    // 获取文件名
                    const contentDisposition = response.headers.get('Content-Disposition');
                    let filename = 'gcli2api_logs.txt';
                    if (contentDisposition) {
                        const filenameMatch = contentDisposition.match(/filename=(.+)/);
                        if (filenameMatch) {
                            filename = filenameMatch[1];
                        }
                    }

                    // 下载文件
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);

                    showStatus(`日志文件下载成功: ${filename}`, 'success');
                } else {
                    const errorText = await response.text();
                    let errorMsg = '下载失败';
                    try {
                        const errorData = JSON.parse(errorText);
                        errorMsg = errorData.detail || errorData.error || '未知错误';
                    } catch (e) {
                        errorMsg = errorText || '未知错误';
                    }
                    showStatus(`下载日志失败: ${errorMsg}`, 'error');
                }
            } catch (error) {
                console.error('downloadLogs error:', error);
                showStatus(`下载日志时网络错误: ${error.message}`, 'error');
            }
        }

        async function clearLogs() {
            try {
                // 调用后端API清空日志文件
                const response = await fetch('/auth/logs/clear', {
                    method: 'POST',
                    headers: getAuthHeaders()
                });

                const data = await response.json();

                if (response.ok) {
                    // 清空前端显示的日志
                    clearLogsDisplay();
                    showStatus(data.message, 'success');
                } else {
                    showStatus(`清空日志失败: ${data.detail || data.error || '未知错误'}`, 'error');
                }
            } catch (error) {
                console.error('clearLogs error:', error);
                // 即使后端清空失败，也清空前端显示
                clearLogsDisplay();
                showStatus(`清空日志时网络错误: ${error.message}`, 'error');
            }
        }

        function filterLogs() {
            const filter = document.getElementById('logLevelFilter').value;
            currentLogFilter = filter;

            if (filter === 'all') {
                filteredLogs = [...allLogs];
            } else {
                filteredLogs = allLogs.filter(log => log.toUpperCase().includes(filter));
            }

            displayLogs();
        }

        function displayLogs() {
            const logContent = document.getElementById('logContent');
            if (filteredLogs.length === 0) {
                logContent.textContent = currentLogFilter === 'all' ?
                    '暂无日志...' : `暂无${currentLogFilter}级别的日志...`;
            } else {
                logContent.textContent = filteredLogs.join('\n');
            }
        }

        // 凭证文件管理相关函数
        async function refreshCredsStatus(silent = false) {
            const credsLoading = document.getElementById('credsLoading');
            const credsList = document.getElementById('credsList');

            try {
                if (!silent) {
                    credsLoading.style.display = 'block';
                    credsList.innerHTML = '';
                }

                console.log('Fetching creds status...');

                const response = await fetch('/creds/status', {
                    method: 'GET',
                    headers: getAuthHeaders()
                });

                console.log('Creds status response:', response.status);

                const data = await response.json();
                console.log('Creds status data:', data);

                if (response.ok) {
                    credsData = data.creds;

                    // 计算统计数据
                    calculateStats();

                    // 更新统计显示
                    updateStatsDisplay();

                    // 应用筛选并显示第一页
                    currentPage = 1;
                    applyFilters();

                    if (!silent) {
                        showStatus(`已加载 ${Object.keys(credsData).length} 个凭证文件`, 'success');
                    }
                } else {
                    if (!silent) {
                        showStatus(`加载失败: ${data.detail || data.error || '未知错误'}`, 'error');
                    }
                }
            } catch (error) {
                console.error('refreshCredsStatus error:', error);
                if (!silent) {
                    showStatus(`网络错误: ${error.message}`, 'error');
                }
            } finally {
                if (!silent) {
                    credsLoading.style.display = 'none';
                }
            }
        }

        // 计算统计数据
        function calculateStats() {
            statsData = {
                total: 0,
                normal: 0,
                disabled: 0
            };

            // 清空并重新收集错误码
            availableErrorCodes.clear();

            for (const [fullPath, credInfo] of Object.entries(credsData)) {
                statsData.total++;

                if (credInfo.status.disabled) {
                    statsData.disabled++;
                } else {
                    statsData.normal++;
                }

                // 收集错误码信息
                if (credInfo.status.error_codes && credInfo.status.error_codes.length > 0) {
                    credInfo.status.error_codes.forEach(code => {
                        availableErrorCodes.add(code);
                    });
                }
            }

            // 更新错误码快速筛选按钮
            updateErrorCodeBadges();
        }

        // 更新错误码筛选快速按钮
        function updateErrorCodeBadges() {
            const errorCodeBadges = document.getElementById('errorCodeBadges');
            errorCodeBadges.innerHTML = '';

            if (availableErrorCodes.size === 0) {
                errorCodeBadges.innerHTML = '<span style="color: #28a745;">所有文件都无错误</span>';
                return;
            }

            const sortedCodes = Array.from(availableErrorCodes).sort((a, b) => a - b);
            sortedCodes.forEach(code => {
                const badge = document.createElement('span');
                badge.className = 'error-code-badge';
                badge.textContent = code;
                badge.onclick = () => filterByErrorCode(code);
                errorCodeBadges.appendChild(badge);
            });
        }

        // 按错误码快速筛选
        function filterByErrorCode(code) {
            document.getElementById('errorCodeFilter').value = code.toString();
            applyFilters();
        }

        // 更新统计显示
        function updateStatsDisplay() {
            document.getElementById('statTotal').textContent = statsData.total;
            document.getElementById('statNormal').textContent = statsData.normal;
            document.getElementById('statDisabled').textContent = statsData.disabled;
        }

        // 应用筛选
        function applyFilters() {
            const statusFilter = document.getElementById('statusFilter').value;
            const errorCodeFilter = document.getElementById('errorCodeFilter').value;
            currentFilter = statusFilter;
            currentErrorCodeFilter = errorCodeFilter;
            filteredCredsData = {};

            for (const [fullPath, credInfo] of Object.entries(credsData)) {
                let shouldInclude = false;

                // 状态筛选
                switch (statusFilter) {
                    case 'all':
                        shouldInclude = true;
                        break;
                    case 'normal':
                        shouldInclude = !credInfo.status.disabled;
                        break;
                    case 'disabled':
                        shouldInclude = credInfo.status.disabled;
                        break;
                }

                // 如果状态筛选已经排除，跳过错误码筛选
                if (!shouldInclude) {
                    continue;
                }

                // 错误码筛选
                const errorCodes = credInfo.status.error_codes || [];
                switch (errorCodeFilter) {
                    case 'all':
                        // 保持当前状态
                        break;
                    case 'no-errors':
                        shouldInclude = errorCodes.length === 0;
                        break;
                    case 'has-errors':
                        shouldInclude = errorCodes.length > 0;
                        break;
                    default:
                        // 具体错误码筛选
                        const targetCode = parseInt(errorCodeFilter);
                        if (!isNaN(targetCode)) {
                            shouldInclude = errorCodes.includes(targetCode);
                        }
                        break;
                }

                if (shouldInclude) {
                    filteredCredsData[fullPath] = credInfo;
                }
            }

            // 清空选择状态
            selectedCredFiles.clear();
            updateBatchControls();

            currentPage = 1;
            renderCredsList();
            updatePagination();
        }

        // 获取当前页数据
        function getCurrentPageData() {
            const filteredEntries = Object.entries(filteredCredsData);
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            return filteredEntries.slice(startIndex, endIndex);
        }

        // 获取总页数
        function getTotalPages() {
            return Math.ceil(Object.keys(filteredCredsData).length / pageSize);
        }

        // 渲染凭证列表
        function renderCredsList() {
            const credsList = document.getElementById('credsList');
            credsList.innerHTML = '';

            const currentPageData = getCurrentPageData();

            if (currentPageData.length === 0) {
                const message = Object.keys(credsData).length === 0 ?
                    '暂无凭证文件' : '当前筛选条件下暂无数据';
                credsList.innerHTML = `<p style="text-align: center; color: #666;">${message}</p>`;
                document.getElementById('paginationContainer').style.display = 'none';
                return;
            }

            for (const [fullPath, credInfo] of currentPageData) {
                const card = createCredCard(fullPath, credInfo);
                credsList.appendChild(card);
            }

            document.getElementById('paginationContainer').style.display = getTotalPages() > 1 ? 'flex' : 'none';

            // 更新批量控件状态
            updateBatchControls();
        }

        // 更新分页信息
        function updatePagination() {
            const totalPages = getTotalPages();
            const totalItems = Object.keys(filteredCredsData).length;
            const startItem = (currentPage - 1) * pageSize + 1;
            const endItem = Math.min(currentPage * pageSize, totalItems);

            document.getElementById('paginationInfo').textContent =
                `第 ${currentPage} 页，共 ${totalPages} 页 (显示 ${startItem}-${endItem}，共 ${totalItems} 项)`;

            document.getElementById('prevPageBtn').disabled = currentPage <= 1;
            document.getElementById('nextPageBtn').disabled = currentPage >= totalPages;
        }

        // 切换页面
        function changePage(direction) {
            const totalPages = getTotalPages();
            const newPage = currentPage + direction;

            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderCredsList();
                updatePagination();
            }
        }

        // 改变每页显示数量
        function changePageSize() {
            pageSize = parseInt(document.getElementById('pageSizeSelect').value);
            currentPage = 1;
            renderCredsList();
            updatePagination();
        }

        function createCredCard(fullPath, credInfo) {
            const div = document.createElement('div');
            const status = credInfo.status;
            const filename = credInfo.filename;

            // 调试：记录状态
            if (filename.includes('atomic-affinity')) {
                console.log(`Creating card for ${filename}:`, status);
            }

            // 设置卡片状态样式
            let cardClass = 'cred-card';
            if (status.disabled) cardClass += ' disabled';

            div.className = cardClass;

            // 创建状态标签
            let statusBadges = '';
            if (status.disabled) {
                statusBadges += '<span class="status-badge disabled">已禁用</span>';
            } else {
                statusBadges += '<span class="status-badge enabled">已启用</span>';
            }


            // 调试：记录 error_codes
            console.log(`Error codes for ${filename}:`, status.error_codes);

            if (status.error_codes && status.error_codes.length > 0) {
                statusBadges += `<span class="error-codes">错误码: ${status.error_codes.join(', ')}</span>`;
                // 检查是否包含自动封禁的错误码
                const autoBanErrors = status.error_codes.filter(code => code === 400 || code === 403);
                if (autoBanErrors.length > 0 && status.disabled) {
                    statusBadges += `<span class="status-badge" style="background-color: #e74c3c; color: white;">AUTO_BAN</span>`;
                }
            } else {
                // 显示无错误码状态
                statusBadges += `<span class="status-badge" style="background-color: #28a745; color: white;">无错误</span>`;
            }

            // 为HTML ID生成安全的标识符
            const pathId = btoa(encodeURIComponent(fullPath)).replace(/[+/=]/g, '_');

            // 创建操作按钮 - 使用文件名而不是完整路径
            let actionButtons = '';
            if (status.disabled) {
                actionButtons += `<button class="cred-btn enable" data-filename="${filename}" data-action="enable">启用</button>`;
            } else {
                actionButtons += `<button class="cred-btn disable" data-filename="${filename}" data-action="disable">禁用</button>`;
            }

            actionButtons += `
                <button class="cred-btn view" onclick="toggleCredDetails('${pathId}')">查看内容</button>
                <button class="cred-btn download" onclick="downloadCred('${filename}')">下载</button>
                <button class="cred-btn email" onclick="fetchUserEmail('${filename}')">查看账号邮箱</button>
                <button class="cred-btn delete" data-filename="${filename}" data-action="delete">删除</button>
            `;

            // 构建邮箱显示
            let emailInfo = '';
            if (credInfo.user_email) {
                emailInfo = `<div class="cred-email" style="font-size: 12px; color: #666; margin-top: 2px;">${credInfo.user_email}</div>`;
            } else {
                emailInfo = `<div class="cred-email" style="font-size: 12px; color: #999; margin-top: 2px; font-style: italic;">未获取邮箱</div>`;
            }

            div.innerHTML = `
                <div class="cred-header">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" class="file-checkbox" data-filename="${filename}" onchange="toggleFileSelection('${filename}')">
                        <div>
                            <div class="cred-filename">${filename}</div>
                            ${emailInfo}
                        </div>
                    </div>
                    <div class="cred-status">${statusBadges}</div>
                </div>
                <div class="cred-actions">${actionButtons}</div>
                <div class="cred-details" id="details-${pathId}">
                    <div class="cred-content"></div>
                </div>
            `;

            // 设置文件内容（避免HTML注入）
            const contentDiv = div.querySelector('.cred-content');
            if (credInfo.content) {
                contentDiv.textContent = JSON.stringify(credInfo.content, null, 2);
            } else {
                contentDiv.textContent = credInfo.error || '无法读取文件内容';
            }

            // 添加事件监听器到按钮
            const actionButtonElements = div.querySelectorAll('[data-filename][data-action]');
            actionButtonElements.forEach(button => {
                button.addEventListener('click', function () {
                    const filename = this.getAttribute('data-filename');
                    const action = this.getAttribute('data-action');

                    if (action === 'delete') {
                        deleteCred(filename);
                    } else {
                        credAction(filename, action);
                    }
                });
            });

            return div;
        }

        async function credAction(filename, action) {
            try {
                console.log('Performing action:', action, 'on file:', filename);
                console.log('Filename type:', typeof filename);
                console.log('Filename length:', filename.length);
                console.log('Ends with .json:', filename.endsWith('.json'));

                const requestBody = {
                    filename: filename,
                    action: action
                };

                console.log('Request body:', requestBody);

                const response = await fetch('/creds/action', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(requestBody)
                });

                console.log('Response status:', response.status);

                const data = await response.json();
                console.log('Response data:', data);

                if (response.ok) {
                    showStatus(data.message, 'success');
                    await refreshCredsStatus(); // 刷新状态
                } else {
                    showStatus(`操作失败: ${data.detail || data.error || '未知错误'}`, 'error');
                }
            } catch (error) {
                console.error('credAction error:', error);
                showStatus(`网络错误: ${error.message}`, 'error');
            }
        }

        function toggleCredDetails(pathId) {
            const detailsId = 'details-' + pathId;
            const details = document.getElementById(detailsId);
            if (details) {
                details.classList.toggle('show');
            }
        }

        async function downloadCred(filename) {
            try {
                const response = await fetch(`/creds/download/${filename}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showStatus(`已下载文件: ${filename}`, 'success');
                } else {
                    const data = await response.json();
                    showStatus(`下载失败: ${data.error}`, 'error');
                }
            } catch (error) {
                showStatus(`下载失败: ${error.message}`, 'error');
            }
        }

        async function downloadAllCreds() {
            try {
                const response = await fetch('/creds/download-all', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = 'credentials.zip';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    showStatus('已下载所有凭证文件', 'success');
                } else {
                    const data = await response.json();
                    showStatus(`打包下载失败: ${data.error}`, 'error');
                }
            } catch (error) {
                showStatus(`打包下载失败: ${error.message}`, 'error');
            }
        }

        async function deleteCred(filename) {
            if (!confirm(`确定要删除凭证文件吗？\n${filename}`)) {
                return;
            }

            await credAction(filename, 'delete');
        }

        // 配置管理相关函数
        let currentConfig = {};
        let envLockedFields = new Set();

        async function loadConfig(silent = false) {
            const configLoading = document.getElementById('configLoading');
            const configForm = document.getElementById('configForm');
            try {
                if (!silent) {
                    configLoading.style.display = 'block';
                    configForm.classList.add('hidden');
                }
                const response = await fetch('/config/get', { method: 'GET', headers: getAuthHeaders() });
                const data = await response.json();
                if (response.ok) {
                    currentConfig = data.config || {};
                    envLockedFields = new Set(data.env_locked || []);
                    populateConfigForm();

                    // 加载聚合模式
                    try {
                        const keyConfigResponse = await fetch('/api/keys/config', { headers: getAuthHeaders() });
                        if (keyConfigResponse.ok) {
                            const keyConfigData = await keyConfigResponse.json();
                            const aggregationModeEl = document.getElementById('keyAggregationMode');
                            if (aggregationModeEl && keyConfigData.aggregation_mode) {
                                aggregationModeEl.value = keyConfigData.aggregation_mode;
                            }
                        }
                    } catch (e) {
                        console.error('Failed to load key aggregation mode:', e);
                    }

                    if (!silent) {
                        configForm.classList.remove('hidden');
                    }
                    refreshAllConfig(false, silent);  // 静默刷新，不显示按钮加载状态，传递 silent 参数
                    if (!silent) {
                        showStatus('配置加载成功', 'success');
                    }
                } else {
                    if (!silent) {
                        showStatus(`加载配置失败: ${data.detail || data.error || '未知错误'}`, 'error');
                    }
                }
            } catch (error) {
                if (!silent) {
                    showStatus(`网络错误: ${error.message}`, 'error');
                }
            } finally {
                if (!silent) {
                    configLoading.style.display = 'none';
                }
            }
        }

        function populateConfigForm() {
            const hostEl = document.getElementById('host');
            const portEl = document.getElementById('port');
            const apiPwdEl = document.getElementById('configApiPassword');
            const panelPwdEl = document.getElementById('configPanelPassword');
            const aaiKeysEl = document.getElementById('assemblyApiKeys');
            const useAssemblyEl = document.getElementById('useAssembly');
            const overrideEl = document.getElementById('overrideEnv');
            if (hostEl) hostEl.value = currentConfig.host || '0.0.0.0';
            if (portEl) portEl.value = currentConfig.port || 7861;
            if (apiPwdEl) apiPwdEl.value = currentConfig.api_password || '';
            if (panelPwdEl) panelPwdEl.value = currentConfig.panel_password || '';
            if (aaiKeysEl) {
                // 密钥配置页面只用于新增，不显示现有密钥，查看密钥请使用"查看密钥"按钮
                aaiKeysEl.value = '';
            }
            // useAssembly 现在是隐藏字段，始终为 true
            if (useAssemblyEl) useAssemblyEl.value = 'true';
            if (overrideEl) overrideEl.checked = !!currentConfig.override_env;
            const callsRotEl = document.getElementById('callsPerRotation');
            const r429EnEl = document.getElementById('retry429Enabled');
            const r429MaxEl = document.getElementById('retry429MaxRetries');
            const r429IntEl = document.getElementById('retry429Interval');
            const banEnEl = document.getElementById('autoBanEnabled');
            const banCodesEl = document.getElementById('autoBanErrorCodes');
            if (callsRotEl) callsRotEl.value = currentConfig.calls_per_rotation ?? 100;
            if (r429EnEl) r429EnEl.checked = !!currentConfig.retry_429_enabled;
            if (r429MaxEl) r429MaxEl.value = currentConfig.retry_429_max_retries ?? 5;
            if (r429IntEl) r429IntEl.value = currentConfig.retry_429_interval ?? 1.0;
            if (banEnEl) banEnEl.checked = !!currentConfig.auto_ban_enabled;
            if (banCodesEl) banCodesEl.value = Array.isArray(currentConfig.auto_ban_error_codes) ? currentConfig.auto_ban_error_codes.join(',') : (currentConfig.auto_ban_error_codes || '');
            // 秘钥配置不做锁定
            lockField('useAssembly', 'USE_ASSEMBLY');
            lockField('configApiPassword', 'API_PASSWORD');
            lockField('configPanelPassword', 'PANEL_PASSWORD');
            lockField('port', 'PORT');
            lockField('host', 'HOST');
            const overrideEl2 = document.getElementById('overrideEnv');
            if (overrideEl2) {
                overrideEl2.addEventListener('change', applyLocks);
            }
        }

        function applyLocks() {
            // 秘钥配置不做锁定
            lockField('useAssembly', 'USE_ASSEMBLY');
            lockField('configApiPassword', 'API_PASSWORD');
            lockField('configPanelPassword', 'PANEL_PASSWORD');
            lockField('port', 'PORT');
            lockField('host', 'HOST');
            lockField('callsPerRotation', 'CALLS_PER_ROTATION');
            lockField('retry429Enabled', 'RETRY_429_ENABLED');
            lockField('retry429MaxRetries', 'RETRY_429_MAX_RETRIES');
            lockField('retry429Interval', 'RETRY_429_INTERVAL');
            lockField('autoBanEnabled', 'AUTO_BAN');
            lockField('autoBanErrorCodes', 'AUTO_BAN_ERROR_CODES');
        }

        function lockField(id, envName) {
            const el = document.getElementById(id);
            if (!el) return;
            const group = el.closest('.form-group') || el.parentElement;
            const overrideEl = document.getElementById('overrideEnv');
            const overrideOn = overrideEl && overrideEl.checked;
            if (envLockedFields.has(envName) && !overrideOn) {
                el.disabled = true;
                if (group) group.classList.add('env-locked');
            } else {
                el.disabled = false;
                if (group) group.classList.remove('env-locked');
            }
        }

        function setConfigField(fieldId, value) {
            const field = document.getElementById(fieldId);
            if (field) {
                field.value = value;

                // 检查是否被环境变量锚定
                const configKey = fieldId.replace(/([A-Z])/g, '_$1').toLowerCase();
                if (envLockedFields.has(configKey)) {
                    field.disabled = true;
                    const group = field.closest('.form-group') || field.parentElement;
                    if (group) group.classList.add('env-locked');
                } else {
                    field.disabled = false;
                    const group = field.closest('.form-group') || field.parentElement;
                    if (group) group.classList.remove('env-locked');
                }
            }
        }

        async function saveConfig() {
            const payload = {
                override_env: document.getElementById('overrideEnv').checked,
                api_password: document.getElementById('configApiPassword').value.trim(),
                panel_password: document.getElementById('configPanelPassword').value.trim(),
                host: document.getElementById('host').value.trim(),
                port: parseInt(document.getElementById('port').value) || 7861,
                calls_per_rotation: parseInt(document.getElementById('callsPerRotation').value) || 100,
                retry_429_enabled: !!document.getElementById('retry429Enabled').checked,
                retry_429_max_retries: parseInt(document.getElementById('retry429MaxRetries').value) || 5,
                retry_429_interval: parseFloat(document.getElementById('retry429Interval').value) || 1.0,
                auto_ban_enabled: !!document.getElementById('autoBanEnabled').checked,
                auto_ban_error_codes: document.getElementById('autoBanErrorCodes').value
            };
            const generalPwd = document.getElementById('configPassword').value.trim();
            if (generalPwd) payload.password = generalPwd;

            // 处理密钥配置：根据更新模式使用不同的接口
            const newKeys = document.getElementById('assemblyApiKeys').value.split(/\n|,/).map(s => s.trim()).filter(s => s.length > 0);
            const keyUpdateMode = document.getElementById('keyUpdateMode')?.value || 'append';

            try {
                // 如果有新密钥，使用密钥管理API
                if (newKeys.length > 0) {
                    const keysResponse = await fetch('/api/keys', {
                        method: 'POST',
                        headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            keys: newKeys,
                            mode: keyUpdateMode
                        })
                    });

                    // 先读取响应数据（只能读取一次）
                    const keysData = await keysResponse.json();

                    if (!keysResponse.ok) {
                        throw new Error(keysData.detail || '保存密钥失败');
                    }

                    // 检查是否有重复密钥并提示（只在追加模式下检查）
                    if (keyUpdateMode === 'append') {
                        const duplicateKeys = Array.isArray(keysData.duplicate_keys) ? keysData.duplicate_keys : [];
                        const duplicateCount = duplicateKeys.length > 0 ? duplicateKeys.length : (keysData.duplicate_count || 0);
                        const addedCount = keysData.added_count !== undefined ? keysData.added_count : (newKeys.length - duplicateCount);

                        // 调试信息（可在控制台查看）
                        console.log('密钥添加结果:', {
                            mode: keyUpdateMode,
                            total: newKeys.length,
                            added: addedCount,
                            duplicate: duplicateCount,
                            duplicateKeys: duplicateKeys
                        });

                        if (duplicateCount > 0 && duplicateKeys.length > 0) {
                            // 有重复密钥，使用弹窗提示，列出所有重复的密钥
                            const duplicateList = duplicateKeys.map(k => {
                                if (k && typeof k === 'string' && k.length > 8) {
                                    return k.substring(0, 4) + '...' + k.substring(k.length - 4);
                                } else if (k && typeof k === 'string' && k.length > 0) {
                                    return k.substring(0, 2) + '***';
                                }
                                return String(k || '');
                            }).filter(k => k).join('\n  • ');

                            if (addedCount === 0) {
                                // 所有密钥都是重复的，使用弹窗提示
                                alert(`⚠️ 重复密钥提醒\n\n所有 ${duplicateCount} 个密钥都是重复的，未添加任何密钥。\n\n重复的密钥：\n  • ${duplicateList}`);
                            } else {
                                // 部分密钥重复，使用弹窗提示
                                alert(`⚠️ 重复密钥提醒\n\n成功添加 ${addedCount} 个密钥，跳过 ${duplicateCount} 个重复密钥。\n\n重复的密钥：\n  • ${duplicateList}`);
                            }
                        } else if (duplicateCount > 0) {
                            // 有重复但列表为空（不应该发生，但作为后备）
                            alert(`⚠️ 重复密钥提醒\n\n成功添加 ${addedCount} 个密钥，跳过 ${duplicateCount} 个重复密钥`);
                        } else if (addedCount > 0) {
                            // 没有重复，显示成功提示
                            showStatus(`成功添加 ${addedCount} 个密钥`, 'success');
                        } else {
                            // 没有添加任何密钥
                            showStatus(`未添加任何密钥`, 'warning');
                        }
                    } else {
                        // 覆盖模式，显示成功提示
                        const addedCount = keysData.added_count || newKeys.length;
                        showStatus(`成功覆盖 ${addedCount} 个密钥`, 'success');
                    }
                }

                // 保存聚合模式
                const aggregationMode = document.getElementById('keyAggregationMode')?.value;
                if (aggregationMode) {
                    const modeResponse = await fetch('/api/keys/config/aggregation-mode', {
                        method: 'PUT',
                        headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                        body: JSON.stringify({ mode: aggregationMode })
                    });
                    if (!modeResponse.ok) {
                        const modeData = await modeResponse.json();
                        log.warning(`保存聚合模式失败: ${modeData.detail || '未知错误'}`);
                    }
                }

                // 保存其他配置
                const response = await fetch('/config/save', { method: 'POST', headers: getAuthHeaders(), body: JSON.stringify(payload) });
                const data = await response.json();
                if (response.ok) {
                    // 清空密钥输入框（因为已经保存）
                    if (newKeys.length > 0) {
                        document.getElementById('assemblyApiKeys').value = '';
                    }

                    const passwordChanged = (
                        (payload.panel_password && payload.panel_password !== (currentConfig.panel_password || '')) ||
                        (payload.api_password && payload.api_password !== (currentConfig.api_password || '')) ||
                        (payload.password && payload.password !== (currentConfig.password || ''))
                    );
                    if (passwordChanged) {
                        authToken = '';
                        document.getElementById('mainSection').classList.add('hidden');
                        document.getElementById('loginSection').classList.remove('hidden');
                        document.getElementById('loginPassword').value = '';

                        // 恢复登录页面专属特效（涟漪、渐变背景）
                        const rippleCanvas = document.getElementById('rippleCanvas');
                        const gradientOverlay = document.getElementById('gradientOverlay');
                        if (rippleCanvas) {
                            rippleCanvas.style.display = '';
                            rippleCanvas.style.opacity = '1';
                        }
                        if (gradientOverlay) {
                            gradientOverlay.style.display = '';
                            gradientOverlay.style.opacity = '0';
                            gradientActivated = false;
                        }

                        showStatus('密码已更新，请重新登录', 'info');
                    } else {
                        // 如果没有显示密钥相关的提示，才显示通用成功提示
                        if (newKeys.length === 0) {
                            showStatus('配置保存成功', 'success');
                        }
                        // 静默加载配置，不覆盖之前的提示消息
                        setTimeout(() => loadConfig(true), 500);
                    }
                } else {
                    showStatus(`保存配置失败: ${data.detail || data.error || '未知错误'}`, 'error');
                }
            } catch (error) {
                showStatus(`网络错误: ${error.message}`, 'error');
            }
        }

        async function refreshAllConfig(showBtnLoading = true, silent = false) {
            const metaEl = document.getElementById('allConfigMeta');
            const metaBar = document.getElementById('configMetaBar');
            const tbl = document.getElementById('allConfigTable');

            // 获取刷新按钮并添加加载状态（仅在手动点击时显示）
            const refreshBtn = showBtnLoading ? document.querySelector('button[onclick="refreshAllConfig()"]') : null;
            const originalBtnText = refreshBtn ? refreshBtn.textContent : '';
            if (refreshBtn) {
                refreshBtn.disabled = true;
                refreshBtn.textContent = '刷新中...';
                refreshBtn.style.opacity = '0.7';
            }

            try {
                const res = await fetch('/config/all', { headers: getAuthHeaders() });
                const data = await res.json();
                const cfg = data.config || {};
                const backend = data.backend || 'file';
                const prefix = data.prefix || '';
                if (metaEl) {
                    const colorMap = { redis: '#28a745', file: '#6c757d', postgres: '#0d6efd', mongodb: '#6f42c1' };
                    const bcol = colorMap[backend] || '#6c757d';
                    metaEl.style.display = 'flex';
                    metaEl.style.alignItems = 'center';
                    metaEl.style.gap = '6px';
                    metaEl.style.flexWrap = 'wrap';
                    metaEl.innerHTML = `
                        <span style="background:${bcol};color:white;padding:2px 8px;border-radius:3px;font-size:11px;font-weight:500;">后端: ${backend}</span>
                        <span style="background:#17a2b8;color:white;padding:2px 8px;border-radius:3px;font-size:11px;font-weight:500;">前缀: ${prefix}</span>
                        <span style="color:#888;font-size:11px;">共 ${Object.keys(cfg).length} 项</span>
                    `;
                }
                if (metaBar) {
                    const colorMap = { redis: '#28a745', file: '#6c757d', postgres: '#0d6efd', mongodb: '#6f42c1' };
                    const bcol = colorMap[backend] || '#6c757d';
                    metaBar.innerHTML = `
                        <span style="display:inline-block;background:${bcol};color:white;padding:3px 10px;border-radius:4px;font-size:12px;font-weight:500;">后端: ${backend}</span>
                        <span style="display:inline-block;background:#17a2b8;color:white;padding:3px 10px;border-radius:4px;font-size:12px;font-weight:500;margin-left:6px;">前缀: ${prefix}</span>
                        <span style="margin-left:10px;color:#888;font-size:11px;">共 ${Object.keys(cfg).length} 项配置</span>
                    `;
                }
                // 配置项名称映射（简洁明了的中文名称）
                // 配置项名称映射
                const nameMap = {
                    host: '监听地址',
                    port: '端口',
                    api_password: 'API密码',
                    panel_password: '面板密码',
                    password: '通用密码',
                    proxy: '代理',
                    assembly_api_keys: '密钥列表',
                    assembly_api_key: 'API密钥',
                    override_env: '面板优先',
                    calls_per_rotation: '轮换次数',
                    retry_429_enabled: '429重试',
                    retry_429_max_retries: '最大重试',
                    retry_429_interval: '重试间隔',
                    auto_ban_enabled: '自动封禁',
                    auto_ban_error_codes: '封禁码',
                    credentials_dir: '凭证目录',
                    disabled_key_indices: '禁用索引',
                    key_aggregation_mode: '聚合模式',
                    key_states: '密钥状态',
                    rate_limit_info: '速率限制',
                    unified_stats: '统计数据',
                    available_models: '模型列表',
                    available_models_meta: '模型信息',
                    available_models_selected: '已选模型',
                    key_stats: '密钥统计',
                    assembly_current_account: '当前账号',
                    assembly_dashboard_session: '会话信息'
                };

                // 动态匹配名称（支持带后缀的键名）
                const getDisplayName = (key) => {
                    if (nameMap[key]) return nameMap[key];
                    // 匹配 assembly_dashboard_session:xxx 格式
                    if (key.startsWith('assembly_dashboard_session:')) return '会话';
                    if (key.startsWith('assembly_')) return '上游配置';
                    if (key.startsWith('key_')) return '密钥配置';
                    if (key.startsWith('rate_')) return '速率配置';
                    return key.length > 15 ? key.substring(0, 12) + '...' : key;
                };

                // 判断是否为长内容（超过100个字符）
                const MAX_PREVIEW_LENGTH = 100;
                const isLongContent = (str) => str.length > MAX_PREVIEW_LENGTH;

                // 转义HTML
                const escapeHtml = (text) => {
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                };

                const rows = Object.keys(cfg).sort().map((k, idx) => {
                    const v = cfg[k];
                    // 折叠时显示单行，展开时显示格式化
                    const vsCompact = typeof v === 'object' ? JSON.stringify(v) : String(v);
                    const vsFull = typeof v === 'object' ? JSON.stringify(v, null, 2) : String(v);
                    const displayName = getDisplayName(k);
                    const rowId = `config-row-${idx}`;

                    let valueCell;
                    let actionsCell;

                    if (isLongContent(vsCompact)) {
                        // 长内容：折叠时显示单行预览，展开时显示格式化内容
                        const preview = escapeHtml(vsCompact.substring(0, MAX_PREVIEW_LENGTH)) + '...';
                        const fullContent = escapeHtml(vsFull);
                        valueCell = `
                            <td class="config-value-cell" data-label="值">
                                <span class="config-value-preview">${preview}</span>
                                <span class="config-value-full">${fullContent}</span>
                            </td>
                        `;
                        actionsCell = `
                            <td class="config-actions-cell" data-label="操作" style="white-space:nowrap;vertical-align:top;">
                                <div class="config-value-actions">
                                    <button class="config-toggle-btn" onclick="toggleConfigValue('${rowId}')" data-expanded="false">展开</button>
                                    <button class="config-copy-btn" onclick="copyConfigValue('${rowId}')">复制</button>
                                </div>
                            </td>
                        `;
                    } else {
                        valueCell = `
                            <td class="config-value-cell" data-label="值" style="word-break:break-all;">
                                <span class="config-value-preview">${escapeHtml(vsCompact)}</span>
                            </td>
                        `;
                        actionsCell = `
                            <td class="config-actions-cell" data-label="操作" style="white-space:nowrap;vertical-align:top;">
                                <div class="config-value-actions">
                                    <button class="config-copy-btn" onclick="copyConfigValue('${rowId}')">复制</button>
                                </div>
                            </td>
                        `;
                    }

                    return `<tr id="${rowId}">
                        <td data-label="名称" style="width:70px;color:#333;font-weight:500;font-size:13px;vertical-align:top;">${displayName}</td>
                        <td data-label="键" style="width:180px;color:#888;font-family:monospace;font-size:11px;word-break:break-all;vertical-align:top;" title="${escapeHtml(k)}">${escapeHtml(k)}</td>
                        ${valueCell}
                        ${actionsCell}
                    </tr>`;
                }).join('');

                if (tbl) {
                    tbl.innerHTML = `
                        <thead>
                            <tr>
                                <th style="width:70px">名称</th>
                                <th style="width:180px">键</th>
                                <th>值</th>
                                <th style="width:100px">操作</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    `;
                }
                if (!silent) showStatus('全部配置刷新成功 ✓', 'success');
            } catch (e) {
                if (!silent) showStatus(`加载全部配置失败: ${e.message}`, 'error');
            } finally {
                // 恢复按钮状态
                if (refreshBtn) {
                    refreshBtn.disabled = false;
                    refreshBtn.textContent = originalBtnText || '刷新全部配置';
                    refreshBtn.style.opacity = '1';
                }
            }
        }

        // 切换配置值展开/收起
        function toggleConfigValue(rowId) {
            const row = document.getElementById(rowId);
            if (!row) return;

            const cell = row.querySelector('.config-value-cell');
            const btn = row.querySelector('.config-toggle-btn');

            if (cell && btn) {
                const isExpanded = cell.classList.contains('expanded');
                if (isExpanded) {
                    cell.classList.remove('expanded');
                    btn.textContent = '展开';
                    btn.setAttribute('data-expanded', 'false');
                } else {
                    cell.classList.add('expanded');
                    btn.textContent = '收起';
                    btn.setAttribute('data-expanded', 'true');
                }
            }
        }

        // 复制配置值
        function copyConfigValue(rowId) {
            const row = document.getElementById(rowId);
            if (!row) return;

            const cell = row.querySelector('.config-value-cell');
            if (!cell) return;

            // 获取完整值（优先从full，否则从preview）
            const fullSpan = cell.querySelector('.config-value-full');
            const previewSpan = cell.querySelector('.config-value-preview');
            const valueToCopy = fullSpan ? fullSpan.textContent : (previewSpan ? previewSpan.textContent : '');

            if (!valueToCopy) return;

            // 复制到剪贴板
            navigator.clipboard.writeText(valueToCopy).then(() => {
                // 从操作列中查找按钮
                const actionsCell = row.querySelector('.config-actions-cell');
                const btn = actionsCell ? actionsCell.querySelector('.config-copy-btn') : null;
                if (btn) {
                    const originalText = btn.textContent;
                    btn.textContent = '已复制';
                    btn.classList.add('copied');
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.classList.remove('copied');
                    }, 2000);
                }
                showStatus('配置值已复制到剪贴板', 'success');
            }).catch(err => {
                console.error('复制失败:', err);
                showStatus('复制失败，请手动复制', 'error');
            });
        }

        // 环境变量凭证管理相关函数


        // 批量操作相关函数
        function toggleFileSelection(filename) {
            if (selectedCredFiles.has(filename)) {
                selectedCredFiles.delete(filename);
            } else {
                selectedCredFiles.add(filename);
            }
            updateBatchControls();
        }

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const fileCheckboxes = document.querySelectorAll('.file-checkbox');

            if (selectAllCheckbox.checked) {
                // 全选当前页面的文件
                fileCheckboxes.forEach(checkbox => {
                    const filename = checkbox.getAttribute('data-filename');
                    selectedCredFiles.add(filename);
                    checkbox.checked = true;
                });
            } else {
                // 取消全选
                selectedCredFiles.clear();
                fileCheckboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
            }
            updateBatchControls();
        }

        function updateBatchControls() {
            const selectedCount = selectedCredFiles.size;
            const selectedCountElement = document.getElementById('selectedCount');
            const batchEnableBtn = document.getElementById('batchEnableBtn');
            const batchDisableBtn = document.getElementById('batchDisableBtn');
            const batchDeleteBtn = document.getElementById('batchDeleteBtn');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');

            selectedCountElement.textContent = `已选择 ${selectedCount} 项`;

            // 启用/禁用批量操作按钮
            const hasSelection = selectedCount > 0;
            batchEnableBtn.disabled = !hasSelection;
            batchDisableBtn.disabled = !hasSelection;
            batchDeleteBtn.disabled = !hasSelection;

            // 更新全选复选框状态
            const currentPageFileCount = document.querySelectorAll('.file-checkbox').length;
            const currentPageSelectedCount = Array.from(document.querySelectorAll('.file-checkbox'))
                .filter(checkbox => selectedCredFiles.has(checkbox.getAttribute('data-filename'))).length;

            if (currentPageSelectedCount === 0) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = false;
            } else if (currentPageSelectedCount === currentPageFileCount) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = true;
            } else {
                selectAllCheckbox.indeterminate = true;
                selectAllCheckbox.checked = false;
            }

            // 更新页面上的复选框状态
            document.querySelectorAll('.file-checkbox').forEach(checkbox => {
                const filename = checkbox.getAttribute('data-filename');
                checkbox.checked = selectedCredFiles.has(filename);
            });
        }

        async function batchAction(action) {
            const selectedFiles = Array.from(selectedCredFiles);

            if (selectedFiles.length === 0) {
                showStatus('请先选择要操作的文件', 'error');
                return;
            }

            let confirmMessage = '';
            switch (action) {
                case 'enable':
                    confirmMessage = `确定要启用选中的 ${selectedFiles.length} 个文件吗？`;
                    break;
                case 'disable':
                    confirmMessage = `确定要禁用选中的 ${selectedFiles.length} 个文件吗？`;
                    break;
                case 'delete':
                    confirmMessage = `确定要删除选中的 ${selectedFiles.length} 个文件吗？\n注意：此操作不可恢复！`;
                    break;
            }

            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                showStatus(`正在执行批量${action === 'enable' ? '启用' : action === 'disable' ? '禁用' : '删除'}操作...`, 'info');

                const requestBody = {
                    action: action,
                    filenames: selectedFiles
                };

                const response = await fetch('/creds/batch-action', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                if (response.ok) {
                    showStatus(`批量操作完成：成功处理 ${data.success_count}/${selectedFiles.length} 个文件`, 'success');

                    // 清空选择
                    selectedCredFiles.clear();
                    updateBatchControls();

                    // 刷新列表
                    await refreshCredsStatus();
                } else {
                    showStatus(`批量操作失败: ${data.detail || data.error || '未知错误'}`, 'error');
                }
            } catch (error) {
                console.error('batchAction error:', error);
                showStatus(`批量操作网络错误: ${error.message}`, 'error');
            }
        }

        // 邮箱相关函数
        async function fetchUserEmail(filename) {
            try {
                showStatus('正在获取用户邮箱...', 'info');

                const response = await fetch(`/creds/fetch-email/${encodeURIComponent(filename)}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok && data.user_email) {
                    showStatus(`成功获取邮箱: ${data.user_email}`, 'success');
                    // 刷新凭证状态以更新显示
                    await refreshCredsStatus();
                } else {
                    showStatus(data.message || '无法获取用户邮箱', 'error');
                }
            } catch (error) {
                console.error('fetchUserEmail error:', error);
                showStatus(`获取邮箱失败: ${error.message}`, 'error');
            }
        }

        async function refreshAllEmails() {
            try {
                if (!confirm('确定要刷新所有凭证的用户邮箱吗？这可能需要一些时间。')) {
                    return;
                }

                showStatus('正在刷新所有用户邮箱...', 'info');

                const response = await fetch('/creds/refresh-all-emails', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    showStatus(`邮箱刷新完成：成功获取 ${data.success_count}/${data.total_count} 个邮箱地址`, 'success');
                    // 刷新凭证状态以更新显示
                    await refreshCredsStatus();
                } else {
                    showStatus(data.message || '邮箱刷新失败', 'error');
                }
            } catch (error) {
                console.error('refreshAllEmails error:', error);

                showStatus(`邮箱刷新网络错误: ${error.message} `, 'error');
            }
        }

        // =====================================================================
        // 登录页面动态特效
        // =====================================================================

        // 粒子系统
        class ParticleSystem {
            constructor(canvas) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.particles = [];
                this.mouseX = 0;
                this.mouseY = 0;
                this.resize();
                window.addEventListener('resize', () => this.resize());
            }

            resize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
            }

            createParticle() {
                const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                const colors = isDark
                    ? ['rgba(66, 133, 244, 0.6)', 'rgba(52, 168, 83, 0.5)', 'rgba(251, 188, 5, 0.5)', 'rgba(234, 67, 53, 0.4)']
                    : ['rgba(66, 133, 244, 0.3)', 'rgba(52, 168, 83, 0.25)', 'rgba(251, 188, 5, 0.25)', 'rgba(234, 67, 53, 0.2)'];

                return {
                    x: Math.random() * this.canvas.width,
                    y: Math.random() * this.canvas.height,
                    size: Math.random() * 3 + 1,
                    speedX: (Math.random() - 0.5) * 0.5,
                    speedY: (Math.random() - 0.5) * 0.5,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    opacity: Math.random() * 0.5 + 0.2
                };
            }

            init(count = 50) {
                this.particles = [];
                for (let i = 0; i < count; i++) {
                    this.particles.push(this.createParticle());
                }
            }

            update() {
                this.particles.forEach(p => {
                    p.x += p.speedX;
                    p.y += p.speedY;

                    // 鼠标吸引效果
                    const dx = this.mouseX - p.x;
                    const dy = this.mouseY - p.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist < 150) {
                        p.x += dx * 0.01;
                        p.y += dy * 0.01;
                    }

                    // 边界处理
                    if (p.x < 0) p.x = this.canvas.width;
                    if (p.x > this.canvas.width) p.x = 0;
                    if (p.y < 0) p.y = this.canvas.height;
                    if (p.y > this.canvas.height) p.y = 0;
                });
            }

            draw() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

                this.particles.forEach(p => {
                    this.ctx.beginPath();
                    this.ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    this.ctx.fillStyle = p.color;
                    this.ctx.fill();
                });

                // 绘制连线
                this.particles.forEach((p1, i) => {
                    this.particles.slice(i + 1).forEach(p2 => {
                        const dx = p1.x - p2.x;
                        const dy = p1.y - p2.y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        if (dist < 100) {
                            this.ctx.beginPath();
                            this.ctx.moveTo(p1.x, p1.y);
                            this.ctx.lineTo(p2.x, p2.y);
                            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                            this.ctx.strokeStyle = isDark
                                ? `rgba(66, 133, 244, ${0.15 * (1 - dist / 100)})`
                                : `rgba(66, 133, 244, ${0.08 * (1 - dist / 100)})`;
                            this.ctx.stroke();
                        }
                    });
                });
            }

            animate() {
                this.update();
                this.draw();
                requestAnimationFrame(() => this.animate());
            }
        }

        // 彩带/五彩纸屑系统
        class ConfettiSystem {
            constructor(canvas) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.confetti = [];
                this.resize();
                window.addEventListener('resize', () => this.resize());
            }

            resize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
            }

            createConfetti(x, y, count = 5) {
                const colors = ['#4285f4', '#34a853', '#fbbc05', '#ea4335', '#9c27b0', '#00bcd4'];
                for (let i = 0; i < count; i++) {
                    this.confetti.push({
                        x: x,
                        y: y,
                        width: Math.random() * 10 + 5,
                        height: Math.random() * 6 + 3,
                        color: colors[Math.floor(Math.random() * colors.length)],
                        speedX: (Math.random() - 0.5) * 4,
                        speedY: Math.random() * 2 + 1,
                        rotation: Math.random() * 360,
                        rotationSpeed: (Math.random() - 0.5) * 10,
                        opacity: 1,
                        gravity: 0.1
                    });
                }
            }

            update() {
                this.confetti = this.confetti.filter(c => {
                    c.x += c.speedX;
                    c.y += c.speedY;
                    c.speedY += c.gravity;
                    c.rotation += c.rotationSpeed;
                    c.opacity -= 0.008;
                    return c.opacity > 0 && c.y < this.canvas.height + 50;
                });
            }

            draw() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

                this.confetti.forEach(c => {
                    this.ctx.save();
                    this.ctx.translate(c.x, c.y);
                    this.ctx.rotate(c.rotation * Math.PI / 180);
                    this.ctx.globalAlpha = c.opacity;
                    this.ctx.fillStyle = c.color;
                    this.ctx.fillRect(-c.width / 2, -c.height / 2, c.width, c.height);
                    this.ctx.restore();
                });
            }

            animate() {
                this.update();
                this.draw();
                requestAnimationFrame(() => this.animate());
            }
        }

        // 熔岩蔓延涟漪系统 - 三层台阶：登录框 → 登录框底框 → 屏幕幕布
        class RippleSystem {
            constructor(canvas) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.ripples = [];
                this.loginCardRect = null;
                this.resize();
                window.addEventListener('resize', () => this.resize());
            }

            resize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
                this.updateLoginCardRect();
            }

            updateLoginCardRect() {
                const loginCard = document.querySelector('.login-card');
                if (loginCard) {
                    this.loginCardRect = loginCard.getBoundingClientRect();
                }
            }

            createRipple(x, y) {
                this.updateLoginCardRect();

                const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                const colors = [
                    isDark ? 'rgba(66, 133, 244, 0.3)' : 'rgba(66, 133, 244, 0.18)',
                    isDark ? 'rgba(52, 168, 83, 0.28)' : 'rgba(52, 168, 83, 0.15)',
                    isDark ? 'rgba(251, 188, 5, 0.25)' : 'rgba(251, 188, 5, 0.12)',
                    isDark ? 'rgba(234, 67, 53, 0.28)' : 'rgba(234, 67, 53, 0.15)'
                ];

                const maxDist = Math.max(
                    Math.sqrt(x * x + y * y),
                    Math.sqrt((this.canvas.width - x) ** 2 + y * y),
                    Math.sqrt(x * x + (this.canvas.height - y) ** 2),
                    Math.sqrt((this.canvas.width - x) ** 2 + (this.canvas.height - y) ** 2)
                );

                const baseColor = colors[Math.floor(Math.random() * colors.length)];

                // 三层台阶：登录框内 → 登录框底框（阴影区域） → 整个屏幕
                // 第一层：登录框内，立即开始
                this.ripples.push({
                    x: x,
                    y: y,
                    radius: 0,
                    maxRadius: maxDist * 1.8,
                    color: baseColor,
                    opacity: 0.5,
                    speed: 0.42,  // 再慢三成，像熔岩缓慢流动
                    layer: 0,
                    wavePhase: Math.random() * Math.PI * 2,
                    // 熔岩的不规则边缘参数
                    noiseSeeds: Array.from({ length: 8 }, () => Math.random() * 100),
                    filled: true  // 熔岩是填充的
                });

                // 第二层：登录框底框，延迟开始
                setTimeout(() => {
                    this.ripples.push({
                        x: x,
                        y: y,
                        radius: 0,
                        maxRadius: maxDist * 1.8,
                        color: baseColor,
                        opacity: 0.35,
                        speed: 0.35,  // 再慢三成
                        layer: 1,
                        wavePhase: Math.random() * Math.PI * 2,
                        noiseSeeds: Array.from({ length: 8 }, () => Math.random() * 100),
                        filled: true
                    });
                }, 800);

                // 第三层：整个屏幕，更晚开始
                setTimeout(() => {
                    this.ripples.push({
                        x: x,
                        y: y,
                        radius: 0,
                        maxRadius: maxDist * 1.8,
                        color: baseColor,
                        opacity: 0.2,
                        speed: 0.28,  // 再慢三成
                        layer: 2,
                        wavePhase: Math.random() * Math.PI * 2,
                        noiseSeeds: Array.from({ length: 8 }, () => Math.random() * 100),
                        filled: true
                    });
                }, 1600);
            }

            // 简单的噪声函数，模拟熔岩不规则边缘
            noise(angle, seeds, phase) {
                let result = 0;
                for (let i = 0; i < seeds.length; i++) {
                    const freq = (i + 1) * 2;
                    const amp = 15 / (i + 1);
                    result += Math.sin(angle * freq + seeds[i] + phase * 0.5) * amp;
                }
                return result;
            }

            update() {
                this.ripples.forEach(r => {
                    // 计算扩散进度 (0 到 1)
                    const progress = r.radius / r.maxRadius;

                    // 使用缓出函数：开始快，越往外越慢
                    // easeOutQuart: 1 - (1 - x)^4
                    const easeOutFactor = 1 - Math.pow(1 - progress, 4);
                    // 速度从初始速度的2倍开始，逐渐减慢到0.1倍
                    const dynamicSpeed = r.speed * 2 * (1 - easeOutFactor * 0.95);
                    r.radius += Math.max(dynamicSpeed, r.speed * 0.1);

                    r.wavePhase += 0.008;

                    // 扩散越远，透明度越低（线性衰减）
                    const distanceFade = 1 - progress * 0.8;
                    r.currentOpacity = r.opacity * distanceFade;

                    // 超过一半后额外衰减
                    if (progress > 0.5) {
                        r.currentOpacity *= Math.max(0.1, 1 - (progress - 0.5) * 1.5);
                    }
                });
                this.ripples = this.ripples.filter(r => r.radius < r.maxRadius && r.currentOpacity > 0.01);
            }

            draw() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.updateLoginCardRect();

                // 按层级排序绘制（底层先绘制，这样上层会覆盖）
                const sortedRipples = [...this.ripples].sort((a, b) => b.layer - a.layer);

                sortedRipples.forEach(r => {
                    if (r.radius < 5) return;

                    this.ctx.save();

                    // 创建裁剪区域：整个画布减去登录框区域
                    // 这样熔岩只会在登录框外部渲染，不会遮挡登录框
                    // 每帧都实时获取位置，所以会跟着登录框一起浮动
                    if (this.loginCardRect) {
                        const rect = this.loginCardRect;
                        // 稍微扩大裁剪区域，确保完全覆盖登录框
                        const padding = -3;
                        const cornerRadius = 26;

                        // 绘制整个画布区域
                        this.ctx.beginPath();
                        this.ctx.rect(0, 0, this.canvas.width, this.canvas.height);

                        // 减去登录框区域（使用圆角矩形，稍微扩大以确保完全覆盖）
                        const left = rect.left + padding;
                        const right = rect.right - padding;
                        const top = rect.top + padding;
                        const bottom = rect.bottom - padding;

                        this.ctx.moveTo(left + cornerRadius, top);
                        this.ctx.lineTo(right - cornerRadius, top);
                        this.ctx.arcTo(right, top, right, top + cornerRadius, cornerRadius);
                        this.ctx.lineTo(right, bottom - cornerRadius);
                        this.ctx.arcTo(right, bottom, right - cornerRadius, bottom, cornerRadius);
                        this.ctx.lineTo(left + cornerRadius, bottom);
                        this.ctx.arcTo(left, bottom, left, bottom - cornerRadius, cornerRadius);
                        this.ctx.lineTo(left, top + cornerRadius);
                        this.ctx.arcTo(left, top, left + cornerRadius, top, cornerRadius);
                        this.ctx.closePath();

                        this.ctx.clip('evenodd'); // evenodd规则：外部区域被填充，内部（登录框）被排除
                    }

                    this.ctx.translate(r.x, r.y);

                    // 绘制熔岩形状 - 不规则的有机边缘
                    this.ctx.beginPath();
                    const points = 100;
                    for (let i = 0; i <= points; i++) {
                        const angle = (i / points) * Math.PI * 2;
                        // 使用噪声函数创建不规则边缘，像熔岩流动
                        const noiseVal = this.noise(angle, r.noiseSeeds, r.wavePhase);
                        const currentRadius = r.radius + noiseVal;
                        const px = Math.cos(angle) * currentRadius;
                        const py = Math.sin(angle) * currentRadius;

                        if (i === 0) {
                            this.ctx.moveTo(px, py);
                        } else {
                            this.ctx.lineTo(px, py);
                        }
                    }
                    this.ctx.closePath();

                    // 熔岩填充 - 从中心到边缘的渐变，越远越淡
                    const gradient = this.ctx.createRadialGradient(0, 0, 0, 0, 0, r.radius + 20);
                    const baseOpacity = r.currentOpacity || r.opacity;

                    // 中心较浓，边缘较淡（扩散衰减效果）
                    gradient.addColorStop(0, r.color.replace(/[\d.]+\)$/, (baseOpacity * 0.6) + ')'));
                    gradient.addColorStop(0.3, r.color.replace(/[\d.]+\)$/, (baseOpacity * 0.5) + ')'));
                    gradient.addColorStop(0.6, r.color.replace(/[\d.]+\)$/, (baseOpacity * 0.3) + ')'));
                    gradient.addColorStop(0.85, r.color.replace(/[\d.]+\)$/, (baseOpacity * 0.15) + ')'));
                    gradient.addColorStop(1, r.color.replace(/[\d.]+\)$/, (baseOpacity * 0.05) + ')'));

                    this.ctx.fillStyle = gradient;
                    this.ctx.fill();

                    // 边缘线条 - 更淡的边缘
                    this.ctx.strokeStyle = r.color.replace(/[\d.]+\)$/, (baseOpacity * 0.3) + ')');
                    this.ctx.lineWidth = 1.5;
                    this.ctx.stroke();

                    this.ctx.restore();
                });
            }

            animate() {
                this.update();
                this.draw();
                requestAnimationFrame(() => this.animate());
            }
        }

        // 点击涟漪效果
        function createClickRipple(x, y) {
            const ripple = document.createElement('div');
            ripple.className = 'click-ripple';
            const colors = ['rgba(66, 133, 244, 0.4)', 'rgba(52, 168, 83, 0.4)', 'rgba(251, 188, 5, 0.4)', 'rgba(234, 67, 53, 0.4)'];
            const color = colors[Math.floor(Math.random() * colors.length)];
            ripple.style.cssText = `
                left: ${x} px;
                top: ${y} px;
                width: 20px;
                height: 20px;
                background: ${color};
                box - shadow: 0 0 20px ${color};
                `;
            document.body.appendChild(ripple);
            setTimeout(() => ripple.remove(), 600);
        }

        // 初始化动态特效
        let particleSystem = null;
        let confettiSystem = null;
        let rippleSystem = null;
        let isMouseInLoginCard = false;
        let gradientActivated = false;

        // 初始化固定头部滚动效果
        function initFixedHeaderScroll() {
            const fixedHeader = document.getElementById('fixedHeader');
            const contentWrapper = document.querySelector('.tab-content-wrapper');
            if (!fixedHeader || !contentWrapper) return;

            // 监听内容区域滚动事件添加阴影
            contentWrapper.addEventListener('scroll', function () {
                if (contentWrapper.scrollTop > 10) {
                    fixedHeader.classList.add('scrolled');
                } else {
                    fixedHeader.classList.remove('scrolled');
                }
            }, { passive: true });
        }

        function initLoginEffects() {
            const particleCanvas = document.getElementById('particleCanvas');
            const confettiCanvas = document.getElementById('confettiCanvas');
            const rippleCanvas = document.getElementById('rippleCanvas');
            const mouseGlow = document.getElementById('mouseGlow');
            const gradientOverlay = document.getElementById('gradientOverlay');
            const loginSection = document.getElementById('loginSection');
            const loginCard = document.querySelector('.login-card');

            if (!particleCanvas || !confettiCanvas || !rippleCanvas) return;

            // 初始化粒子系统
            particleSystem = new ParticleSystem(particleCanvas);
            particleSystem.init(40);
            particleSystem.animate();

            // 初始化涟漪系统（受层林尽染开关控制）
            const lavaRippleEnabledInit = localStorage.getItem('lavaRippleEnabled') !== 'false';
            if (lavaRippleEnabledInit) {
                rippleSystem = new RippleSystem(rippleCanvas);
                rippleSystem.animate();
            } else {
                // 隐藏涟漪画布和渐变背景
                rippleCanvas.style.display = 'none';
                if (gradientOverlay) gradientOverlay.style.display = 'none';
            }

            // 初始化彩带系统
            confettiSystem = new ConfettiSystem(confettiCanvas);
            confettiSystem.animate();

            // 登录卡片鼠标进入事件 - 触发渐变浸染（受层林尽染开关控制）
            if (loginCard) {
                loginCard.addEventListener('mouseenter', () => {
                    isMouseInLoginCard = true;
                    const lavaEnabled = localStorage.getItem('lavaRippleEnabled') !== 'false';
                    if (lavaEnabled && gradientOverlay && !gradientActivated) {
                        gradientOverlay.style.opacity = '1';
                        gradientActivated = true;
                    }
                });

                loginCard.addEventListener('mouseleave', () => {
                    isMouseInLoginCard = false;
                });
            }

            // 鼠标移动事件 - 涟漪 + 彩带掉落 + 光晕跟随（全局生效）
            let lastConfettiTime = 0;
            let lastRippleTime = 0;
            document.addEventListener('mousemove', (e) => {
                // 更新粒子系统鼠标位置（全局生效）
                if (particleSystem) {
                    particleSystem.mouseX = e.clientX;
                    particleSystem.mouseY = e.clientY;
                }

                // 更新鼠标光晕位置（全局生效）
                if (mouseGlow) {
                    mouseGlow.style.left = e.clientX + 'px';
                    mouseGlow.style.top = e.clientY + 'px';
                    // 登录页面时根据是否在卡片内调整透明度，主页面时保持较低透明度
                    const isLoginPage = loginSection && !loginSection.classList.contains('hidden');
                    if (isLoginPage) {
                        mouseGlow.style.opacity = isMouseInLoginCard ? '1' : '0.4';
                    } else {
                        mouseGlow.style.opacity = '0.3';
                    }
                }

                const now = Date.now();

                // 在登录卡片内时，产生缓慢的水波涟漪效果（仅登录页面，受层林尽染开关控制）
                const lavaRippleEnabled = localStorage.getItem('lavaRippleEnabled') !== 'false';
                if (lavaRippleEnabled && isMouseInLoginCard && rippleSystem && now - lastRippleTime > 800) {
                    rippleSystem.createRipple(e.clientX, e.clientY);
                    lastRippleTime = now;
                }

                // 彩带掉落效果
                const isLoginPage = loginSection && !loginSection.classList.contains('hidden');
                if (confettiSystem) {
                    if (isLoginPage && now - lastConfettiTime > 100) {
                        // 登录页面：固定掉落
                        confettiSystem.createConfetti(e.clientX, e.clientY, 2);
                        lastConfettiTime = now;
                    } else if (!isLoginPage) {
                        // 主页面：根据配置决定是否掉落
                        const confettiEnabled = document.getElementById('confettiEnabled')?.checked;
                        const confettiProbability = parseInt(document.getElementById('confettiProbability')?.value || 10);
                        if (confettiEnabled && now - lastConfettiTime > 200 && Math.random() * 100 < confettiProbability) {
                            confettiSystem.createConfetti(e.clientX, e.clientY, 1);
                            lastConfettiTime = now;
                        }
                    }
                }
            });

            // 鼠标离开时隐藏光晕
            document.addEventListener('mouseleave', () => {
                if (mouseGlow) mouseGlow.style.opacity = '0';
            });

            // 点击事件 - 涟漪 + 爆炸彩带
            document.addEventListener('click', (e) => {
                const isLoginPage = loginSection && !loginSection.classList.contains('hidden');

                // 点击涟漪效果（全局生效）
                createClickRipple(e.clientX, e.clientY);

                // 爆炸彩带
                if (confettiSystem) {
                    if (isLoginPage) {
                        confettiSystem.createConfetti(e.clientX, e.clientY, 15);
                    } else {
                        // 主页面：根据配置决定是否掉落
                        const confettiEnabled = document.getElementById('confettiEnabled')?.checked;
                        if (confettiEnabled) {
                            confettiSystem.createConfetti(e.clientX, e.clientY, 5);
                        }
                    }
                }

                // 水波涟漪仅在登录页面生效（受层林尽染开关控制）
                const lavaRippleEnabledClick = localStorage.getItem('lavaRippleEnabled') !== 'false';
                if (lavaRippleEnabledClick && isLoginPage && rippleSystem) {
                    rippleSystem.createRipple(e.clientX, e.clientY);
                }
            });
        }

        // 初始化自定义下拉框
        function initCustomSelects(container = document) {
            container.querySelectorAll('.custom-select-wrapper:not(.initialized)').forEach(wrapper => {
                wrapper.classList.add('initialized');
                const trigger = wrapper.querySelector('.custom-select-trigger');
                const options = wrapper.querySelectorAll('.custom-select-option');
                const selectId = wrapper.dataset.selectId;
                const hiddenInput = document.getElementById(selectId);
                const onChangeCallback = wrapper.dataset.onchange;

                // 点击触发器切换下拉框
                trigger.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // 关闭其他下拉框
                    document.querySelectorAll('.custom-select-wrapper.open').forEach(w => {
                        if (w !== wrapper) w.classList.remove('open');
                    });
                    wrapper.classList.toggle('open');
                });

                // 点击选项
                options.forEach(option => {
                    option.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const value = option.dataset.value;
                        const text = option.textContent;
                        const oldValue = hiddenInput ? hiddenInput.value : null;

                        // 更新显示
                        trigger.textContent = text;

                        // 更新选中状态
                        options.forEach(o => o.classList.remove('selected'));
                        option.classList.add('selected');

                        // 更新隐藏input的值
                        if (hiddenInput) hiddenInput.value = value;

                        // 关闭下拉框
                        wrapper.classList.remove('open');

                        // 触发onchange回调
                        if (onChangeCallback && oldValue !== value) {
                            try {
                                eval(onChangeCallback);
                            } catch (err) {
                                console.error('Custom select onchange error:', err);
                            }
                        }
                    });
                });
            });

            // 点击外部关闭下拉框（只绑定一次）
            if (!window._customSelectClickBound) {
                window._customSelectClickBound = true;
                document.addEventListener('click', () => {
                    document.querySelectorAll('.custom-select-wrapper.open').forEach(w => {
                        w.classList.remove('open');
                    });
                });
            }
        }

        // 页面加载时检查状态
        window.onload = async function () {
            console.log('Page loaded');
            console.log('Login section exists:', !!document.getElementById('loginSection'));
            console.log('Main section exists:', !!document.getElementById('mainSection'));

            // 初始化自定义下拉框
            initCustomSelects();

            // 初始化固定头部滚动效果
            initFixedHeaderScroll();

            // 初始化登录页面动态特效
            initLoginEffects();

            // 检查自动登录
            const autoLoginSuccess = await checkAutoLogin();
            if (autoLoginSuccess) {
                // 自动登录成功，直接进入主界面
                const loginEl = document.getElementById('loginSection');
                const mainEl = document.getElementById('mainSection');
                const container = document.querySelector('.container');
                const rippleCanvas = document.getElementById('rippleCanvas');
                const gradientOverlay = document.getElementById('gradientOverlay');
                const configFloatingActions = document.getElementById('configFloatingActions');

                // 隐藏登录界面
                if (rippleCanvas) rippleCanvas.style.display = 'none';
                if (gradientOverlay) gradientOverlay.style.display = 'none';
                container.classList.remove('login-mode');
                loginEl.classList.add('hidden');

                // 显示主界面
                mainEl.classList.remove('hidden');
                if (configFloatingActions) configFloatingActions.classList.add('visible');

                // 加载数据
                switchTab('config');
                await loadConfig();
                await refreshUsageStats();
                triggerAccountPreload();

                console.log('自动登录成功');
            } else {
                // 显示登录页面
                const loginSection = document.getElementById('loginSection');
                if (loginSection && !loginSection.classList.contains('hidden')) {
                    document.querySelector('.container').classList.add('login-mode');
                }
            }



            // 初始化工具定义高度同步
            setTimeout(syncToolsCardHeight, 100);

            // 窗口大小变化时重新同步
            window.addEventListener('resize', () => {
                setTimeout(syncToolsCardHeight, 50);
            });

            // 加载彩带配置
            loadConfettiConfig();

            // 添加 env-locked 点击提示事件 - 点击整个锁定区域都会提示
            document.addEventListener('click', function (e) {
                const lockedGroup = e.target.closest('.env-locked');
                if (lockedGroup) {
                    // 滚动到配置状态区域让用户看到提示
                    const configStatus = document.getElementById('configStatus');
                    if (configStatus) {
                        configStatus.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                    showStatus('此项由环境变量锁定，请勾选「面板优先」选项后方可修改', 'error');
                }
            });
        };

        // 加载彩带配置
        function loadConfettiConfig() {
            const savedEnabled = localStorage.getItem('confettiEnabled');
            const savedProbability = localStorage.getItem('confettiProbability');
            const savedLavaRipple = localStorage.getItem('lavaRippleEnabled');

            const enabledEl = document.getElementById('confettiEnabled');
            const probabilityEl = document.getElementById('confettiProbability');
            const probabilityValueEl = document.getElementById('confettiProbabilityValue');
            const lavaRippleEl = document.getElementById('lavaRippleEnabled');

            if (enabledEl && savedEnabled !== null) {
                enabledEl.checked = savedEnabled === 'true';
            }

            if (probabilityEl && savedProbability !== null) {
                const val = parseInt(savedProbability) || 10;
                probabilityEl.value = val;
                if (probabilityValueEl) probabilityValueEl.textContent = val;
                probabilityEl.style.background = `linear - gradient(to right, #4285f4 0 %, #4285f4 ${val} %, #ddd ${val} %, #ddd 100 %)`;
            }

            // 层林尽染开关（默认开启）
            if (lavaRippleEl) {
                lavaRippleEl.checked = savedLavaRipple !== 'false';
            }

            // 添加事件监听器保存配置
            if (enabledEl) {
                enabledEl.addEventListener('change', saveConfettiConfig);
            }
            if (probabilityEl) {
                probabilityEl.addEventListener('input', saveConfettiConfig);
            }
            if (lavaRippleEl) {
                lavaRippleEl.addEventListener('change', saveConfettiConfig);
            }
        }

        // 保存彩带配置
        function saveConfettiConfig() {
            const enabledEl = document.getElementById('confettiEnabled');
            const probabilityEl = document.getElementById('confettiProbability');
            const lavaRippleEl = document.getElementById('lavaRippleEnabled');

            if (enabledEl) {
                localStorage.setItem('confettiEnabled', enabledEl.checked);
            }
            if (probabilityEl) {
                localStorage.setItem('confettiProbability', probabilityEl.value);
            }
            if (lavaRippleEl) {
                localStorage.setItem('lavaRippleEnabled', lavaRippleEl.checked);
            }
        }

        // =====================================================================
        // 使用统计相关函数
        // =====================================================================

        let usageStatsData = {};
        let currentEditingFile = '';

        // 刷新使用统计
        async function refreshUsageStats(silent = false) {
            const usageLoading = document.getElementById('usageLoading');
            const usageList = document.getElementById('usageList');

            try {
                if (!silent) {
                    usageLoading.style.display = 'block';
                    usageList.innerHTML = '';
                }

                // 同时获取聚合数据、凭证状态、密钥状态和配置信息
                const [aggregatedResponse, credsStatusResponse, keysStatsResponse, configResponse] = await Promise.all([
                    fetch('/usage/aggregated', {
                        method: 'GET',
                        headers: getAuthHeaders()
                    }),
                    fetch('/creds/status', {
                        method: 'GET',
                        headers: getAuthHeaders()
                    }),
                    fetch('/api/keys/stats', {
                        method: 'GET',
                        headers: getAuthHeaders()
                    }).catch(() => ({ ok: false, json: () => Promise.resolve({}) })),
                    fetch('/config/get', {
                        method: 'GET',
                        headers: getAuthHeaders()
                    }).catch(() => ({ ok: false, json: () => Promise.resolve({ config: {} }) }))
                ]);

                const aggregatedData = await aggregatedResponse.json();
                const credsStatusData = await credsStatusResponse.json();
                const keysStatsData = keysStatsResponse.ok ? await keysStatsResponse.json() : {};
                const configData = configResponse.ok ? await configResponse.json() : { config: {} };

                // 获取配置中的密钥列表（用于判断失效密钥）
                const configuredKeys = (configData.config?.assembly_api_keys || []).map(k => {
                    // 脱敏密钥用于匹配
                    if (k && k.length > 8) {
                        return k.substring(0, 4) + '...' + k.substring(k.length - 4);
                    }
                    return k;
                });

                if (aggregatedResponse.ok) {
                    // 从aggregatedData.log_summary.keys构建usageStatsData
                    usageStatsData = {};
                    const keys = (aggregatedData.log_summary && aggregatedData.log_summary.keys) || {};

                    // 获取凭证状态映射（将文件名映射到状态）
                    const credsStatus = credsStatusData.creds || {};

                    // 获取密钥状态映射（从/api/keys/stats获取）
                    // 构建脱敏密钥到禁用状态的映射（支持多种键名格式）
                    const keyDisabledMap = {};
                    // 构建所有密钥的集合（用于判断某个keyName是否是密钥）
                    const allKeysSet = new Set();

                    // 先处理禁用的密钥（优先级更高，确保禁用的密钥被正确标记）
                    if (keysStatsData.disabled && Array.isArray(keysStatsData.disabled)) {
                        keysStatsData.disabled.forEach(key => {
                            if (key.masked_key) {
                                // 使用masked_key作为主键
                                keyDisabledMap[key.masked_key] = true; // disabled列表中的密钥是禁用的
                                allKeysSet.add(key.masked_key);
                                // 同时支持其他可能的键名格式（如果有的话）
                                if (key.display_key && key.display_key !== key.masked_key) {
                                    keyDisabledMap[key.display_key] = true;
                                    allKeysSet.add(key.display_key);
                                }
                            }
                        });
                    }
                    // 再处理启用的密钥
                    if (keysStatsData.enabled && Array.isArray(keysStatsData.enabled)) {
                        keysStatsData.enabled.forEach(key => {
                            if (key.masked_key) {
                                // 只有在keyDisabledMap中不存在时才设置（避免覆盖已禁用的状态）
                                if (!keyDisabledMap.hasOwnProperty(key.masked_key)) {
                                    keyDisabledMap[key.masked_key] = false; // enabled列表中的密钥是启用的
                                }
                                allKeysSet.add(key.masked_key);
                                // 同时支持其他可能的键名格式（如果有的话）
                                if (key.display_key && key.display_key !== key.masked_key && !keyDisabledMap.hasOwnProperty(key.display_key)) {
                                    keyDisabledMap[key.display_key] = false;
                                    allKeysSet.add(key.display_key);
                                }
                            }
                        });
                    }

                    // 为每个key创建统计数据结构
                    for (const [keyName, keyData] of Object.entries(keys)) {
                        // 计算总调用次数（成功+失败）
                        const totalCalls = (keyData.ok || 0) + (keyData.fail || 0);

                        // 查找对应的凭证状态
                        // keyName可能是脱敏后的密钥（masked key）或 "creds/filename.json" 格式
                        let disabled = false;
                        let isKey = false; // 标记是否是密钥
                        let isInvalid = false; // 标记是否是失效密钥（统计中存在但配置中不存在）

                        // 首先检查是否是密钥（通过脱敏密钥匹配）
                        if (keyDisabledMap.hasOwnProperty(keyName)) {
                            disabled = keyDisabledMap[keyName];
                            isKey = true;
                        } else {
                            // 如果不在keyDisabledMap中，检查keyData中是否有masked_key字段
                            // 如果有，尝试用masked_key匹配
                            const maskedKeyFromData = keyData.masked_key || keyData.display_key || keyName;
                            if (maskedKeyFromData) {
                                if (keyDisabledMap.hasOwnProperty(maskedKeyFromData)) {
                                    disabled = keyDisabledMap[maskedKeyFromData];
                                    isKey = true;
                                } else if (allKeysSet.has(maskedKeyFromData) || allKeysSet.has(keyName)) {
                                    // 如果maskedKeyFromData或keyName在所有密钥集合中，说明它是密钥
                                    // 但不在keyDisabledMap中，这可能是因为状态数据不完整
                                    // 这种情况下，我们暂时不设置disabled，等第二次处理时再更新
                                    isKey = true;
                                } else {
                                    // 检查是否是失效密钥：在统计中存在但不在配置中
                                    // 如果keyName或maskedKeyFromData不在configuredKeys中，说明是失效密钥
                                    const isInConfigured = configuredKeys.some(ck =>
                                        ck === keyName || ck === maskedKeyFromData ||
                                        keyName.includes(ck) || maskedKeyFromData.includes(ck) ||
                                        ck.includes(keyName) || ck.includes(maskedKeyFromData)
                                    );
                                    if (!isInConfigured && (keyName.length > 10 || maskedKeyFromData.length > 10)) {
                                        // 看起来像密钥格式（长度较长），但不在配置中，是失效密钥
                                        isKey = true;
                                        isInvalid = true;
                                        disabled = false; // 失效密钥不算禁用
                                    }
                                }
                            }

                            // 如果确定不是密钥，则查找凭证状态
                            if (!isKey) {
                                // 方法1: 直接匹配（keyName就是凭证文件名）
                                if (credsStatus[keyName]) {
                                    disabled = credsStatus[keyName].status?.disabled || false;
                                } else {
                                    // 方法2: 匹配去掉路径前缀的文件名
                                    const keyNameWithoutPrefix = keyName.replace(/^creds\//, '');
                                    if (credsStatus[keyNameWithoutPrefix]) {
                                        disabled = credsStatus[keyNameWithoutPrefix].status?.disabled || false;
                                    } else {
                                        // 方法3: 遍历所有凭证，检查文件名是否包含keyName或keyName包含文件名
                                        for (const [credFilename, credInfo] of Object.entries(credsStatus)) {
                                            const credNameWithoutPrefix = credFilename.replace(/^creds\//, '');
                                            if (keyName === credFilename ||
                                                keyName === credNameWithoutPrefix ||
                                                keyNameWithoutPrefix === credFilename ||
                                                keyNameWithoutPrefix === credNameWithoutPrefix ||
                                                keyName.includes(credFilename) ||
                                                credFilename.includes(keyName) ||
                                                keyName.includes(credNameWithoutPrefix) ||
                                                credNameWithoutPrefix.includes(keyName)) {
                                                disabled = credInfo.status?.disabled || false;
                                                break;
                                            }
                                        }
                                    }
                                }
                            }
                        }

                        usageStatsData[keyName] = {
                            display_name: keyName,
                            total_calls: totalCalls,
                            daily_limit_total: 1000, // 默认限制
                            model_counts: keyData.model_counts || {},
                            next_reset_time: aggregatedData.next_reset_time || null,
                            disabled: disabled,
                            isInvalid: isInvalid, // 标记是否是失效密钥
                            isKey: isKey // 标记是否是密钥
                        };
                    }

                    // 确保所有配置的密钥都被统计（即使没有使用记录）
                    // 从/keys/stats获取所有密钥，确保禁用的密钥也被包含
                    if (keysStatsData.total_keys !== undefined) {
                        // 先处理禁用的密钥（确保禁用的密钥被正确标记，优先级最高）
                        if (keysStatsData.disabled && Array.isArray(keysStatsData.disabled)) {
                            keysStatsData.disabled.forEach(keyStat => {
                                if (keyStat.masked_key) {
                                    // 如果这个密钥不在usageStatsData中，添加它
                                    if (!usageStatsData.hasOwnProperty(keyStat.masked_key)) {
                                        usageStatsData[keyStat.masked_key] = {
                                            display_name: keyStat.masked_key,
                                            total_calls: 0,
                                            daily_limit_total: 1000,
                                            model_counts: keyStat.model_counts || {},
                                            next_reset_time: aggregatedData.next_reset_time || null,
                                            disabled: true  // 来自disabled数组，直接设置为禁用
                                        };
                                    } else {
                                        // 如果已存在，强制更新为禁用状态（确保状态正确）
                                        usageStatsData[keyStat.masked_key].disabled = true;
                                    }
                                }
                            });
                        }

                        // 再处理启用的密钥
                        if (keysStatsData.enabled && Array.isArray(keysStatsData.enabled)) {
                            keysStatsData.enabled.forEach(keyStat => {
                                if (keyStat.masked_key) {
                                    // 如果这个密钥不在usageStatsData中，添加它
                                    if (!usageStatsData.hasOwnProperty(keyStat.masked_key)) {
                                        usageStatsData[keyStat.masked_key] = {
                                            display_name: keyStat.masked_key,
                                            total_calls: 0,
                                            daily_limit_total: 1000,
                                            model_counts: keyStat.model_counts || {},
                                            next_reset_time: aggregatedData.next_reset_time || null,
                                            disabled: false  // 来自enabled数组，直接设置为启用
                                        };
                                    } else {
                                        // 如果已存在，直接更新为启用状态
                                        // 因为如果密钥在enabled数组中，说明它应该是启用的
                                        // 我们已经先处理了disabled数组，所以这里可以安全地更新
                                        usageStatsData[keyStat.masked_key].disabled = false;
                                    }
                                }
                            });
                        }
                    }

                    // 计算活跃、禁用和失效的密钥数
                    // 禁用密钥：在多密钥管理中被禁用或自动禁用的密钥（在配置中但被禁用）
                    // 失效密钥：统计中存在但配置中不存在的历史密钥
                    const activeKeys = Object.values(usageStatsData).filter(s => !s.disabled && !s.isInvalid).length;
                    const disabledKeys = Object.values(usageStatsData).filter(s => s.disabled && s.isKey && !s.isInvalid).length;
                    const invalidKeys = Object.values(usageStatsData).filter(s => s.isInvalid).length;

                    document.getElementById('totalApiCalls').textContent = aggregatedData.total_all_model_calls || 0;
                    document.getElementById('activeKeys').textContent = activeKeys;
                    document.getElementById('disabledKeys').textContent = disabledKeys;

                    // 渲染使用统计列表
                    renderUsageList();

                    if (!silent) {
                        showStatus(`已加载 ${Object.keys(usageStatsData).length} 个密钥的使用统计（活跃: ${activeKeys}, 禁用: ${disabledKeys}）`, 'success');
                    }
                } else {
                    if (!silent) {
                        showStatus('加载使用统计失败', 'error');
                    }
                }
            } catch (error) {
                if (!silent) {
                    showStatus(`网络错误: ${error.message} `, 'error');
                }
            } finally {
                if (!silent) {
                    usageLoading.style.display = 'none';
                }
            }
        }

        async function checkInvalidKeys() {
            try {
                const res = await fetch('/keys/invalid', { headers: getAuthHeaders() });
                const data = await res.json();
                const list = (data.invalid_keys || []).map(it => it.key).join(', ');
                const msg = `失效密钥 ${data.invalid_keys?.length || 0} 个${list ? '：' + list : ''} `;
                showStatus(msg, 'info');
            } catch (e) {
                showStatus('检查失效密钥失败: ' + e.message, 'error');
            }
        }

        async function deleteInvalidKeys() {
            if (!confirm('确定要移除所有失效密钥的数据吗？\n\n这将：\n1. 清除失效密钥的日志记录\n2. 清除失效密钥的统计数据\n3. 将失效密钥加入忽略列表\n\n注意：配置中的有效密钥不会被移除！')) {
                return;
            }
            try {
                const res = await fetch('/keys/delete-invalid', { method: 'POST', headers: getAuthHeaders() });
                const data = await res.json();
                if (res.ok) {
                    showStatus(`已移除失效密钥数据：${data.invalid_deleted || 0} 个密钥，已加入忽略列表 ${data.ignored_count || 0} 项`, 'success');
                    // 同步刷新日志统计与使用统计列表
                    await refreshLogSummary();
                    await refreshUsageStats();
                    // 重新检查失效密钥
                    await checkInvalidKeys();
                } else {
                    showStatus('移除失败: ' + (data.detail || '未知错误'), 'error');
                }
            } catch (e) {
                showStatus('移除失效密钥数据失败: ' + e.message, 'error');
            }
        }

        // 重置所有统计
        async function resetAllStats() {
            if (!confirm('确定要重置所有统计数据吗？\n\n这将清除所有密钥的调用统计，包括：\n- 成功/失败次数\n- 模型调用次数\n- 排行榜数据\n\n此操作不可恢复！')) {
                return;
            }
            try {
                const res = await fetch('/usage/reset', {
                    method: 'POST',
                    headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                const data = await res.json();
                if (res.ok) {
                    showStatus('所有统计数据已重置', 'success');
                    await refreshLogSummary();
                    await refreshUsageStats();
                } else {
                    showStatus('重置失败: ' + (data.detail || '未知错误'), 'error');
                }
            } catch (e) {
                showStatus('重置统计失败: ' + e.message, 'error');
            }
        }

        // 重置指定密钥的统计
        async function resetKeyStats(maskedKey) {
            if (!confirm(`确定要清除密钥 ${maskedKey} 的统计数据吗？\n\n这将清除该密钥的所有调用统计。`)) {
                return;
            }
            try {
                const res = await fetch('/usage/reset', {
                    method: 'POST',
                    headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: maskedKey })
                });
                const data = await res.json();
                if (res.ok) {
                    showStatus(`密钥 ${maskedKey} 的统计已清除`, 'success');
                    await refreshLogSummary();
                    await refreshUsageStats();
                } else {
                    showStatus('清除失败: ' + (data.detail || '未知错误'), 'error');
                }
            } catch (e) {
                showStatus('清除统计失败: ' + e.message, 'error');
            }
        }

        async function refreshLogSummary() {
            const model = document.getElementById('modelFilter').value || '';
            const key = (document.getElementById('keyFilter').value || '').trim();
            const only = document.getElementById('onlyFilter').value || '';
            let url = '/usage/aggregated';
            const params = [];
            if (model) params.push('model=' + encodeURIComponent(model));
            if (key) params.push('key=' + encodeURIComponent(key));
            if (only) params.push('only=' + encodeURIComponent(only));
            // 添加时间戳防止缓存
            params.push('_t=' + Date.now());
            if (params.length) url += '?' + params.join('&');

            // 为全部数据的请求也添加时间戳
            const urlAll = '/usage/aggregated?_t=' + Date.now();

            const [resFiltered, resAll] = await Promise.all([
                fetch(url, { headers: getAuthHeaders() }),
                fetch(urlAll, { headers: getAuthHeaders() })
            ]);
            const data = await resFiltered.json();
            const dataAll = await resAll.json();
            const ls = data.log_summary || { models: {}, keys: {}, total: {} };
            const lsAll = dataAll.log_summary || { models: {}, keys: {}, total: {} };
            renderLogSummary(ls);
            // 下拉选项始终用未过滤数据填充，避免只剩一个选项
            populateModelFilter(lsAll);
            populateKeyFilter(lsAll);
            renderModelRanking(ls);
            // 更新环形图数据和渲染
            distributionData = lsAll;
            updateDistributionKeyFilter();
            distributionLegendPage = 1;
            renderDistributionChart();
        }

        function populateModelFilter(data) {
            const sel = document.getElementById('modelFilter');
            const prev = sel.value;
            sel.innerHTML = '';
            const opt0 = document.createElement('option');
            opt0.value = '';
            opt0.textContent = '全部模型';
            sel.appendChild(opt0);
            Object.keys(data.models || {}).forEach(m => {
                const opt = document.createElement('option');
                opt.value = m;
                opt.textContent = m;
                sel.appendChild(opt);
            });
            sel.value = prev;
        }

        function populateKeyFilter(data) {
            const sel = document.getElementById('keyFilter');
            const prev = sel.value;
            sel.innerHTML = '';
            const opt0 = document.createElement('option');
            opt0.value = '';
            opt0.textContent = '全部密钥';
            sel.appendChild(opt0);
            Object.keys(data.keys || {}).forEach(k => {
                const opt = document.createElement('option');
                opt.value = k;
                opt.textContent = k;
                sel.appendChild(opt);
            });
            sel.value = prev;
        }

        function renderLogSummary(data) {
            const mDiv = document.getElementById('logSummaryModels');
            const kDiv = document.getElementById('logSummaryKeys');
            const models = data.models || {};
            const keys = data.keys || {};
            let mHtml = '<div class="table-responsive"><table class="table"><thead><tr><th>模型</th><th>成功</th><th>失败</th></tr></thead><tbody>';
            Object.entries(models).forEach(([m, v]) => {
                mHtml += `<tr><td>${m}</td><td>${v.ok || 0}</td><td>${v.fail || 0}</td></tr>`;
            });
            mHtml += '</tbody></table></div>';
            let kHtml = '<div class="table-responsive"><table class="table"><thead><tr><th>密钥</th><th>成功</th><th>失败</th><th style="width:50px;">操作</th></tr></thead><tbody>';
            Object.entries(keys).forEach(([kk, v]) => {
                const totalCalls = (v.ok || 0) + (v.fail || 0);
                const clearBtn = totalCalls > 0 ?
                    `<button class="btn btn-sm" style="background:#6c757d; padding:2px 6px; font-size:10px;" onclick="resetKeyStats('${kk}')" title="清除">清除</button>` :
                    '-';
                kHtml += `<tr><td title="${kk}">${kk}</td><td>${v.ok || 0}</td><td>${v.fail || 0}</td><td>${clearBtn}</td></tr>`;
            });
            kHtml += '</tbody></table></div>';
            mDiv.innerHTML = mHtml;
            kDiv.innerHTML = kHtml;
        }

        // 模型排行分页状态
        let rankingCurrentPage = 1;
        const rankingPageSize = 12;
        let rankingAllEntries = [];

        // 柱状图颜色列表（柔和的彩色）
        const RANKING_COLORS = [
            '#f8bbd0', '#e1bee7', '#d1c4e9', '#c5cae9', '#bbdefb',
            '#b3e5fc', '#b2ebf2', '#b2dfdb', '#c8e6c9', '#dcedc8',
            '#f0f4c3', '#fff9c4', '#ffecb3', '#ffe0b2', '#ffccbc',
            '#d7ccc8', '#cfd8dc', '#f48fb1', '#ce93d8', '#b39ddb'
        ];

        function renderModelRanking(data) {
            const only = document.getElementById('onlyFilter').value || '';
            const models = data.models || {};
            rankingAllEntries = Object.entries(models).map(([name, v]) => {
                const ok = v.ok || 0;
                const fail = v.fail || 0;
                const count = only === 'success' ? ok : (only === 'fail' ? fail : (ok + fail));
                return { name, ok, fail, count };
            }).filter(e => e.count > 0);
            rankingAllEntries.sort((a, b) => b.count - a.count);
            rankingCurrentPage = 1;
            renderRankingPage();
        }

        function renderRankingPage() {
            const container = document.getElementById('modelRanking');
            if (!container) return;

            const entries = rankingAllEntries;
            const totalEntries = entries.length;
            const total = entries.reduce((sum, e) => sum + e.count, 0);

            if (totalEntries === 0) {
                container.innerHTML = `<div class="ranking-header">
                    <div class="ranking-title">模型调用次数排行</div>
                    <div class="ranking-total">总计: 0</div>
                </div>
                    <div style="text-align:center; color:var(--text-secondary); padding:40px 0;">暂无数据</div>`;
                return;
            }

            const pageEntries = entries; // 显示所有条目
            const pageMax = Math.max(1, ...pageEntries.map(e => e.count));
            const maxBarHeight = 160;

            // 计算Y轴刻度 - 确保比最大值多留一个刻度空余
            const yTicks = [];
            let yMax, step;
            if (pageMax <= 5) {
                // 小数值：最大值+1
                yMax = pageMax + 1;
                for (let i = yMax; i >= 0; i--) yTicks.push(i);
            } else if (pageMax <= 50) {
                // 中小数值：步长10
                step = 10;
                yMax = Math.ceil(pageMax / step) * step + step;
                for (let i = yMax; i >= 0; i -= step) yTicks.push(i);
            } else if (pageMax <= 500) {
                // 中等数值：步长100
                step = 100;
                yMax = Math.ceil(pageMax / step) * step + step;
                for (let i = yMax; i >= 0; i -= step) yTicks.push(i);
            } else {
                // 大数值：动态计算合适步长
                const magnitude = Math.pow(10, Math.floor(Math.log10(pageMax)));
                step = Math.ceil(pageMax / magnitude / 4) * magnitude;
                yMax = Math.ceil(pageMax / step) * step + step;
                for (let i = yMax; i >= 0; i -= step) yTicks.push(i);
            }
            const chartMax = yMax;

            // 计算跳跃式X轴标签间隔（确保标签不重叠，每个标签约需5个柱子宽度）
            // 最少间隔5，最多显示约6个标签
            const labelInterval = Math.max(5, Math.ceil(totalEntries / 6));

            let html = `<div class="ranking-header">
                <div class="ranking-title">模型调用次数排行</div>
                <div class="ranking-total">总计: ${total}</div>
            </div>`;

            html += `<div class="ranking-body">`;

            // Y轴
            html += `<div class="ranking-y-axis">`;
            yTicks.forEach(v => { html += `<span>${v}</span>`; });
            html += `</div>`;

            // 图表区域
            let gridLinesHtml = '';
            for (let i = 0; i < yTicks.length; i++) gridLinesHtml += '<div class="ranking-grid-line"></div>';

            html += `<div class="ranking-chart-area">
                    <div class="ranking-chart-wrapper">
                        <div class="ranking-grid-lines">${gridLinesHtml}</div>
                        <div class="ranking-chart" id="rankingChartBars">`;

            pageEntries.forEach((e, idx) => {
                const barHeight = Math.max(2, Math.round((e.count / chartMax) * maxBarHeight));
                const color = RANKING_COLORS[idx % RANKING_COLORS.length];
                html += `<div class="ranking-bar-group" data-idx="${idx}" data-name="${e.name}" data-count="${e.count}" data-color="${color}">
                                <div class="ranking-bar-col" style="height:${barHeight}px; background:${color};"></div>
                            </div>`;
            });

            html += `</div></div>`;

            // X轴标签 - 跳跃式显示
            html += `<div class="ranking-x-labels">`;
            pageEntries.forEach((e, idx) => {
                const showLabel = idx % labelInterval === 0;
                html += `<div class="ranking-x-label" title="${e.name}">${showLabel ? e.name : ''}</div>`;
            });
            html += `</div></div>`;

            html += `</div>`; // ranking-body 闭合

            // 图例分页
            const legendPageSize = 12;
            const legendTotalPages = Math.ceil(totalEntries / legendPageSize);
            const legendCurrentPage = window.rankingLegendPage || 1;
            const legendStart = (legendCurrentPage - 1) * legendPageSize;
            const legendEntries = entries.slice(legendStart, legendStart + legendPageSize);

            html += `<div class="ranking-legend-wrapper">`;
            if (legendTotalPages > 1) {
                html += `<div class="ranking-legend-pager">
                    <button class="ranking-legend-pager-btn" onclick="changeLegendPage(-1)" ${legendCurrentPage <= 1 ? 'disabled' : ''}>▲</button>
                    <span>${legendCurrentPage}/${legendTotalPages}</span>
                    <button class="ranking-legend-pager-btn" onclick="changeLegendPage(1)" ${legendCurrentPage >= legendTotalPages ? 'disabled' : ''}>▼</button>
                </div>`;
            }
            html += `<div class="ranking-legend-bar" style="margin-top:0; padding-top:0; border-top:none; padding-right:${legendTotalPages > 1 ? '40px' : '0'};">`;
            legendEntries.forEach((e, idx) => {
                const color = RANKING_COLORS[(legendStart + idx) % RANKING_COLORS.length];
                html += `<div class="ranking-legend-item">
                    <span class="ranking-legend-dot" style="background:${color};"></span>
                    <span>${e.name}</span>
                </div>`;
            });
            html += `</div></div>`;

            container.innerHTML = html;

            // 添加 tooltip 事件
            const chartBars = container.querySelector('#rankingChartBars');
            if (chartBars) {
                let tooltip = null;
                chartBars.addEventListener('mouseover', (e) => {
                    const barGroup = e.target.closest('.ranking-bar-group');
                    if (!barGroup) return;
                    const name = barGroup.dataset.name;
                    const count = barGroup.dataset.count;
                    const color = barGroup.dataset.color;

                    if (!tooltip) {
                        tooltip = document.createElement('div');
                        tooltip.className = 'ranking-tooltip';
                        tooltip.style.position = 'fixed';
                        document.body.appendChild(tooltip);
                    }
                    tooltip.innerHTML = `
                    <div class="ranking-tooltip-title">${name}</div>
                        <div class="ranking-tooltip-row">
                            <span class="ranking-tooltip-dot" style="background:${color};"></span>
                            <span>${name}</span>
                            <span class="ranking-tooltip-count">${count}</span>
                        </div>
                `;
                    const rect = barGroup.getBoundingClientRect();
                    tooltip.style.left = (rect.left + rect.width / 2) + 'px';
                    tooltip.style.top = (rect.top - 10) + 'px';
                    tooltip.style.transform = 'translate(-50%, -100%)';
                    tooltip.style.display = 'block';
                });
                chartBars.addEventListener('mouseout', (e) => {
                    if (!e.target.closest('.ranking-bar-group')) return;
                    if (tooltip) tooltip.style.display = 'none';
                });
            }
        }

        // 图例分页函数
        window.rankingLegendPage = 1;
        function changeLegendPage(delta) {
            const legendTotalPages = Math.ceil(rankingAllEntries.length / 12);
            const newPage = (window.rankingLegendPage || 1) + delta;
            if (newPage >= 1 && newPage <= legendTotalPages) {
                window.rankingLegendPage = newPage;
                renderRankingPage();
            }
        }

        function changeRankingPage(delta) {
            const totalPages = Math.ceil(rankingAllEntries.length / rankingPageSize);
            const newPage = rankingCurrentPage + delta;
            if (newPage >= 1 && newPage <= totalPages) {
                rankingCurrentPage = newPage;
                renderRankingPage();
            }
        }

        // ==================== 模型分布环形图 ====================
        let distributionData = null;
        let distributionLegendPage = 1;
        const DONUT_COLORS = [
            '#f8bbd0', '#ffb74d', '#90caf9', '#a5d6a7', '#ce93d8',
            '#80deea', '#fff176', '#bcaaa4', '#b39ddb', '#81c784',
            '#ff8a65', '#4dd0e1', '#aed581', '#7986cb', '#e57373',
            '#64b5f6', '#dce775', '#ba68c8', '#4db6ac', '#f06292'
        ];

        function updateDistributionKeyFilter() {
            const sel = document.getElementById('distributionKeyFilter');
            if (!sel || !distributionData) return;
            const prev = sel.value;
            sel.innerHTML = '<option value="">所有密钥</option>';
            Object.keys(distributionData.keys || {}).forEach(k => {
                const opt = document.createElement('option');
                opt.value = k;
                opt.textContent = k.length > 20 ? k.substring(0, 8) + '...' + k.substring(k.length - 8) : k;
                sel.appendChild(opt);
            });
            sel.value = prev;
        }

        function renderDistributionChart() {
            const container = document.getElementById('distributionChart');
            if (!container || !distributionData) return;

            const keyFilter = document.getElementById('distributionKeyFilter')?.value || '';
            let models = {};

            if (keyFilter) {
                const keyData = distributionData.keys?.[keyFilter];
                if (keyData && keyData.models) {
                    Object.entries(keyData.models).forEach(([m, c]) => {
                        const ok = c.ok || 0;
                        if (ok > 0) models[m] = (models[m] || 0) + ok;
                    });
                }
            } else {
                Object.values(distributionData.keys || {}).forEach(keyData => {
                    if (keyData.models) {
                        Object.entries(keyData.models).forEach(([m, c]) => {
                            const ok = c.ok || 0;
                            if (ok > 0) models[m] = (models[m] || 0) + ok;
                        });
                    }
                });
            }

            const entries = Object.entries(models)
                .map(([name, count]) => ({ name, count }))
                .sort((a, b) => b.count - a.count);

            const total = entries.reduce((sum, e) => sum + e.count, 0);

            if (total === 0) {
                container.innerHTML = '<div style="text-align:center; color:var(--text-secondary); padding:40px;">暂无数据</div>';
                return;
            }

            // 检测移动端
            const isMobile = window.innerWidth <= 768;

            // 环形图参数 - 移动端使用紧凑的高度，宽度适中
            const width = isMobile ? 280 : 640;
            const height = isMobile ? 240 : 320;
            const cx = width / 2;
            const cy = height / 2;
            const outerRadius = isMobile ? 90 : 90;
            const innerRadius = isMobile ? 55 : 55;
            const gapAngle = 0.05; // 增大间隔角度

            // 计算每个块的角度
            let currentAngle = -Math.PI / 2;
            const segments = entries.map((e, idx) => {
                const angleSize = (e.count / total) * 2 * Math.PI - gapAngle;
                const startAngle = currentAngle;
                const endAngle = currentAngle + angleSize;
                currentAngle = endAngle + gapAngle;
                return {
                    ...e,
                    startAngle,
                    endAngle,
                    midAngle: (startAngle + endAngle) / 2,
                    color: DONUT_COLORS[idx % DONUT_COLORS.length],
                    idx
                };
            });

            // 生成圆弧路径 - 带圆角端点
            function arcPath(startAngle, endAngle, outerR, innerR) {
                // 使用更复杂的路径来实现圆角
                const midR = (outerR + innerR) / 2;
                const thickness = outerR - innerR;
                const cornerR = thickness / 2;

                // 计算圆角端点的位置
                const startMidX = cx + midR * Math.cos(startAngle);
                const startMidY = cy + midR * Math.sin(startAngle);
                const endMidX = cx + midR * Math.cos(endAngle);
                const endMidY = cy + midR * Math.sin(endAngle);

                const x1 = cx + outerR * Math.cos(startAngle);
                const y1 = cy + outerR * Math.sin(startAngle);
                const x2 = cx + outerR * Math.cos(endAngle);
                const y2 = cy + outerR * Math.sin(endAngle);
                const x3 = cx + innerR * Math.cos(endAngle);
                const y3 = cy + innerR * Math.sin(endAngle);
                const x4 = cx + innerR * Math.cos(startAngle);
                const y4 = cy + innerR * Math.sin(startAngle);
                const largeArc = endAngle - startAngle > Math.PI ? 1 : 0;

                // 使用简单路径，通过filter实现圆角
                return `M ${x1} ${y1} A ${outerR} ${outerR} 0 ${largeArc} 1 ${x2} ${y2} L ${x3} ${y3} A ${innerR} ${innerR} 0 ${largeArc} 0 ${x4} ${y4} Z`;
            }

            // 生成圆弧SVG
            let arcsHtml = '';
            segments.forEach((seg, idx) => {
                const path = arcPath(seg.startAngle, seg.endAngle, outerRadius, innerRadius);
                arcsHtml += `<path d="${path}" fill="${seg.color}"
                class="donut-segment" data-idx="${idx}"
                data-name="${seg.name}" data-count="${seg.count}" data-color="${seg.color}"
                style="cursor:pointer; transition: transform 0.2s, filter 0.2s;" />`;
            });

            // 生成标签 - 移动端使用径向分布，桌面端使用左右分布
            let labelsHtml = '';

            if (isMobile) {
                // 移动端：不显示环形图上的标签，只使用下方的图例列表
                // 这样可以避免标签被遮挡的问题
                labelsHtml = '';
            } else {
                // 桌面端：显示外延标签 - 优化折线长度，长名称使用跑马灯滚动
                const labelRadius = outerRadius + 12;  // 折线第一段距离（缩短）
                const textRadius = outerRadius + 18;   // 折线第二段水平距离（缩短）
                const minLabelSpacing = 22;            // 最小间距
                const maxTextWidth = 130;              // 文字显示区域最大宽度

                const allLabels = segments.map((seg, idx) => {
                    const midAngle = seg.midAngle;
                    const isRight = Math.cos(midAngle) >= 0;
                    const idealY = cy + labelRadius * Math.sin(midAngle);
                    return {
                        idx,
                        seg,
                        midAngle,
                        isRight,
                        y: idealY,
                        originalY: idealY
                    };
                });

                const relaxLabels = (labels) => {
                    if (labels.length <= 1) return;
                    labels.sort((a, b) => a.y - b.y);
                    const iterations = 10;
                    for (let iter = 0; iter < iterations; iter++) {
                        let changed = false;
                        for (let i = 0; i < labels.length - 1; i++) {
                            const top = labels[i];
                            const bottom = labels[i + 1];
                            const dist = bottom.y - top.y;
                            if (dist < minLabelSpacing) {
                                const overlap = minLabelSpacing - dist;
                                top.y -= overlap / 2;
                                bottom.y += overlap / 2;
                                changed = true;
                            }
                        }
                        if (!changed) break;
                    }
                };

                const rightLabels = allLabels.filter(l => l.isRight);
                const leftLabels = allLabels.filter(l => !l.isRight);

                relaxLabels(rightLabels);
                relaxLabels(leftLabels);

                [...rightLabels, ...leftLabels].forEach(label => {
                    const { seg, midAngle, isRight, y: finalY, idx } = label;
                    // 第一点：从环形图边缘出发，沿着区块中心角度方向
                    const x1 = cx + (outerRadius + 3) * Math.cos(midAngle);
                    const y1 = cy + (outerRadius + 3) * Math.sin(midAngle);
                    // 第二点：斜向延伸到与标签同一Y高度的位置
                    const bendX = isRight ? cx + outerRadius + 20 : cx - outerRadius - 20;
                    const x2 = bendX;
                    const y2 = finalY;
                    // 第三点：水平延伸到标签位置
                    const x3 = isRight ? cx + textRadius + 10 : cx - textRadius - 10;
                    const y3 = finalY;
                    const textX = isRight ? x3 + 4 : x3 - 4;
                    const textAnchor = isRight ? 'start' : 'end';

                    // 所有标签直接显示，不滚动
                    labelsHtml += `
                        <polyline points="${x1},${y1} ${x2},${y2} ${x3},${y3}" fill="none" stroke="${seg.color}" stroke-width="1.2" opacity="0.6" />
                        <text x="${textX}" y="${y3 + 4}" 
                            text-anchor="${textAnchor}" 
                            fill="${seg.color}" 
                            font-size="12" 
                            font-weight="500"
                            class="donut-label" 
                            data-idx="${idx}">${seg.name}</text>
                    `;
                });
            }

            // 移动端和桌面端共用的布局，区别在于尺寸和标签
            if (isMobile) {
                container.innerHTML = `
                    <div style="width:100%; display:flex; justify-content:center;">
                        <svg width="${width}" height="${height}" viewBox="0 0 ${width} ${height}">
                            <g id="donutArcs">${arcsHtml}</g>
                            <g id="donutLabels">${labelsHtml}</g>
                            <circle cx="${cx}" cy="${cy}" r="${innerRadius - 5}" fill="var(--card-bg)" />
                            <text x="${cx}" y="${cy - 5}" text-anchor="middle" fill="var(--text-color)" font-size="18" font-weight="600">${total}</text>
                            <text x="${cx}" y="${cy + 12}" text-anchor="middle" fill="var(--text-secondary)" font-size="10">总计</text>
                        </svg>
                    </div>
                    <div id="distributionLegendContainer" style="width:100%; display:flex; flex-direction:column;"></div>
                `;
            } else {
                container.innerHTML = `
                    <div style="flex:1; min-width:400px; display:flex; justify-content:center;">
                        <svg width="${width}" height="${height}" viewBox="0 0 ${width} ${height}">
                            <g id="donutArcs">${arcsHtml}</g>
                            <g id="donutLabels">${labelsHtml}</g>
                            <circle cx="${cx}" cy="${cy}" r="${innerRadius - 5}" fill="var(--card-bg)" />
                            <text x="${cx}" y="${cy - 5}" text-anchor="middle" fill="var(--text-color)" font-size="20" font-weight="600">${total}</text>
                            <text x="${cx}" y="${cy + 15}" text-anchor="middle" fill="var(--text-secondary)" font-size="11">总计</text>
                        </svg>
                    </div>
                    <div id="distributionLegendContainer" style="width: 200px; display: flex; flex-direction: column; justify-content: center; height: ${height}px;"></div>
                `;
            }

            // 渲染图例 (for both mobile and desktop)
            renderDistributionLegend(entries);

            // 悬浮效果
            const svg = container.querySelector('svg');
            const segmentEls = svg.querySelectorAll('.donut-segment');
            let tooltip = null;

            segmentEls.forEach(el => {
                el.addEventListener('mouseenter', function () {
                    this.style.transform = `translate(${Math.cos(segments[this.dataset.idx].midAngle) * 8}px, ${Math.sin(segments[this.dataset.idx].midAngle) * 8}px)`;
                    this.style.filter = 'brightness(1.1) drop-shadow(0 2px 6px rgba(0,0,0,0.3))';
                });
                el.addEventListener('mouseleave', function () {
                    this.style.transform = 'none';
                    this.style.filter = 'none';
                });
                el.addEventListener('mousemove', function (e) {
                    const name = this.dataset.name;
                    const count = this.dataset.count;
                    const color = this.dataset.color;
                    const percent = ((count / total) * 100).toFixed(1);
                    if (!tooltip) {
                        tooltip = document.createElement('div');
                        tooltip.className = 'donut-tooltip';
                        tooltip.style.position = 'fixed';
                        document.body.appendChild(tooltip);
                    }
                    tooltip.innerHTML = `<div style="font-weight:500;font-size:13px;margin-bottom:3px;">${name}</div>
                    <div style="display:flex;align-items:center;gap:5px;font-size:12px;">
                        <span style="width:8px;height:8px;border-radius:50%;background:${color};"></span>
                        <span>${count} (${percent}%)</span>
                    </div>`;
                    tooltip.style.left = (e.clientX + 15) + 'px';
                    tooltip.style.top = (e.clientY + 15) + 'px';
                    tooltip.style.display = 'block';
                });
                el.addEventListener('mouseout', function () {
                    if (tooltip) tooltip.style.display = 'none';
                });
            });
        }

        function renderDistributionLegend(entries) {
            const container = document.getElementById('distributionLegendContainer');
            if (!container) return;

            const isMobile = window.innerWidth <= 768;
            const legendPageSize = 7;
            const legendTotalPages = Math.ceil(entries.length / legendPageSize);
            // Ensure current page is valid
            if (distributionLegendPage > legendTotalPages) distributionLegendPage = legendTotalPages || 1;

            const legendStart = (distributionLegendPage - 1) * legendPageSize;
            const legendEntries = entries.slice(legendStart, legendStart + legendPageSize);

            let legendHtml = '<div class="donut-legend" style="flex:1; display:flex; flex-direction:column; justify-content:center;">';
            legendEntries.forEach((e, idx) => {
                const color = DONUT_COLORS[(legendStart + idx) % DONUT_COLORS.length];
                // 长名称需要滚动（移动端>15字符，桌面端>20字符）
                const nameLength = e.name.length;
                const scrollThreshold = isMobile ? 15 : 20;
                const needsScroll = nameLength > scrollThreshold;
                const scrollClass = needsScroll ? 'marquee-scroll' : 'no-scroll';

                // 首尾相连：需要滚动时复制一份文本
                const nameContent = needsScroll
                    ? `<span class="marquee-text">${e.name}</span><span class="marquee-text">${e.name}</span>`
                    : e.name;

                legendHtml += `<div class="donut-legend-item" data-idx="${legendStart + idx}" style="margin: 4px 0;">
                    <span class="donut-legend-dot" style="background:${color};"></span>
                    <span class="donut-legend-name" title="${e.name}">
                        <span class="donut-legend-name-inner ${scrollClass}">${nameContent}</span>
                    </span>
                    <span class="donut-legend-count">${e.count}</span>
                </div>`;
            });
            legendHtml += '</div>';

            if (legendTotalPages > 1) {
                legendHtml += `<div class="donut-legend-pager" style="margin-top:10px; display:flex; justify-content:center; align-items:center; gap:10px;">
                    <button onclick="changeDistributionLegendPage(-1)" ${distributionLegendPage <= 1 ? 'disabled' : ''} style="border:none; background:none; cursor:pointer; padding:4px;">◀</button>
                    <span style="font-size:12px; color:var(--text-secondary);">${distributionLegendPage}/${legendTotalPages}</span>
                    <button onclick="changeDistributionLegendPage(1)" ${distributionLegendPage >= legendTotalPages ? 'disabled' : ''} style="border:none; background:none; cursor:pointer; padding:4px;">▶</button>
                </div>`;
            }

            container.innerHTML = legendHtml;
        }

        function changeDistributionLegendPage(delta) {
            distributionLegendPage += delta;
            // Need to get entries again. Since we don't have them in scope, we need data.
            // We can reuse the logic from renderDistributionChart to get entries or store them globally.
            // renderDistributionChart calculates entries from distributionData.
            // Let's call renderDistributionChart() again? No, that defeats the purpose.
            // We should store the sorted entries or recalculate them efficiently.
            // Or easier: pass renderDistributionChart just for data processing? 
            // Better: update changeDistributionLegendPage to call renderDistributionChart (which is what we wanted to avoid) OR
            // Extract data processing to separate function `getDistributionEntries()` and call that.

            // For now, let's keep it simple: We need the entries.
            // Let's make `currentDistributionEntries` a global variable or attached to window.

            if (typeof window.currentDistributionEntries !== 'undefined') {
                renderDistributionLegend(window.currentDistributionEntries);
            } else {
                // Fallback if data not available (should not happen if flow is correct)
                renderDistributionChart();
            }
        }

        // 渲染使用统计列表
        function renderUsageList() {
            const usageList = document.getElementById('usageList');
            usageList.innerHTML = '';

            if (Object.keys(usageStatsData).length === 0) {
                usageList.innerHTML = '<p style="text-align: center; color: #666;">暂无使用统计数据</p>';
                return;
            }

            for (const [filename, stats] of Object.entries(usageStatsData)) {
                const card = createUsageCard(filename, stats);
                usageList.appendChild(card);
            }
        }

        // 创建使用统计卡片
        function createUsageCard(filename, stats) {
            const div = document.createElement('div');
            div.className = 'usage-card';

            // 计算使用百分比
            const totalPercent = Math.min((stats.total_calls / stats.daily_limit_total) * 100, 100);

            function getTotalProgressClass(percent) {
                if (percent >= 90) return 'danger';
                if (percent >= 70) return 'warning';
                return 'total';
            }

            // 格式化时间
            function formatTime(isoString) {
                if (!isoString) return '未知';
                try {
                    const date = new Date(isoString);
                    return date.toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' });
                } catch (e) {
                    return '格式错误';
                }
            }

            // 格式化显示名称
            let displayName = stats.display_name || filename;
            // 如果是 key:hash 格式，进行脱敏处理
            if (displayName.startsWith('key:') && displayName.length > 20) {
                const hash = displayName.substring(4); // 移除 "key:" 前缀
                displayName = `Key: ${hash.substring(0, 4)}...${hash.substring(hash.length - 4)} `;
            }

            // 根据禁用状态添加样式
            const disabledClass = stats.disabled ? 'usage-card-disabled' : '';
            const disabledBadge = stats.disabled ? '<span class="status-badge" style="background-color: #6c757d; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-left: 8px;">已禁用</span>' : '';

            div.className = `usage-card ${disabledClass}`;

            div.innerHTML = `
                    <div class="usage-header">
                        <div class="usage-filename" style="display: flex; align-items: center;">
                            ${displayName}
                            ${disabledBadge}
                        </div>
                    </div>
                
                <div class="usage-progress">
                    <div class="usage-progress-label">
                        <span>所有模型</span>
                        <span>${stats.total_calls}/${stats.daily_limit_total} (${totalPercent.toFixed(1)}%)</span>
                    </div>
                    <div class="usage-progress-bar">
                        <div class="usage-progress-fill ${getTotalProgressClass(totalPercent)}" style="width: ${totalPercent}%"></div>
                    </div>
                </div>
                
                <div class="usage-info">
                    <div class="usage-info-item" style="grid-column: 1 / -1;">
                        <span class="usage-info-label">下次重置时间</span>
                        <span class="usage-info-value">${formatTime(stats.next_reset_time)}</span>
                    </div>
                </div>
                <div style="margin-top:12px">
                    <div style="font-size:13px; font-weight:600; color:var(--text-secondary); margin-bottom:8px">各模型调用次数</div>
                    <div style="display:flex; gap:6px; flex-wrap:wrap; min-height:24px">
                        ${Object.keys(stats.model_counts || {}).length === 0 ?
                    '<span style="color:#999; font-size:12px">暂无数据</span>' :
                    Object.entries(stats.model_counts || {})
                        .sort((a, b) => b[1] - a[1])  // 按调用次数从大到小排序
                        .map(([m, c]) => {
                            const cat = getModelCategory(m);
                            const colors = getCatColors(cat);
                            return `<span style="display:inline-flex; align-items:center; gap:4px; background:${colors.bg}; color:${colors.text}; padding:4px 10px; border-radius:12px; font-size:12px; border-left:4px solid ${colors.border}">
                                        <span style="font-weight:600; color:${colors.border}">【${c}】</span>
                                        <span>${m}</span>
                                    </span>`;
                        }).join('')
                }
                    </div>
                </div>
                
                <div class="usage-actions">
                    <button class="usage-btn limits" onclick="openLimitsModal('${filename}')">设置限制</button>
                </div>
                `;

            return div;
        }

        // 打开限制设置弹窗
        function openLimitsModal(filename) {
            const stats = usageStatsData[filename];
            if (!stats) {
                showStatus('找不到文件统计数据', 'error');
                return;
            }

            currentEditingFile = filename;
            document.getElementById('modalFilename').value = filename;
            document.getElementById('modalTotalLimit').value = stats.daily_limit_total;
            document.getElementById('limitsModal').style.display = 'block';
        }

        // 关闭限制设置弹窗
        function closeLimitsModal() {
            document.getElementById('limitsModal').style.display = 'none';
            currentEditingFile = '';
        }

        // 保存限制设置
        async function saveLimits() {
            const totalLimit = parseInt(document.getElementById('modalTotalLimit').value);
            if (isNaN(totalLimit) || totalLimit < 1) {
                showStatus('总调用限制必须是大于0的数字', 'error');
                return;
            }

            try {
                const response = await fetch('/usage/update-limits', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        filename: currentEditingFile,
                        total_limit: totalLimit
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showStatus(data.message, 'success');
                    closeLimitsModal();
                    // 刷新统计数据
                    await refreshUsageStats();
                } else {
                    showStatus(`设置失败: ${data.detail || data.error || '未知错误'} `, 'error');
                }
            } catch (error) {
                console.error('saveLimits error:', error);
                showStatus(`网络错误: ${error.message}`, 'error');
            }
        }



        // 关闭弹窗当点击弹窗外部时
        window.onclick = function (event) {
            const modal = document.getElementById('limitsModal');
            if (event.target == modal) {
                closeLimitsModal();
            }
        }


    </script>
    <!-- 模型选择弹窗 -->
    <div id="modelsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">选择模型</h3>
                <button class="modal-close" onclick="closeModelsModal()">&times;</button>
            </div>
            <div class="modal-body" id="modelsModalBody" style="max-height:420px; overflow:auto"></div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModelsModal()" style="background:#6c757d">取消</button>
                <button class="btn" onclick="saveSelectedModels()">确定</button>
            </div>
        </div>
    </div>
    <script>
        // Temperature 和 Max Tokens 滑块更新函数
        function updateTemperatureValue(value) {
            document.getElementById('playgroundTemperatureValue').value = value;
            const slider = document.getElementById('playgroundTemperature');
            const percent = (value / 2) * 100;
            slider.style.background = `linear - gradient(to right, #4285f4 0 %, #4285f4 ${percent} %, #e0e0e0 ${percent} %, #e0e0e0 100 %)`;
            // 实时更新预览
            updateRequestPreview();
        }

        function updateTemperatureSlider(value) {
            const slider = document.getElementById('playgroundTemperature');
            slider.value = value;
            updateTemperatureValue(value);
        }

        function updateMaxTokensValue(value) {
            document.getElementById('playgroundMaxTokensValue').value = value;
            const slider = document.getElementById('playgroundMaxTokens');
            const max = parseInt(slider.max);
            const percent = (value / max) * 100;
            slider.style.background = `linear - gradient(to right, #4285f4 0 %, #4285f4 ${percent} %, #e0e0e0 ${percent} %, #e0e0e0 100 %)`;
            // 实时更新预览
            updateRequestPreview();
        }

        function updateMaxTokensSlider(value) {
            const slider = document.getElementById('playgroundMaxTokens');
            slider.value = value;
            updateMaxTokensValue(value);
        }

        // 根据模型更新 Max Tokens 上限
        function updateMaxTokensLimit(model) {
            const slider = document.getElementById('playgroundMaxTokens');
            const valueInput = document.getElementById('playgroundMaxTokensValue');

            // 优先从 playgroundModelsMeta 获取 max_completion_tokens
            const meta = playgroundModelsMeta[model] || modelMetaFromConfig[model] || (queriedModels.meta || {})[model] || {};
            let maxTokens = parseInt(meta.max_tokens || 0);

            // 如果元数据中没有，使用默认值
            if (!maxTokens || maxTokens <= 0) {
                // 默认回退值
                const defaultLimits = {
                    'claude': 64000,
                    'gpt-5': 128000,
                    'gpt-4': 32768,
                    'gemini': 65535,
                    'default': 8192
                };

                maxTokens = defaultLimits['default'];
                for (const [key, limit] of Object.entries(defaultLimits)) {
                    if (model && model.toLowerCase().includes(key)) {
                        maxTokens = limit;
                        break;
                    }
                }
            }

            slider.max = maxTokens;
            valueInput.max = maxTokens;

            // 如果当前值超过新上限，调整为新上限
            const currentValue = parseInt(slider.value);
            if (currentValue > maxTokens) {
                slider.value = maxTokens;
                valueInput.value = maxTokens;
            }

            // 设置一个合理的默认值（不超过上限的一半或 4096，取较小值）
            const defaultValue = Math.min(4096, Math.floor(maxTokens / 2));
            if (currentValue > maxTokens || currentValue <= 0) {
                slider.value = defaultValue;
                valueInput.value = defaultValue;
            }

            // 始终更新进度条背景以反映新的 max 值
            updateMaxTokensValue(parseInt(slider.value));

            console.log(`Model ${model}: max_tokens limit set to ${maxTokens}, current value: ${slider.value} `);
        }

        async function initPlayground() {
            try {
                await loadModels();
                await loadPlaygroundApiKeys();
                clearMessages();
                addMessageRow('system', 'You are a helpful assistant.');
                addMessageRow('user', 'hello');
                // 初始化后立即显示预览
                await updateRequestPreview();
                showStatus('操练场已就绪', 'success');
            } catch (e) {
                showStatus('加载模型失败: ' + e.message, 'error');
            }
        }

        async function loadPlaygroundApiKeys() {
            try {
                const res = await fetch('/config/get', { headers: getAuthHeaders() });
                const data = await res.json();
                const cfg = data.config || {};
                const apiKeys = cfg.assembly_api_keys || [];

                const keySelect = document.getElementById('playgroundApiKey');
                if (keySelect && Array.isArray(apiKeys)) {
                    keySelect.innerHTML = '<option value="">自动选择（默认）</option>';
                    apiKeys.forEach((key, index) => {
                        if (key && key.trim()) {
                            const opt = document.createElement('option');
                            opt.value = key;
                            // 脱敏显示
                            const masked = key.length > 8 ?
                                key.substring(0, 4) + '...' + key.substring(key.length - 4) :
                                key.substring(0, 2) + '***';
                            opt.textContent = `Key #${index}: ${masked} `;
                            keySelect.appendChild(opt);
                        }
                    });
                }
            } catch (e) {
                console.error('加载 API Keys 失败:', e);
            }
        }

        // 存储从 /v1/models 获取的模型元数据
        let playgroundModelsMeta = {};

        async function loadModels() {
            const sel = document.getElementById('playgroundModel');
            sel.innerHTML = '';
            const res = await fetch('/v1/models', { headers: getAuthHeaders() });
            const data = await res.json();
            const list = (data && data.data) ? data.data : [];

            // 保存模型元数据
            playgroundModelsMeta = {};
            list.forEach(item => {
                const id = item.id || item;
                const opt = document.createElement('option');
                opt.value = id;
                opt.textContent = id;
                sel.appendChild(opt);

                // 保存元数据，包括 max_completion_tokens
                if (typeof item === 'object') {
                    const tp = item.top_provider || {};
                    playgroundModelsMeta[id] = {
                        context_length: tp.context_length || item.context_length,
                        max_tokens: tp.max_completion_tokens || item.max_completion_tokens,
                        default_parameters: item.default_parameters || {}
                    };
                }
            });

            if (!sel.value && list.length > 0) { sel.value = (list[0].id || list[0]); }
            sel.onchange = () => applyModelDefaults(sel.value);
            applyModelDefaults(sel.value);
        }

        function applyModelDefaults(modelId) {
            // 优先使用 playgroundModelsMeta，然后是 modelMetaFromConfig，最后是 queriedModels.meta
            const meta = playgroundModelsMeta[modelId] || modelMetaFromConfig[modelId] || (queriedModels.meta || {})[modelId] || {};

            // 更新 max_tokens 滑块上限
            updateMaxTokensLimit(modelId);

            // 设置默认参数
            const defs = meta.default_parameters || {};
            if (defs && (defs.temperature !== undefined && defs.temperature !== null)) {
                const t = document.getElementById('playgroundTemperature');
                const tv = document.getElementById('playgroundTemperatureValue');
                if (t) {
                    t.value = defs.temperature;
                    if (tv) tv.value = defs.temperature;
                    updateTemperatureValue(defs.temperature);
                }
            }
        }

        function addMessageRow(role = 'user', content = '') {
            const wrap = document.getElementById('playgroundMessages');
            const row = document.createElement('div');
            row.className = 'playground-message-row';

            // 顶部行：类型选择 + 删除按钮
            const topRow = document.createElement('div');
            topRow.className = 'playground-message-top';

            const roleSel = document.createElement('select');
            roleSel.className = 'config-input playground-role-select';
            ['system', 'user', 'assistant', 'tool'].forEach(r => { const o = document.createElement('option'); o.value = r; o.textContent = r; roleSel.appendChild(o); });
            roleSel.value = role;
            roleSel.onchange = () => updateRequestPreview();

            const del = document.createElement('button');
            del.className = 'btn playground-delete-btn';
            del.textContent = '删除';
            del.onclick = () => {
                row.remove();
                updateRequestPreview();
                // 删除后同步高度
                setTimeout(syncToolsCardHeight, 10);
            };

            topRow.appendChild(roleSel);
            topRow.appendChild(del);

            // 内容区域：文本框
            const ta = document.createElement('textarea');
            ta.className = 'config-input playground-message-textarea';
            ta.value = content || '';
            ta.oninput = () => updateRequestPreview();

            row.appendChild(topRow);
            row.appendChild(ta);
            wrap.appendChild(row);
            updateRequestPreview();

            // 添加后同步高度
            setTimeout(syncToolsCardHeight, 10);
        }

        function clearMessages() {
            const wrap = document.getElementById('playgroundMessages');
            wrap.innerHTML = '';
            const out = document.getElementById('playgroundOutputContent');
            const raw = document.getElementById('playgroundRawJson');
            if (out) out.textContent = '';
            if (raw) raw.textContent = '';
            // 清空后更新预览
            updateRequestPreview();
            // 清空后同步高度
            setTimeout(syncToolsCardHeight, 10);
        }

        // 全局变量存储正在进行的测试
        let playgroundTestInProgress = false;
        let playgroundAbortController = null;

        // 预览请求
        async function previewRequest() {
            console.log('previewRequest called');

            const sel = document.getElementById('playgroundModel');
            if (!sel || !sel.value) {
                alert('请先选择模型');
                return;
            }

            const temp = parseFloat(document.getElementById('playgroundTemperature').value) || 0.5;
            const maxT = parseInt(document.getElementById('playgroundMaxTokens').value) || 4096;
            const stream = document.getElementById('playgroundStream')?.checked || false;

            const rows = Array.from(document.querySelectorAll('#playgroundMessages .playground-message-row'));
            let messages = rows.map(r => {
                const selectEl = r.querySelector('select');
                const textareaEl = r.querySelector('textarea');
                if (!selectEl || !textareaEl) return null;
                const role = selectEl.value;
                const content = textareaEl.value;
                return { role, content };
            }).filter(m => m && (m.content || '').trim().length > 0);

            // 如果没有消息，使用默认消息
            if (messages.length === 0) {
                messages = [{ role: 'user', content: 'Hello' }];
            }

            const requestData = {
                model: sel.value,
                messages: messages,
                temperature: temp,
                max_tokens: maxT,
                stream: stream
            };

            // 添加工具定义
            const toolsStr = document.getElementById('playgroundToolsJson')?.value?.trim() || '';
            if (toolsStr) {
                try {
                    requestData.tools = JSON.parse(toolsStr);
                } catch (e) {
                    alert('工具定义 JSON 格式错误: ' + e.message);
                    return;
                }
            }

            console.log('Request data:', requestData);

            try {
                const response = await fetch('/api/playground/preview', {
                    method: 'POST',
                    headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });

                console.log('Response status:', response.status);

                if (response.ok) {
                    const data = await response.json();
                    console.log('Preview data:', data);

                    // 显示预览区域
                    const previewSection = document.getElementById('requestPreviewSection');
                    if (previewSection) {
                        previewSection.style.display = 'block';
                    }

                    const methodEl = document.getElementById('previewMethod');
                    const urlEl = document.getElementById('previewUrl');
                    const headersEl = document.getElementById('previewHeaders');
                    const bodyEl = document.getElementById('previewBody');

                    if (methodEl) methodEl.textContent = data.method || 'POST';
                    if (urlEl) urlEl.textContent = data.url || '';

                    // 格式化请求头
                    if (headersEl) {
                        const headers = { ...data.headers };
                        headersEl.textContent = JSON.stringify(headers, null, 2);
                    }

                    // 格式化请求体（使用 value 而不是 textContent，因为现在是 textarea）
                    if (bodyEl) {
                        bodyEl.value = JSON.stringify(data.body, null, 2);
                        bodyEl.readOnly = true; // 默认只读，点击编辑后可编辑
                    }
                } else {
                    const errorText = await response.text();
                    console.error('Preview error:', errorText);
                    try {
                        const error = JSON.parse(errorText);
                        alert('预览失败: ' + (error.detail || '未知错误'));
                    } catch {
                        alert('预览失败: ' + errorText);
                    }
                }
            } catch (error) {
                console.error('Preview request error:', error);
                alert('预览失败: ' + error.message);
            }
        }

        // 复制请求体
        function copyRequestBody() {
            const body = document.getElementById('previewBody').value;
            navigator.clipboard.writeText(body).then(() => {
                alert('已复制到剪贴板');
            }).catch(err => {
                alert('复制失败: ' + err.message);
            });
        }

        // 编辑请求体
        function editRequestBody() {
            const textarea = document.getElementById('previewBody');
            textarea.readOnly = false;
            textarea.focus();
            alert('现在可以编辑请求体了，编辑完成后点击"发送"按钮');
        }

        // 发送自定义请求
        async function sendCustomRequest() {
            const body = document.getElementById('previewBody').value;

            try {
                const requestData = JSON.parse(body);

                // 使用现有的 sendPlayground 逻辑，但使用自定义的请求体
                const sel = document.getElementById('playgroundModel');
                const selectedKey = document.getElementById('playgroundApiKey')?.value || '';

                const headers = { ...getAuthHeaders(), 'Content-Type': 'application/json' };
                if (selectedKey) {
                    headers['X-API-Key'] = selectedKey;
                }

                const response = await fetch('/v1/chat/completions', {
                    method: 'POST',
                    headers: headers,
                    body: body
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('playgroundOutputContent').textContent = data.choices?.[0]?.message?.content || JSON.stringify(data);
                    document.getElementById('playgroundRawJson').textContent = JSON.stringify(data, null, 2);
                    showStatus('请求成功', 'success');
                } else {
                    const error = await response.text();
                    showStatus('请求失败: ' + error, 'error');
                }
            } catch (e) {
                alert('请求体格式错误或发送失败: ' + e.message);
            }
        }

        async function sendPlayground() {
            // 如果已有测试在进行，提示用户
            if (playgroundTestInProgress) {
                if (!confirm('已有测试正在进行，是否取消并开始新测试？')) {
                    return;
                }
                if (playgroundAbortController) {
                    playgroundAbortController.abort();
                }
            }

            const sel = document.getElementById('playgroundModel');
            const temp = parseFloat(document.getElementById('playgroundTemperatureValue')?.value || document.getElementById('playgroundTemperature').value) || 0.5;
            const maxT = parseInt(document.getElementById('playgroundMaxTokensValue')?.value || document.getElementById('playgroundMaxTokens').value) || 4096;
            const selectedKey = document.getElementById('playgroundApiKey')?.value || '';

            const rows = Array.from(document.querySelectorAll('#playgroundMessages .playground-message-row'));
            const messages = rows.map(r => {
                const role = r.querySelector('select').value;
                const content = r.querySelector('textarea').value;
                return { role, content };
            }).filter(m => (m.content || '').trim().length > 0);

            const body = { model: sel.value, messages, temperature: temp, max_tokens: maxT };
            const toolsStr = document.getElementById('playgroundToolsJson').value.trim();
            if (toolsStr) {
                try {
                    const tools = JSON.parse(toolsStr);
                    body.tools = tools;
                    body.tool_choice = 'auto';
                } catch (e) {
                    showStatus('工具JSON解析失败: ' + e.message, 'error');
                    return;
                }
            }
            const enableStream = !!document.getElementById('playgroundStream')?.checked;
            if (enableStream) body.stream = true;

            try {
                playgroundTestInProgress = true;
                playgroundAbortController = new AbortController();

                collapseAfterSend();
                showStatus('测试进行中...（可切换标签页，测试将在后台继续）', 'info');

                // 如果配置还没有加载，先加载配置
                if (!currentConfig || Object.keys(currentConfig).length === 0) {
                    try {
                        const response = await fetch('/config/get', { method: 'GET', headers: getAuthHeaders() });
                        const data = await response.json();
                        if (response.ok) {
                            currentConfig = data.config || {};
                        }
                    } catch (e) {
                        console.warn('Failed to load config:', e);
                    }
                }

                // 获取正确的 API 访问密码
                // 优先级：通用密码 > API 访问密码 > 控制面板密码（fallback）
                let apiPassword = '';
                if (currentConfig.password) {
                    apiPassword = currentConfig.password;
                } else if (currentConfig.api_password) {
                    apiPassword = currentConfig.api_password;
                } else {
                    apiPassword = authToken;
                }

                // 构建请求头
                const headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiPassword} `
                };
                // 如果选择了特定的 Key，添加到请求头
                if (selectedKey) {
                    headers['X-API-Key'] = selectedKey;
                }

                const res = await fetch('/v1/chat/completions', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(body),
                    signal: playgroundAbortController.signal
                });

                if (!enableStream) {
                    const data = await res.json();
                    if (!res.ok) { throw new Error(data.detail || '请求失败'); }
                    const first = ((data.choices || [])[0] || {});
                    let msg = ((first.message || {}).content);
                    if (Array.isArray(msg)) {
                        msg = msg.map(p => (typeof p === 'string') ? p : (p && (p.text || ''))).join('');
                    }
                    msg = msg || '';

                    // 更新显示区域
                    document.getElementById('playgroundOutputContent').textContent = msg;
                    document.getElementById('playgroundRawJson').textContent = JSON.stringify(data, null, 2);

                    // 显示结果弹窗
                    showPlaygroundResult(msg, data);
                    showStatus('测试完成', 'success');
                } else {
                    const reader = res.body.getReader();
                    const decoder = new TextDecoder('utf-8');
                    let buf = '';
                    const outEl = document.getElementById('playgroundOutputContent');
                    const rawEl = document.getElementById('playgroundRawJson');

                    // 清空之前的内容
                    if (outEl) outEl.textContent = '';
                    if (rawEl) rawEl.textContent = '';

                    let rawBuf = '';
                    let fullMessage = '';
                    let lastData = null;

                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;
                        buf += decoder.decode(value, { stream: true });
                        const parts = buf.split('\n\n');
                        buf = parts.pop();
                        for (const part of parts) {
                            const line = part.trim();
                            if (!line.startsWith('data:')) continue;
                            const payload = line.slice(5).trim();
                            if (payload === '[DONE]') continue;
                            try {
                                const obj = JSON.parse(payload);
                                lastData = obj;
                                const ch = (obj.choices || [])[0] || {};
                                const delta = ch.delta || {};
                                const content = delta.content || '';
                                if (content) {
                                    fullMessage += content;
                                    if (outEl) outEl.textContent += content;
                                }
                                rawBuf += payload + "\n\n";
                                if (rawEl) rawEl.textContent = rawBuf;
                            } catch (e) { }
                        }
                    }

                    // 显示结果弹窗
                    showPlaygroundResult(fullMessage, lastData);
                    showStatus('测试完成', 'success');
                }
            } catch (e) {
                if (e.name === 'AbortError') {
                    showStatus('测试已取消', 'info');
                } else {
                    showStatus('测试失败: ' + e.message, 'error');
                }
            } finally {
                playgroundTestInProgress = false;
                playgroundAbortController = null;
            }
        }

        function showPlaygroundResult(message, data) {
            const modal = document.getElementById('playgroundResultModal');
            const messageEl = document.getElementById('playgroundResultMessage');
            const keyEl = document.getElementById('playgroundResultKey');
            const tokensEl = document.getElementById('playgroundResultTokens');

            if (messageEl) {
                messageEl.textContent = message || '(无返回消息)';
            }

            if (keyEl && data) {
                // 尝试从响应头或数据中获取使用的 Key
                const usedKey = data.key || '系统自动选择';
                keyEl.textContent = usedKey;
            }

            if (tokensEl && data && data.usage) {
                const usage = data.usage;
                tokensEl.textContent = `输入: ${usage.prompt_tokens || 0} tokens, 输出: ${usage.completion_tokens || 0} tokens, 总计: ${usage.total_tokens || 0} tokens`;
            } else {
                tokensEl.textContent = '无 token 使用信息';
            }

            if (modal) {
                modal.style.display = 'block';
            }
        }

        function closePlaygroundResultModal() {
            const modal = document.getElementById('playgroundResultModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // 点击弹窗外部关闭
        window.addEventListener('click', (event) => {
            const modal = document.getElementById('playgroundResultModal');
            if (event.target === modal) {
                closePlaygroundResultModal();
            }
        });

        function toggleSection(id) {
            const el = document.getElementById(id);
            if (!el) return;
            const show = (el.style.display === 'none');
            el.style.display = show ? 'block' : 'none';

            // 更新箭头图标
            const map = {
                'playgroundMessagesWrap': 'playgroundMessagesToggle',
                'playgroundToolsWrap': 'playgroundToolsToggle',
                'requestPreviewWrap': 'requestPreviewToggle'
            };
            const tid = map[id];
            const t = tid ? document.getElementById(tid) : null;
            if (t) t.textContent = show ? '▼' : '▶';

            // 更新卡片折叠状态（用于CSS样式）
            const card = el.closest('.playground-param-card');
            if (card) {
                if (show) {
                    card.classList.remove('collapsed');
                } else {
                    card.classList.add('collapsed');
                }
            }

            // 同步工具定义高度
            syncToolsCardHeight();
        }

        // 同步工具定义卡片高度与会话参数卡片
        function syncToolsCardHeight() {
            const messagesCard = document.querySelector('.playground-messages-card');
            const toolsCard = document.querySelector('.playground-tools-card');
            const toolsTextarea = document.getElementById('playgroundToolsJson');

            if (!messagesCard || !toolsCard || !toolsTextarea) return;

            // 如果任一卡片折叠，不同步高度
            if (messagesCard.classList.contains('collapsed') || toolsCard.classList.contains('collapsed')) {
                toolsTextarea.style.height = '';
                return;
            }

            // 获取会话参数卡片的内容高度
            const messagesContent = document.getElementById('playgroundMessagesWrap');
            if (!messagesContent) return;

            const messagesHeight = messagesContent.offsetHeight;
            const toolsContent = document.getElementById('playgroundToolsWrap');
            if (!toolsContent) return;

            // 计算工具定义textarea需要的高度
            // 减去padding和config-note的高度
            const toolsNote = toolsContent.querySelector('.config-note');
            const noteHeight = toolsNote ? toolsNote.offsetHeight + 6 : 30; // 6是margin-top
            const padding = 24; // 上下padding各12px
            const targetHeight = Math.max(120, messagesHeight - noteHeight - padding);

            toolsTextarea.style.height = targetHeight + 'px';
        }

        function collapseAfterSend() {
            ['playgroundMessagesWrap', 'playgroundToolsWrap', 'requestPreviewWrap'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.style.display = 'none';
                    // 添加折叠状态
                    const card = el.closest('.playground-param-card');
                    if (card) card.classList.add('collapsed');
                }
            });
            const msgToggle = document.getElementById('playgroundMessagesToggle');
            const toolsToggle = document.getElementById('playgroundToolsToggle');
            const previewToggle = document.getElementById('requestPreviewToggle');
            if (msgToggle) msgToggle.textContent = '▶';
            if (toolsToggle) toolsToggle.textContent = '▶';
            if (previewToggle) previewToggle.textContent = '▶';
        }

        function getModelCategory(id) {
            const s = String(id || '');
            if (s.startsWith('claude')) return 'Anthropic';
            if (s.startsWith('gpt') || s.startsWith('chatgpt')) return 'OpenAI';
            if (s.startsWith('gemini')) return 'Google';
            return 'Other';
        }

        // ==================== 请求预览相关函数 ====================

        // 实时更新请求预览
        async function updateRequestPreview() {
            const sel = document.getElementById('playgroundModel');
            if (!sel || !sel.value) {
                // 如果没有选择模型，清空预览
                const bodyEl = document.getElementById('previewBody');
                if (bodyEl) {
                    bodyEl.value = '// 请先选择模型';
                }
                return;
            }

            // 构建请求体
            const temp = parseFloat(document.getElementById('playgroundTemperatureValue')?.value || document.getElementById('playgroundTemperature').value) || 0.5;
            const maxT = parseInt(document.getElementById('playgroundMaxTokensValue')?.value || document.getElementById('playgroundMaxTokens').value) || 4096;
            const selectedKey = document.getElementById('playgroundApiKey')?.value || '';

            const rows = Array.from(document.querySelectorAll('#playgroundMessages .playground-message-row'));
            const messages = rows.map(r => {
                const role = r.querySelector('select')?.value || 'user';
                const content = r.querySelector('textarea')?.value || '';
                return { role, content };
            }).filter(m => (m.content || '').trim().length > 0);

            const body = {
                model: sel.value,
                messages: messages.length > 0 ? messages : [{ role: 'user', content: '(请添加消息)' }],
                temperature: temp,
                max_tokens: maxT
            };

            // 添加工具定义
            const toolsStr = document.getElementById('playgroundToolsJson')?.value?.trim();
            if (toolsStr) {
                try {
                    const tools = JSON.parse(toolsStr);
                    body.tools = tools;
                    body.tool_choice = 'auto';
                } catch (e) {
                    // JSON 解析失败，不添加工具
                }
            }

            // 添加 stream 参数
            const enableStream = !!document.getElementById('playgroundStream')?.checked;
            if (enableStream) body.stream = true;

            // 更新预览
            await showRequestPreview(body, selectedKey);
        }

        async function showRequestPreview(body, selectedKey) {
            const section = document.getElementById('requestPreviewSection');
            if (!section) return;

            // 如果配置还没有加载，先加载配置
            if (!currentConfig || Object.keys(currentConfig).length === 0) {
                try {
                    const response = await fetch('/config/get', { method: 'GET', headers: getAuthHeaders() });
                    const data = await response.json();
                    if (response.ok) {
                        currentConfig = data.config || {};
                    }
                } catch (e) {
                    console.warn('Failed to load config for preview:', e);
                }
            }

            // 显示预览区域
            section.style.display = 'block';

            // 更新 URL
            const urlEl = document.getElementById('previewUrl');
            if (urlEl) {
                urlEl.textContent = window.location.origin + '/v1/chat/completions';
            }

            // 更新请求头
            const headersEl = document.getElementById('previewHeaders');
            if (headersEl) {
                // 获取正确的 API 访问密码
                // 优先级：通用密码 > API 访问密码 > 控制面板密码（fallback）
                let apiPassword = '';
                if (currentConfig.password) {
                    // 如果设置了通用密码，使用通用密码
                    apiPassword = currentConfig.password;
                } else if (currentConfig.api_password) {
                    // 否则使用 API 访问密码
                    apiPassword = currentConfig.api_password;
                } else {
                    // 如果都没有，使用当前登录的 token（控制面板密码，作为 fallback）
                    apiPassword = authToken;
                }

                // 构建请求头：包含 API 访问密码（Authorization）和可选的 API Key
                const headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiPassword} `  // API 访问密码
                };

                // 如果选择了特定的 API Key，添加到请求头
                if (selectedKey) {
                    headers['X-API-Key'] = selectedKey;
                }

                headersEl.textContent = JSON.stringify(headers, null, 2);
            }

            // 更新请求体
            const bodyEl = document.getElementById('previewBody');
            if (bodyEl) {
                bodyEl.value = JSON.stringify(body, null, 2);
                bodyEl.readOnly = true;
                bodyEl.style.backgroundColor = '#1e1e1e';
                bodyEl.style.border = '1px solid var(--border-color)';
            }
        }

        function copyRequestBody() {
            const bodyEl = document.getElementById('previewBody');
            if (!bodyEl) return;

            bodyEl.select();
            document.execCommand('copy');
            showStatus('请求体已复制到剪贴板', 'success');
        }

        function editRequestBody() {
            const bodyEl = document.getElementById('previewBody');
            if (!bodyEl) return;

            // 使请求体可编辑
            bodyEl.readOnly = false;
            bodyEl.style.backgroundColor = '#2d2d2d';
            bodyEl.style.border = '2px solid #4285f4';
            showStatus('请求体现在可编辑，编辑完成后点击"发送"按钮', 'info');
        }

        async function sendCustomRequest() {
            const bodyEl = document.getElementById('previewBody');
            if (!bodyEl) return;

            try {
                const body = JSON.parse(bodyEl.value);

                // 如果已有测试在进行，提示用户
                if (playgroundTestInProgress) {
                    if (!confirm('已有测试正在进行，是否取消并开始新测试？')) {
                        return;
                    }
                    if (playgroundAbortController) {
                        playgroundAbortController.abort();
                    }
                }

                playgroundTestInProgress = true;
                playgroundAbortController = new AbortController();

                collapseAfterSend();
                showStatus('测试进行中...（使用自定义请求体）', 'info');

                // 构建请求头
                const headersEl = document.getElementById('previewHeaders');
                let headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken} `  // API 访问密码
                };

                // 如果用户编辑了请求头，使用编辑后的请求头
                if (headersEl) {
                    try {
                        const customHeaders = JSON.parse(headersEl.textContent);
                        // 合并自定义请求头，但保留 Authorization
                        headers = { ...headers, ...customHeaders };
                    } catch (e) {
                        console.warn('Failed to parse custom headers:', e);
                    }
                }

                const enableStream = !!body.stream;

                const res = await fetch('/v1/chat/completions', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(body),
                    signal: playgroundAbortController.signal
                });

                if (!enableStream) {
                    const data = await res.json();
                    if (!res.ok) { throw new Error(data.detail || '请求失败'); }
                    const first = ((data.choices || [])[0] || {});
                    let msg = ((first.message || {}).content);
                    if (Array.isArray(msg)) {
                        msg = msg.map(p => (typeof p === 'string') ? p : (p && (p.text || ''))).join('');
                    }
                    msg = msg || '';

                    // 更新显示区域
                    document.getElementById('playgroundOutputContent').textContent = msg;
                    document.getElementById('playgroundRawJson').textContent = JSON.stringify(data, null, 2);

                    // 显示结果弹窗
                    showPlaygroundResult(msg, data);
                    showStatus('测试完成', 'success');
                } else {
                    const reader = res.body.getReader();
                    const decoder = new TextDecoder('utf-8');
                    let buf = '';
                    const outEl = document.getElementById('playgroundOutputContent');
                    const rawEl = document.getElementById('playgroundRawJson');

                    // 清空之前的内容
                    if (outEl) outEl.textContent = '';
                    if (rawEl) rawEl.textContent = '';

                    let rawBuf = '';
                    let fullMessage = '';
                    let lastData = null;

                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;
                        buf += decoder.decode(value, { stream: true });
                        const parts = buf.split('\n\n');
                        buf = parts.pop();
                        for (const part of parts) {
                            const line = part.trim();
                            if (!line.startsWith('data:')) continue;
                            const payload = line.slice(5).trim();
                            if (payload === '[DONE]') continue;
                            try {
                                const obj = JSON.parse(payload);
                                lastData = obj;
                                const ch = (obj.choices || [])[0] || {};
                                const delta = ch.delta || {};
                                const content = delta.content || '';
                                if (content) {
                                    fullMessage += content;
                                    if (outEl) outEl.textContent += content;
                                }
                                rawBuf += payload + "\n\n";
                                if (rawEl) rawEl.textContent = rawBuf;
                            } catch (e) { }
                        }
                    }

                    // 显示结果弹窗
                    showPlaygroundResult(fullMessage, lastData);
                    showStatus('测试完成', 'success');
                }
            } catch (e) {
                if (e.name === 'AbortError') {
                    showStatus('测试已取消', 'info');
                } else if (e instanceof SyntaxError) {
                    showStatus('请求体 JSON 格式错误: ' + e.message, 'error');
                } else {
                    showStatus('测试失败: ' + e.message, 'error');
                }
            } finally {
                playgroundTestInProgress = false;
                playgroundAbortController = null;

                // 恢复请求体为只读
                const bodyEl = document.getElementById('previewBody');
                if (bodyEl) {
                    bodyEl.readOnly = true;
                    bodyEl.style.backgroundColor = '#1e1e1e';
                    bodyEl.style.border = '1px solid var(--border-color)';
                }
            }
        }

        function getCatColors(cat) {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const m = isDark ? {
                // 暗黑模式颜色
                Anthropic: { bg: 'rgba(111, 66, 193, 0.2)', border: '#9f7aea', text: '#d6bcfa' },
                OpenAI: { bg: 'rgba(31, 111, 235, 0.2)', border: '#63b3ed', text: '#90cdf4' },
                Google: { bg: 'rgba(43, 147, 72, 0.2)', border: '#68d391', text: '#9ae6b4' },
                Other: { bg: 'rgba(160, 160, 160, 0.2)', border: '#a0aec0', text: '#cbd5e0' }
            } : {
                // 亮色模式颜色
                Anthropic: { bg: '#f2e9ff', border: '#6f42c1', text: '#4b2e83' },
                OpenAI: { bg: '#e7f0ff', border: '#1f6feb', text: '#1f3f8a' },
                Google: { bg: '#e8f7ee', border: '#2b9348', text: '#1f6b2e' },
                Other: { bg: '#eee', border: '#999', text: '#555' }
            };
            return m[cat] || m.Other;
        }

        function formatTokensShort(v) {
            const n = parseInt(v || 0);
            if (!n || n <= 0) return '-';
            if (n >= 1000000) return Math.round(n / 1000000) + 'm';
            if (n >= 1000) return Math.round(n / 1000) + 'k';
            return String(n);
        }

        function renderSelectedModelsChips() {
            const wrap = document.getElementById('selectedModelsChips');
            if (!wrap) return;
            wrap.innerHTML = '';
            selectedModels.forEach(m => {
                const chip = document.createElement('span');
                const cat = getModelCategory(m);
                const colors = getCatColors(cat);
                const meta = (modelMetaFromConfig[m] || (queriedModels.meta || {})[m] || {});
                const ctx = formatTokensShort(meta.context_length);
                chip.className = 'badge model-chip';
                // 使用与使用统计相同的样式
                chip.style = `display:inline-flex; align-items:center; gap:4px; background:${colors.bg}; color:${colors.text}; padding:4px 10px; border-radius:12px; margin:2px; font-size:12px; border-left:4px solid ${colors.border}; transition:all 0.2s ease;`;
                chip.innerHTML = `<span>${m}</span><span class="model-ctx" style="font-size:11px; color:${colors.text}; opacity:0.7;">${ctx}</span>`;
                wrap.appendChild(chip);
            });
        }

        async function loadSelectedModelsFromConfig() {
            try {
                const res = await fetch('/config/all', { headers: getAuthHeaders() });
                const data = await res.json();
                const cfg = data.config || {};
                const sel = cfg.available_models_selected || [];
                selectedModels = Array.isArray(sel) ? sel : [];
                modelMetaFromConfig = cfg.available_models_meta || {};
                renderSelectedModelsChips();
            } catch (e) {
                // ignore
            }
        }

        async function queryModels() {
            try {
                const res = await fetch('/models/query', { headers: getAuthHeaders() });
                const data = await res.json();
                queriedModels = { grouped: data.grouped || {}, models: data.models || [], meta: data.meta || {} };
                openModelsModal();
            } catch (e) {
                showStatus('获取模型列表失败: ' + e.message, 'error');
            }
        }

        function openModelsModal() {
            const modal = document.getElementById('modelsModal');
            const body = document.getElementById('modelsModalBody');
            if (!modal || !body) return;
            const groups = queriedModels.grouped || {};
            const ordered = ['Anthropic', 'OpenAI', 'Google', 'Other'];
            let html = '';
            ordered.forEach(cat => {
                const items = groups[cat] || [];
                const colors = getCatColors(cat);
                html += `<div style="margin:8px 0"><div style="font-weight:600; margin-bottom:6px; color:${colors.text}">${cat} (${items.length})</div>`;
                items.forEach(m => {
                    const checked = selectedModels.includes(m) ? 'checked' : '';
                    const mt = (queriedModels.meta || {})[m] || {};
                    const ctx = formatTokensShort(mt.context_length);
                    const mx = mt.max_tokens ? (mt.max_tokens >= 1000 ? Math.round(mt.max_tokens / 1000) + 'k' : mt.max_tokens) : '-';
                    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                    const metaColor = isDark ? 'rgba(255,255,255,0.5)' : '#666';
                    html += `<label style="display:inline-flex; align-items:center; gap:6px; margin:4px 8px 4px 0; padding:4px 8px; border-left:4px solid ${colors.border}; background:${colors.bg}; border-radius:8px"><input type="checkbox" class="model-check" value="${m}" ${checked}/> <span style="color:${colors.text}">${m}</span><span style="color:${metaColor}; font-size:12px">(ctx:${ctx}, max:${mx})</span></label>`;
                });
                html += `</div>`;
            });
            body.innerHTML = html || '<div>未查询到模型</div>';
            modal.style.display = 'block';
        }

        function closeModelsModal() {
            const modal = document.getElementById('modelsModal');
            if (modal) modal.style.display = 'none';
        }

        function collectCheckedModels() {
            const checks = Array.from(document.querySelectorAll('.model-check'));
            return checks.filter(c => c.checked).map(c => c.value);
        }

        async function fillAllModels() {
            try {
                if (!queriedModels.models || queriedModels.models.length === 0) {
                    const res = await fetch('/models/query', { headers: getAuthHeaders() });
                    const data = await res.json();
                    queriedModels = { grouped: data.grouped || {}, models: data.models || [], meta: data.meta || {} };
                }
                selectedModels = Array.from(new Set([...(queriedModels.models || [])]));
                renderSelectedModelsChips();
                const res2 = await fetch('/models/save', { method: 'POST', headers: getAuthHeaders(), body: JSON.stringify({ selected_models: selectedModels }) });
                const data2 = await res2.json();
                if (res2.ok) {
                    showStatus(`已保存 ${data2.saved_count} 个模型`, 'success');
                } else {
                    showStatus(`保存失败: ${data2.detail || data2.error || '未知错误'} `, 'error');
                }
            } catch (e) {
                showStatus('填充失败: ' + e.message, 'error');
            }
        }

        function clearSelectedModels() {
            selectedModels = [];
            renderSelectedModelsChips();
        }

        async function saveSelectedModels() {
            // 如果弹窗打开，优先从弹窗勾选收集
            const modal = document.getElementById('modelsModal');
            if (modal && modal.style.display === 'block') {
                selectedModels = collectCheckedModels();
            }
            try {
                const res = await fetch('/models/save', { method: 'POST', headers: getAuthHeaders(), body: JSON.stringify({ selected_models: selectedModels }) });
                const data = await res.json();
                if (res.ok) {
                    renderSelectedModelsChips();
                    closeModelsModal();
                    showStatus(`已保存 ${data.saved_count} 个模型`, 'success');
                } else {
                    showStatus(`保存失败: ${data.detail || data.error || '未知错误'} `, 'error');
                }
            } catch (e) {
                showStatus('保存失败: ' + e.message, 'error');
            }
        }

        // ==================== 账户管理相关函数 ====================
        let accountSessionData = null;
        let currentAccountSubTab = 'overview';
        let currentAccountEmail = null;  // 当前选中的账户邮箱
        let accountsList = [];  // 账户列表
        const ACCOUNT_CACHE_TTL_MS = 5 * 60 * 1000;
        let accountAutoRefreshTimer = null;
        const accountCache = {
            info: { ts: 0, html: '' },
            apiKeys: { ts: 0, html: '' },  // API keys 独立缓存
            billing: { ts: 0, html: '' },
            usage: {},  // key: dateParams -> { ts, html }
            cost: {},   // key: dateParams|group_by -> { ts, html }
            rates: { ts: 0, html: '' }
        };
        function isFresh(ts) { return !!ts && (Date.now() - ts) < ACCOUNT_CACHE_TTL_MS; }
        function startAccountAutoRefresh() {
            if (accountAutoRefreshTimer) clearInterval(accountAutoRefreshTimer);
            accountAutoRefreshTimer = setInterval(() => {
                if (currentAccountSubTab === 'overview') {
                    loadAccountInfo(true);
                    loadAccountBilling(true);
                    loadAccountApiKeys(false); // 非强制刷新，使用缓存或后台更新
                } else if (currentAccountSubTab === 'usage') {
                    loadAccountUsage(true);
                } else if (currentAccountSubTab === 'cost') {
                    loadAccountCost(true);
                } else if (currentAccountSubTab === 'rates') {
                    loadAccountRates(true);
                }
            }, ACCOUNT_CACHE_TTL_MS);
        }

        // 初始化账户管理标签页
        async function initAccountTab() {
            await checkAccountSession();
        }

        // 加载账户列表
        // skipSubTabSwitch: 如果为 true，则不触发 switchAccountSubTab（用于切换账号时避免重复加载）
        async function loadAccountsList(skipSubTabSwitch = false) {
            try {
                const res = await fetch('/api/account/accounts', { headers: getAuthHeaders() });
                const data = await res.json();
                if (res.ok && data.accounts) {
                    accountsList = data.accounts;
                    currentAccountEmail = data.current_account;
                    renderAccountsList();
                    if (!skipSubTabSwitch) {
                        if (currentAccountEmail) {
                            // 如果有当前账户，显示账户详情
                            document.getElementById('accountDetailsSection').classList.remove('hidden');
                            switchAccountSubTab('overview');
                        } else {
                            // 如果没有当前账户，隐藏详情区域
                            document.getElementById('accountDetailsSection').classList.add('hidden');
                        }
                    }
                }
            } catch (e) {
                console.error('Load accounts list failed:', e);
            }
        }

        // 显示添加账户表单
        function showAddAccountForm() {
            const form = document.getElementById('addAccountForm');
            if (form) {
                form.classList.remove('hidden');
                // 清空输入框
                document.getElementById('newAccountEmail').value = '';
                document.getElementById('newAccountPassword').value = '';
                // 聚焦到邮箱输入框
                setTimeout(() => document.getElementById('newAccountEmail').focus(), 100);
            }
        }

        // 隐藏添加账户表单
        function hideAddAccountForm() {
            const form = document.getElementById('addAccountForm');
            if (form) {
                form.classList.add('hidden');
            }
        }

        // 添加新账户
        async function addNewAccount() {
            const email = document.getElementById('newAccountEmail').value.trim();
            const password = document.getElementById('newAccountPassword').value;

            if (!email || !password) {
                showAccountStatus('请输入邮箱和密码', 'error');
                return;
            }

            // 检查是否已存在该账户
            if (accountsList.some(acc => acc.email === email)) {
                showAccountStatus('该账户已存在，请勿重复添加', 'error');
                return;
            }

            showAccountStatus('正在添加账户...', 'info');
            try {
                const res = await fetch('/api/account/login', {
                    method: 'POST',
                    headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();
                if (res.ok && data.success) {
                    showAccountStatus('账户添加成功', 'success');
                    // 清空表单
                    document.getElementById('newAccountEmail').value = '';
                    document.getElementById('newAccountPassword').value = '';
                    // 隐藏表单
                    hideAddAccountForm();
                    // 重新加载账户列表
                    await loadAccountsList();
                    // 如果这是第一个账户，自动切换并显示详情
                    if (accountsList.length === 1 && !currentAccountEmail) {
                        await switchAccount(email);
                    }
                } else {
                    showAccountStatus(data.detail || '添加账户失败', 'error');
                }
            } catch (e) {
                showAccountStatus('添加账户失败: ' + e.message, 'error');
            }
        }

        // 渲染账户列表
        function renderAccountsList() {
            const container = document.getElementById('accountListContainer');

            if (!container) return;

            if (accountsList.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">暂无已登录的账户，点击上方"添加账户"按钮添加第一个账户</p>';
                return;
            }

            // 显示账户列表
            let html = '<div style="display: grid; gap: 12px;">';
            accountsList.forEach(account => {
                const isCurrent = account.email === currentAccountEmail;
                // 转义邮箱中的特殊字符，防止XSS
                const safeEmail = account.email.replace(/'/g, "\\'").replace(/"/g, "&quot;");
                // 已选中账户添加脉冲动画效果
                const selectedStyle = isCurrent ? 'animation: selectedAccountPulse 2s ease-in-out infinite; box-shadow: 0 0 12px rgba(66, 133, 244, 0.4);' : '';
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--card-bg); border-radius: 8px; border: 2px solid ${isCurrent ? '#4285f4' : 'var(--border-color)'}; ${selectedStyle}">
                        <div>
                            <div style="font-weight: 600; color: var(--text-color); font-size: 14px;">${account.email}</div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                                类型: ${account.customer_type || 'PAYG'}
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            ${isCurrent ? '<span style="color: #4285f4; font-size: 12px; font-weight: 600;">当前</span>' : ''}
                            <button class="btn btn-sm" onclick="switchAccount('${safeEmail}')" style="background: ${isCurrent ? '#6c757d' : '#4285f4'};">
                                ${isCurrent ? '已选中' : '切换'}
                            </button>
                            <button class="btn btn-sm" onclick="accountLogout('${safeEmail}')" style="background: #dc3545;">登出</button>
                        </div>
                    </div>
                    `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        // 在账户列表为空时，也显示添加账户按钮的提示
        function updateAddAccountButtonVisibility() {
            // 按钮已经在账户列表区域顶部，始终可见
        }

        // 切换账户
        async function switchAccount(email) {
            if (!email) {
                email = document.getElementById('accountSelector')?.value;
            }
            if (!email) {
                showAccountStatus('请选择账户', 'error');
                return;
            }

            // 立即清空页面显示内容，显示加载状态（避免显示旧账号数据）
            // 在 API 调用之前就清空，确保用户不会看到旧数据
            const infoEl = document.getElementById('accountInfoContent');
            const balanceEl = document.getElementById('accountBalanceContent');
            const usageEl = document.getElementById('accountUsageContent');
            const costEl = document.getElementById('accountCostContent');
            const ratesEl = document.getElementById('accountRatesContent');
            const apiKeysEl = document.getElementById('apiKeysSection');
            if (infoEl) infoEl.innerHTML = getOverviewLoadingHTML();
            if (balanceEl) balanceEl.innerHTML = getBillingLoadingHTML();
            if (usageEl) usageEl.innerHTML = getUsageLoadingHTML();
            if (costEl) costEl.innerHTML = getCostLoadingHTML();
            if (ratesEl) ratesEl.innerHTML = getRatesLoadingHTML();
            if (apiKeysEl) apiKeysEl.innerHTML = '<div class="loading-spinner"><div class="spinner"></div><div class="spinner-text">正在加载 API Keys...</div></div>';

            // 清空缓存，防止从缓存读取旧数据
            accountCache.info = { ts: 0, html: '' };
            accountCache.apiKeys = { ts: 0, html: '' };
            accountCache.billing = { ts: 0, html: '' };
            accountCache.usage = {};
            accountCache.cost = {};
            accountCache.rates = { ts: 0, html: '' };

            // 强制浏览器重绘，确保加载状态立即显示
            await new Promise(resolve => requestAnimationFrame(() => requestAnimationFrame(resolve)));

            try {
                const res = await fetch('/api/account/switch', {
                    method: 'POST',
                    headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email })
                });

                if (!res.ok) {
                    const errorData = await res.json().catch(() => ({ detail: `HTTP ${res.status}: ${res.statusText} ` }));
                    showAccountStatus(errorData.detail || `切换账户失败: HTTP ${res.status} `, 'error');
                    return;
                }

                const data = await res.json();
                if (data.success) {
                    currentAccountEmail = email;

                    // 重置成本筛选器状态
                    costFilterState.initialized = false;

                    // 显示账户详情并切换到概览（但不触发数据加载，由下面的并发加载统一处理）
                    document.getElementById('accountDetailsSection').classList.remove('hidden');

                    // 先设置子标签页状态，但不触发加载
                    currentAccountSubTab = 'overview';
                    const tabs = ['overview', 'usage', 'cost', 'rates'];
                    tabs.forEach(t => {
                        const el = document.getElementById('accountSub' + t.charAt(0).toUpperCase() + t.slice(1));
                        const btn = document.getElementById('accountSubTab' + t.charAt(0).toUpperCase() + t.slice(1));
                        if (el) el.classList.toggle('hidden', t !== 'overview');
                        if (btn) btn.style.background = (t === 'overview') ? '#4285f4' : '#6c757d';
                    });

                    // 使用合并的 overview API 减少请求数量（1个请求代替3个）
                    // 同时并发加载 usage、cost、rates
                    console.log('Starting parallel data loading for account:', email);
                    const startTime = Date.now();

                    // 使用 Promise.allSettled 来跟踪所有请求的完成情况
                    // overview API 合并了 info + billing + apiKeys
                    // 切换账户时优先使用预加载缓存，减少等待时间
                    Promise.allSettled([
                        loadAccountsList(true),
                        loadAccountOverviewData(false),  // 合并的 info + billing + apiKeys，优先使用缓存
                        loadAccountUsage(false, true),   // 优先使用缓存
                        loadAccountCost(false, true),    // 优先使用缓存
                        loadAccountRates(false, true)    // 优先使用缓存
                    ]).then(results => {
                        const elapsed = Date.now() - startTime;
                        console.log(`All data loading completed in ${elapsed} ms`, results.map((r, i) => ({
                            index: i,
                            status: r.status,
                            reason: r.status === 'rejected' ? r.reason?.message : undefined
                        })));
                    });

                    // 启动自动刷新
                    startAccountAutoRefresh();

                    // 延迟刷新其他管理页面，避免占用浏览器连接池
                    // 等待 2 秒后再刷新，让主要的账户数据请求先完成
                    setTimeout(() => {
                        try {
                            // 1. 凭证管理（文件管理）
                            if (typeof refreshCredsStatus === 'function') {
                                refreshCredsStatus(true); // silent=true
                            }
                            // 2. 配置管理
                            if (typeof loadConfig === 'function') {
                                loadConfig(true); // silent=true
                            }
                            // 3. 使用统计
                            if (typeof refreshUsageStats === 'function') {
                                refreshUsageStats(true); // silent=true
                            }
                            // 4. 速率限制
                            if (typeof loadRateLimits === 'function') {
                                loadRateLimits(); // 静默调用
                            }
                            // 5. 多密钥管理（如果弹窗已打开，则刷新）
                            const keyModal = document.getElementById('keyManagementModal');
                            if (keyModal && keyModal.style.display === 'block' && typeof loadKeyManagementModal === 'function') {
                                loadKeyManagementModal();
                            }
                        } catch (e) {
                            console.warn('刷新管理页面时出错:', e);
                        }
                    }, 2000);
                } else {
                    showAccountStatus(data.detail || data.message || '切换账户失败', 'error');
                }
            } catch (e) {
                console.error('Switch account error:', e);
                showAccountStatus('切换账户失败: ' + (e.message || String(e)), 'error');
            }
        }

        // 检查账户登录状态
        // 加载概览数据（合并 info + billing + apiKeys，减少请求数量）
        async function loadAccountOverviewData(force = false) {
            if (!currentAccountEmail) return;

            try {
                const params = new URLSearchParams();
                if (force) params.append('force', '1');
                params.append('account_email', currentAccountEmail);

                console.log('Loading overview data for:', currentAccountEmail);
                const res = await fetch('/api/account/overview?' + params.toString(), { headers: getAuthHeaders() });
                if (!res.ok) throw new Error('加载概览数据失败');
                const data = await res.json();
                console.log('Overview data received:', data);

                // 更新 info 缓存和显示
                if (data.info) {
                    const infoHtml = `
                    <div style="display: grid; gap: 12px;">
                            <div><strong>邮箱:</strong> ${data.info.email || '-'}</div>
                            <div><strong>账户 ID:</strong> ${data.info.id || '-'}</div>
                            <div><strong>类型:</strong> ${data.info.customer_type || '-'}</div>
                            <div><strong>创建时间:</strong> ${data.info.created ? new Date(data.info.created).toLocaleDateString() : '-'}</div>
                            <div><strong>支付方式:</strong> ${data.info.cc_brand ? data.info.cc_brand.toUpperCase() + ' ****' + data.info.cc_last4 : '未设置'}</div>
                            <div id="apiKeysSection" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);"></div>
                        </div>
                    `;
                    accountCache.info = { ts: Date.now(), html: infoHtml };
                    const infoEl = document.getElementById('accountInfoContent');
                    if (infoEl) infoEl.innerHTML = infoHtml;
                }

                // 更新 billing 缓存和显示
                if (data.billing) {
                    const balance = data.billing.balance || 0;
                    const totalSpend = data.billing.total_spend_30_days || 0;
                    let billingHtml = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px;">';
                    billingHtml += '<div style="text-align: center; padding: 24px; background: linear-gradient(135deg, var(--card-bg) 0%, rgba(255,77,77,0.05) 100%); border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 4px 15px rgba(255,77,77,0.1);">';
                    billingHtml += '<div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px;">当前余额</div>';
                    billingHtml += '<div class="balance-amount" style="font-size: 36px; font-weight: bold;">$' + balance.toFixed(5) + '</div>';
                    billingHtml += '</div>';
                    billingHtml += '<div style="text-align: center; padding: 24px; background: linear-gradient(135deg, var(--card-bg) 0%, rgba(40,167,69,0.05) 100%); border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 4px 15px rgba(40,167,69,0.1);">';
                    billingHtml += '<div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px;">30天消费</div>';
                    billingHtml += '<div class="spend-amount" style="font-size: 36px; font-weight: bold;">$' + totalSpend.toFixed(5) + '</div>';
                    billingHtml += '</div></div>';
                    billingHtml += '<div style="margin-top: 16px; text-align: center;">';
                    billingHtml += '<a href="https://www.assemblyai.com/dashboard/account/billing" target="_blank" class="btn btn-sm" style="background: linear-gradient(135deg, #17a2b8, #138496); border: none; padding: 8px 20px;">充值</a>';
                    billingHtml += '<button class="btn btn-sm" onclick="loadAccountBilling(true)" style="margin-left: 8px; padding: 8px 20px;">刷新</button>';
                    billingHtml += '</div>';
                    accountCache.billing = { ts: Date.now(), html: billingHtml };
                    const balanceEl = document.getElementById('accountBalanceContent');
                    if (balanceEl) balanceEl.innerHTML = billingHtml;
                }

                // 更新 apiKeys 缓存和显示（使用与 loadAccountApiKeys 相同的样式）
                if (data.api_keys) {
                    let apiKeysHtml = '';
                    if (data.api_keys.length > 0) {
                        apiKeysHtml = `
                    <strong style="display: block; margin-bottom: 12px;">API Keys(${data.api_keys.length}):</strong>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            ${data.api_keys.map((key, idx) => `
                                    <div style="background: var(--card-bg); padding: 12px; border-radius: 6px; border: 1px solid var(--border-color);">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                            <span style="font-weight: 500; color: var(--text-color);">${key.name || 'Unnamed Key'}</span>
                                            <span style="font-size: 12px; color: ${key.is_disabled ? 'var(--error-color)' : 'var(--success-color)'};">
                                                ${key.is_disabled ? '已禁用' : '已启用'}
                                            </span>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <div id="apiKey_${idx}" style="flex: 1; font-family: monospace; font-size: 13px; background: var(--bg-color); padding: 8px; border-radius: 4px; word-break: break-all; color: var(--text-color);">
                                                ${key.api_key || '-'}
                                            </div>
                                            <button class="btn btn-sm" onclick="copyApiKey('${key.api_key || ''}')" style="padding: 6px 12px; white-space: nowrap;">复制</button>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 12px; color: var(--text-secondary);">
                                            <span>项目: ${key.project_name || '-'}</span>
                                            <span>创建: ${key.created ? new Date(key.created).toLocaleDateString() : '-'}</span>
                                        </div>
                                    </div>
                                `).join('')}
                        </div>
                `;
                    } else {
                        apiKeysHtml = '<div style="color: var(--text-secondary); font-style: italic;">未找到 API Keys</div>';
                    }
                    accountCache.apiKeys = { ts: Date.now(), html: apiKeysHtml };
                    const apiKeysEl = document.getElementById('apiKeysSection');
                    if (apiKeysEl) apiKeysEl.innerHTML = apiKeysHtml;
                }

                return data;
            } catch (e) {
                console.error('Failed to load overview data:', e);
                throw e;
            }
        }

        // 复制 API Key 到剪贴板
        function copyApiKey(apiKey) {
            if (!apiKey) {
                showAccountStatus('无效的 API Key', 'error');
                return;
            }
            navigator.clipboard.writeText(apiKey).then(() => {
                showAccountStatus('API Key 已复制到剪贴板', 'success');
            }).catch(err => {
                console.error('复制失败:', err);
                showAccountStatus('复制失败，请手动复制', 'error');
            });
        }

        async function checkAccountSession() {
            try {
                // 先加载账户列表（不触发子标签页切换，避免重复加载）
                await loadAccountsList(true);

                // 检查是否有已登录的账户
                if (accountsList.length > 0) {
                    document.getElementById('accountLoginSection').classList.add('hidden');
                    document.getElementById('accountLoggedInSection').classList.remove('hidden');

                    // 如果有当前账户，显示详情并并发加载所有数据
                    if (currentAccountEmail) {
                        document.getElementById('accountDetailsSection').classList.remove('hidden');

                        // 设置子标签页状态为概览，但不触发加载
                        currentAccountSubTab = 'overview';
                        const tabs = ['overview', 'usage', 'cost', 'rates'];
                        tabs.forEach(t => {
                            const el = document.getElementById('accountSub' + t.charAt(0).toUpperCase() + t.slice(1));
                            const btn = document.getElementById('accountSubTab' + t.charAt(0).toUpperCase() + t.slice(1));
                            if (el) el.classList.toggle('hidden', t !== 'overview');
                            if (btn) btn.style.background = (t === 'overview') ? '#4285f4' : '#6c757d';
                        });

                        // 使用合并的 overview API 加载概览数据（1个请求代替3个）
                        // 同时并发加载 usage、cost、rates
                        // 首次加载不强制刷新，优先使用预加载缓存
                        console.log('Initial load: Starting parallel data loading for account:', currentAccountEmail);
                        Promise.allSettled([
                            loadAccountOverviewData(false),  // 合并的 info + billing + apiKeys，优先使用缓存
                            loadAccountUsage(false, true),   // 优先使用缓存
                            loadAccountCost(false, true),    // 优先使用缓存
                            loadAccountRates(false, true)    // 优先使用缓存
                        ]).then(results => {
                            console.log('Initial load: All data loading completed', results.map((r, i) => ({
                                index: i,
                                status: r.status
                            })));
                        });

                        // 启动自动刷新
                        startAccountAutoRefresh();
                    } else {
                        document.getElementById('accountDetailsSection').classList.add('hidden');
                    }
                } else {
                    document.getElementById('accountLoginSection').classList.remove('hidden');
                    document.getElementById('accountLoggedInSection').classList.add('hidden');
                }
            } catch (e) {
                console.error('Check session failed:', e);
            }
        }

        // 账户登录（邮箱密码）
        async function accountLogin() {
            const email = document.getElementById('accountEmail').value;
            const password = document.getElementById('accountPassword').value;
            if (!email || !password) {
                showAccountStatus('请输入邮箱和密码', 'error');
                return;
            }
            showAccountStatus('登录中...', 'info');
            try {
                const res = await fetch('/api/account/login', {
                    method: 'POST',
                    headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();
                if (res.ok && data.success) {
                    showAccountStatus('登录成功', 'success');
                    document.getElementById('accountPassword').value = '';
                    document.getElementById('accountEmail').value = '';
                    // 重新加载账户列表
                    await loadAccountsList();
                    // 如果这是第一个账户，自动切换并显示详情
                    if (accountsList.length === 1 && !currentAccountEmail) {
                        await switchAccount(data.email);
                    } else {
                        await checkAccountSession();
                    }
                } else {
                    showAccountStatus(data.detail || '登录失败', 'error');
                }
            } catch (e) {
                showAccountStatus('登录失败: ' + e.message, 'error');
            }
        }

        // 账户登出
        async function accountLogout(email) {
            if (!email) {
                email = currentAccountEmail;
            }
            if (!email) {
                showAccountStatus('请指定要登出的账户', 'error');
                return;
            }

            try {
                const params = email ? `? account_email = ${encodeURIComponent(email)} ` : '';
                await fetch('/api/account/logout' + params, { method: 'POST', headers: getAuthHeaders() });

                // 如果登出的是当前账户，清空当前账户
                if (email === currentAccountEmail) {
                    currentAccountEmail = null;
                    accountSessionData = null;
                    // 清空缓存
                    accountCache.info = { ts: 0, html: '' };
                    accountCache.apiKeys = { ts: 0, html: '' };
                    accountCache.billing = { ts: 0, html: '' };
                    accountCache.usage = {};
                    accountCache.cost = {};
                    accountCache.rates = { ts: 0, html: '' };
                    document.getElementById('accountDetailsSection').classList.add('hidden');
                }

                // 重新加载账户列表
                await loadAccountsList();

                // 如果没有任何账户了，显示登录界面
                if (accountsList.length === 0) {
                    document.getElementById('accountLoginSection').classList.remove('hidden');
                    document.getElementById('accountLoggedInSection').classList.add('hidden');
                }

                showAccountStatus('已登出', 'success');
            } catch (e) {
                showAccountStatus('登出失败: ' + e.message, 'error');
            }
        }

        // 显示账户状态消息
        function showAccountStatus(message, type = 'info') {
            const el = document.getElementById('accountStatus');
            if (el) {
                el.innerHTML = `<div class="status ${type}">${message}</div>`;
            }
        }

        // 切换账户子标签页
        function switchAccountSubTab(tabName) {
            // 检查是否选择了账户
            if (!currentAccountEmail) {
                showAccountStatus('请先选择要查看的账户', 'error');
                return;
            }

            currentAccountSubTab = tabName;
            const tabs = ['overview', 'usage', 'cost', 'rates'];
            tabs.forEach(t => {
                const el = document.getElementById('accountSub' + t.charAt(0).toUpperCase() + t.slice(1));
                const btn = document.getElementById('accountSubTab' + t.charAt(0).toUpperCase() + t.slice(1));
                if (el) el.classList.toggle('hidden', t !== tabName);
                if (btn) btn.style.background = (t === tabName) ? '#4285f4' : '#6c757d';
            });
            // 加载对应数据（优先使用缓存，缓存过期或不存在才请求）
            if (tabName === 'overview') {
                const infoEl = document.getElementById('accountInfoContent');
                const balEl = document.getElementById('accountBalanceContent');
                if (infoEl && accountCache.info.html && isFresh(accountCache.info.ts)) {
                    infoEl.innerHTML = accountCache.info.html;
                    const sek = document.getElementById('apiKeysSection');
                    if (sek && accountCache.apiKeys && accountCache.apiKeys.html && isFresh(accountCache.apiKeys.ts)) {
                        sek.innerHTML = accountCache.apiKeys.html;
                    }
                    loadAccountApiKeys(false);
                } else {
                    loadAccountInfo();
                }
                if (balEl && accountCache.billing.html && isFresh(accountCache.billing.ts)) {
                    balEl.innerHTML = accountCache.billing.html;
                } else {
                    loadAccountBilling();
                }
            } else if (tabName === 'usage') {
                // 初始化筛选器（如果尚未初始化）
                if (!usageFilterState.initialized) {
                    initUsageFilters();
                    usageFilterState.initialized = true;
                }

                // 加载使用量数据（总览 + 详情）
                loadAccountUsageAll();
            } else if (tabName === 'cost') {
                // 初始化筛选器（如果尚未初始化）
                if (!costFilterState.initialized) {
                    initCostFilters();
                    costFilterState.initialized = true;
                }

                // 加载成本数据（总览 + 详情）
                loadAccountCost();
            } else if (tabName === 'rates') {
                // 确保区域下拉框有默认值
                const regionSelect = document.getElementById('accountRatesRegion');
                if (regionSelect && !regionSelect.value) {
                    regionSelect.value = 'US';
                }

                const el = document.getElementById('accountRatesContent');
                console.log('Switching to rates tab, cache:', accountCache.rates ? { ts: accountCache.rates.ts, hasHtml: !!accountCache.rates.html } : 'none');
                if (el && accountCache.rates.html && isFresh(accountCache.rates.ts)) {
                    console.log('Using cached rates data');
                    el.innerHTML = accountCache.rates.html;
                } else {
                    console.log('No valid cache, loading rates data');
                    loadAccountRates();
                }
            }
            startAccountAutoRefresh();
        }

        // 加载账户概览
        async function loadAccountOverview(force = false) {
            loadAccountInfo(force);
            loadAccountBilling(force);
        }

        // 加载账户信息（快速响应，不包含 API keys）
        // skipApiKeys: 如果为 true，则不自动加载 API keys（用于 switchAccount 中避免重复请求）
        async function loadAccountInfo(force = false, skipApiKeys = false) {
            if (!currentAccountEmail) {
                const el = document.getElementById('accountInfoContent');
                if (el) el.innerHTML = '<p style="color: var(--text-secondary);">请先选择账户</p>';
                return;
            }
            const el = document.getElementById('accountInfoContent');
            if (!el) return;
            if (!force && accountCache.info.html && isFresh(accountCache.info.ts)) {
                el.innerHTML = accountCache.info.html;
                // 异步加载 API keys（不阻塞），除非 skipApiKeys=true
                if (!skipApiKeys) {
                    loadAccountApiKeys(force);
                }
                return;
            }
            el.innerHTML = getOverviewLoadingHTML();
            try {
                const params = currentAccountEmail ? `? account_email = ${encodeURIComponent(currentAccountEmail)} ` : '';
                const res = await fetch('/api/account/info' + params, { headers: getAuthHeaders() });
                if (!res.ok) {
                    if (res.status === 401) {
                        await checkAccountSession();
                        return;
                    }
                    throw new Error('加载失败');
                }
                const data = await res.json();

                // 基础信息 HTML（立即显示，不等待 API keys）
                const html = `
                    <div style="display: grid; gap: 12px;">
                        <div><strong>邮箱:</strong> ${data.email || '-'}</div>
                        <div><strong>账户 ID:</strong> ${data.id || '-'}</div>
                        <div><strong>类型:</strong> ${data.customer_type || '-'}</div>
                        <div><strong>创建时间:</strong> ${data.created ? new Date(data.created).toLocaleDateString() : '-'}</div>
                        <div><strong>支付方式:</strong> ${data.cc_brand ? data.cc_brand.toUpperCase() + ' ****' + data.cc_last4 : '未设置'}</div>
                        <div id="apiKeysSection" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                            <div class="loading-spinner" style="padding: 16px 0;"><div class="spinner"></div><div class="spinner-text">正在加载 API Keys...</div></div>
                        </div>
                    </div>
                    `;
                accountCache.info = { ts: Date.now(), html };
                el.innerHTML = html;

                // 异步加载 API keys（不阻塞基础信息显示），除非 skipApiKeys=true
                if (!skipApiKeys) {
                    const sek = document.getElementById('apiKeysSection');
                    if (sek && accountCache.apiKeys && accountCache.apiKeys.html && isFresh(accountCache.apiKeys.ts)) {
                        sek.innerHTML = accountCache.apiKeys.html;
                    }
                    loadAccountApiKeys(false);
                }
            } catch (e) {
                el.innerHTML = `<div class="status error">加载失败: ${e.message}</div>`;
            }
        }

        // 独立加载 API Keys（异步，不阻塞账户信息，带缓存，带超时）
        async function loadAccountApiKeys(force = false) {
            if (!currentAccountEmail) {
                const el = document.getElementById('apiKeysSection');
                if (el) el.innerHTML = '<p style="color: var(--text-secondary);">请先选择账户</p>';
                return;
            }
            const el = document.getElementById('apiKeysSection');
            if (!el) return;

            // 使用缓存
            if (!force && accountCache.apiKeys && accountCache.apiKeys.html && isFresh(accountCache.apiKeys.ts)) {
                el.innerHTML = accountCache.apiKeys.html;
                return;
            }

            try {
                // 添加 15 秒超时
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000);

                const params = new URLSearchParams();
                if (force) params.append('force', '1');
                if (currentAccountEmail) params.append('account_email', currentAccountEmail);
                const res = await fetch('/api/account/api-keys' + (params.toString() ? '?' + params.toString() : ''), {
                    headers: getAuthHeaders(),
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                if (!res.ok) throw new Error('加载 API Keys 失败');
                const data = await res.json();

                let apiKeysHtml = '';
                if (data.api_keys && data.api_keys.length > 0) {
                    apiKeysHtml = `
                    <strong style="display: block; margin-bottom: 12px;">API Keys(${data.api_keys.length}):</strong>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            ${data.api_keys.map((key, idx) => `
                                <div style="background: var(--card-bg); padding: 12px; border-radius: 6px; border: 1px solid var(--border-color);">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <span style="font-weight: 500; color: var(--text-color);">${key.name || 'Unnamed Key'}</span>
                                        <span style="font-size: 12px; color: ${key.is_disabled ? 'var(--error-color)' : 'var(--success-color)'};">
                                            ${key.is_disabled ? '已禁用' : '已启用'}
                                        </span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <div style="flex: 1; font-family: monospace; font-size: 13px; background: var(--bg-color); padding: 8px; border-radius: 4px; word-break: break-all; color: var(--text-color);">
                                            ${key.api_key || '-'}
                                        </div>
                                        <button class="btn btn-sm" onclick="copyApiKey('${key.api_key || ''}')" style="padding: 6px 12px; white-space: nowrap;">复制</button>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 12px; color: var(--text-secondary);">
                                        <span>项目: ${key.project_name || '-'}</span>
                                        <span>创建: ${key.created ? new Date(key.created).toLocaleDateString() : '-'}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                `;
                } else {
                    apiKeysHtml = '<div style="color: var(--text-secondary); font-style: italic;">未找到 API Keys</div>';
                }

                if (data.error) {
                    apiKeysHtml += `<div class="status warning" style="margin-top: 8px;">注意: ${data.error}</div>`;
                }

                // 缓存 API keys HTML
                accountCache.apiKeys = { ts: Date.now(), html: apiKeysHtml };
                el.innerHTML = apiKeysHtml;


            } catch (e) {
                const errorMsg = e.name === 'AbortError' ? '请求超时，请稍后重试' : e.message;
                el.innerHTML = `<div class="status error">加载 API Keys 失败: ${errorMsg} <br><button class="btn btn-sm" onclick="loadAccountApiKeys(true)" style="margin-top: 8px;">重试</button></div>`;
            }
        }

        // 加载账单信息
        async function loadAccountBilling(force = false) {
            if (!currentAccountEmail) {
                const el = document.getElementById('accountBalanceContent');
                if (el) el.innerHTML = '<p style="color: var(--text-secondary);">请先选择账户</p>';
                return;
            }
            const el = document.getElementById('accountBalanceContent');
            if (!el) return;
            if (!force && accountCache.billing.html && isFresh(accountCache.billing.ts)) {
                el.innerHTML = accountCache.billing.html;
                return;
            }
            el.innerHTML = getBillingLoadingHTML();
            try {
                const params = new URLSearchParams();
                if (force) params.append('force', '1');
                if (currentAccountEmail) params.append('account_email', currentAccountEmail);
                const res = await fetch('/api/account/billing' + (params.toString() ? '?' + params.toString() : ''), { headers: getAuthHeaders() });
                if (!res.ok) throw new Error('加载失败');
                const data = await res.json();
                console.log('Billing data:', data);

                const balance = data.balance || 0;
                const totalSpend = data.total_spend_30_days || 0;

                let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px;">';
                // 余额卡片 - 红色动态效果
                html += '<div style="text-align: center; padding: 24px; background: linear-gradient(135deg, var(--card-bg) 0%, rgba(255,77,77,0.05) 100%); border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 4px 15px rgba(255,77,77,0.1);">';
                html += '<div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px;">当前余额</div>';
                html += '<div class="balance-amount" style="font-size: 36px; font-weight: bold;">$' + balance.toFixed(5) + '</div>';
                html += '</div>';
                // 消费卡片 - 绿色动态效果
                html += '<div style="text-align: center; padding: 24px; background: linear-gradient(135deg, var(--card-bg) 0%, rgba(40,167,69,0.05) 100%); border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 4px 15px rgba(40,167,69,0.1);">';
                html += '<div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px;">30天消费</div>';
                html += '<div class="spend-amount" style="font-size: 36px; font-weight: bold;">$' + totalSpend.toFixed(5) + '</div>';
                html += '</div></div>';
                html += '<div style="margin-top: 16px; text-align: center;">';
                html += '<a href="https://www.assemblyai.com/dashboard/account/billing" target="_blank" class="btn btn-sm" style="background: linear-gradient(135deg, #17a2b8, #138496); border: none; padding: 8px 20px;">充值</a>';
                html += '<button class="btn btn-sm" onclick="loadAccountBilling(true)" style="margin-left: 8px; padding: 8px 20px;">刷新</button>';
                html += '</div>';

                if (data.error) {
                    html += '<div class="status warning" style="margin-top: 12px;">注意: ' + data.error + '</div>';
                }

                accountCache.billing = { ts: Date.now(), html };
                el.innerHTML = html;
            } catch (e) {
                console.error('Failed to load billing:', e);
                el.innerHTML = '<div class="status error">加载失败: ' + e.message + '<br><button class="btn btn-sm" onclick="loadAccountBilling()" style="margin-top: 8px;">重试</button></div>';
            }
        }
        // 日期选择器切换函数
        function onUsageWindowChange() {
            const window_size = document.getElementById('accountUsageWindow')?.value || 'month';
            const customRange = document.getElementById('usageCustomDateRange');
            if (customRange) {
                customRange.style.display = window_size === 'custom' ? 'flex' : 'none';
            }
            if (window_size !== 'custom') {
                loadAccountUsage(true);
            }
        }

        function onCostWindowChange() {
            const window_size = document.getElementById('accountCostWindow')?.value || 'month';
            const customRange = document.getElementById('costCustomDateRange');
            if (customRange) {
                customRange.style.display = window_size === 'custom' ? 'flex' : 'none';
            }
            if (window_size !== 'custom') {
                loadAccountCost(true);
            }
        }

        // 获取日期范围参数
        // AssemblyAI API: ending_before 是 exclusive 的，所以需要加一天
        function getNextDay(dateStr) {
            const date = new Date(dateStr);
            date.setDate(date.getDate() + 1);
            return date.toISOString().split('T')[0];
        }

        function getUsageDateParams() {
            const window_size = document.getElementById('accountUsageWindow')?.value || 'month';
            if (window_size === 'custom') {
                const startDate = document.getElementById('usageStartDate')?.value;
                const endDate = document.getElementById('usageEndDate')?.value;
                if (startDate && endDate) {
                    // ending_before 需要是结束日期的第二天（exclusive）
                    const endingBefore = getNextDay(endDate);
                    return `starting_on = ${startDate}& ending_before=${endingBefore} `;
                }
                return 'window_size=month';
            }
            return `window_size = ${window_size} `;
        }

        function getCostDateParams() {
            const window_size = document.getElementById('accountCostWindow')?.value || 'month';
            if (window_size === 'custom') {
                const startDate = document.getElementById('costStartDate')?.value;
                const endDate = document.getElementById('costEndDate')?.value;
                if (startDate && endDate) {
                    // ending_before 需要是结束日期的第二天（exclusive）
                    const endingBefore = getNextDay(endDate);
                    return `starting_on = ${startDate}& ending_before=${endingBefore} `;
                }
                return 'window_size=month';
            }
            return `window_size = ${window_size} `;
        }

        // 生成使用量页面的加载动画HTML
        function getUsageLoadingHTML() {
            return `
                    <div class="skeleton-loader">
                    <div class="skeleton-card" style="text-align: center;">
                        <div class="skeleton-line short" style="margin: 0 auto 12px;"></div>
                        <div class="skeleton-big-number"></div>
                        <div class="skeleton-line short" style="margin: 8px auto 0;"></div>
                    </div>
                    <div class="skeleton-card">
                        <div class="skeleton-line medium"></div>
                        <div style="height: 6px; background: var(--border-color); border-radius: 4px; margin-bottom: 16px;"></div>
                    </div>
                    <div class="skeleton-card">
                        <div class="skeleton-line medium" style="margin-bottom: 16px;"></div>
                        <div class="skeleton-line long"></div>
                        <div class="skeleton-line long"></div>
                        <div class="skeleton-line medium"></div>
                    </div>
                    <div class="loading-spinner" style="padding: 20px 0;">
                        <div class="spinner"></div>
                        <div class="spinner-text">正在加载使用量数据...</div>
                    </div>
                </div>
                    `;
        }

        // 生成成本页面的加载动画HTML
        function getCostLoadingHTML() {
            return `
                    <div class="skeleton-loader">
                    <div class="skeleton-card" style="text-align: center;">
                        <div class="skeleton-line short" style="margin: 0 auto 8px;"></div>
                        <div class="skeleton-line short" style="margin: 0 auto 12px;"></div>
                        <div class="skeleton-big-number"></div>
                    </div>
                    <div class="skeleton-card">
                        <div class="skeleton-line medium" style="margin-bottom: 16px;"></div>
                        <div style="height: 8px; background: var(--border-color); border-radius: 4px; margin-bottom: 16px;"></div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                            <div class="skeleton-card" style="margin: 0;"><div class="skeleton-line short"></div><div class="skeleton-line medium"></div></div>
                            <div class="skeleton-card" style="margin: 0;"><div class="skeleton-line short"></div><div class="skeleton-line medium"></div></div>
                        </div>
                    </div>
                    <div class="loading-spinner" style="padding: 20px 0;">
                        <div class="spinner"></div>
                        <div class="spinner-text">正在加载成本数据...</div>
                    </div>
                </div>
                    `;
        }

        // 生成Cost Details详情区域的加载动画HTML
        function getCostDetailLoadingHTML() {
            return `
                    <div class="skeleton-loader" style="padding: 0;">
                    <!-- 模拟图表区域 -->
                    <div class="skeleton-card" style="margin: 0; padding: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <div class="skeleton-line short" style="width: 80px; margin: 0;"></div>
                            <div style="display: flex; gap: 8px;">
                                <div class="skeleton-line" style="width: 60px; height: 12px; margin: 0;"></div>
                                <div class="skeleton-line" style="width: 60px; height: 12px; margin: 0;"></div>
                                <div class="skeleton-line" style="width: 60px; height: 12px; margin: 0;"></div>
                            </div>
                        </div>
                        <!-- 模拟曲线图区域 -->
                        <div style="height: 200px; background: linear-gradient(180deg, var(--card-bg) 0%, var(--border-color) 100%); border-radius: 8px; position: relative; overflow: hidden;">
                            <div style="position: absolute; bottom: 0; left: 0; right: 0; height: 60%; background: linear-gradient(90deg, var(--border-color) 25%, var(--card-bg) 50%, var(--border-color) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; opacity: 0.5;"></div>
                        </div>
                        <!-- 模拟X轴标签 -->
                        <div style="display: flex; justify-content: space-between; margin-top: 8px;">
                            <div class="skeleton-line" style="width: 40px; height: 10px; margin: 0;"></div>
                            <div class="skeleton-line" style="width: 40px; height: 10px; margin: 0;"></div>
                            <div class="skeleton-line" style="width: 40px; height: 10px; margin: 0;"></div>
                            <div class="skeleton-line" style="width: 40px; height: 10px; margin: 0;"></div>
                        </div>
                    </div>
                    <div class="loading-spinner" style="padding: 16px 0;">
                        <div class="spinner"></div>
                        <div class="spinner-text">正在加载成本详情...</div>
                    </div>
                </div>
                    `;
        }

        // 生成使用详情区域的加载动画HTML
        function getUsageDetailLoadingHTML() {
            return `
                    <div class="skeleton-loader" style="padding: 0;">
                    <!-- 模拟图表区域 -->
                    <div class="skeleton-card" style="margin: 0; padding: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <div class="skeleton-line short" style="width: 80px; margin: 0;"></div>
                            <div style="display: flex; gap: 8px;">
                                <div class="skeleton-line" style="width: 60px; height: 12px; margin: 0;"></div>
                                <div class="skeleton-line" style="width: 60px; height: 12px; margin: 0;"></div>
                                <div class="skeleton-line" style="width: 60px; height: 12px; margin: 0;"></div>
                            </div>
                        </div>
                        <!-- 模拟条形图区域 -->
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div class="skeleton-line" style="width: 100px; height: 14px; margin: 0;"></div>
                                <div class="skeleton-line" style="flex: 1; height: 24px; margin: 0; border-radius: 4px;"></div>
                                <div class="skeleton-line" style="width: 60px; height: 14px; margin: 0;"></div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div class="skeleton-line" style="width: 100px; height: 14px; margin: 0;"></div>
                                <div class="skeleton-line" style="flex: 1; height: 24px; margin: 0; border-radius: 4px; max-width: 70%;"></div>
                                <div class="skeleton-line" style="width: 60px; height: 14px; margin: 0;"></div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div class="skeleton-line" style="width: 100px; height: 14px; margin: 0;"></div>
                                <div class="skeleton-line" style="flex: 1; height: 24px; margin: 0; border-radius: 4px; max-width: 40%;"></div>
                                <div class="skeleton-line" style="width: 60px; height: 14px; margin: 0;"></div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div class="skeleton-line" style="width: 100px; height: 14px; margin: 0;"></div>
                                <div class="skeleton-line" style="flex: 1; height: 24px; margin: 0; border-radius: 4px; max-width: 20%;"></div>
                                <div class="skeleton-line" style="width: 60px; height: 14px; margin: 0;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="loading-spinner" style="padding: 16px 0;">
                        <div class="spinner"></div>
                        <div class="spinner-text">正在加载使用详情...</div>
                    </div>
                </div>
                    `;
        }

        // 生成费率页面的加载动画HTML
        function getRatesLoadingHTML() {
            return `
                    <div class="skeleton-loader">
                    <div class="skeleton-card">
                        <div class="skeleton-line medium" style="margin-bottom: 16px;"></div>
                        <div class="skeleton-line long"></div>
                        <div class="skeleton-line long"></div>
                        <div class="skeleton-line long"></div>
                        <div class="skeleton-line medium"></div>
                    </div>
                    <div class="loading-spinner" style="padding: 20px 0;">
                        <div class="spinner"></div>
                        <div class="spinner-text">正在加载费率信息...</div>
                    </div>
                </div>
                    `;
        }

        // 生成概览页面的加载动画HTML
        function getOverviewLoadingHTML() {
            return `
                    <div class="skeleton-loader">
                    <div class="skeleton-card">
                        <div class="skeleton-line medium" style="margin-bottom: 12px;"></div>
                        <div class="skeleton-line long"></div>
                        <div class="skeleton-line long"></div>
                        <div class="skeleton-line medium"></div>
                    </div>
                    <div class="loading-spinner" style="padding: 20px 0;">
                        <div class="spinner"></div>
                        <div class="spinner-text">正在加载账户信息...</div>
                    </div>
                </div>
                    `;
        }

        // 生成余额页面的加载动画HTML
        function getBillingLoadingHTML() {
            return `
                    <div class="skeleton-loader">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        <div class="skeleton-card" style="text-align: center;">
                            <div class="skeleton-line short" style="margin: 0 auto 12px;"></div>
                            <div class="skeleton-big-number"></div>
                        </div>
                        <div class="skeleton-card" style="text-align: center;">
                            <div class="skeleton-line short" style="margin: 0 auto 12px;"></div>
                            <div class="skeleton-big-number"></div>
                        </div>
                    </div>
                    <div class="loading-spinner" style="padding: 20px 0;">
                        <div class="spinner"></div>
                        <div class="spinner-text">正在加载余额信息...</div>
                    </div>
                </div >
                    `;
        }

        async function loadAccountUsage(force = false, silent = false) {
            if (!currentAccountEmail) {
                const el = document.getElementById('accountUsageContent');
                if (el) el.innerHTML = '<p style="color: var(--text-secondary);">请先选择账户</p>';
                return;
            }
            const el = document.getElementById('accountUsageContent');
            if (!el) return;
            const key = 'summary';

            // 强制刷新时清除缓存（无论是否静默）
            if (force) {
                delete accountCache.usage[key];
            }

            if (!force) {
                const cached = accountCache.usage[key];
                if (cached && cached.html && isFresh(cached.ts)) {
                    el.innerHTML = cached.html;
                    return;
                }
            }
            // 静默模式不显示加载中
            if (!silent) {
                el.innerHTML = getUsageLoadingHTML();
            }
            try {
                // 强制刷新时添加force参数和时间戳防止缓存
                const timestamp = Date.now();
                const params = new URLSearchParams();
                params.append('force', '1');
                params.append('_t', timestamp);
                if (currentAccountEmail) params.append('account_email', currentAccountEmail);
                console.log('Fetching usage data for:', currentAccountEmail, 'force:', force, 'silent:', silent);
                const res = await fetch('/api/account/usage?' + params.toString(), { headers: getAuthHeaders() });
                if (!res.ok) throw new Error('加载失败');
                const data = await res.json();
                console.log('Usage data received (force=' + force + ', silent=' + silent + '):', data);

                // 归类并复刻使用量分布与列表 - 确保数据始终显示
                const hasModelData = data.by_model && Array.isArray(data.by_model) && data.by_model.length > 0;
                const hasItemsData = data.items && Array.isArray(data.items) && data.items.length > 0;
                const totalTokens = data.total_tokens || 0;

                // 如果没有详细数据，显示加载中状态（带动画）并快速重试
                if (!hasModelData && !hasItemsData) {
                    if (!silent) {
                        el.innerHTML = getUsageLoadingHTML();
                    }
                    // 1秒后自动重试（最多重试3次）
                    const retryCount = window.usageRetryCount || 0;
                    if (retryCount < 3) {
                        window.usageRetryCount = retryCount + 1;
                        setTimeout(() => {
                            loadAccountUsage(true, true);
                        }, 1000);
                    } else {
                        // 重试次数用完，显示空状态
                        window.usageRetryCount = 0;
                        el.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">暂无使用量数据</div>';
                    }
                    return;
                }

                // 成功获取数据，重置重试计数
                window.usageRetryCount = 0;

                let html = '<div style="display: grid; gap: 16px;">';

                // 总 tokens 显示（只有在有详细数据时才显示）
                html += '<div style="text-align: center; padding: 20px; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color);">';
                html += '<div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">LLM Gateway + LeMUR</div>';
                html += '<div style="font-size: 36px; font-weight: bold; color: var(--text-color);">' + totalTokens.toLocaleString() + '</div>';
                html += '<div style="font-size: 14px; color: var(--text-secondary);">Total tokens</div>';
                html += '</div>';

                if (hasModelData) {
                    const models = [...data.by_model];
                    function vendorOf(name) {
                        const n = (name || '').toLowerCase();
                        if (n.includes('gpt')) return 'GPT';
                        if (n.includes('gemini')) return 'Gemini';
                        if (n.includes('claude')) return 'Claude';
                        return 'Other';
                    }
                    const vendorTotals = {};
                    models.forEach(m => { const v = vendorOf(m.model); vendorTotals[v] = (vendorTotals[v] || 0) + (m.tokens || 0); });
                    const vendorsSorted = Object.keys(vendorTotals).sort((a, b) => vendorTotals[b] - vendorTotals[a]);
                    const groups = vendorsSorted.map(v => ({ vendor: v, items: models.filter(m => vendorOf(m.model) === v).sort((a, b) => b.tokens - a.tokens) }));
                    const palette = {
                        'GPT': ['#1e88e5', '#1565c0', '#64b5f6', '#0d47a1'],
                        'Gemini': ['#00bcd4', '#26c6da', '#80deea', '#4dd0e1'],
                        'Claude': ['#ff7043', '#fb8c00', '#f4511e', '#ff9800'],
                        'Other': ['#9c27b0', '#ab47bc', '#8e24aa', '#ba68c8']
                    };
                    const colorMap = {};
                    groups.forEach(g => { g.items.forEach((it, idx) => { const c = it.color || (palette[g.vendor] || palette['Other'])[idx % (palette[g.vendor] || palette['Other']).length]; colorMap[it.model] = c; }); });
                    html += '<div style="padding: 16px; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color);">';
                    html += '<h4 style="margin-bottom: 12px; color: var(--text-color);">使用量分布</h4>';
                    html += '<div style="display: flex; height: 6px; border-radius: 4px; overflow: hidden; margin-bottom: 16px;">';
                    groups.forEach(function (group) {
                        group.items.forEach(function (item) {
                            const percentage = totalTokens > 0 ? (item.tokens / totalTokens) * 100 : 0;
                            const color = colorMap[item.model];
                            html += '<div style="width:' + percentage + '%; background:' + color + ';"></div>';
                        });
                    });
                    html += '</div>';
                    html += '</div>';

                    html += '<div class="usage-card" style="padding: 16px; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color);">';
                    html += '<h4 style="margin-bottom: 12px; color: var(--text-color);">按模型分类</h4>';
                    groups.forEach(function (group) {
                        html += '<div style="font-weight:600; color: var(--text-secondary); margin:8px 0;">' + group.vendor + '</div>';
                        group.items.forEach(function (item) {
                            const color = colorMap[item.model];
                            const percentage = totalTokens > 0 ? ((item.tokens / totalTokens) * 100).toFixed(1) : 0;
                            html += '<div class="usage-model-row">';
                            html += '<div class="usage-model-info">';
                            html += '<span class="usage-model-dot" style="background: ' + color + ';"></span>';
                            html += '<span class="usage-model-name">' + item.model + '</span>';
                            html += '</div>';
                            html += '<div class="usage-model-stats">';
                            html += '<span class="usage-model-tokens">' + item.tokens.toLocaleString() + '</span>';
                            html += '<span class="usage-model-unit">tokens</span>';
                            html += '<span class="usage-model-percent">(' + percentage + '%)</span>';
                            html += '</div>';
                            html += '</div>';
                        });
                    });
                    html += '</div>';
                } else if (hasItemsData) {
                    html += '<div style="padding: 16px; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color);">';
                    html += '<table class="table" style="width: 100%;"><thead><tr><th>日期</th><th>产品</th><th>模型</th><th>使用量</th></tr></thead><tbody>';
                    data.items.forEach(function (item) {
                        html += '<tr><td>' + (item.date || '-') + '</td><td>' + (item.product || '-') + '</td><td>' + (item.model || '-') + '</td><td>' + (item.usage || item.tokens || 0) + ' ' + (item.unit || 'tokens') + '</td></tr>';
                    });
                    html += '</tbody></table>';
                    html += '</div>';
                } else {
                    html += '<div class="status info">暂无使用量数据，请稍后刷新重试</div>';
                }

                // 显示调试信息（如果有）- 仅在控制台输出，不显示给用户
                if (data.debug_info && Object.keys(data.debug_info).length > 0) {
                    console.log('Debug info:', data.debug_info);
                    // 调试信息仅用于开发，不在界面显示
                }

                // 显示错误信息
                if (data.error) {
                    html += '<div class="status warning" style="margin-top: 12px;">注意: ' + data.error + '</div>';
                }

                html += '</div>';

                // 缓存完整数据
                accountCache.usage[key] = { ts: Date.now(), html, complete: true };
                console.log('Usage data cached successfully');

                el.innerHTML = html;
            } catch (e) {
                console.error('Failed to load usage:', e);
                el.innerHTML = '<div class="status error">加载失败: ' + e.message + '<br><button class="btn btn-sm" onclick="loadAccountUsage(true)" style="margin-top: 8px;">重试</button></div>';
            }
        }

        // ========== 使用量筛选器相关函数 ==========

        // 使用量筛选器状态
        const usageFilterState = {
            windowSize: 'day',
            startDate: null,
            endDate: null,
            product: 'LLM Gateway + LeMUR',
            initialized: false
        };

        // 使用量视图模式
        let usageViewMode = 'chart';

        function setUsageViewMode(mode) {
            usageViewMode = mode;
            document.getElementById('usageViewChart')?.classList.toggle('active', mode === 'chart');
            document.getElementById('usageViewTable')?.classList.toggle('active', mode === 'table');
            // 重新渲染详情
            if (window.lastUsageDetailData) {
                renderUsageDetails(window.lastUsageDetailData);
            }
        }

        // 初始化使用量筛选器
        function initUsageFilters() {
            // 设置默认日期范围（最近7天，包含今天）
            const today = new Date();
            const start = new Date(today);
            start.setDate(today.getDate() - 6); // 包含今天，所以减去6天

            usageFilterState.startDate = start.toISOString().split('T')[0];
            usageFilterState.endDate = today.toISOString().split('T')[0]; // 结束日期是今天

            const startDateEl = document.getElementById('usageStartDate');
            const endDateEl = document.getElementById('usageEndDate');

            if (startDateEl) {
                startDateEl.value = usageFilterState.startDate;
                startDateEl.max = today.toISOString().split('T')[0];
            }
            if (endDateEl) {
                endDateEl.value = usageFilterState.endDate;
                endDateEl.max = today.toISOString().split('T')[0];
            }

            updateUsageDateLabel();
        }

        function toggleUsageFilterPanel(panel) {
            const panels = ['Date', 'Product'];
            panels.forEach(p => {
                const el = document.getElementById('usageFilter' + p + 'Panel');
                const btn = document.getElementById('usageFilter' + p + 'Btn');
                if (p === panel) {
                    el?.classList.toggle('hidden');
                    btn?.classList.toggle('active');
                } else {
                    el?.classList.add('hidden');
                    btn?.classList.remove('active');
                }
            });
        }

        function setUsageDatePreset(days) {
            const today = new Date();
            const start = new Date(today);
            start.setDate(today.getDate() - (days - 1)); // 包含今天，所以减去 days-1

            usageFilterState.startDate = start.toISOString().split('T')[0];
            usageFilterState.endDate = today.toISOString().split('T')[0]; // 结束日期是今天

            document.getElementById('usageStartDate').value = usageFilterState.startDate;
            document.getElementById('usageEndDate').value = usageFilterState.endDate;

            // 更新预设按钮状态
            document.querySelectorAll('.usage-date-preset').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.days) === days);
            });

            updateUsageDateLabel();
            loadAccountUsageDetails(true);
        }

        function applyUsageDateFilter() {
            usageFilterState.startDate = document.getElementById('usageStartDate').value;
            usageFilterState.endDate = document.getElementById('usageEndDate').value;

            // 清除预设按钮状态
            document.querySelectorAll('.usage-date-preset').forEach(btn => btn.classList.remove('active'));

            updateUsageDateLabel();
            toggleUsageFilterPanel('Date');
            loadAccountUsageDetails(true);
        }

        function setUsageProduct(product) {
            usageFilterState.product = product;

            // 更新按钮状态
            document.querySelectorAll('.usage-product-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.product === product);
            });

            // 更新标签
            const label = document.getElementById('usageFilterProductLabel');
            if (label) {
                const shortName = product.includes('LLM') ? 'LLM' : product.split('-')[0];
                label.textContent = 'Product: ' + shortName;
            }

            toggleUsageFilterPanel('Product');
            loadAccountUsageDetails(true);
        }

        function updateUsageDateLabel() {
            const label = document.getElementById('usageFilterDateLabel');
            if (!label) return;

            const start = new Date(usageFilterState.startDate);
            const end = new Date(usageFilterState.endDate);
            const days = Math.round((end - start) / (1000 * 60 * 60 * 24));

            if (days === 7) {
                label.textContent = 'Date: Last 7 days';
            } else if (days === 14) {
                label.textContent = 'Date: Last 14 days';
            } else if (days === 30) {
                label.textContent = 'Date: Last 30 days';
            } else {
                label.textContent = '日期: ' + (start.getMonth() + 1) + '/' + start.getDate() + ' - ' + (end.getMonth() + 1) + '/' + end.getDate();
            }
        }

        // 构建使用量筛选参数
        function buildUsageFilterParams() {
            const params = new URLSearchParams();

            if (usageFilterState.startDate && usageFilterState.endDate) {
                params.append('window_size', usageFilterState.windowSize);
                params.append('starting_on', usageFilterState.startDate);
                // ending_before 需要是结束日期的第二天（exclusive）
                const endDateObj = new Date(usageFilterState.endDate);
                endDateObj.setDate(endDateObj.getDate() + 1);
                params.append('ending_before', endDateObj.toISOString().split('T')[0]);
            }

            if (usageFilterState.product) {
                params.append('product', usageFilterState.product);
            }

            params.append('group_by', 'model');
            params.append('regions', 'US');
            params.append('services', 'API');

            return params;
        }

        // 加载使用量总览数据
        async function loadAccountUsageSummary(force = false) {
            if (!currentAccountEmail) return;

            const el = document.getElementById('accountUsageSummarySection');
            if (!el) return;

            try {
                const params = new URLSearchParams();
                params.append('force', force ? '1' : '0');
                params.append('_t', Date.now());
                params.append('account_email', currentAccountEmail);

                const res = await fetch('/api/account/usage?' + params.toString(), { headers: getAuthHeaders() });
                if (!res.ok) throw new Error('Failed to load summary');

                const data = await res.json();

                let html = '<div style="display: grid; gap: 16px;">';
                html += '<div class="summary-card">';
                html += '<div class="summary-title" style="margin-bottom: 8px;">Summary (Last 30 days)</div>';
                html += '<div class="summary-sub">Total tokens across account</div>';
                html += '<div class="summary-value">' + (data.total_tokens || 0).toLocaleString() + '</div>';
                html += '</div>';
                html += '</div>';

                el.innerHTML = html;
            } catch (e) {
                console.error('Failed to load usage summary:', e);
                el.innerHTML = '<div class="status error">加载失败</div>';
            }
        }

        // 加载使用量详情数据
        async function loadAccountUsageDetails(force = false) {
            if (!currentAccountEmail) return;

            const el = document.getElementById('accountUsageDetails');
            const totalEl = document.getElementById('usageDetailTotal');
            const dateRangeEl = document.getElementById('usageDetailDateRange');
            if (!el) return;

            // 骨架屏加载动画
            el.innerHTML = getUsageDetailLoadingHTML();

            try {
                const params = buildUsageFilterParams();
                params.append('force', force ? '1' : '0');
                params.append('_t', Date.now());
                params.append('account_email', currentAccountEmail);

                const res = await fetch('/api/account/usage?' + params.toString(), { headers: getAuthHeaders() });
                if (!res.ok) throw new Error('Failed to load details');

                const data = await res.json();
                window.lastUsageDetailData = data;

                // 更新总额
                let detailTotal = 0;
                if (data.by_model && data.by_model.length > 0) {
                    detailTotal = data.by_model.reduce((sum, item) => sum + (item.tokens || 0), 0);
                } else {
                    detailTotal = data.total_tokens || 0;
                }
                if (totalEl) totalEl.textContent = detailTotal.toLocaleString();

                // 更新日期范围显示
                if (dateRangeEl && usageFilterState.startDate && usageFilterState.endDate) {
                    const start = new Date(usageFilterState.startDate);
                    const end = new Date(usageFilterState.endDate);
                    dateRangeEl.textContent = '(' + (start.getMonth() + 1) + '/' + start.getDate() + ' - ' + (end.getMonth() + 1) + '/' + end.getDate() + ')';
                }

                // 渲染详情
                renderUsageDetails(data);

            } catch (e) {
                console.error('Failed to load usage details:', e);
                el.innerHTML = '<div class="status error">加载失败</div>';
            }
        }

        // 渲染使用量详情
        function renderUsageDetails(data) {
            const el = document.getElementById('accountUsageDetails');
            if (!el) return;

            // 检查是否有数据：优先使用 by_model，如果为空则从 daily_by_model 或 segments 构建
            let models = data.by_model || [];

            if (models.length === 0) {
                // 尝试从 daily_by_model 中提取模型名称和汇总数据
                const dailyByModel = data.daily_by_model || [];
                if (dailyByModel.length > 0) {
                    const modelTotals = {};
                    dailyByModel.forEach(day => {
                        if (day.models) {
                            Object.entries(day.models).forEach(([model, data]) => {
                                if (!modelTotals[model]) {
                                    modelTotals[model] = { input: 0, output: 0, total: 0 };
                                }
                                modelTotals[model].input += data.input || 0;
                                modelTotals[model].output += data.output || 0;
                                modelTotals[model].total += data.total || (data.input || 0) + (data.output || 0);
                            });
                        }
                    });

                    // 转换为数组并排序
                    models = Object.entries(modelTotals)
                        .map(([model, data]) => ({
                            model: model,
                            tokens: data.total || data.input + data.output,
                            input_tokens: data.input,
                            output_tokens: data.output
                        }))
                        .filter(m => m.tokens > 0)
                        .sort((a, b) => b.tokens - a.tokens);
                }

                // 如果还是没有，尝试从 segments 构建（但没有模型名称）
                if (models.length === 0 && data.segments && data.segments.length > 0) {
                    models = data.segments.map((seg, idx) => ({
                        model: seg.name || seg.model || `Model ${idx + 1} `,
                        tokens: seg.value || seg.tokens || 0,
                        color: seg.color
                    })).filter(m => m.tokens > 0);
                }

                // 更新 data.by_model 以便后续使用
                if (models.length > 0) {
                    data.by_model = models;
                }
            }

            const hasData = models.length > 0 || (data.total_tokens && data.total_tokens > 0);

            if (!hasData) {
                const totalEl = document.getElementById('usageDetailTotal');
                if (totalEl) totalEl.textContent = '0';
                el.innerHTML = '<div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);"><div style="font-size: 14px;">该时间范围内没有使用数据</div></div>';
                return;
            }

            if (usageViewMode === 'chart') {
                renderUsageChart(el, data);
            } else {
                renderUsageTable(el, data);
            }
        }

        // 渲染使用量图表
        function renderUsageChart(el, data) {
            try {
                const colorPalette = ['#4285f4', '#ea4335', '#fbbc04', '#34a853', '#ff6d01', '#46bdc6', '#7baaf7', '#f07b72', '#fcd04f', '#81c995', '#ff9e80', '#78d9ec', '#a8c7fa', '#f6aea9', '#fde293', '#a8dab5', '#ffccbc', '#b2ebf2'];

                // 为每个模型分配颜色
                const modelColors = {};
                if (data.by_model) {
                    data.by_model.forEach((item, idx) => {
                        modelColors[item.model] = colorPalette[idx % colorPalette.length];
                    });
                }

                let dailyByModel = data.daily_by_model || [];

                const dates = dailyByModel.map(d => d.date);

                // 计算每个模型在每天的数据
                const modelDailyData = {};
                let dataPointCount = dailyByModel.length;

                dailyByModel.forEach((day, idx) => {
                    if (day.models) {
                        Object.entries(day.models).forEach(([model, tokens]) => {
                            if (!modelDailyData[model]) {
                                modelDailyData[model] = new Array(dataPointCount).fill(0);
                            }
                            const total = typeof tokens === 'object' ?
                                ((tokens.input || 0) + (tokens.output || 0)) :
                                (tokens || 0);
                            modelDailyData[model][idx] = total;
                        });
                    }
                });

                // 计算单个模型的最大值
                let maxAmount = 0;
                Object.values(modelDailyData).forEach(arr => {
                    arr.forEach(val => {
                        if (val > maxAmount) maxAmount = val;
                    });
                });
                maxAmount = maxAmount || 1000;
                maxAmount = maxAmount * 1.1;

                // 计算合适的Y轴刻度
                let yMax = maxAmount;
                let yStep = yMax / 4;
                const yTicks = [];

                try {
                    if (maxAmount > 1) {
                        const yTickCount = 4;
                        const rawStep = maxAmount / yTickCount;
                        if (rawStep > 0 && isFinite(rawStep)) {
                            const logVal = Math.log10(rawStep);
                            if (isFinite(logVal)) {
                                const magnitude = Math.pow(10, Math.floor(logVal));
                                const normalizedStep = rawStep / magnitude;
                                let niceStep;
                                if (normalizedStep <= 1) niceStep = 1;
                                else if (normalizedStep <= 2) niceStep = 2;
                                else if (normalizedStep <= 5) niceStep = 5;
                                else niceStep = 10;
                                yStep = niceStep * magnitude;
                                yMax = Math.ceil(maxAmount / yStep) * yStep;
                            }
                        }
                    }
                } catch (e) {
                    console.warn('Y-axis calculation error:', e);
                }

                if (!isFinite(yMax) || yMax <= 0) yMax = 1000;
                if (!isFinite(yStep) || yStep <= 0) yStep = yMax / 4;

                for (let v = 0; v <= yMax * 1.001; v += yStep) {
                    yTicks.push(Math.round(v));
                    if (yTicks.length > 10) break;
                }
                if (yTicks.length === 0) yTicks.push(0, yMax);

                const chartHeight = 200;
                const chartWidth = 100;

                let html = '<div style="position: relative;">';

                // Y轴标签
                html += '<div style="position: absolute; left: 0; top: 0; bottom: 30px; width: 50px; display: flex; flex-direction: column; justify-content: space-between; font-size: 10px; color: var(--text-secondary); text-align: right; padding-right: 8px;">';
                for (let i = yTicks.length - 1; i >= 0; i--) {
                    const formatted = yTicks[i] >= 1000000 ? (yTicks[i] / 1000000).toFixed(1) + 'M' :
                        yTicks[i] >= 1000 ? (yTicks[i] / 1000).toFixed(0) + 'K' :
                            yTicks[i].toString();
                    html += '<div>' + formatted + '</div>';
                }
                html += '</div>';

                // 图表区域
                html += '<div id="usageChartContainer" style="margin-left: 55px; position: relative; height: ' + chartHeight + 'px; border-bottom: 1px solid var(--border-color);">';

                if (dataPointCount > 0) {
                    const width = chartWidth;
                    const height = chartHeight - 20;

                    html += '<svg viewBox="0 0 ' + width + ' ' + height + '" preserveAspectRatio="none" style="width: 100%; height: 100%; overflow: visible;">';
                    html += '<defs>';

                    Object.entries(modelColors).forEach(([model, color], idx) => {
                        html += '<linearGradient id="usageGrad' + idx + '" x1="0%" y1="0%" x2="0%" y2="100%">';
                        html += '<stop offset="0%" style="stop-color:' + color + ';stop-opacity:0.3"/>';
                        html += '<stop offset="100%" style="stop-color:' + color + ';stop-opacity:0.02"/>';
                        html += '</linearGradient>';
                    });
                    html += '</defs>';

                    // 绘制Y轴网格线
                    yTicks.forEach((tick, i) => {
                        if (i > 0) {
                            const yPct = (1 - tick / yMax) * 100;
                            html += '<line x1="0%" y1="' + yPct + '%" x2="100%" y2="' + yPct + '%" stroke="#e0e0e0" stroke-width="1" vector-effect="non-scaling-stroke" opacity="0.6"/>';
                        }
                    });

                    // 绘制每个模型的曲线
                    const sortedModels = Object.entries(modelDailyData)
                        .map(([model, arr]) => ({ model, arr, total: arr.reduce((a, b) => a + b, 0) }))
                        .sort((a, b) => a.total - b.total);

                    const allModelPoints = {};

                    // 给两侧留出边距（10%）
                    const padding = width * 0.05;
                    const innerWidth = width - padding * 2;

                    sortedModels.forEach(({ model, arr }, modelIdx) => {
                        const color = modelColors[model] || colorPalette[modelIdx % colorPalette.length];
                        const gradId = Object.keys(modelColors).indexOf(model);

                        const points = arr.map((val, i) => {
                            const yVal = Math.max(0, Math.min(height, height - (val / yMax) * height));
                            return {
                                x: dataPointCount > 1 ? padding + (i / (dataPointCount - 1)) * innerWidth : width / 2,
                                y: yVal,
                                value: val
                            };
                        });

                        allModelPoints[model] = points;

                        if (points.length > 1) {
                            const curvePath = generateSmoothPath(points, 0.2, height);
                            if (curvePath) {
                                // 填充区域：从曲线起点底部开始，沿曲线，到终点底部，闭合
                                const firstX = points[0].x;
                                const lastX = points[points.length - 1].x;
                                const fillPath = curvePath + ' L' + lastX + ',' + height + ' L' + firstX + ',' + height + ' Z';
                                html += '<path d="' + fillPath + '" fill="url(#usageGrad' + (gradId >= 0 ? gradId : modelIdx) + ')" opacity="0.5"/>';
                                html += '<path d="' + curvePath + '" fill="none" stroke="' + color + '" stroke-width="1.5" vector-effect="non-scaling-stroke"/>';
                            }
                        }
                    });

                    html += '</svg>';

                    // 垂直指示线
                    html += '<div id="usageChartIndicator" style="display: none; position: absolute; top: 0; bottom: 0; width: 1px; background: var(--text-secondary); pointer-events: none; opacity: 0.5;"></div>';

                    // 数据点圆点容器
                    html += '<div id="usageChartDots" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none;"></div>';

                    // 交互层
                    html += '<div id="usageChartOverlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; cursor: crosshair; z-index: 10;" onmousemove="showUsageTooltip(event)" onmouseleave="hideUsageTooltip()"></div>';

                    // 存储点数据
                    window.usageChartPoints = allModelPoints;
                    window.usageChartData = {
                        dailyByModel: dailyByModel,
                        modelColors: modelColors,
                        yMax: yMax,
                        chartHeight: chartHeight - 20
                    };
                }

                html += '</div>';

                // X轴标签
                if (dates.length > 0) {
                    html += '<div style="margin-left: 55px; display: flex; justify-content: space-between; font-size: 10px; color: var(--text-secondary); padding-top: 4px;">';
                    const step = Math.max(1, Math.floor(dates.length / 8));
                    for (let i = 0; i < dates.length; i += step) {
                        const d = new Date(dates[i]);
                        html += '<div>' + (d.getMonth() + 1) + '/' + d.getDate() + '</div>';
                    }
                    html += '</div>';
                }

                // Tooltip
                html += '<div id="usageChartTooltip" style="display: none; position: fixed; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 12px; font-size: 12px; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-width: 500px; pointer-events: none;"></div>';

                html += '</div>';
                el.innerHTML = html;
            } catch (e) {
                console.error('renderUsageChart error:', e);
                el.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">图表渲染失败: ' + e.message + '</div>';
            }
        }

        // 显示使用量tooltip
        function showUsageTooltip(event) {
            const tooltip = document.getElementById('usageChartTooltip');
            const overlay = document.getElementById('usageChartOverlay');
            const indicator = document.getElementById('usageChartIndicator');
            const dotsContainer = document.getElementById('usageChartDots');

            if (!tooltip || !overlay || !window.usageChartData) return;
            const dailyByModel = window.usageChartData.dailyByModel || [];
            if (dailyByModel.length === 0) return;

            const rect = overlay.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const pct = x / rect.width;
            const idx = Math.min(Math.floor(pct * dailyByModel.length), dailyByModel.length - 1);

            if (idx < 0 || !dailyByModel[idx]) return;

            // 显示垂直指示线
            if (indicator) {
                const indicatorX = (idx / Math.max(dailyByModel.length - 1, 1)) * rect.width;
                indicator.style.display = 'block';
                indicator.style.left = indicatorX + 'px';
            }

            // 显示数据点圆点
            if (dotsContainer && window.usageChartPoints) {
                const modelColors = window.usageChartData.modelColors || {};
                const yMax = window.usageChartData.yMax || 1;
                const chartHeight = rect.height;
                let dotsHtml = '';

                Object.entries(window.usageChartPoints).forEach(([model, points]) => {
                    if (points[idx] && points[idx].value > 0) {
                        const color = modelColors[model] || '#4285f4';
                        const dotX = (idx / Math.max(points.length - 1, 1)) * rect.width;
                        const dotY = chartHeight - (points[idx].value / yMax) * chartHeight;
                        dotsHtml += '<div style="position: absolute; left: ' + (dotX - 4) + 'px; top: ' + (dotY - 4) + 'px; width: 8px; height: 8px; border-radius: 50%; background: ' + color + '; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.3);"></div>';
                    }
                });
                dotsContainer.innerHTML = dotsHtml;
            }

            const item = dailyByModel[idx];
            const date = new Date(item.date);
            const dateStr = date.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric', year: 'numeric' }) + ' (UTC)';

            // 构建tooltip内容
            let tooltipHtml = '<div style="font-weight: 600; margin-bottom: 8px; color: var(--text-color);">' + dateStr + '</div>';

            if (item.models && Object.keys(item.models).length > 0) {
                const modelColors = window.usageChartData.modelColors || {};
                tooltipHtml += '<div style="display: flex; gap: 24px;">';
                tooltipHtml += '<div style="flex: 1;"><div style="font-weight: 500; margin-bottom: 4px; color: var(--text-secondary); font-size: 11px;">INPUT</div>';

                Object.entries(item.models).forEach(([model, data]) => {
                    const color = modelColors[model] || '#4285f4';
                    const inputTokens = typeof data === 'object' ? (data.input || 0) : 0;
                    tooltipHtml += '<div style="color: ' + color + '; font-size: 11px;">' + model + ': ' + inputTokens.toLocaleString() + '</div>';
                });

                tooltipHtml += '</div>';
                tooltipHtml += '<div style="width: 1px; background: var(--border-color);"></div>';
                tooltipHtml += '<div style="flex: 1;"><div style="font-weight: 500; margin-bottom: 4px; color: var(--text-secondary); font-size: 11px;">OUTPUT</div>';

                Object.entries(item.models).forEach(([model, data]) => {
                    const color = modelColors[model] || '#4285f4';
                    const outputTokens = typeof data === 'object' ? (data.output || 0) : 0;
                    tooltipHtml += '<div style="color: ' + color + '; font-size: 11px;">' + model + ': ' + outputTokens.toLocaleString() + '</div>';
                });

                tooltipHtml += '</div></div>';
            }

            tooltip.innerHTML = tooltipHtml;
            tooltip.style.display = 'block';

            // 智能定位
            const tooltipRect = tooltip.getBoundingClientRect();
            let left = event.clientX + 15;
            let top = event.clientY - tooltipRect.height / 2;

            if (left + tooltipRect.width > window.innerWidth - 10) {
                left = event.clientX - tooltipRect.width - 15;
            }
            if (top < 10) top = 10;
            if (top + tooltipRect.height > window.innerHeight - 10) {
                top = window.innerHeight - tooltipRect.height - 10;
            }

            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
        }

        // 隐藏使用量tooltip
        function hideUsageTooltip() {
            const tooltip = document.getElementById('usageChartTooltip');
            const indicator = document.getElementById('usageChartIndicator');
            const dotsContainer = document.getElementById('usageChartDots');

            if (tooltip) tooltip.style.display = 'none';
            if (indicator) indicator.style.display = 'none';
            if (dotsContainer) dotsContainer.innerHTML = '';
        }

        // 渲染使用量表格（带分布图和分类）
        function renderUsageTable(el, data) {
            const models = data.by_model || [];
            if (models.length === 0) {
                el.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">没有使用数据</div>';
                return;
            }

            // 计算总量
            const totalTokens = models.reduce((sum, m) => sum + (m.tokens || 0), 0);

            // 按分类分配颜色（同一分类使用相近颜色）
            const groupColorPalettes = {
                'Claude': ['#ff6b35', '#ff8c5a', '#ffad7f', '#ffc9a3'],   // 橙色系
                'Gemini': ['#00bcd4', '#26c6da', '#4dd0e1', '#80deea'],   // 青色系
                'GPT': ['#2196f3', '#42a5f5', '#64b5f6', '#90caf9'],      // 蓝色系
                '其他': ['#9c27b0', '#ab47bc', '#ba68c8', '#ce93d8']      // 紫色系
            };
            const groupColorIndex = { 'Claude': 0, 'Gemini': 0, 'GPT': 0, '其他': 0 };

            const modelColors = {};
            models.forEach(m => {
                const name = m.model || '';
                let group = '其他';
                if (name.toLowerCase().includes('claude')) {
                    group = 'Claude';
                } else if (name.toLowerCase().includes('gemini')) {
                    group = 'Gemini';
                } else if (name.toLowerCase().includes('gpt') || name.toLowerCase().includes('chatgpt')) {
                    group = 'GPT';
                }
                const palette = groupColorPalettes[group];
                modelColors[m.model] = palette[groupColorIndex[group] % palette.length];
                groupColorIndex[group]++;
            });

            // 按tokens排序
            const sortedModels = [...models].sort((a, b) => (b.tokens || 0) - (a.tokens || 0));

            let html = '<div style="padding: 0;">';

            // 使用量分布条
            html += '<div style="margin-bottom: 16px;">';
            html += '<div style="font-size: 14px; font-weight: 500; color: var(--text-color); margin-bottom: 8px;">使用量分布</div>';
            html += '<div style="display: flex; height: 8px; border-radius: 4px; overflow: hidden; background: var(--border-color);">';
            sortedModels.forEach(m => {
                const pct = totalTokens > 0 ? ((m.tokens || 0) / totalTokens) * 100 : 0;
                if (pct > 0) {
                    const color = modelColors[m.model];
                    html += '<div style="width: ' + pct + '%; background: ' + color + ';" title="' + m.model + ': ' + pct.toFixed(1) + '%"></div>';
                }
            });
            html += '</div></div>';

            // 按模型分类
            html += '<div style="font-size: 14px; font-weight: 500; color: var(--text-color); margin-bottom: 8px;">按模型分类</div>';

            // 分组：Claude, Gemini, GPT, 其他
            const groups = {
                'Claude': [],
                'Gemini': [],
                'GPT': [],
                '其他': []
            };

            sortedModels.forEach(m => {
                const name = m.model || '';
                if (name.toLowerCase().includes('claude')) {
                    groups['Claude'].push(m);
                } else if (name.toLowerCase().includes('gemini')) {
                    groups['Gemini'].push(m);
                } else if (name.toLowerCase().includes('gpt') || name.toLowerCase().includes('chatgpt')) {
                    groups['GPT'].push(m);
                } else {
                    groups['其他'].push(m);
                }
            });

            // 渲染每个分组
            Object.entries(groups).forEach(([groupName, groupModels]) => {
                if (groupModels.length === 0) return;

                html += '<div style="margin-bottom: 8px;">';
                html += '<div style="font-size: 14px; font-weight: 600; color: var(--text-color); padding: 4px 0;">' + groupName + '</div>';

                groupModels.forEach(m => {
                    const color = modelColors[m.model];
                    const pct = totalTokens > 0 ? ((m.tokens || 0) / totalTokens) * 100 : 0;

                    html += '<div style="display: flex; align-items: center; padding: 8px 0; gap: 10px; border-bottom: 1px solid var(--border-color);">';
                    html += '<div style="width: 10px; height: 10px; border-radius: 50%; background: ' + color + '; flex-shrink: 0;"></div>';
                    html += '<div style="flex: 1; font-size: 14px; color: var(--text-color); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">' + m.model + '</div>';
                    html += '<div style="font-size: 14px; color: var(--text-color); text-align: right; white-space: nowrap;">';
                    html += '<span style="font-weight: 600;">' + (m.tokens || 0).toLocaleString() + '</span>';
                    html += ' <span style="color: var(--text-secondary);">tokens</span>';
                    html += ' <span style="color: var(--text-secondary);">(' + pct.toFixed(1) + '%)</span>';
                    html += '</div>';
                    html += '</div>';
                });

                html += '</div>';
            });

            html += '</div>';
            el.innerHTML = html;
        }

        // 加载使用量数据（总览 + 详情）
        async function loadAccountUsageAll(force = false) {
            if (!currentAccountEmail) return;

            // 初始化筛选器
            if (!usageFilterState.initialized) {
                initUsageFilters();
                usageFilterState.initialized = true;
            }

            // 并发加载总览和详情
            await Promise.all([
                loadAccountUsageSummary(force),
                loadAccountUsageDetails(force)
            ]);
        }

        // ========== 使用量筛选器相关函数结束 ==========

        // ========== 成本筛选器相关函数 ==========

        // HTML转义函数
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 成本筛选器状态
        const costFilterState = {
            windowSize: 'day',
            startDate: null,
            endDate: null,
            services: ['API', 'Playground'],
            models: [],  // 空数组表示全部
            allModels: [],  // 所有可用模型
            regions: ['US', 'Europe'],
            activePanel: null,
            initialized: false
        };

        // 初始化成本筛选器
        async function initCostFilters() {
            // 设置默认日期范围（最近7天，包含今天）
            const today = new Date();
            const sevenDaysAgo = new Date(today);
            sevenDaysAgo.setDate(today.getDate() - 6); // 包含今天，所以减去6天

            const endDateEl = document.getElementById('costEndDate');
            const startDateEl = document.getElementById('costStartDate');

            if (endDateEl) {
                endDateEl.value = today.toISOString().split('T')[0];
                // 设置最大日期为今天
                endDateEl.max = today.toISOString().split('T')[0];
            }
            if (startDateEl) {
                startDateEl.value = sevenDaysAgo.toISOString().split('T')[0];
                // 设置最大日期为今天
                startDateEl.max = today.toISOString().split('T')[0];
            }

            costFilterState.endDate = today.toISOString().split('T')[0];
            costFilterState.startDate = sevenDaysAgo.toISOString().split('T')[0];

            // 加载可用的模型列表
            await loadCostFilterModels();
        }

        // 验证日期范围
        function validateCostDateRange() {
            const startDateEl = document.getElementById('costStartDate');
            const endDateEl = document.getElementById('costEndDate');
            const errorEl = document.getElementById('costDateError');
            const applyBtn = document.getElementById('costDateApplyBtn');

            if (!startDateEl || !endDateEl) return true;

            const startDate = startDateEl.value;
            const endDate = endDateEl.value;

            if (startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);

                if (end < start) {
                    // 显示错误
                    if (errorEl) {
                        errorEl.style.display = 'block';
                        errorEl.textContent = '结束日期不能早于开始日期';
                    }
                    if (applyBtn) {
                        applyBtn.disabled = true;
                        applyBtn.style.opacity = '0.5';
                    }
                    return false;
                }
            }

            // 隐藏错误
            if (errorEl) errorEl.style.display = 'none';
            if (applyBtn) {
                applyBtn.disabled = false;
                applyBtn.style.opacity = '1';
            }
            return true;
        }

        // 加载可用的模型列表
        async function loadCostFilterModels() {
            if (!currentAccountEmail) return;

            try {
                const res = await fetch('/api/account/cost/filters?account_email=' + encodeURIComponent(currentAccountEmail), { headers: getAuthHeaders() });
                if (!res.ok) return;

                const data = await res.json();
                costFilterState.allModels = data.models || [];

                // 渲染模型列表
                renderCostModelList(data);
            } catch (e) {
                console.error('Failed to load cost filters:', e);
            }
        }

        // 渲染模型列表
        function renderCostModelList(data) {
            const container = document.getElementById('costModelList');
            if (!container) return;

            const categories = data.model_categories || {};
            let html = '';

            // LLM Gateway 模型（按输入/输出分组）
            if (categories['LLM Gateway (Input)'] && categories['LLM Gateway (Input)'].length > 0) {
                html += '<div class="cost-model-category" style="grid-column: 1 / -1;">';
                html += '<div class="cost-model-category-title">🤖 LLM Gateway (Input)</div>';
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 4px;">';
                categories['LLM Gateway (Input)'].forEach(model => {
                    const modelValue = model + ' (Input)';
                    html += '<label class="cost-model-item"><input type="checkbox" value="' + escapeHtml(modelValue) + '" checked onchange="updateCostModelLabel()"><span>' + escapeHtml(model) + '</span></label>';
                });
                html += '</div></div>';
            }

            if (categories['LLM Gateway (Output)'] && categories['LLM Gateway (Output)'].length > 0) {
                html += '<div class="cost-model-category" style="grid-column: 1 / -1;">';
                html += '<div class="cost-model-category-title">🤖 LLM Gateway (Output)</div>';
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 4px;">';
                categories['LLM Gateway (Output)'].forEach(model => {
                    const modelValue = model + ' (Output)';
                    html += '<label class="cost-model-item"><input type="checkbox" value="' + escapeHtml(modelValue) + '" checked onchange="updateCostModelLabel()"><span>' + escapeHtml(model) + '</span></label>';
                });
                html += '</div></div>';
            }

            // 其他服务类别
            const otherCategories = ['Speech-to-Text', 'Streaming Speech-to-Text', 'Speech Understanding'];
            otherCategories.forEach(catName => {
                const models = categories[catName];
                if (models && models.length > 0) {
                    html += '<div class="cost-model-category" style="grid-column: 1 / -1;">';
                    html += '<div class="cost-model-category-title">🎤 ' + catName + '</div>';
                    html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 4px;">';
                    models.forEach(model => {
                        html += '<label class="cost-model-item"><input type="checkbox" value="' + escapeHtml(model) + '" checked onchange="updateCostModelLabel()"><span>' + escapeHtml(model) + '</span></label>';
                    });
                    html += '</div></div>';
                }
            });

            // 如果没有分类数据，显示简单列表
            if (!html && data.models && data.models.length > 0) {
                html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 4px;">';
                data.models.forEach(model => {
                    html += '<label class="cost-model-item"><input type="checkbox" value="' + escapeHtml(model) + '" checked onchange="updateCostModelLabel()"><span>' + escapeHtml(model) + '</span></label>';
                });
                html += '</div>';
            }

            if (!html) {
                html = '<div style="color: var(--text-secondary); font-size: 13px;">暂无模型数据，请先加载成本数据</div>';
            }

            container.innerHTML = html;
            updateCostModelLabel();
        }

        // 切换筛选面板
        function toggleCostFilterPanel(panelType) {
            console.log('toggleCostFilterPanel called with:', panelType);
            const panels = ['Date', 'Service', 'Model', 'Region'];
            const panelTypeCapitalized = panelType.charAt(0).toUpperCase() + panelType.slice(1);

            panels.forEach(p => {
                // ID 格式: costFilter{Type}Panel, costFilter{Type}Btn
                const pId = 'costFilter' + p + 'Panel';
                const bId = 'costFilter' + p + 'Btn';
                const panel = document.getElementById(pId);
                const btn = document.getElementById(bId);

                if (!panel || !btn) {
                    console.error('Missing element:', pId, 'or', bId);
                    return;
                }

                if (p === panelTypeCapitalized) {
                    // 切换当前面板
                    const isHidden = panel.classList.contains('hidden');
                    if (isHidden) {
                        panel.classList.remove('hidden');
                        btn.classList.add('active');
                        costFilterState.activePanel = panelType;
                    } else {
                        panel.classList.add('hidden');
                        btn.classList.remove('active');
                        costFilterState.activePanel = null;
                    }
                } else {
                    // 关闭其他面板
                    panel.classList.add('hidden');
                    btn.classList.remove('active');
                }
            });
        }

        // 设置时间窗口
        function setCostWindow(windowSize) {
            costFilterState.windowSize = windowSize;
            document.querySelectorAll('.cost-window-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.window === windowSize);
            });
        }

        // 设置日期预设（快速选择）
        function setCostDatePreset(days) {
            const today = new Date();
            const start = new Date(today);
            start.setDate(today.getDate() - (days - 1)); // 包含今天，所以减去 days-1

            const startDateEl = document.getElementById('costStartDate');
            const endDateEl = document.getElementById('costEndDate');

            if (startDateEl && endDateEl) {
                startDateEl.value = start.toISOString().split('T')[0];
                endDateEl.value = today.toISOString().split('T')[0];
            }

            costFilterState.startDate = start.toISOString().split('T')[0];
            costFilterState.endDate = today.toISOString().split('T')[0];

            // 更新预设按钮状态
            document.querySelectorAll('.cost-date-preset').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.days) === days);
            });

            // 更新标签
            const label = document.getElementById('costFilterDateLabel');
            if (label) {
                if (days === 7) {
                    label.textContent = 'Date: Last 7 days';
                } else if (days === 14) {
                    label.textContent = 'Date: Last 14 days';
                } else if (days === 30) {
                    label.textContent = 'Date: Last 30 days';
                }
            }

            // 立即应用筛选
            applyCostFilters();
        }

        // 更新日期标签
        function updateCostDateLabel() {
            const startDate = document.getElementById('costStartDate').value;
            const endDate = document.getElementById('costEndDate').value;
            const label = document.getElementById('costFilterDateLabel');

            if (startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                // 计算天数差
                const days = Math.round((end - start) / (1000 * 60 * 60 * 24)) + 1;

                if (days === 7) {
                    label.textContent = 'Date: Last 7 days';
                } else if (days === 14) {
                    label.textContent = 'Date: Last 14 days';
                } else if (days === 30) {
                    label.textContent = 'Date: Last 30 days';
                } else {
                    label.textContent = 'Date: ' + (start.getMonth() + 1) + '/' + start.getDate() + ' - ' + (end.getMonth() + 1) + '/' + end.getDate();
                }
            } else {
                label.textContent = 'Date: Last 7 days';
            }
        }

        // 更新服务标签
        function updateCostServiceLabel() {
            const api = document.getElementById('costServiceAPI').checked;
            const playground = document.getElementById('costServicePlayground').checked;
            const label = document.getElementById('costFilterServiceLabel');

            if (api && playground) {
                label.textContent = '服务: 全部';
            } else if (api) {
                label.textContent = '服务: API';
            } else if (playground) {
                label.textContent = '服务: Playground';
            } else {
                label.textContent = '服务: 无';
            }
        }

        // 更新模型标签
        function updateCostModelLabel() {
            const checkboxes = document.querySelectorAll('#costModelList input[type="checkbox"]');
            const checked = document.querySelectorAll('#costModelList input[type="checkbox"]:checked');
            const label = document.getElementById('costFilterModelLabel');
            const countLabel = document.getElementById('costModelCountLabel');
            const selectAll = document.getElementById('costModelSelectAll');

            if (checkboxes.length === 0) {
                label.textContent = '模型: 全部';
                countLabel.textContent = '已选: 全部';
                return;
            }

            if (checked.length === checkboxes.length) {
                label.textContent = '模型: 全部';
                countLabel.textContent = '已选: 全部 (' + checkboxes.length + ')';
                selectAll.checked = true;
                selectAll.indeterminate = false;
            } else if (checked.length === 0) {
                label.textContent = '模型: 无';
                countLabel.textContent = '已选: 0';
                selectAll.checked = false;
                selectAll.indeterminate = false;
            } else {
                label.textContent = '模型: ' + checked.length + '个';
                countLabel.textContent = '已选: ' + checked.length + '/' + checkboxes.length;
                selectAll.indeterminate = true;
            }
        }

        // 更新区域标签
        function updateCostRegionLabel() {
            const us = document.getElementById('costRegionUS').checked;
            const europe = document.getElementById('costRegionEurope').checked;
            const label = document.getElementById('costFilterRegionLabel');

            if (us && europe) {
                label.textContent = '区域: 全部';
            } else if (us) {
                label.textContent = '区域: US';
            } else if (europe) {
                label.textContent = '区域: Europe';
            } else {
                label.textContent = '区域: 无';
            }
        }

        // 全选/取消全选模型
        function toggleAllCostModels(checked) {
            document.querySelectorAll('#costModelList input[type="checkbox"]').forEach(cb => {
                cb.checked = checked;
            });
            updateCostModelLabel();
        }

        // 重置日期筛选
        function resetCostDateFilter() {
            const today = new Date();
            const sevenDaysAgo = new Date(today);
            sevenDaysAgo.setDate(today.getDate() - 7);

            document.getElementById('costEndDate').value = today.toISOString().split('T')[0];
            document.getElementById('costStartDate').value = sevenDaysAgo.toISOString().split('T')[0];
            setCostWindow('day');
            updateCostDateLabel();
        }

        // 重置服务筛选
        function resetCostServiceFilter() {
            document.getElementById('costServiceAPI').checked = true;
            document.getElementById('costServicePlayground').checked = true;
            updateCostServiceLabel();
        }

        // 重置模型筛选
        function resetCostModelFilter() {
            toggleAllCostModels(true);
        }

        // 重置区域筛选
        function resetCostRegionFilter() {
            document.getElementById('costRegionUS').checked = true;
            document.getElementById('costRegionEurope').checked = true;
            updateCostRegionLabel();
        }

        // 清除所有筛选
        function clearAllCostFilters() {
            resetCostDateFilter();
            resetCostServiceFilter();
            resetCostModelFilter();
            resetCostRegionFilter();
            applyCostFilters();
        }

        // 构建筛选参数
        function buildCostFilterParams() {
            const params = new URLSearchParams();

            // 日期参数
            const startDate = document.getElementById('costStartDate').value;
            const endDate = document.getElementById('costEndDate').value;
            if (startDate && endDate) {
                params.append('window_size', costFilterState.windowSize);
                params.append('starting_on', startDate);
                // ending_before 需要是结束日期的第二天（exclusive）
                const endDateObj = new Date(endDate);
                endDateObj.setDate(endDateObj.getDate() + 1);
                params.append('ending_before', endDateObj.toISOString().split('T')[0]);
            }

            // 服务参数
            const services = [];
            if (document.getElementById('costServiceAPI').checked) services.push('API');
            if (document.getElementById('costServicePlayground').checked) services.push('Playground');
            if (services.length > 0 && services.length < 2) {
                params.append('services', services.join(','));
            }

            // 区域参数
            const regions = [];
            if (document.getElementById('costRegionUS').checked) regions.push('US');
            if (document.getElementById('costRegionEurope').checked) regions.push('Europe');
            if (regions.length > 0 && regions.length < 2) {
                params.append('regions', regions.join(','));
            }

            // 模型参数
            const allCheckboxes = document.querySelectorAll('#costModelList input[type="checkbox"]');
            const checkedModels = document.querySelectorAll('#costModelList input[type="checkbox"]:checked');
            if (allCheckboxes.length > 0 && checkedModels.length < allCheckboxes.length && checkedModels.length > 0) {
                checkedModels.forEach(cb => {
                    params.append('models', cb.value);
                });
            }

            return params;
        }

        // 更新已应用筛选显示
        function updateActiveFiltersDisplay() {
            const container = document.getElementById('costActiveFilters');
            const tagsContainer = document.getElementById('costActiveFilterTags');
            if (!container || !tagsContainer) return;

            const tags = [];

            // 日期
            const startDate = document.getElementById('costStartDate').value;
            const endDate = document.getElementById('costEndDate').value;
            if (startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                const today = new Date();
                const sevenDaysAgo = new Date(today);
                sevenDaysAgo.setDate(today.getDate() - 7);

                // 检查是否是默认的7天范围
                const isDefault = Math.abs(start - sevenDaysAgo) < 86400000 && Math.abs(end - today) < 86400000;
                if (!isDefault) {
                    tags.push({ type: 'date', label: (start.getMonth() + 1) + '/' + start.getDate() + ' - ' + (end.getMonth() + 1) + '/' + end.getDate() });
                }
            }

            // 服务
            const api = document.getElementById('costServiceAPI').checked;
            const playground = document.getElementById('costServicePlayground').checked;
            if (!api || !playground) {
                if (api) tags.push({ type: 'service', label: 'API' });
                if (playground) tags.push({ type: 'service', label: 'Playground' });
            }

            // 区域
            const us = document.getElementById('costRegionUS').checked;
            const europe = document.getElementById('costRegionEurope').checked;
            if (!us || !europe) {
                if (us) tags.push({ type: 'region', label: 'US' });
                if (europe) tags.push({ type: 'region', label: 'Europe' });
            }

            // 模型
            const allCheckboxes = document.querySelectorAll('#costModelList input[type="checkbox"]');
            const checkedModels = document.querySelectorAll('#costModelList input[type="checkbox"]:checked');
            if (allCheckboxes.length > 0 && checkedModels.length < allCheckboxes.length) {
                tags.push({ type: 'model', label: checkedModels.length + '个模型' });
            }

            if (tags.length === 0) {
                container.classList.add('hidden');
                return;
            }

            container.classList.remove('hidden');
            tagsContainer.innerHTML = tags.map(tag =>
                '<span class="cost-active-tag">' + tag.label + '</span>'
            ).join('');
        }

        // 应用筛选
        function applyCostFilters() {
            // 验证日期范围
            if (!validateCostDateRange()) {
                return;
            }

            // 关闭所有面板
            ['Date', 'Service', 'Model', 'Region'].forEach(p => {
                const panel = document.getElementById('costFilter' + p + 'Panel');
                const btn = document.getElementById('costFilter' + p + 'Btn');
                if (panel) panel.classList.add('hidden');
                if (btn) btn.classList.remove('active');
            });

            // 更新标签
            updateCostDateLabel();
            updateActiveFiltersDisplay();

            // 只重新加载详情数据（不重新加载总览）
            loadAccountCostDetails(true);
        }

        // ========== 成本筛选器相关函数结束 ==========

        // 成本视图模式
        let costViewMode = 'chart';  // 'chart' 或 'table'

        function setCostViewMode(mode) {
            costViewMode = mode;
            document.getElementById('costViewChart')?.classList.toggle('active', mode === 'chart');
            document.getElementById('costViewTable')?.classList.toggle('active', mode === 'table');
            // 重新渲染详情
            if (window.lastCostDetailData) {
                renderCostDetails(window.lastCostDetailData);
            }
        }

        // 加载总览数据（不受筛选影响）
        async function loadAccountCostSummary(force = false) {
            if (!currentAccountEmail) return;

            const el = document.getElementById('accountCostSummarySection');
            if (!el) return;

            try {
                const params = new URLSearchParams();
                params.append('force', force ? '1' : '0');
                params.append('_t', Date.now());
                params.append('account_email', currentAccountEmail);

                const res = await fetch('/api/account/cost?' + params.toString(), { headers: getAuthHeaders() });
                if (!res.ok) throw new Error('Failed to load summary');

                const data = await res.json();

                // 计算总额：优先从 by_service 累加，否则使用 total_cost
                let totalCost = 0;
                if (data.by_service && data.by_service.length > 0) {
                    totalCost = data.by_service.reduce((sum, item) => sum + (item.cost || 0), 0);
                } else {
                    totalCost = data.total_cost || 0;
                }

                let html = '<div style="display: grid; gap: 16px;">';

                // Summary 卡片
                html += '<div class="summary-card">';
                html += '<div class="summary-title" style="margin-bottom: 8px;">Summary (Last 30 days)</div>';
                html += '<div class="summary-sub">Total spend across account</div>';
                html += '<div class="summary-value">$' + totalCost.toFixed(5) + '</div>';
                html += '</div>';

                // Cost Breakdown
                if (data.by_service && data.by_service.length > 0) {
                    html += '<div style="padding: 16px; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color);">';
                    html += '<h4 style="margin-bottom: 12px; color: var(--text-color);">Cost Breakdown (Last 30 days)</h4>';
                    html += '<div style="height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden; display: flex; margin-bottom: 16px;">';
                    const colors = ['#4caf50', '#2196f3', '#ff9800', '#9c27b0'];
                    data.by_service.forEach((item, index) => {
                        const pct = totalCost > 0 ? (item.cost / totalCost) * 100 : 0;
                        html += '<div style="width: ' + pct + '%; background: ' + colors[index % colors.length] + ';"></div>';
                    });
                    html += '</div>';
                    html += '<div class="responsive-grid">';
                    data.by_service.forEach((item, index) => {
                        html += '<div class="responsive-item" style="padding: 12px; border: 1px solid var(--border-color); border-radius: 4px; background: var(--card-bg);">';
                        html += '<div style="font-size: 12px; color: var(--text-secondary);">' + item.service + '</div>';
                        html += '<div style="font-size: 20px; font-weight: bold; color: ' + colors[index % colors.length] + ';">$' + item.cost.toFixed(2) + '</div>';
                        html += '</div>';
                    });
                    html += '</div></div>';
                }

                html += '</div>';
                el.innerHTML = html;
            } catch (e) {
                console.error('Failed to load cost summary:', e);
                el.innerHTML = '<div class="status error">加载失败</div>';
            }
        }

        // 加载详情数据（受筛选影响）
        async function loadAccountCostDetails(force = false) {
            if (!currentAccountEmail) return;

            const el = document.getElementById('accountCostDetails');
            const totalEl = document.getElementById('costDetailTotal');
            const dateRangeEl = document.getElementById('costDetailDateRange');
            if (!el) return;

            // 骨架屏加载动画
            el.innerHTML = getCostDetailLoadingHTML();

            try {
                const params = buildCostFilterParams();
                params.append('force', force ? '1' : '0');
                params.append('_t', Date.now());
                params.append('account_email', currentAccountEmail);

                const res = await fetch('/api/account/cost?' + params.toString(), { headers: getAuthHeaders() });
                if (!res.ok) throw new Error('Failed to load details');

                const data = await res.json();
                window.lastCostDetailData = data;

                console.log('Cost details data:', {
                    total_cost: data.total_cost,
                    by_model_count: (data.by_model || []).length,
                    spend_trend_count: (data.spend_trend || []).length,
                    daily_by_model_count: (data.daily_by_model || []).length,
                    by_service: data.by_service
                });

                // 更新总额：优先从 by_model 累加
                let detailTotal = 0;
                if (data.by_model && data.by_model.length > 0) {
                    detailTotal = data.by_model.reduce((sum, item) => sum + (item.cost || 0), 0);
                } else {
                    detailTotal = data.total_cost || 0;
                }
                if (totalEl) totalEl.textContent = '$' + detailTotal.toFixed(2);

                // 更新日期范围显示
                if (dateRangeEl) {
                    const startDate = document.getElementById('costStartDate').value;
                    const endDate = document.getElementById('costEndDate').value;
                    if (startDate && endDate) {
                        const start = new Date(startDate);
                        const end = new Date(endDate);
                        dateRangeEl.textContent = '(' + (start.getMonth() + 1) + '/' + start.getDate() + ' - ' + (end.getMonth() + 1) + '/' + end.getDate() + ')';
                    } else {
                        // 从 spend_trend 获取日期范围
                        const trend = data.spend_trend || [];
                        if (trend.length > 0) {
                            const firstDate = new Date(trend[0].date);
                            const lastDate = new Date(trend[trend.length - 1].date);
                            dateRangeEl.textContent = '(' + (firstDate.getMonth() + 1) + '/' + firstDate.getDate() + ' - ' + (lastDate.getMonth() + 1) + '/' + lastDate.getDate() + ')';
                        } else {
                            dateRangeEl.textContent = '';
                        }
                    }
                }

                renderCostDetails(data);
            } catch (e) {
                console.error('Failed to load cost details:', e);
                el.innerHTML = '<div class="status error">加载失败</div>';
            }
        }

        // 渲染详情内容
        function renderCostDetails(data) {
            const el = document.getElementById('accountCostDetails');
            if (!el) return;

            const hasData = data.by_model && data.by_model.length > 0;

            if (!hasData) {
                // 没有数据时，更新总额为 $0.00
                const totalEl = document.getElementById('costDetailTotal');
                if (totalEl) totalEl.textContent = '$0.00';

                el.innerHTML = '<div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);"><div style="font-size: 14px;">You don\'t have any spend activity in this timeframe.</div></div>';
                return;
            }

            if (costViewMode === 'chart') {
                renderCostChart(el, data);
            } else {
                renderCostTable(el, data);
            }
        }

        // 生成平滑贝塞尔曲线路径（限制控制点不超出边界）
        function generateSmoothPath(points, tension = 0.25, maxY = 180) {
            if (points.length < 2) return '';
            if (points.length === 2) {
                return 'M' + points[0].x + ',' + points[0].y + ' L' + points[1].x + ',' + points[1].y;
            }

            // 限制Y坐标在有效范围内
            const clampY = (y) => Math.max(0, Math.min(maxY, y));

            let path = 'M' + points[0].x + ',' + clampY(points[0].y);

            for (let i = 0; i < points.length - 1; i++) {
                const p0 = points[Math.max(0, i - 1)];
                const p1 = points[i];
                const p2 = points[i + 1];
                const p3 = points[Math.min(points.length - 1, i + 2)];

                const cp1x = p1.x + (p2.x - p0.x) * tension;
                const cp1y = clampY(p1.y + (p2.y - p0.y) * tension);
                const cp2x = p2.x - (p3.x - p1.x) * tension;
                const cp2y = clampY(p2.y - (p3.y - p1.y) * tension);

                path += ' C' + cp1x + ',' + cp1y + ' ' + cp2x + ',' + cp2y + ' ' + p2.x + ',' + clampY(p2.y);
            }

            return path;
        }

        // 渲染热力曲线图
        function renderCostChart(el, data) {
            try {
                const colorPalette = ['#4285f4', '#ea4335', '#fbbc04', '#34a853', '#ff6d01', '#46bdc6', '#7baaf7', '#f07b72', '#fcd04f', '#81c995', '#ff9e80', '#78d9ec', '#a8c7fa', '#f6aea9', '#fde293', '#a8dab5', '#ffccbc', '#b2ebf2'];

                // 为每个模型分配颜色
                const modelColors = {};
                if (data.by_model) {
                    data.by_model.forEach((item, idx) => {
                        modelColors[item.model] = colorPalette[idx % colorPalette.length];
                    });
                }

                const trendData = data.spend_trend || [];
                const dailyByModel = data.daily_by_model || [];
                const dates = trendData.map(t => t.date);

                // 计算每个模型在每天的数据
                const modelDailyData = {};
                let dataPointCount = trendData.length;
                if (dataPointCount === 0 && dailyByModel.length > 0) {
                    dataPointCount = Math.max(...dailyByModel.map(d => d.index || 0)) + 1;
                }

                dailyByModel.forEach(day => {
                    if (day.models) {
                        Object.entries(day.models).forEach(([model, costs]) => {
                            if (!modelDailyData[model]) {
                                modelDailyData[model] = new Array(dataPointCount).fill(0);
                            }
                            if (day.index < dataPointCount) {
                                modelDailyData[model][day.index] = (costs.input || 0) + (costs.output || 0);
                            }
                        });
                    }
                });

                // 计算单个模型的最大值（不是总和）
                let maxAmount = 0;
                Object.values(modelDailyData).forEach(arr => {
                    arr.forEach(val => {
                        if (val > maxAmount) maxAmount = val;
                    });
                });
                // 也检查 trendData
                trendData.forEach(t => {
                    if ((t.amount || 0) > maxAmount) maxAmount = t.amount;
                });
                maxAmount = maxAmount || 0.01;

                // 增加10%的余量，避免曲线顶到边缘
                maxAmount = maxAmount * 1.1;

                // 计算合适的Y轴刻度（4-5个刻度）
                let yMax = maxAmount;
                let yStep = yMax / 4;
                const yTicks = [];

                try {
                    if (maxAmount > 0.0001) {
                        const yTickCount = 4;
                        const rawStep = maxAmount / yTickCount;
                        if (rawStep > 0 && isFinite(rawStep)) {
                            const logVal = Math.log10(rawStep);
                            if (isFinite(logVal)) {
                                const magnitude = Math.pow(10, Math.floor(logVal));
                                const normalizedStep = rawStep / magnitude;
                                let niceStep;
                                if (normalizedStep <= 1) niceStep = 1;
                                else if (normalizedStep <= 2) niceStep = 2;
                                else if (normalizedStep <= 5) niceStep = 5;
                                else niceStep = 10;
                                yStep = niceStep * magnitude;
                                yMax = Math.ceil(maxAmount / yStep) * yStep;
                            }
                        }
                    }
                } catch (e) {
                    console.warn('Y-axis calculation error:', e);
                }

                if (!isFinite(yMax) || yMax <= 0) yMax = 0.01;
                if (!isFinite(yStep) || yStep <= 0) yStep = yMax / 4;

                // 生成刻度（从0开始）
                for (let v = 0; v <= yMax * 1.001; v += yStep) {
                    yTicks.push(Math.round(v * 10000) / 10000);
                    if (yTicks.length > 10) break;
                }
                if (yTicks.length === 0) yTicks.push(0, yMax);

                console.log('Y-axis:', { maxAmount, yMax, yStep, yTicks });

                const chartHeight = 200;
                const chartWidth = 100; // SVG viewBox width

                let html = '<div style="position: relative;">';

                // Y轴标签
                html += '<div style="position: absolute; left: 0; top: 0; bottom: 30px; width: 50px; display: flex; flex-direction: column; justify-content: space-between; font-size: 10px; color: var(--text-secondary); text-align: right; padding-right: 8px;">';
                for (let i = yTicks.length - 1; i >= 0; i--) {
                    html += '<div>$' + yTicks[i].toFixed(2) + '</div>';
                }
                html += '</div>';

                // 图表区域
                html += '<div id="costChartContainer" style="margin-left: 55px; position: relative; height: ' + chartHeight + 'px; border-bottom: 1px solid var(--border-color);">';

                // 渲染曲线图
                if (trendData.length > 0 || Object.keys(modelDailyData).length > 0 || (data.by_model && data.by_model.length > 0)) {
                    const width = chartWidth;
                    const height = chartHeight - 20; // 留出底部空间

                    html += '<svg viewBox="0 0 ' + width + ' ' + height + '" preserveAspectRatio="none" style="width: 100%; height: 100%; overflow: visible;">';
                    html += '<defs>';

                    // 为每个模型创建渐变
                    Object.entries(modelColors).forEach(([model, color], idx) => {
                        html += '<linearGradient id="grad' + idx + '" x1="0%" y1="0%" x2="0%" y2="100%">';
                        html += '<stop offset="0%" style="stop-color:' + color + ';stop-opacity:0.3"/>';
                        html += '<stop offset="100%" style="stop-color:' + color + ';stop-opacity:0.02"/>';
                        html += '</linearGradient>';
                    });
                    html += '</defs>';

                    // 绘制Y轴网格线（使用百分比避免变形）
                    yTicks.forEach((tick, i) => {
                        if (i > 0) { // 跳过0刻度
                            const yPct = (1 - tick / yMax) * 100;
                            html += '<line x1="0%" y1="' + yPct + '%" x2="100%" y2="' + yPct + '%" stroke="#e0e0e0" stroke-width="1" vector-effect="non-scaling-stroke" opacity="0.6"/>';
                        }
                    });

                    // 绘制每个模型的曲线（按成本从小到大绘制，大的在前面）
                    const sortedModels = Object.entries(modelDailyData)
                        .map(([model, arr]) => ({ model, arr, total: arr.reduce((a, b) => a + b, 0) }))
                        .sort((a, b) => a.total - b.total);

                    // 存储所有模型的点数据用于tooltip
                    const allModelPoints = {};

                    sortedModels.forEach(({ model, arr }, sortIdx) => {
                        const color = modelColors[model] || colorPalette[sortIdx % colorPalette.length];
                        const gradIdx = Object.keys(modelColors).indexOf(model);

                        // 给两侧留出边距（5%）
                        const padding = width * 0.05;
                        const innerWidth = width - padding * 2;

                        // 计算点坐标（确保Y不低于0，不高于height）
                        const points = arr.map((val, i) => {
                            const yVal = Math.max(0, Math.min(height, height - (val / yMax) * height));
                            return {
                                x: padding + (i / Math.max(arr.length - 1, 1)) * innerWidth,
                                y: yVal,
                                value: val
                            };
                        });
                        allModelPoints[model] = points;

                        // 生成平滑曲线路径
                        const curvePath = generateSmoothPath(points, 0.2, height);

                        // 填充区域（使用平滑曲线）
                        if (curvePath) {
                            const firstX = points[0].x;
                            const lastX = points[points.length - 1].x;
                            const fillPath = curvePath + ' L' + lastX + ',' + height + ' L' + firstX + ',' + height + ' Z';
                            html += '<path d="' + fillPath + '" fill="url(#grad' + (gradIdx >= 0 ? gradIdx : sortIdx) + ')" opacity="0.5"/>';
                            // 曲线
                            html += '<path d="' + curvePath + '" fill="none" stroke="' + color + '" stroke-width="1.5" vector-effect="non-scaling-stroke" opacity="0.8"/>';
                        }
                    });

                    // 如果没有按模型的数据，使用总趋势
                    if (sortedModels.length === 0 && trendData.length > 0) {
                        const padding = width * 0.05;
                        const innerWidth = width - padding * 2;

                        const points = trendData.map((t, i) => {
                            const yVal = Math.max(0, Math.min(height, height - ((t.amount || 0) / yMax) * height));
                            return {
                                x: padding + (i / Math.max(trendData.length - 1, 1)) * innerWidth,
                                y: yVal,
                                value: t.amount || 0
                            };
                        });

                        const curvePath = generateSmoothPath(points, 0.2, height);
                        if (curvePath) {
                            html += '<defs><linearGradient id="gradDefault" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:#4285f4;stop-opacity:0.3"/><stop offset="100%" style="stop-color:#4285f4;stop-opacity:0.02"/></linearGradient></defs>';
                            const firstX = points[0].x;
                            const lastX = points[points.length - 1].x;
                            const fillPath = curvePath + ' L' + lastX + ',' + height + ' L' + firstX + ',' + height + ' Z';
                            html += '<path d="' + fillPath + '" fill="url(#gradDefault)" opacity="0.5"/>';
                            html += '<path d="' + curvePath + '" fill="none" stroke="#4285f4" stroke-width="1.5" vector-effect="non-scaling-stroke"/>';
                        }
                    }

                    html += '</svg>';

                    // 垂直指示线（初始隐藏）
                    html += '<div id="costChartIndicator" style="display: none; position: absolute; top: 0; bottom: 0; width: 1px; background: var(--text-secondary); pointer-events: none; opacity: 0.5;"></div>';

                    // 数据点圆点容器
                    html += '<div id="costChartDots" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none;"></div>';

                    // 交互层（添加 z-index 确保在最上层）
                    html += '<div id="costChartOverlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; cursor: crosshair; z-index: 10;" onmousemove="showCostTooltip(event)" onmouseleave="hideCostTooltip()"></div>';

                    // 存储点数据
                    window.costChartPoints = allModelPoints;
                }

                html += '</div>';

                // X轴标签
                if (dates.length > 0) {
                    html += '<div style="margin-left: 55px; display: flex; justify-content: space-between; font-size: 10px; color: var(--text-secondary); padding-top: 4px;">';
                    const step = Math.max(1, Math.floor(dates.length / 8));
                    for (let i = 0; i < dates.length; i += step) {
                        const d = new Date(dates[i]);
                        html += '<div>' + (d.getMonth() + 1) + '/' + d.getDate() + '</div>';
                    }
                    html += '</div>';
                }

                html += '</div>';

                // Tooltip（在图表容器外部，避免被裁剪，移动端自适应）
                html += '<div id="costChartTooltip" style="display: none; position: fixed; background: var(--container-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 12px; font-size: 11px; box-shadow: 0 4px 16px rgba(0,0,0,0.15); z-index: 99999; max-width: calc(100vw - 20px); overflow: hidden;"></div>';

                // 存储数据供tooltip使用
                window.costChartData = {
                    trend: trendData,
                    byModel: data.by_model,
                    dailyByModel: data.daily_by_model || [],
                    modelColors: modelColors,
                    yMax: yMax,
                    chartHeight: chartHeight - 20
                };

                el.innerHTML = html;
            } catch (e) {
                console.error('renderCostChart error:', e);
                el.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">图表渲染失败: ' + e.message + '</div>';
            }
        }

        // 显示tooltip
        function showCostTooltip(event) {
            const tooltip = document.getElementById('costChartTooltip');
            const overlay = document.getElementById('costChartOverlay');
            const indicator = document.getElementById('costChartIndicator');
            const dotsContainer = document.getElementById('costChartDots');

            if (!tooltip || !overlay || !window.costChartData) return;
            if (!window.costChartData.trend || window.costChartData.trend.length === 0) return;

            const rect = overlay.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const pct = x / rect.width;
            const trend = window.costChartData.trend || [];
            const idx = Math.min(Math.floor(pct * trend.length), trend.length - 1);

            if (idx < 0 || !trend[idx]) return;

            // 显示垂直指示线
            if (indicator) {
                const indicatorX = (idx / Math.max(trend.length - 1, 1)) * rect.width;
                indicator.style.display = 'block';
                indicator.style.left = indicatorX + 'px';
            }

            // 显示数据点圆点
            if (dotsContainer && window.costChartPoints) {
                const modelColors = window.costChartData.modelColors || {};
                const yMax = window.costChartData.yMax || 1;
                const chartHeight = rect.height;
                let dotsHtml = '';

                Object.entries(window.costChartPoints).forEach(([model, points]) => {
                    if (points[idx] && points[idx].value > 0) {
                        const color = modelColors[model] || '#4285f4';
                        const dotX = (idx / Math.max(points.length - 1, 1)) * rect.width;
                        const dotY = chartHeight - (points[idx].value / yMax) * chartHeight;
                        dotsHtml += '<div style="position: absolute; left: ' + (dotX - 4) + 'px; top: ' + (dotY - 4) + 'px; width: 8px; height: 8px; border-radius: 50%; background: ' + color + '; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.3);"></div>';
                    }
                });
                dotsContainer.innerHTML = dotsHtml;
            }

            const item = trend[idx];
            const date = new Date(item.date);
            const dateStr = date.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric', year: 'numeric' }) + ' (UTC)';

            // 获取当天有数据的模型（从 daily_by_model 中查找）
            const dailyByModel = window.costChartData.dailyByModel || [];
            const dayData = dailyByModel.find(d => d.index === idx);
            const modelColors = window.costChartData.modelColors || {};
            const defaultColors = ['#4285f4', '#ea4335', '#fbbc04', '#34a853', '#ff6d01', '#46bdc6', '#7baaf7', '#f07b72', '#fcd04f', '#81c995', '#ff9e80', '#78d9ec'];

            let html = '<div style="font-weight: 600; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid var(--border-color);">' + dateStr + '</div>';

            if (dayData && dayData.models && Object.keys(dayData.models).length > 0) {
                // 按金额排序，只显示当天有数据的模型
                const sortedModels = Object.entries(dayData.models)
                    .map(([model, costs]) => ({
                        model,
                        input: costs.input || 0,
                        output: costs.output || 0,
                        total: (costs.input || 0) + (costs.output || 0)
                    }))
                    .filter(m => m.total > 0)
                    .sort((a, b) => b.total - a.total);

                // 检测是否为移动端（宽度小于 500px）
                const isMobile = window.innerWidth < 500;

                if (isMobile) {
                    // 移动端：单列紧凑布局，显示模型名和总额
                    sortedModels.forEach((m, i) => {
                        const color = modelColors[m.model] || defaultColors[i % defaultColors.length];
                        html += '<div style="color: ' + color + '; font-size: 11px; padding: 2px 0; display: flex; justify-content: space-between; gap: 8px;">';
                        html += '<span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 120px;">' + m.model + '</span>';
                        html += '<strong>$' + m.total.toFixed(4) + '</strong>';
                        html += '</div>';
                    });
                } else {
                    // 桌面端：两列布局，左边 Input，右边 Output，中间有分隔线
                    html += '<div style="display: flex; gap: 0; align-items: stretch;">';
                    // 左列 - Input
                    html += '<div style="flex: 1; padding-right: 12px;">';
                    html += '<div style="font-size: 10px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">Input</div>';
                    sortedModels.forEach((m, i) => {
                        const color = modelColors[m.model] || defaultColors[i % defaultColors.length];
                        html += '<div style="color: ' + color + '; white-space: nowrap; font-size: 11px; padding: 2px 0;">' + m.model + ': <strong>$' + m.input.toFixed(4) + '</strong></div>';
                    });
                    html += '</div>';
                    // 分隔线
                    html += '<div style="width: 1px; background: linear-gradient(to bottom, transparent, var(--border-color) 10%, var(--border-color) 90%, transparent); margin: 0 12px; min-height: 100%;"></div>';
                    // 右列 - Output
                    html += '<div style="flex: 1; padding-left: 0;">';
                    html += '<div style="font-size: 10px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;">Output</div>';
                    sortedModels.forEach((m, i) => {
                        const color = modelColors[m.model] || defaultColors[i % defaultColors.length];
                        html += '<div style="color: ' + color + '; white-space: nowrap; font-size: 11px; padding: 2px 0;">' + m.model + ': <strong>$' + m.output.toFixed(4) + '</strong></div>';
                    });
                    html += '</div>';
                    html += '</div>';
                }
            } else {
                // 如果没有 daily_by_model 数据，显示当天总额
                html += '<div style="color: var(--text-secondary);">Total: $' + (item.amount || 0).toFixed(4) + '</div>';
            }

            tooltip.innerHTML = html;
            tooltip.style.display = 'block';

            // 智能定位：优先右侧，空间不够则左侧，再不够则上下布局
            const tooltipRect = tooltip.getBoundingClientRect();
            const margin = 15;
            const viewW = window.innerWidth;
            const viewH = window.innerHeight;
            const tipW = tooltipRect.width;
            const tipH = tooltipRect.height;
            const mouseX = event.clientX;
            const mouseY = event.clientY;

            let left, top;

            // 移动端检测
            const isMobile = viewW < 500;

            if (isMobile) {
                // 移动端：固定在屏幕底部中央
                left = Math.max(10, (viewW - tipW) / 2);
                top = viewH - tipH - 20;
            } else {
                // 桌面端：智能定位
                // 水平定位：优先右侧 -> 左侧 -> 居中
                if (mouseX + margin + tipW < viewW - 10) {
                    left = mouseX + margin;
                } else if (mouseX - margin - tipW > 10) {
                    left = mouseX - margin - tipW;
                } else {
                    left = Math.max(10, Math.min(viewW - tipW - 10, mouseX - tipW / 2));
                }

                // 垂直定位：优先垂直居中于鼠标位置
                top = mouseY - tipH / 2;

                // 如果左右都放不下，尝试上下布局
                if (tipW > viewW - 40) {
                    left = 10;
                    if (mouseY + margin + tipH < viewH - 10) {
                        top = mouseY + margin;
                    } else if (mouseY - margin - tipH > 10) {
                        top = mouseY - margin - tipH;
                    }
                }
            }

            // 边界检查
            if (left < 10) left = 10;
            if (left + tipW > viewW - 10) left = viewW - tipW - 10;
            if (top < 10) top = 10;
            if (top + tipH > viewH - 10) top = viewH - tipH - 10;

            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
        }

        function hideCostTooltip() {
            const tooltip = document.getElementById('costChartTooltip');
            const indicator = document.getElementById('costChartIndicator');
            const dotsContainer = document.getElementById('costChartDots');
            if (tooltip) tooltip.style.display = 'none';
            if (indicator) indicator.style.display = 'none';
            if (dotsContainer) dotsContainer.innerHTML = '';
        }

        // 渲染表格视图
        function renderCostTable(el, data) {
            const models = data.by_model || [];
            if (models.length === 0) {
                el.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">没有成本数据</div>';
                return;
            }

            // 计算总成本
            const totalCost = models.reduce((sum, m) => sum + (m.cost || 0), 0);

            // 按分类分配颜色（同一分类使用相近颜色）
            const groupColorPalettes = {
                'Claude': ['#ff6b35', '#ff8c5a', '#ffad7f', '#ffc9a3'],
                'Gemini': ['#00bcd4', '#26c6da', '#4dd0e1', '#80deea'],
                'GPT': ['#2196f3', '#42a5f5', '#64b5f6', '#90caf9'],
                '其他': ['#9c27b0', '#ab47bc', '#ba68c8', '#ce93d8']
            };
            const groupColorIndex = { 'Claude': 0, 'Gemini': 0, 'GPT': 0, '其他': 0 };

            const modelColors = {};
            models.forEach(m => {
                const name = m.model || '';
                let group = '其他';
                if (name.toLowerCase().includes('claude')) {
                    group = 'Claude';
                } else if (name.toLowerCase().includes('gemini')) {
                    group = 'Gemini';
                } else if (name.toLowerCase().includes('gpt') || name.toLowerCase().includes('chatgpt')) {
                    group = 'GPT';
                }
                const palette = groupColorPalettes[group];
                modelColors[m.model] = palette[groupColorIndex[group] % palette.length];
                groupColorIndex[group]++;
            });

            // 按成本排序
            const sortedModels = [...models].sort((a, b) => (b.cost || 0) - (a.cost || 0));

            let html = '<div style="padding: 0;">';

            // 成本分布条
            html += '<div style="margin-bottom: 16px;">';
            html += '<div style="font-size: 14px; font-weight: 500; color: var(--text-color); margin-bottom: 8px;">成本分布</div>';
            html += '<div style="display: flex; height: 8px; border-radius: 4px; overflow: hidden; background: var(--border-color);">';
            sortedModels.forEach(m => {
                const pct = totalCost > 0 ? ((m.cost || 0) / totalCost) * 100 : 0;
                if (pct > 0) {
                    const color = modelColors[m.model];
                    html += '<div style="width: ' + pct + '%; background: ' + color + ';" title="' + m.model + ': ' + pct.toFixed(1) + '%"></div>';
                }
            });
            html += '</div></div>';

            // 按模型分类
            html += '<div style="font-size: 14px; font-weight: 500; color: var(--text-color); margin-bottom: 8px;">按模型分类</div>';

            // 分组
            const groups = { 'Claude': [], 'Gemini': [], 'GPT': [], '其他': [] };

            sortedModels.forEach(m => {
                const name = m.model || '';
                if (name.toLowerCase().includes('claude')) {
                    groups['Claude'].push(m);
                } else if (name.toLowerCase().includes('gemini')) {
                    groups['Gemini'].push(m);
                } else if (name.toLowerCase().includes('gpt') || name.toLowerCase().includes('chatgpt')) {
                    groups['GPT'].push(m);
                } else {
                    groups['其他'].push(m);
                }
            });

            // 渲染每个分组
            Object.entries(groups).forEach(([groupName, groupModels]) => {
                if (groupModels.length === 0) return;

                html += '<div style="margin-bottom: 8px;">';
                html += '<div style="font-size: 14px; font-weight: 600; color: var(--text-color); padding: 4px 0;">' + groupName + '</div>';

                groupModels.forEach(m => {
                    const color = modelColors[m.model];
                    const pct = totalCost > 0 ? ((m.cost || 0) / totalCost) * 100 : 0;

                    html += '<div style="display: flex; align-items: center; padding: 8px 0; gap: 10px; border-bottom: 1px solid var(--border-color);">';
                    html += '<div style="width: 10px; height: 10px; border-radius: 50%; background: ' + color + '; flex-shrink: 0;"></div>';
                    html += '<div style="flex: 1; font-size: 14px; color: var(--text-color); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">' + m.model + '</div>';
                    html += '<div style="font-size: 14px; color: var(--text-color); text-align: right; white-space: nowrap;">';
                    html += '<span style="font-weight: 600;">$' + (m.cost || 0).toFixed(4) + '</span>';
                    html += ' <span style="color: var(--text-secondary);">(' + pct.toFixed(1) + '%)</span>';
                    html += '</div>';
                    html += '</div>';
                });

                html += '</div>';
            });

            html += '</div>';
            el.innerHTML = html;
        }

        // 加载成本数据（总览 + 详情）
        async function loadAccountCost(force = false, silent = false) {
            if (!currentAccountEmail) return;

            // 并发加载总览和详情
            await Promise.all([
                loadAccountCostSummary(force),
                loadAccountCostDetails(force)
            ]);
        }

        // 导出成本数据
        async function exportAccountCost(format) {
            if (!currentAccountEmail) {
                showAccountStatus('请先选择账户', 'error');
                return;
            }
            try {
                // 使用当前筛选参数
                const params = buildCostFilterParams();
                params.append('format', format);
                params.append('account_email', currentAccountEmail);
                const res = await fetch(`/ api / account /export/cost?${params.toString()}`, { headers: getAuthHeaders() });
                if (!res.ok) throw new Error('导出失败');
                const data = await res.json();
                const content = format === 'csv' ? data.data : JSON.stringify(data.data, null, 2);
                const blob = new Blob([content], { type: format === 'csv' ? 'text/csv' : 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `cost_export.${format}`;
                a.click();
                URL.revokeObjectURL(url);
                showAccountStatus('导出成功', 'success');
            } catch (e) {
                showAccountStatus('导出失败: ' + e.message, 'error');
            }
        }

        // 加载费率数据
        async function loadAccountRates(force = false, silent = false) {
            if (!currentAccountEmail) {
                const el = document.getElementById('accountRatesContent');
                if (el) el.innerHTML = '<p style="color: var(--text-secondary);">请先选择账户</p>';
                return;
            }
            const el = document.getElementById('accountRatesContent');
            if (!el) return;

            // 强制刷新时清除缓存
            if (force) {
                accountCache.rates = { ts: 0, html: '' };
            }

            if (!force && accountCache.rates.html && isFresh(accountCache.rates.ts)) {
                el.innerHTML = accountCache.rates.html;
                return;
            }
            // 静默模式不显示加载中
            if (!silent) {
                el.innerHTML = getRatesLoadingHTML();
            }
            const region = document.getElementById('accountRatesRegion')?.value || 'US';
            try {
                const params = new URLSearchParams();
                params.append('region', region);
                if (force) params.append('force', '1');
                if (currentAccountEmail) params.append('account_email', currentAccountEmail);
                console.log('Fetching rates data for:', currentAccountEmail, 'force:', force, 'silent:', silent);
                const res = await fetch(`/api/account/rates?${params.toString()}`, { headers: getAuthHeaders() });
                if (!res.ok) throw new Error('加载失败');
                const data = await res.json();
                console.log('Rates data received:', data);
                let html = '<div style="display: grid; gap: 20px;">';

                // LLM Gateway - 合并输入/输出两列并优先展示
                if ((data.llm_gateway_input && data.llm_gateway_input.length > 0) || (data.llm_gateway_output && data.llm_gateway_output.length > 0)) {
                    const map = {};
                    (data.llm_gateway_input || []).forEach(item => {
                        const k = item.model || '-';
                        if (!map[k]) map[k] = { in: 0, out: 0, inDisplay: '-', outDisplay: '-', unit: item.unit || '' };
                        map[k].in = item.rate || 0;
                        map[k].inDisplay = item.rate_display || ('$' + (item.rate || 0).toFixed(2));
                        map[k].unit = item.unit || map[k].unit || '';
                    });
                    (data.llm_gateway_output || []).forEach(item => {
                        const k = item.model || '-';
                        if (!map[k]) map[k] = { in: 0, out: 0, inDisplay: '-', outDisplay: '-', unit: item.unit || '' };
                        map[k].out = item.rate || 0;
                        map[k].outDisplay = item.rate_display || ('$' + (item.rate || 0).toFixed(2));
                        map[k].unit = item.unit || map[k].unit || '';
                    });
                    const rows = Object.keys(map).map(k => ({
                        model: k,
                        in: map[k].in,
                        out: map[k].out,
                        inDisplay: map[k].inDisplay,
                        outDisplay: map[k].outDisplay,
                        unit: map[k].unit
                    })).sort((a, b) => {
                        function vendor(n) { const s = (n || '').toLowerCase(); if (s.includes('gpt')) return 0; if (s.includes('claude')) return 1; if (s.includes('gemini')) return 2; return 3; }
                        const v = vendor(a.model) - vendor(b.model); if (v !== 0) return v; return (b.out || 0) - (a.out || 0);
                    });
                    html += '<div class="rates-card" style="padding: 16px; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color);">';
                    html += '<h5 style="color: var(--text-color);">LLM Gateway</h5>';
                    html += '<div class="rates-table-wrap">';
                    html += '<table class="table rates-table"><thead><tr><th>模型</th><th>输入</th><th>输出</th><th class="rates-unit-col">单位</th></tr></thead><tbody>';
                    rows.forEach(r => {
                        const inTxt = r.inDisplay || '-';
                        const outTxt = r.outDisplay || '-';
                        html += `<tr><td>${r.model}</td><td>${inTxt}</td><td>${outTxt}</td><td class="rates-unit-col">${r.unit || '-'}</td></tr>`;
                    });
                    html += '</tbody></table>';
                    html += '</div>';
                    html += '</div>';
                }

                // Speech-to-Text
                if (data.speech_to_text && data.speech_to_text.length > 0) {
                    html += '<div class="rates-card" style="padding: 16px; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color);"><h5 style="color: var(--text-color);">Speech-to-Text</h5><table class="table rates-simple-table"><thead><tr><th>模型</th><th>费率</th></tr></thead><tbody>';
                    data.speech_to_text.forEach(item => {
                        html += `<tr><td>${item.model}${item.beta ? ' <span style="color: #ffc107; font-size: 11px;">Beta</span>' : ''}</td><td>$${item.rate} / ${item.unit}</td></tr>`;
                    });
                    html += '</tbody></table></div>';
                }

                // Streaming
                if (data.streaming && data.streaming.length > 0) {
                    html += '<div class="rates-card" style="padding: 16px; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border-color);"><h5 style="color: var(--text-color);">Streaming</h5><table class="table rates-simple-table"><thead><tr><th>模型</th><th>费率</th></tr></thead><tbody>';
                    data.streaming.forEach(item => {
                        html += `<tr><td>${item.model}${item.beta ? ' <span style="color: #ffc107; font-size: 11px;">Beta</span>' : ''}</td><td>$${item.rate} / ${item.unit}</td></tr>`;
                    });
                    html += '</tbody></table></div>';
                }

                // Notes
                if (data.notes && data.notes.length > 0) {
                    html += '<div style="color: var(--text-secondary); font-size: 12px; margin-top: 12px;">';
                    data.notes.forEach(note => {
                        html += `<div>${note}</div>`;
                    });
                    html += '</div>';
                }

                html += '</div>';
                accountCache.rates = { ts: Date.now(), html };
                el.innerHTML = html;
            } catch (e) {
                el.innerHTML = `<div class="status error">加载失败: ${e.message}</div>`;
            }
        }

        // 初始化账户管理标签页
        function initAccountTab() {
            checkAccountSession();
            startAccountAutoRefresh();
        }
    </script>
</body>

</html>