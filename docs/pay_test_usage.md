# Stripe 支付测试脚本使用说明

## 概述

`pay_test.py` 是一个用于测试 Stripe 支付和 AssemblyAI 账户升级的交互式脚本。该脚本通过两个 API 接口完成完整的支付流程：

1. **Stripe Payment Methods API** - 创建支付方式
2. **AssemblyAI Dashboard API** - 升级账户计划

## 功能特性

- ✅ 交互式输入，逐步引导用户完成支付流程
- ✅ 支持从文件读取长字符串（hCaptcha token、Cookie）
- ✅ 支持多行粘贴输入
- ✅ 详细的错误分析和调试信息
- ✅ 显示支付方式创建结果和订单号

## 前置要求

### 1. Python 环境
- Python 3.7+
- 已安装 `httpx` 库

### 2. 必需信息
- 银行卡信息（卡号、CVC、过期日期、持卡人姓名）
- 浏览器 Cookie（从 AssemblyAI 网站获取）
- hCaptcha token（可选，用于支付方式创建）

## 使用方法

### 基本使用

```bash
python pay_test.py
```

### 交互式流程

脚本会按以下顺序引导您完成支付：

#### 第一步：输入卡号相关信息

1. **卡号**：输入完整的银行卡号
2. **CVC 安全码**：输入卡片背面的3位安全码
3. **过期月份**：格式为 MM（例如：08）
4. **过期年份**：格式为 YY（例如：28）
5. **持卡人姓名**：默认值为 "Chris Moore"，可直接回车使用
6. **hCaptcha token**（可选）：
   - 直接粘贴 token 内容（支持多行，粘贴后按空行结束）
   - 输入文件路径（例如：`/path/to/token.txt`）
   - 直接回车跳过，使用默认值

#### 第二步：输入 Cookie 信息

**重要**：Cookie 是必需的，用于身份验证。

**获取 Cookie 的方法**：
1. 打开浏览器，访问 https://www.assemblyai.com
2. 登录您的账户
3. 打开开发者工具（F12）
4. 切换到 Network 标签
5. 在网站上执行任意操作（如刷新页面）
6. 找到任意请求，点击查看 Headers
7. 在 Request Headers 中找到 `Cookie` 字段
8. 复制完整的 Cookie 值

**输入方式**：
- 直接粘贴 Cookie 内容（支持多行，粘贴后按空行结束）
- 输入文件路径（例如：`./cookie.txt` 或 `/path/to/cookie.txt`）

**注意**：
- Cookie 会过期，如果遇到 500 错误，请重新从浏览器复制最新的 Cookie
- 如果文件不存在，脚本会提示错误并允许重新输入

#### 第三步：输入付款金额信息

1. **付款金额**：输入美元金额，支持小数（例如：`10` 或 `0.01`）
2. **是否免费升级**：
   - `y` - 免费升级（不扣款）
   - `n` - 正常扣款（默认）

**重要限制**：
- ⚠️ **最低充值金额为 10 美元**
- 如果输入金额小于 10 美元，API 可能会返回错误
- 建议充值金额：`10` 美元或以上

#### 第四步：确认信息

脚本会显示所有输入的信息供您确认：
- Payment Method ID
- 卡号（部分隐藏）
- 付款金额
- 是否免费
- Cookie 长度

确认无误后输入 `y` 继续，或输入 `n` 取消。

## 输入技巧

### 从文件读取长字符串

如果 token 或 Cookie 太长，可以保存到文件中：

```bash
# 保存 token 到文件
echo "P1_eyJ0eXAiOiJKV1QiLCJhbGc..." > token.txt

# 保存 Cookie 到文件
echo "rs_ga=GA1.1.b269b0d1..." > cookie.txt
```

然后在脚本中输入文件路径：
```
请输入 hCaptcha token 或文件路径: ./token.txt
请输入 Cookie 内容或文件路径: ./cookie.txt
```

### 多行粘贴

对于长字符串，可以：
1. 直接粘贴第一行
2. 如果还没输入完，继续粘贴（脚本会提示）
3. 输入空行结束

## 输出说明

### 成功示例

```
✅ 支付方式创建成功!
Payment Method ID: pm_1SYptDLhDBkzam9lZiEjDSLR
卡品牌: mastercard
卡号后四位: 9780
过期日期: 8/2028

✅ 账户计划升级成功!
```

### 错误处理

脚本会显示详细的错误信息：

```
❌ 请求失败!
响应状态码: 500

【错误分析】
500 Internal Server Error 可能的原因:
1. Cookie 过期或无效 - 请检查 Cookie 是否最新
2. 金额格式问题 - API 可能需要整数（美分）而不是浮点数
3. 支付方式 ID 与账户不匹配
4. 服务器端验证失败
5. 缺少必需的请求参数

建议:
- 检查 Cookie 是否从浏览器最新复制
- 尝试将金额转换为整数（美分）
- 确认支付方式 ID 是否正确
```

## 常见问题

### Q1: 为什么提示 Cookie 不能为空？

A: Cookie 是 AssemblyAI 账户身份验证的必需信息。请确保：
- 已登录 AssemblyAI 网站
- 从浏览器开发者工具中复制了完整的 Cookie
- Cookie 没有过期

### Q2: 为什么返回 500 错误？

A: 500 错误通常由以下原因引起：
1. **Cookie 过期**：最常见原因，请重新复制最新的 Cookie
2. **金额格式**：某些 API 可能需要整数（美分）而不是浮点数
3. **支付方式不匹配**：确保支付方式是在同一会话中创建的
4. **最低金额限制**：确保金额 >= 10 美元

### Q3: 为什么只能充值超过 10 美元？

A: 这是 AssemblyAI API 的限制。最低充值金额为 10 美元。如果输入小于 10 美元的金额，API 可能会返回错误。

### Q4: hCaptcha token 从哪里获取？

A: hCaptcha token 是在浏览器中完成验证后生成的。通常：
- 在浏览器中访问支付页面时会自动生成
- 可以从浏览器的 Network 请求中获取
- 如果不需要，可以直接回车跳过，使用默认值

### Q5: 如何确认支付是否成功？

A: 脚本会显示：
- Payment Method ID（支付方式创建成功）
- 账户计划升级结果（如果成功会显示成功信息）

您也可以在 AssemblyAI 网站的控制面板中查看账户余额和交易记录。

## 注意事项

1. **安全性**：
   - 不要将包含敏感信息的文件提交到版本控制系统
   - Cookie 和 token 具有时效性，请妥善保管
   - 使用完毕后建议删除包含敏感信息的临时文件

2. **金额限制**：
   - 最低充值金额：**10 美元**
   - 支持小数输入（例如：10.5）
   - 如果遇到错误，可以尝试使用整数金额

3. **Cookie 有效期**：
   - Cookie 会过期，如果遇到认证错误，请重新获取
   - 建议每次使用前都从浏览器复制最新的 Cookie

4. **测试环境**：
   - 脚本使用 Stripe 的 live 模式（`pk_live_...`）
   - 请确保使用测试卡号或确认卡号有效

## 脚本结构

```
pay_test.py
├── create_payment_method()      # 创建 Stripe 支付方式
├── upgrade_account_plan()      # 升级 AssemblyAI 账户计划
├── get_user_input_and_create_payment()  # 交互式输入流程
└── main()                      # 主函数
```

## 相关文件

- `pay_test.py` - 主脚本文件
- `pay_test_example.py` - 使用示例（如果存在）

## 更新日志

- 支持从文件读取长字符串
- 改进错误分析和提示
- 添加详细的调试信息
- 支持小数金额输入
- 改进 Cookie 输入验证

## 技术支持

如果遇到问题：
1. 检查错误信息中的【错误分析】部分
2. 确认所有输入信息正确
3. 重新获取最新的 Cookie
4. 确保金额 >= 10 美元

---

**最后更新**：2025-01-29
